<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>Builds</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>Builds</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="understanding-image-builds">Understanding image builds</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="builds-about-understanding-image-builds">Builds</h3>
<div class="paragraph">
<p>A <em>build</em> is the process of transforming input parameters into a resulting
object. Most often, the process is used to transform input parameters or source
code into a runnable image. A <code>BuildConfig</code> object is the definition of the
entire build process.</p>
</div>
<div class="paragraph">
<p>OpenShift Enterprise uses Kubernetes by creating containers
from build images and pushing them to a container image registry.</p>
</div>
<div class="paragraph">
<p>Build objects share common characteristics including inputs for a build, the need to
complete a build process, logging the build process, publishing resources from
successful builds, and publishing the final status of the build. Builds take
advantage of resource restrictions, specifying limitations on resources such as
CPU usage, memory usage, and build or pod execution time.</p>
</div>
<div class="paragraph">
<p>The OpenShift Enterprise build system provides extensible support for <em>build
strategies</em> that are based on selectable types specified in the build API. There
are three primary build strategies available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Docker build</p>
</li>
<li>
<p>Source-to-Image (S2I) build</p>
</li>
<li>
<p>Custom build</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, Docker builds and S2I builds are supported.</p>
</div>
<div class="paragraph">
<p>The resulting object of a build depends on the builder used to create it. For
Docker and S2I builds, the resulting objects are runnable images. For Custom
builds, the resulting objects are whatever the builder image author has
specified.</p>
</div>
<div class="paragraph">
<p>Additionally, the Pipeline build strategy can be used to implement sophisticated
workflows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Continuous integration</p>
</li>
<li>
<p>Continuous deployment</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="builds-strategy-docker-build-understanding-image-builds">Docker build</h4>
<div class="paragraph">
<p>The Docker build strategy invokes the docker build command, and it expects a
repository with a <strong><em>Dockerfile</em></strong> and all required artifacts in it to produce a
runnable image.</p>
</div>
</div>
<div class="sect3">
<h4 id="build-strategy-s2i-understanding-image-builds">Source-to-Image (S2I) build</h4>
<div class="paragraph">
<p>Source-to-Image (S2I) is a tool for building reproducible, Docker-formatted
container images. It produces ready-to-run images by injecting application
source into a container image and assembling a new image. The new image
incorporates the base image (the builder) and built source and is ready to use
with the <code>buildah run</code> command. S2I supports incremental builds, which re-use
previously downloaded dependencies, previously built artifacts, etc.</p>
</div>
<div class="paragraph">
<p>The advantages of S2I include the following:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Image flexibility
</td>
<td class="hdlist2">
<p>S2I scripts can be written to inject
application code into almost any existing Docker-formatted container image,
taking advantage of the existing ecosystem. Note that, currently, S2I relies on
<code>tar</code> to inject application source, so the image needs to be able to process
tarred content.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Speed
</td>
<td class="hdlist2">
<p>With S2I, the assemble process can perform a large number of complex
operations without creating a new layer at each step, resulting in a fast
process. In addition, S2I scripts can be written to re-use artifacts stored in a
previous version of the application image, rather than having to download or
build them each time the build is run.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Patchability
</td>
<td class="hdlist2">
<p>S2I allows you to rebuild the application consistently if an
underlying image needs a patch due to a security issue.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Operational efficiency
</td>
<td class="hdlist2">
<p>By restricting build operations instead of allowing
arbitrary actions, as a <strong><em>Dockerfile</em></strong> would allow, the PaaS operator can avoid
accidental or intentional abuses of the build system.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Operational security
</td>
<td class="hdlist2">
<p>Building an arbitrary <strong><em>Dockerfile</em></strong> exposes the host
system to root privilege escalation. This can be exploited by a malicious user
because the entire Docker build process is run as a user with Docker privileges.
S2I restricts the operations performed as a root user and can run the scripts
as a non-root user.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
User efficiency
</td>
<td class="hdlist2">
<p>S2I prevents developers from performing arbitrary <code>yum
install</code> type operations, which could slow down development iteration, during
their application build.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Ecosystem
</td>
<td class="hdlist2">
<p>S2I encourages a shared ecosystem of images where you can leverage
best practices for your applications.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Reproducibility
</td>
<td class="hdlist2">
<p>Produced images can include all inputs including specific versions
of build tools and dependencies. This ensures that the image can be reproduced
precisely.</p>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="build-strategy-custom-build-understanding-image-builds">Custom build</h4>
<div class="paragraph">
<p>The Custom build strategy allows developers to define a specific builder image
responsible for the entire build process. Using your own builder image allows
you to customize your build process.</p>
</div>
<div class="paragraph">
<p>A Custom builder image is a plain Docker-formatted container image embedded with
build process logic, for example for building RPMs or base images.</p>
</div>
<div class="paragraph">
<p>Custom builds run with a very high level of privilege and are not available to
users by default. Only users who can be trusted with cluster administration
permissions should be granted access to run custom builds.</p>
</div>
</div>
<div class="sect3">
<h4 id="builds-strategy-pipeline-build-understanding-image-builds">Pipeline build</h4>
<div class="paragraph">
<p>The Pipeline build strategy allows developers to define a <em>Jenkins pipeline</em> for
execution by the Jenkins pipeline plugin. The build can be started, monitored,
and managed by OpenShift Enterprise in the same way as any other build type.</p>
</div>
<div class="paragraph">
<p>Pipeline workflows are defined in a Jenkinsfile, either embedded directly in the
build configuration, or supplied in a Git repository and referenced by the build
configuration.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="understanding-build-configurations">Understanding build configurations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following sections define the concept of a build, <code>BuildConfig</code>, and outline
the primary build strategies available.</p>
</div>
<div class="sect2">
<h3 id="builds-buildconfig-understanding-builds">BuildConfigs</h3>
<div class="paragraph">
<p>A build configuration describes a single build definition and a set of
triggers for when a new build is created. Build configurations are defined
by a <code>BuildConfig</code>, which is a REST object that can be used in a POST to the API
server to create a new instance.</p>
</div>
<div class="paragraph">
<p>A <em>build configuration</em>, or <code>BuildConfig</code>, is characterized by a <em>build strategy</em>
and one or more sources. The strategy determines the process, while
the sources provide its input.</p>
</div>
<div class="paragraph">
<p>Depending on how you choose to create your application using OpenShift Enterprise, a
<code>BuildConfig</code> is typically generated automatically for you if you use the web
console or CLI, and it can be edited at any time. Understanding the parts that
make up a <code>BuildConfig</code> and their available options can help if you choose to
manually change your configuration later.</p>
</div>
<div class="paragraph">
<p>The following example <code>BuildConfig</code> results in a new build every time a
container image tag or the source code changes:</p>
</div>
<div class="listingblock">
<div class="title">BuildConfig Object definition</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: "BuildConfig"
apiVersion: "v1"
metadata:
  name: "ruby-sample-build" <b class="conum">(1)</b>
spec:
  runPolicy: "Serial" <b class="conum">(2)</b>
  triggers: <b class="conum">(3)</b>
    -
      type: "GitHub"
      github:
        secret: "secret101"
    - type: "Generic"
      generic:
        secret: "secret101"
    -
      type: "ImageChange"
  source: <b class="conum">(4)</b>
    git:
      uri: "https://github.com/openshift/ruby-hello-world"
  strategy: <b class="conum">(5)</b>
    sourceStrategy:
      from:
        kind: "ImageStreamTag"
        name: "ruby-20-centos7:latest"
  output: <b class="conum">(6)</b>
    to:
      kind: "ImageStreamTag"
      name: "origin-ruby-sample:latest"
  postCommit: <b class="conum">(7)</b>
      script: "bundle exec rake test"</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This specification creates a new <code>BuildConfig</code> named
<strong>ruby-sample-build</strong>.</p>
</li>
<li>
<p>The <code>runPolicy</code> field controls whether builds created from this build
configuration can be run simultaneously. The default value is <code>Serial</code>, which
means new builds run sequentially, not simultaneously.</p>
</li>
<li>
<p>You can specify a list of triggers, which cause a new build to be created.</p>
</li>
<li>
<p>The <code>source</code> section defines the source of the build. The source type
determines the primary source of input, and can be either <code>Git</code>, to point to
a code repository location,
<code>Dockerfile</code>, to build from an inline Dockerfile,
or <code>Binary</code>, to accept binary payloads. It is possible to have multiple
sources at once. Refer to the documentation for each source type for details.</p>
</li>
<li>
<p>The <code>strategy</code> section describes the build strategy used to execute the
build. You can specify a <code>Source</code>
, <code>Docker</code>, or <code>Custom</code>
strategy here. This example uses the <code>ruby-20-centos7</code> container image
that Source-To-Image uses for the application build.</p>
</li>
<li>
<p>After the container image is successfully built, it is pushed into the
repository described in the <code>output</code> section.</p>
</li>
<li>
<p>The <code>postCommit</code> section defines an optional build hook.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-build-inputs">Creating build inputs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the following sections for an overview of build inputs, instructions on how
to use inputs to provide source content for builds to operate on, and how to use
build environments and create secrets.</p>
</div>
<div class="sect2">
<h3 id="define-build-inputs-creating-build-inputs">Build inputs</h3>
<div class="paragraph">
<p>A <em>build input</em> provides source content for builds to operate on. You can use the
following <em>build inputs</em> to provide sources in OpenShift Enterprise, listed in order
of precedence:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inline Dockerfile definitions</p>
</li>
<li>
<p>Content extracted from existing images</p>
</li>
<li>
<p>Git repositories</p>
</li>
<li>
<p>Binary (Local) inputs</p>
</li>
<li>
<p>Input secrets</p>
</li>
<li>
<p>External artifacts</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can combine multiple inputs in a single build.
However, as the inline
Dockerfile takes precedence, it can overwrite any other file named Dockerfile
provided by another input.
Binary (local) input and Git repositories are mutually
exclusive inputs.</p>
</div>
<div class="paragraph">
<p>You can use input secrets when you do not want certain resources or credentials
used during a build to be available in the final application image produced by
the build, or want to consume a value that is defined in a Secret resource.
External artifacts can be used to pull in additional files that are not available
as one of the other build input types.</p>
</div>
<div class="paragraph">
<p>When you run a build:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A working directory is constructed and all input content is placed in the
working directory. For example, the input Git repository is cloned into the
working directory, and files specified from input images are copied into the
working directory using the target path.</p>
</li>
<li>
<p>The build process changes directories into the <code>contextDir</code>, if one is
defined.</p>
</li>
<li>
<p>The inline Dockerfile, if any, is written to the current directory.</p>
</li>
<li>
<p>The content from the current directory is provided to the build process
for reference by the
Dockerfile, custom builder logic, or
<strong><em>assemble</em></strong> script. This means any input content that resides outside the
<code>contextDir</code> will be ignored by the build.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following example of a source definition includes multiple input types and
an explanation of how they are combined. For more details on how each input type
is defined, see the specific sections for each input type.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">source:
  git:
    uri: https://github.com/openshift/ruby-hello-world.git <b class="conum">(1)</b>
  images:
  - from:
      kind: ImageStreamTag
      name: myinputimage:latest
      namespace: mynamespace
    paths:
    - destinationDir: app/dir/injected/dir <b class="conum">(2)</b>
      sourcePath: /usr/lib/somefile.jar
  contextDir: "app/dir" <b class="conum">(3)</b>
  dockerfile: "FROM centos:7\nRUN yum install -y httpd" <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The repository to be cloned into the working directory for the build.</p>
</li>
<li>
<p><strong><em>/usr/lib/somefile.jar</em></strong> from <code>myinputimage</code> will be stored in <strong><em>&lt;workingdir&gt;/app/dir/injected/dir</em></strong>.</p>
</li>
<li>
<p>The working directory for the build will become <strong><em>&lt;original_workingdir&gt;/app/dir</em></strong>.</p>
</li>
<li>
<p>A Dockerfile with this content will be created in <strong><em>&lt;original_workingdir&gt;/app/dir</em></strong>, overwriting any existing file with that name.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="dockerfile-source-creating-build-inputs">Dockerfile source</h3>
<div class="paragraph">
<p>When you supply a <code>dockerfile</code> value, the content of this field
is written to disk as a file named <strong><em>Dockerfile</em></strong>. This is
done after other input sources are processed, so if the input
source repository contains a <strong><em>Dockerfile</em></strong> in the root directory,
it will be overwritten with this content.</p>
</div>
<div class="paragraph">
<p>The source definition is part of the <code>spec</code> section in the <code>BuildConfig</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">source:
  dockerfile: "FROM centos:7\nRUN yum install -y httpd" <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>dockerfile</code> field contains an inline Dockerfile that will be built.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>The typical use for this field is to provide a <code>Dockerfile</code> to a
Docker strategy build.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="image-source-creating-build-inputs">Image source</h3>
<div class="paragraph">
<p>You can add additional files to the build process with images. Input images are
referenced in the same way the <code>From</code> and <code>To</code> image targets are defined. This
means both container images and imagestream tags can be referenced. In
conjunction with the image, you must provide one or more path pairs to indicate
the path of the files or directories to copy the image and the destination to
place them in the build context.</p>
</div>
<div class="paragraph">
<p>The source path can be any absolute path within the image specified. The
destination must be a relative directory path. At build time, the image will be
loaded and the indicated files and directories will be copied into the context
directory of the build process. This is the same directory into which the source
repository content (if any) is cloned. If the source path ends in <strong><em>/.</em></strong> then
the content of the directory will be copied, but the directory itself will not
be created at the destination.</p>
</div>
<div class="paragraph">
<p>Image inputs are specified in the <code>source</code> definition of the <code>BuildConfig</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">source:
  git:
    uri: https://github.com/openshift/ruby-hello-world.git
  images: <b class="conum">(1)</b>
  - from: <b class="conum">(2)</b>
      kind: ImageStreamTag
      name: myinputimage:latest
      namespace: mynamespace
    paths: <b class="conum">(3)</b>
    - destinationDir: injected/dir <b class="conum">(4)</b>
      sourcePath: /usr/lib/somefile.jar <b class="conum">(5)</b>
  - from:
      kind: ImageStreamTag
      name: myotherinputimage:latest
      namespace: myothernamespace
    pullSecret: mysecret <b class="conum">(6)</b>
    paths:
    - destinationDir: injected/dir
      sourcePath: /usr/lib/somefile.jar</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>An array of one or more input images and files.</p>
</li>
<li>
<p>A reference to the image containing the files to be copied.</p>
</li>
<li>
<p>An array of source/destination paths.</p>
</li>
<li>
<p>The directory relative to the build root where the build process can access the file.</p>
</li>
<li>
<p>The location of the file to be copied out of the referenced image.</p>
</li>
<li>
<p>An optional secret provided if credentials are needed to access the input image.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This feature is not supported for builds using the Custom Strategy.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>Custom Strategy</p>
</li>
<li>
<p>ImageStream Tags</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="source-code-creating-build-inputs">Git source</h3>
<div class="paragraph">
<p>When specified, source code is fetched from the supplied location.</p>
</div>
<div class="paragraph">
<p>If you supply an inline Dockerfile, it overwrites the <strong><em>Dockerfile</em></strong>
(if any) in the <code>contextDir</code> of the Git repository.</p>
</div>
<div class="paragraph">
<p>The source definition is part of the <code>spec</code> section in the <code>BuildConfig</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">source:
  git: <b class="conum">(1)</b>
    uri: "https://github.com/openshift/ruby-hello-world"
    ref: "master"
  contextDir: "app/dir" <b class="conum">(2)</b>
  dockerfile: "FROM openshift/ruby-22-centos7\nUSER example" <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>git</code> field contains the URI to the remote Git repository of the
source code. Optionally, specify the <code>ref</code> field to check out a specific Git
reference. A valid <code>ref</code> can be a SHA1 tag or a branch name.</p>
</li>
<li>
<p>The <code>contextDir</code> field allows you to override the default location inside
the source code repository where the build looks for the application source
code. If your application exists inside a sub-directory, you can override the
default location (the root folder) using this field.</p>
</li>
<li>
<p>If the optional <code>dockerfile</code> field is provided, it should be a string
containing a Dockerfile that overwrites any Dockerfile that may exist in the
source repository.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If the <code>ref</code> field denotes a pull request, the system will use a <code>git fetch</code> operation
and then checkout <code>FETCH_HEAD</code>.</p>
</div>
<div class="paragraph">
<p>When no <code>ref</code> value is provided, OpenShift Enterprise performs a shallow clone
(<code>--depth=1</code>).  In this case, only the files associated with the most recent
commit on the default branch (typically <code>master</code>) are downloaded.  This results
in repositories downloading faster, but without the full commit history.  To
perform a full <code>git clone</code> of the default branch of a specified repository, set
<code>ref</code> to the name of the default branch (for example <code>master</code>).</p>
</div>
<div class="sect3">
<h4 id="build-using-proxy-git-cloning-creating-build-inputs">Using a Proxy</h4>
<div class="paragraph">
<p>If your Git repository can only be accessed using a proxy, you can define the
proxy to use in the <code>source</code> section of the <code>BuildConfig</code>. You can configure
both a HTTP and HTTPS proxy to use. Both fields are optional. Domains for which
no proxying should be performed can also be specified in the <strong>NoProxy</strong> field.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Your source URI must use the HTTP or HTTPS protocol for this to work.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">source:
  git:
    uri: "https://github.com/openshift/ruby-hello-world"
    httpProxy: http://proxy.example.com
    httpsProxy: https://proxy.example.com
    noProxy: somedomain.com, otherdomain.com</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>For Pipeline strategy builds, given the current restrictions with the Git
plug-in for Jenkins, any Git operations through the Git plug-in will not
leverage the HTTP or HTTPS proxy defined in the <code>BuildConfig</code>. The Git plug-in
only will use the proxy configured in the Jenkins UI at the Plugin Manager
panel. This proxy will then be used for all git interactions within Jenkins,
across all jobs.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>You can find instructions on how to configure proxies through
the Jenkins UI at
<a href="https://wiki.jenkins-ci.org/display/JENKINS/JenkinsBehindProxy">JenkinsBehindProxy</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="adding-source-clone-secrets-creating-build-inputs">Adding Source Clone Secrets</h4>
<div class="paragraph">
<p>Builder Pods require access to any Git repositories defined as source for a
build. Source clone secrets are used to provide the builder Pod with access it
would not normally have access to, such as private repositories or repositories
with self-signed or untrusted SSL certificates.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The following source clone secret configurations are supported.</p>
<div class="ulist">
<ul>
<li>
<p>.gitconfig File</p>
</li>
<li>
<p>Basic Authentication</p>
</li>
<li>
<p>SSH Key Authentication</p>
</li>
<li>
<p>Trusted Certificate Authorities</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can also use combinations of these configurations
to meet your specific needs.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Builds are run with the <strong>builder</strong> service account, which must have access to any
source clone secrets used.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Run the following command to grant access:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc secrets link builder mysecret</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Limiting secrets to only the service accounts that reference them is disabled by
default. This means that if <code>serviceAccountConfig.limitSecretReferences</code> is set
to <code>false</code> (the default setting) in the master configuration file, linking
secrets to a service is not required.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="build-auto-add-source-clone-secrets-creating-build-inputs">Automatically Adding a Source Clone Secret to a Build Configuration</h5>
<div class="paragraph">
<p>When a <code>BuildConfig</code> is created, OpenShift Enterprise can automatically populate its
source clone secret reference. This behavior allows the resulting <code>Builds</code> to
automatically use the credentials stored in the referenced <code>Secret</code> to
authenticate to a remote Git repository, without requiring further
configuration.</p>
</div>
<div class="paragraph">
<p>To use this functionality, a <code>Secret</code> containing the Git repository credentials
must exist in the namespace in which the <code>BuildConfig</code> is later created.
This <code>Secret</code> must additionally include one or more annotations prefixed with
<code>build.openshift.io/source-secret-match-uri-</code>. The value of each of these
annotations is a URI pattern, defined as follows. When a <code>BuildConfig</code> is created
without a source clone secret reference and its Git source URI matches a URI
pattern in a <code>Secret</code> annotation, OpenShift Enterprise will automatically insert a
reference to that <code>Secret</code> in the <code>BuildConfig</code>.</p>
</div>
<div class="paragraph">
<div class="title">Prerequisites</div>
<p>A URI pattern must consist of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a valid scheme (<code>*://</code>, <code>git://</code>, <code>http://</code>, <code>https://</code> or <code>ssh://</code>).</p>
</li>
<li>
<p>a host (<code>*</code> or a valid hostname or IP address optionally preceded by <code>*.</code>).</p>
</li>
<li>
<p>a path (<code>/*</code> or <code>/</code> followed by any characters optionally including <code>*</code>
characters).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In all of the above, a <code>*</code> character is interpreted as a wildcard.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>URI patterns must match Git source URIs which are conformant to
<a href="https://www.ietf.org/rfc/rfc3986.txt">RFC3986</a>. Do not include a
username (or password) component in a URI pattern.</p>
</div>
<div class="paragraph">
<p>For example, if you use
<code>ssh://git@bitbucket.atlassian.com:7999/ATLASSIAN/jira.git</code> for a git repository
URL, the source secret must be specified as
<code>ssh://bitbucket.atlassian.com:7999/*</code> (and not
<code>ssh://git@bitbucket.atlassian.com:7999/*</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc annotate secret mysecret \
    'build.openshift.io/source-secret-match-uri-1=ssh://bitbucket.atlassian.com:7999/*'</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>If multiple <code>Secrets</code> match the Git URI of a particular <code>BuildConfig</code>,
OpenShift Enterprise will select the secret with the longest match. This allows for
basic overriding, as in the following example.</p>
</div>
<div class="paragraph">
<p>The following fragment shows two partial source clone secrets, the first
matching any server in the domain <code>mycorp.com</code> accessed by HTTPS, and the second
overriding access to servers <code>mydev1.mycorp.com</code> and <code>mydev2.mycorp.com</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: Secret
apiVersion: v1
metadata:
  name: matches-all-corporate-servers-https-only
  annotations:
    build.openshift.io/source-secret-match-uri-1: https://*.mycorp.com/*
data:
  ...

kind: Secret
apiVersion: v1
metadata:
  name: override-for-my-dev-servers-https-only
  annotations:
    build.openshift.io/source-secret-match-uri-1: https://mydev1.mycorp.com/*
    build.openshift.io/source-secret-match-uri-2: https://mydev2.mycorp.com/*
data:
  ...</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Add a <code>build.openshift.io/source-secret-match-uri-</code> annotation to a pre-existing
secret using:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc annotate secret mysecret \
    'build.openshift.io/source-secret-match-uri-1=https://*.mycorp.com/*'</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="manually-add-source-clone-secrets-creating-build-inputs">Manually Adding a Source Clone Secrets</h5>
<div class="paragraph">
<p>Source clone secrets can be added manually to a build configuration by adding a
<code>sourceSecret</code> field to the <code>source</code> section inside the <code>BuildConfig</code> and
setting it to the name of the <code>secret</code> that you created (<code>basicsecret</code>, in this
example).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: "v1"
kind: "BuildConfig"
metadata:
  name: "sample-build"
spec:
  output:
    to:
      kind: "ImageStreamTag"
      name: "sample-image:latest"
  source:
    git:
      uri: "https://github.com/user/app.git"
    sourceSecret:
      name: "basicsecret"
  strategy:
    sourceStrategy:
      from:
        kind: "ImageStreamTag"
        name: "python-33-centos7:latest"</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>You can also use the <code>oc set build-secret</code> command to set the source clone
secret on an existing build configuration.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To set the source clone secret on an existing build configuration, run:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set build-secret --source bc/sample-build basicsecret</pre>
</div>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>Defining Secrets in the <code>BuildConfig</code> provides more information on this topic.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="source-secrets-gitconfig-file-creating-build-inputs">Creating a secret from a .gitconfig file</h5>
<div class="paragraph">
<p>If the cloning of your application is dependent on a <strong><em>.gitconfig</em></strong> file,
then you can create a secret that contains it. Add
it to the builder service account and then your <code>BuildConfig</code>.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>To create a secret from a <strong><em>.gitconfig</em></strong> file:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create secret generic &lt;secret_name&gt; --from-file=&lt;path/to/.gitconfig&gt;</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>SSL verification can be turned off if <code>sslVerify=false</code> is set for the <code>http</code>
section in your <strong><em>.gitconfig</em></strong> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">[http]
        sslVerify=false</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="source-secrets-gitconfig-file-for-secured-git-creating-build-inputs">Creating a secret from a .gitconfig file for secured Git</h5>
<div class="paragraph">
<p>If your Git server is secured with two-way SSL and user name with password,
you must add the certificate files to your source build and add references to
the certificate files in the <strong><em>.gitconfig</em></strong> file.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Git credentials</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Add the certificate files to your source build and add references to
the certificate files in the <strong><em>.gitconfig</em></strong> file.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the <strong><em>client.crt</em></strong>, <strong><em>cacert.crt</em></strong>, and <strong><em>client.key</em></strong> files to the
<strong><em>/var/run/secrets/openshift.io/source/</em></strong> folder in the application
source code.</p>
</li>
<li>
<p>In the <strong><em>.gitconfig</em></strong> file for the server, add the <code>[http]</code> section
shown in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cat .gitconfig
[user]
        name = &lt;name&gt;
        email = &lt;email&gt;
[http]
        sslVerify = false
        sslCert = /var/run/secrets/openshift.io/source/client.crt
        sslKey = /var/run/secrets/openshift.io/source/client.key
        sslCaInfo = /var/run/secrets/openshift.io/source/cacert.crt</pre>
</div>
</div>
</li>
<li>
<p>Create the secret:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create secret generic &lt;secret_name&gt; \
--from-literal=username=&lt;user_name&gt; \ <b class="conum">(1)</b>
--from-literal=password=&lt;password&gt; \ <b class="conum">(2)</b>
--from-file=.gitconfig=.gitconfig \
--from-file=client.crt=/var/run/secrets/openshift.io/source/client.crt \
--from-file=cacert.crt=/var/run/secrets/openshift.io/source/cacert.crt \
--from-file=client.key=/var/run/secrets/openshift.io/source/client.key</pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The user&#8217;s Git user name.</p>
</li>
<li>
<p>The password for this user.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>To avoid having to enter your password again, be sure to specify the S2I image in
your builds. However, if you cannot clone the repository, you still need to
specify your user name and password to promote the build.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><strong><em>/var/run/secrets/openshift.io/source/</em></strong> folder in the application
source code.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="source-secrets-basic-auth-creating-build-inputs">Creating a secret from source code basic authentication</h5>
<div class="paragraph">
<p>Basic authentication requires either a combination of <code>--username</code> and
<code>--password</code>, or a <code>token</code> to authenticate against the SCM server.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>User name and password to access the private repository.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create the <code>secret</code> first before using the user name and password to access the
private repository:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create secret generic &lt;secret_name&gt; \
    --from-literal=username=&lt;user_name&gt; \
    --from-literal=password=&lt;password&gt; \
    --type=kubernetes.io/basic-auth</pre>
</div>
</div>
</li>
<li>
<p>Create a basic authentication secret with a token:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create secret generic &lt;secret_name&gt; \
    --from-literal=password=&lt;token&gt; \
    --type=kubernetes.io/basic-auth</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="source-secrets-ssh-key-auth-creating-build-inputs">Creating a secret from source code SSH key authentication</h5>
<div class="paragraph">
<p>SSH key based authentication requires a private SSH key.</p>
</div>
<div class="paragraph">
<p>The repository keys are usually located in the <strong><em>$HOME/.ssh/</em></strong> directory, and
are named <code>id_dsa.pub</code>, <code>id_ecdsa.pub</code>, <code>id_ed25519.pub</code>, or <code>id_rsa.pub</code> by
default.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Generate SSH key credentials:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ ssh-keygen -t rsa -C "your_email@example.com"</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Creating a passphrase for the SSH key  prevents OpenShift Enterprise from building.
When prompted for a passphrase, leave it blank.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Two files are created: the public key and a corresponding private key (one of
<code>id_dsa</code>, <code>id_ecdsa</code>, <code>id_ed25519</code>, or <code>id_rsa</code>). With both of these in place,
consult your source control management (SCM) system&#8217;s manual on how to upload
the public key. The private key is used to access your private repository.</p>
</div>
</li>
<li>
<p>Before using the SSH key to access the private repository, create the secret:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create secret generic &lt;secret_name&gt; \
    --from-file=ssh-privatekey=&lt;path/to/ssh/private/key&gt; \
    --type=kubernetes.io/ssh-auth</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="source-secrets-trusted-ca-creating-build-inputs">Creating a secret from source code trusted certificate authorities</h5>
<div class="paragraph">
<p>The set of TLS certificate authorities (CA) that are trusted during a <code>git clone</code>
operation are built into the OpenShift Enterprise infrastructure images. If your Git
server uses a self-signed certificate or one signed by an authority not trusted
by the image, you can create a secret that contains the certificate or disable
TLS verification.</p>
</div>
<div class="paragraph">
<p>If you create a secret for the <code>CA certificate</code>, OpenShift Enterprise uses it to access
your Git server during the <code>git clone</code> operation. Using this method is
significantly more secure than disabling Git&#8217;s SSL verification, which accepts
any TLS certificate that is presented.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create a secret with a CA certificate file.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If your CA uses Intermediate Certificate Authorities, combine the
certificates for all CAs in a <strong><em>ca.crt</em></strong> file. Run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ cat intermediateCA.crt intermediateCA.crt rootCA.crt &gt; ca.crt</pre>
</div>
</div>
</li>
<li>
<p>Create the secret:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create secret generic mycert --from-file=ca.crt=&lt;/path/to/file&gt; <b class="conum">(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>You must use the key name <strong><em>ca.crt</em></strong>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="builds-source-secret-combinations-creating-build-inputs">Source secret combinations</h5>
<div class="paragraph">
<p>You can combine the different methods for creating source clone secrets for your
specific needs.</p>
</div>
<div class="sect5">
<h6 id="builds-source-secret-combinations-ssh-gitconfig-creating-build-inputs">Creating a SSH-based authentication secret with a <strong><em>.gitconfig</em></strong> file</h6>
<div class="paragraph">
<p>You can combine the different methods for creating source clone secrets for your
specific needs, such as a SSH-based authentication secret with a <strong><em>.gitconfig</em></strong> file.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>SSH authentication</p>
</li>
<li>
<p>.gitconfig file</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create a SSH-based authentication secret with a <strong><em>.gitconfig</em></strong> file</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create secret generic &lt;secret_name&gt; \
    --from-file=ssh-privatekey=&lt;path/to/ssh/private/key&gt; \
    --from-file=&lt;path/to/.gitconfig&gt; \
    --type=kubernetes.io/ssh-auth</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="builds-source-secret-combinations-gitconfig-ca-creating-build-inputs">Creating a secret that combines a <strong><em>.gitconfig</em></strong> file and CA certificate</h6>
<div class="paragraph">
<p>You can combine the different methods for creating source clone secrets for your
specific needs, such as a secret that combines a <strong><em>.gitconfig</em></strong> file and CA certificate.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>.gitconfig file</p>
</li>
<li>
<p>CA certificate</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create a secret that combines a <strong><em>.gitconfig</em></strong> file and CA certificate</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create secret generic &lt;secret_name&gt; \
    --from-file=ca.crt=&lt;path/to/certificate&gt; \
    --from-file=&lt;path/to/.gitconfig&gt;</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="builds-source-secret-combinations-basic-auth-ca-creating-build-inputs">Creating a basic authentication secret with a CA certificate</h6>
<div class="paragraph">
<p>You can combine the different methods for creating source clone secrets for your
specific needs, such as a secret that combines a basic authentication and CA certificate.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Basic authentication credentials</p>
</li>
<li>
<p>CA certificate</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create a basic authentication secret with a CA certificate</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create secret generic &lt;secret_name&gt; \
    --from-literal=username=&lt;user_name&gt; \
    --from-literal=password=&lt;password&gt; \
    --from-file=ca-cert=&lt;/path/to/file&gt; \
    --type=kubernetes.io/basic-auth</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="builds-source-secret-combinations-basic-auth-gitconfig-creating-build-inputs">Creating a basic authentication secret with a <strong><em>.gitconfig</em></strong> file</h6>
<div class="paragraph">
<p>You can combine the different methods for creating source clone secrets for your
specific needs, such as a secret that combines a basic authentication and <strong><em>.gitconfig</em></strong> file.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Basic authentication credentials</p>
</li>
<li>
<p><strong><em>.gitconfig</em></strong> file</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create a basic authentication secret with a <strong><em>.gitconfig</em></strong> file</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create secret generic &lt;secret_name&gt; \
    --from-literal=username=&lt;user_name&gt; \
    --from-literal=password=&lt;password&gt; \
    --from-file=&lt;/path/to/.gitconfig&gt; \
    --type=kubernetes.io/basic-auth</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="builds-source-secret-combinations-basic-auth-gitconfig-ca-creating-build-inputs">Creating a basic authentication secret with a <strong><em>.gitconfig</em></strong> file and CA certificate</h6>
<div class="paragraph">
<p>You can combine the different methods for creating source clone secrets for your
specific needs, such as a secret that combines a basic authentication, <strong><em>.gitconfig</em></strong> file,
and CA certificate.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Basic authentication credentials</p>
</li>
<li>
<p><strong><em>.gitconfig</em></strong> file</p>
</li>
<li>
<p>CA certificate</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create a basic authentication secret with a <strong><em>.gitconfig</em></strong> file and CA certificate</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create secret generic &lt;secret_name&gt; \
    --from-literal=username=&lt;user_name&gt; \
    --from-literal=password=&lt;password&gt; \
    --from-file=&lt;/path/to/.gitconfig&gt; \
    --from-file=ca-cert=&lt;/path/to/file&gt; \
    --type=kubernetes.io/basic-auth</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="builds-binary-source-creating-build-inputs">Binary (local) source</h3>
<div class="paragraph">
<p>Streaming content from a local file system to the builder is
called a <code>Binary</code> type build. The corresponding value of
<code>BuildConfig.spec.source.type</code> is <code>Binary</code> for such builds.</p>
</div>
<div class="paragraph">
<p>This source type is unique in that it is leveraged solely based on your use of
the <code>oc start-build</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Binary type builds require content to be streamed from the local file system, so
automatically triggering a binary type build (e.g. via an image change trigger)
is not possible, because the binary files cannot be provided. Similarly, you
cannot launch binary type builds from the web console.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To utilize binary builds, invoke <code>oc start-build</code> with one of these options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--from-file</code>: The contents of the file you specify are sent as a binary stream
to the builder. You can also specify a URL to a file. Then, the builder stores
the data in a file with the same name at the top of the build context.</p>
</li>
<li>
<p><code>--from-dir</code> and <code>--from-repo</code>: The contents are archived and sent as a binary
stream to the builder. Then, the builder extracts the contents of the archive
within the build context directory. With <code>--from-dir</code>, you can also specify
a URL to an archive, which will be extracted.</p>
</li>
<li>
<p><code>--from-archive</code>: The archive you specify is sent to the builder, where it is
extracted within the build context directory. This option
behaves the same as <code>--from-dir</code>; an archive is created on your host first,
whenever the argument to these options is a directory.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In each of the previously listed cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If your <code>BuildConfig</code> already has a <code>Binary</code> source type defined, it will
effectively be ignored and replaced by what the client sends.</p>
</li>
<li>
<p>If your <code>BuildConfig</code> has a <code>Git</code> source type defined, it is dynamically
disabled, since <code>Binary</code> and <code>Git</code> are mutually exclusive, and the data in
the binary stream provided to the builder takes precedence.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Instead of a file name, you can pass a URL with HTTP or HTTPS schema to
<code>--from-file</code> and <code>--from-archive</code>. When using  <code>--from-file</code> with a URL, the
name of the file in the builder image is determined by the <code>Content-Disposition</code>
header sent by the web server, or the last component of the URL path if the
header is not present. No form of authentication is supported and it is not
possible to use custom TLS certificate or disable certificate validation.</p>
</div>
<div class="paragraph">
<p>When using <code>oc new-build --binary=true</code>, the command ensures that the
restrictions associated with binary builds are enforced. The resulting
<code>BuildConfig</code> will have a source type of <code>Binary</code>, meaning that the only
valid way to run a build for this <code>BuildConfig</code> is to use <code>oc
start-build</code> with one of the <code>--from</code> options to provide the requisite binary
data.</p>
</div>
<div class="paragraph">
<p>The <code>dockerfile</code> and <code>contextDir</code> source options have
special meaning with binary builds.</p>
</div>
<div class="paragraph">
<p><code>dockerfile</code> can be used with any binary build source. If <code>dockerfile</code> is
used and the binary stream is an archive, its contents serve as a replacement
Dockerfile to any Dockerfile in the archive. If <code>dockerfile</code> is used with the
<code>--from-file</code> argument, and the file argument is named <code>dockerfile</code>, the value
from <code>dockerfile</code> replaces the value from the binary stream.</p>
</div>
<div class="paragraph">
<p>In the case of the binary stream encapsulating extracted archive content, the
value of the <code>contextDir</code> field is interpreted as a subdirectory within the
archive, and, if valid, the builder changes into that subdirectory before
executing the build.</p>
</div>
</div>
<div class="sect2">
<h3 id="builds-input-secrets-configmaps-creating-build-inputs">Input Secrets and ConfigMaps</h3>
<div class="paragraph">
<p>In some scenarios, build operations require credentials or other configuration
data to access dependent resources, but it is undesirable for that information
to be placed in source control. You can define <em>input secrets</em> and <em>input
ConfigMaps</em> for this purpose.</p>
</div>
<div class="paragraph">
<p>For example, when building a Java application with Maven, you can set up a
private mirror of Maven Central or JCenter that is accessed by private keys.
In order to download libraries from that private mirror, you have to supply the
following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A  <strong><em>settings.xml</em></strong> file configured with the mirror&#8217;s URL and connection
settings.</p>
</li>
<li>
<p>A private key referenced in the settings file, such as <strong><em>~/.ssh/id_rsa</em></strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For security reasons, you do not want to expose your credentials in the
application image.</p>
</div>
<div class="paragraph">
<p>This example describes a Java application, but you can use the same approach
for adding SSL certificates into the <strong><em>/etc/ssl/certs</em></strong> directory, API keys or
tokens, license files, and more.</p>
</div>
<div class="sect3">
<h4 id="builds-adding-input-secrets-configmaps-creating-build-inputs">Adding input secrets and ConfigMaps</h4>
<div class="paragraph">
<p>In some scenarios, build operations require credentials or other configuration
data to access dependent resources, but it is undesirable for that information
to be placed in source control. You can define <em>input secrets</em> and <em>input
ConfigMaps</em> for this purpose.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To add an input secret and/or ConfigMap to an existing <code>BuildConfig</code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the ConfigMap, if it does not exist:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create configmap settings-mvn \
    --from-file=settings.xml=&lt;path/to/settings.xml&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>This creates a new ConfigMap named <strong><em>settings-mvn</em></strong>, which contains the
plain text content of the <strong><em>settings.xml</em></strong> file.</p>
</div>
</li>
<li>
<p>Create the secret, if it does not exist:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create secret generic secret-mvn \
    --from-file=id_rsa=&lt;path/to/.ssh/id_rsa&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>This creates a new secret named <strong><em>secret-mvn</em></strong>, which contains the base64
encoded content of the <strong><em>id_rsa</em></strong> private key.</p>
</div>
</li>
<li>
<p>Add the ConfigMap and secret to the <code>source</code> section in the existing
<code>BuildConfig</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">source:
  git:
    uri: https://github.com/wildfly/quickstart.git
  contextDir: helloworld
  configMaps:
    - configMap:
        name: settings-mvn
  secrets:
    - secret:
        name: secret-mvn</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>To include the secret and ConfigMap in a new <code>BuildConfig</code>, run the following
command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc new-build \
    openshift/wildfly-101-centos7~https://github.com/wildfly/quickstart.git \
    --context-dir helloworld --build-secret “secret-mvn” \
    --build-config-map "settings-mvn"</pre>
</div>
</div>
<div class="paragraph">
<p>During the build, the <strong><em>settings.xml</em></strong> and <strong><em>id_rsa</em></strong> files are copied into the
directory where the source code is located. In OpenShift Enterprise S2I builder
images, this is the image working directory, which is set using the <code>WORKDIR</code>
instruction in the <strong><em>Dockerfile</em></strong>. If you want to specify another directory,
add a <code>destinationDir</code> to the definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">source:
  git:
    uri: https://github.com/wildfly/quickstart.git
  contextDir: helloworld
  configMaps:
    - configMap:
        name: settings-mvn
      destinationDir: ".m2"
  secrets:
    - secret:
        name: secret-mvn
      destinationDir: ".ssh"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify the destination directory when creating a new
<code>BuildConfig</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc new-build \
    openshift/wildfly-101-centos7~https://github.com/wildfly/quickstart.git \
    --context-dir helloworld --build-secret “secret-mvn:.ssh” \
    --build-config-map "settings-mvn:.m2"</pre>
</div>
</div>
<div class="paragraph">
<p>In both cases, the <strong><em>settings.xml</em></strong> file is added to the <strong><em>./.m2</em></strong> directory of the
build environment, and the <strong><em>id_rsa</em></strong> key is added to the <strong><em>./.ssh</em></strong> directory.</p>
</div>
</div>
<div class="sect3">
<h4 id="builds-source-to-image-creating-build-inputs">Source-to-image strategy</h4>
<div class="paragraph">
<p>When using a <code>Source</code> strategy, all defined input secrets are copied to their
respective <code>destinationDir</code>. If you left <code>destinationDir</code> empty, then the
secrets are placed in the working directory of the builder image.</p>
</div>
<div class="paragraph">
<p>The same rule is used when a <code>destinationDir</code> is a relative path; the secrets
are placed in the paths that are relative to the image&#8217;s working directory.
The final directory in the <code>destinationDir</code> path is created if it does not exist in the builder image.
All preceding directories in the <code>destinationDir</code> must exist, or an error will occur.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Input secrets are added as world-writable (have <code>0666</code> permissions) and will
be truncated to size zero after executing the <strong><em>assemble</em></strong> script. This means
that the secret files will exist in the resulting image, but they will be empty
for security reasons.</p>
</div>
<div class="paragraph">
<p>Input ConfigMaps are not truncated after the <strong><em>assemble</em></strong> script completes.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="builds-docker-strategy-creating-build-inputs">Docker strategy</h4>
<div class="paragraph">
<p>When using a <code>Docker</code> strategy, you can add all defined input secrets into your
container image using the
<a href="https://docs.docker.com/engine/reference/builder/#add"><code>ADD</code></a> and
<a href="https://docs.docker.com/engine/reference/builder/#copy"><code>COPY</code> instructions</a> in
your <strong><em>Dockerfile</em></strong>.</p>
</div>
<div class="paragraph">
<p>If you do not specify the <code>destinationDir</code> for a secret, then the files will be
copied into the same directory in which the <strong><em>Dockerfile</em></strong> is located. If you
specify a relative path as <code>destinationDir</code>, then the secrets will be copied
into that directory, relative to your <strong><em>Dockerfile</em></strong> location. This makes the
secret files available to the Docker build operation as part of the context
directory used during the build.</p>
</div>
<div class="listingblock">
<div class="title">Example of a Dockerfile referencing secret and ConfigMap data</div>
<div class="content">
<pre class="nowrap">FROM centos/ruby-22-centos7

USER root
COPY ./secret-dir /secrets
COPY ./config /

# Create a shell script that will output secrets and ConfigMaps when the image is run
RUN echo '#!/bin/sh' &gt; /input_report.sh
RUN echo '(test -f /secrets/secret1 &amp;&amp; echo -n "secret1=" &amp;&amp; cat /secrets/secret1)' &gt;&gt; /input_report.sh
RUN echo '(test -f /config &amp;&amp; echo -n "relative-configMap=" &amp;&amp; cat /config)' &gt;&gt; /input_report.sh
RUN chmod 755 /input_report.sh

CMD ["/bin/sh", "-c", "/input_report.sh"]</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Users should normally remove their input secrets from the final application image
so that the secrets are not present in the container running from that image.
However, the secrets will still exist in the image itself in the layer where
they were added. This removal should be part of the <strong><em>Dockerfile</em></strong> itself.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="builds-custom-strategy-creating-build-inputs">Custom strategy</h4>
<div class="paragraph">
<p>When using a <code>Custom</code> strategy, all the defined input secrets and ConfigMaps
are available inside the builder container in the <strong><em>/var/run/secrets/openshift.io/build</em></strong>
directory. The custom build image is responsible for using these secrets
and ConfigMaps appropriately. The <code>Custom</code> strategy also allows secrets to be
defined as described in Custom Strategy Options.</p>
</div>
<div class="paragraph">
<p>There is no technical difference between existing strategy secrets and the input
secrets. However, your builder image might distinguish between them and use them
differently, based on your build use case.</p>
</div>
<div class="paragraph">
<p>The input secrets are always mounted into the
<strong><em>/var/run/secrets/openshift.io/build</em></strong> directory or your builder can parse the
<code>$BUILD</code> environment variable, which includes the full build object.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="builds-using-external-artifacts-creating-build-inputs">External artifacts</h3>
<div class="paragraph">
<p>It is not recommended to store binary files in a source repository. Therefore,
you may find it necessary to define a build which pulls additional files (such
as Java <strong><em>.jar</em></strong> dependencies) during the build process. How this is done
depends on the build strategy you are using.</p>
</div>
<div class="paragraph">
<p>For a <code>Source</code> build strategy, you must put appropriate shell commands into
the <strong><em>assemble</em></strong> script:</p>
</div>
<div class="listingblock">
<div class="title"><strong><em>.s2i/bin/assemble</em></strong> File</div>
<div class="content">
<pre class="nowrap">#!/bin/sh
APP_VERSION=1.0
wget http://repository.example.com/app/app-$APP_VERSION.jar -O app.jar</pre>
</div>
</div>
<div class="listingblock">
<div class="title"><strong><em>.s2i/bin/run</em></strong> File</div>
<div class="content">
<pre class="nowrap">#!/bin/sh
exec java -jar app.jar</pre>
</div>
</div>
<div class="paragraph">
<p>For a <code>Docker</code> build strategy, you must modify the <strong><em>Dockerfile</em></strong> and invoke
shell commands with the
<a href="https://docs.docker.com/engine/reference/builder/#run"><code>RUN</code> instruction</a>:</p>
</div>
<div class="listingblock">
<div class="title">Excerpt of <strong><em>Dockerfile</em></strong></div>
<div class="content">
<pre class="nowrap">FROM jboss/base-jdk:8

ENV APP_VERSION 1.0
RUN wget http://repository.example.com/app/app-$APP_VERSION.jar -O app.jar

EXPOSE 8080
CMD [ "java", "-jar", "app.jar" ]</pre>
</div>
</div>
<div class="paragraph">
<p>In practice, you may want to use an environment variable for the file location
so that the specific file to be downloaded can be customized using an
environment variable defined on the <code>BuildConfig</code>, rather than updating the
<strong><em>Dockerfile</em></strong> or
<strong><em>assemble</em></strong> script.</p>
</div>
<div class="paragraph">
<p>You can choose between different methods of defining environment variables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using the <strong><em>.s2i/environment</em></strong> file] (only for a Source build strategy)</p>
</li>
<li>
<p>Setting in <code>BuildConfig</code></p>
</li>
<li>
<p>Providing explicitly using <code>oc start-build --env</code> (only for builds that are triggered
manually)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="builds-docker-credentials-private-registries-creating-build-inputs">Using Docker credentials for private registries</h3>
<div class="paragraph">
<p>You can supply builds with a <strong><em>.docker/config.json</em></strong> file with valid credentials
for private container registries. This allows you to push the output image into a
private container image registry or pull a builder image from the private container image registry
that requires authentication.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>For the OpenShift Enterprise container image registry, this is not required because secrets
are generated automatically for you by OpenShift Enterprise.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <strong><em>.docker/config.json</em></strong> file is found in your home directory by default and
has the following format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">auths:
  https://index.docker.io/v1/: <b class="conum">(1)</b>
    auth: "YWRfbGzhcGU6R2labnRib21ifTE=" <b class="conum">(2)</b>
    email: "user@example.com" <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>URL of the registry.</p>
</li>
<li>
<p>Encrypted password.</p>
</li>
<li>
<p>Email address for the login.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can define multiple container image registry entries in this file. Alternatively, you
can also add authentication entries to this file by running the <code>docker login</code>
command. The file will be created if it does not exist.</p>
</div>
<div class="paragraph">
<p>Kubernetes provides <code>Secret</code> objects, which can be used to store configuration
and passwords.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><strong><em>.docker/config.json</em></strong> file</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create the secret from your local <strong><em>.docker/config.json</em></strong> file:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create secret generic dockerhub \
    --from-file=.dockerconfigjson=&lt;path/to/.docker/config.json&gt; \
    --type=kubernetes.io/dockerconfigjson</pre>
</div>
</div>
<div class="paragraph">
<p>This generates a JSON specification of the secret named <code>dockerhub</code> and
creates the object.</p>
</div>
</li>
<li>
<p>Once the secret is created, add it to the builder service account. Each build is
run with the <code>builder</code> role, so you must give it access your secret with the
following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc secrets link builder dockerhub</pre>
</div>
</div>
</li>
<li>
<p>Add a <code>pushSecret</code> field into the <code>output</code> section of the <code>BuildConfig</code> and
set it to the name of the <code>secret</code> that you created, which in the above example
is <code>dockerhub</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  output:
    to:
      kind: "DockerImage"
      name: "private.registry.com/org/private-image:latest"
    pushSecret:
      name: "dockerhub"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the <code>oc set build-secret</code> command to set the push secret on
the build configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set build-secret --push bc/sample-build dockerhub</pre>
</div>
</div>
</li>
<li>
<p>Pull the builder container image from a private container image registry by specifying the
<code>pullSecret</code> field, which is part of the build strategy definition:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">strategy:
  sourceStrategy:
    from:
      kind: "DockerImage"
      name: "docker.io/user/private_repository"
    pullSecret:
      name: "dockerhub"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the <code>oc set build-secret</code> command to set the pull secret on
the build configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set build-secret --pull bc/sample-build dockerhub</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This example uses <code>pullSecret</code> in a Source build, but it is also applicable
in Docker and Custom builds.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="builds-build-environment-creating-build-inputs">Build environments</h3>
<div class="paragraph">
<p>As with pod environment variables, build environment variables can be defined in
terms of references to other resources or variables using the Downward API.
There are some exceptions, which are noted.</p>
</div>
<div class="paragraph">
<p>You can also manage environment variables defined in the <code>BuildConfig</code> with the
<code>oc set env</code> command.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Referencing container resources using <code>valueFrom</code> in build environment variables
is not supported as the references are resolved before the container is created.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="builds-using-build-fields-as-environments-creating-build-inputs">Using build fields as environment variables</h4>
<div class="paragraph">
<p>You can inject information about the build object by setting the <code>fieldPath</code>
environment variable source to the <code>JsonPath</code> of the field from which you are
interested in obtaining the value.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Jenkins Pipeline strategy does not support <code>valueFrom</code> syntax for environment
variables.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Set the <code>fieldPath</code> environment variable source to the <code>JsonPath</code> of the field
from which you are interested in obtaining the value:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">env:
  - name: FIELDREF_ENV
    valueFrom:
      fieldRef:
        fieldPath: metadata.name</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="builds-using-secrets-as-environment-variables-creating-build-inputs">Using secrets as environment variables</h4>
<div class="paragraph">
<p>You can make key values from Secrets available as environment variables using
the <code>valueFrom</code> syntax.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>To use a secret as an environment variable, set the <code>valueFrom</code> syntax:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: BuildConfig
metadata:
  name: secret-example-bc
spec:
  strategy:
    sourceStrategy:
      env:
      - name: MYVAL
        valueFrom:
          secretKeyRef:
            key: myval
            name: mysecret</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="builds-secrets-overview-creating-build-inputs">What is a secret?</h3>
<div class="paragraph">
<p>The <code>Secret</code> object type provides a mechanism to hold sensitive information such
as passwords, OpenShift Enterprise client configuration files, <code>dockercfg</code> files,
private source repository credentials, and so on. Secrets decouple sensitive
content from the pods. You can mount secrets into containers using a volume
plug-in or the system can use secrets to perform actions on behalf of a pod.</p>
</div>
<div class="listingblock">
<div class="title">YAML Secret Object Definition</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: test-secret
  namespace: my-namespace
type: Opaque <b class="conum">(1)</b>
data: <b class="conum">(2)</b>
  username: dmFsdWUtMQ0K <b class="conum">(3)</b>
  password: dmFsdWUtMg0KDQo=
stringData: <b class="conum">(4)</b>
  hostname: myapp.mydomain.com <b class="conum">(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Indicates the structure of the secret’s key names and values.</p>
</li>
<li>
<p>The allowable format for the keys in the <code>data</code> field must meet the
guidelines in the <code>DNS_SUBDOMAIN</code> value in the Kubernetes identifiers glossary.</p>
</li>
<li>
<p>The value associated with keys in the <code>data</code> map must be base64 encoded.</p>
</li>
<li>
<p>Entries in the <code>stringData</code> map are converted to base64
and the entry will then be moved to the <code>data</code> map automatically. This field
is write-only; the value will only be returned via the <code>data</code> field.</p>
</li>
<li>
<p>The value associated with keys in the <code>stringData</code> map is made up of
plain text strings.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_properties-of-secrets">Properties of secrets</h4>
<div class="paragraph">
<p>Key properties include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Secret data can be referenced independently from its definition.</p>
</li>
<li>
<p>Secret data volumes are backed by temporary file-storage facilities (tmpfs)
and never come to rest on a node.</p>
</li>
<li>
<p>Secret data can be shared within a namespace.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_types-of-secrets">Types of Secrets</h4>
<div class="paragraph">
<p>The value in the <code>type</code> field indicates the structure of the secret&#8217;s key names
and values. The type can be used to enforce the presence of user names and keys
in the secret object. If you do not want validation, use the <code>opaque</code> type,
which is the default.</p>
</div>
<div class="paragraph">
<p>Specify one of the following types to trigger minimal server-side validation to
ensure the presence of specific key names in the secret data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>kubernetes.io/service-account-token</code>. Uses a service account token.</p>
</li>
<li>
<p><code>kubernetes.io/dockercfg</code>. Uses the <strong><em>.dockercfg</em></strong> file for required Docker
credentials.</p>
</li>
<li>
<p><code>kubernetes.io/dockerconfigjson</code>. Uses the <strong><em>.docker/config.json</em></strong> file
for required Docker credentials.</p>
</li>
<li>
<p><code>kubernetes.io/basic-auth</code>. Use with Basic Authentication.</p>
</li>
<li>
<p><code>kubernetes.io/ssh-auth</code>. Use with SSH Key Authentication.</p>
</li>
<li>
<p><code>kubernetes.io/tls</code>. Use with TLS certificate authorities.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Specify <code>type= Opaque</code> if you do not want validation, which means the secret
does not claim to conform to any convention for key names or values. An <code>opaque</code>
secret, allows for unstructured <code>key:value</code> pairs that can contain arbitrary
values.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can specify other arbitrary types, such as <code>example.com/my-secret-type</code>.
These types are not enforced server-side, but indicate that the creator of the
secret intended to conform to the key/value requirements of that type.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_updates-to-secrets">Updates to secrets</h4>
<div class="paragraph">
<p>When you modify the value of a secret, the value (used by an already running
pod) will not dynamically change. To change a secret, you must delete the
original pod and create a new pod (perhaps with an identical PodSpec).</p>
</div>
<div class="paragraph">
<p>Updating a secret follows the same workflow as deploying a new container image.
You can use the <code>kubectl rolling-update</code> command.</p>
</div>
<div class="paragraph">
<p>The <code>resourceVersion</code> value in a secret is not specified when it is referenced.
Therefore, if a secret is updated at the same time as pods are starting, then
the version of the secret will be used for the pod will not be defined.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Currently, it is not possible to check the resource version of a secret object
that was used when a pod was created. It is planned that pods will report this
information, so that a controller could restart ones using a old
<code>resourceVersion</code>. In the interim, do not update the data of existing secrets,
but create new ones with distinct names.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="builds-creating-secrets-creating-build-inputs">Creating secrets</h4>
<div class="paragraph">
<p>You must create a secret before creating the pods that depend on that secret.</p>
</div>
<div class="paragraph">
<p>When creating secrets:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a secret object with secret data.</p>
</li>
<li>
<p>Update the pod&#8217;s service account to allow the reference to the secret.</p>
</li>
<li>
<p>Create a pod, which consumes the secret as an environment variable or as a file
(using a <code>secret</code> volume).</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Use the create command to create a secret object from a JSON or YAML file:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create -f &lt;filename&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>For example, you can create a secret from your local <strong><em>.docker/config.json</em></strong> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create secret generic dockerhub \
    --from-file=.dockerconfigjson=&lt;path/to/.docker/config.json&gt; \
    --type=kubernetes.io/dockerconfigjson</pre>
</div>
</div>
<div class="paragraph">
<p>This command generates a JSON specification of the secret named <code>dockerhub</code> and
creates the object.</p>
</div>
<div class="listingblock">
<div class="title">YAML Opaque Secret Object Definition</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: mysecret
type: Opaque <b class="conum">(1)</b>
data:
  username: dXNlci1uYW1l
  password: cGFzc3dvcmQ=</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Specifies an <em>opaque</em> secret.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Docker Configuration JSON File Secret Object Definition</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: aregistrykey
  namespace: myapps
type: kubernetes.io/dockerconfigjson <b class="conum">(1)</b>
data:
  .dockerconfigjson:bm5ubm5ubm5ubm5ubm5ubm5ubm5ubmdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2cgYXV0aCBrZXlzCg== <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Specifies that the secret is using a Docker configuration JSON file.</p>
</li>
<li>
<p>The output of a base64-encoded the Docker configuration JSON file</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="builds-using-secrets-creating-build-inputs">Using secrets</h5>
<div class="paragraph">
<p>After creating secrets, you can create a pod to reference your secret, get logs,
and delete the pod.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create the pod to reference your secret:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create -f &lt;your_yaml_file&gt;.yaml</pre>
</div>
</div>
</li>
<li>
<p>Get the logs:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc logs secret-example-pod</pre>
</div>
</div>
</li>
<li>
<p>Delete the pod:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc delete pod secret-example-pod</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>Example YAML files with secret data:</p>
<div class="listingblock">
<div class="title">YAML Secret That Will Create Four Files</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: test-secret
data:
  username: dmFsdWUtMQ0K     <b class="conum">(1)</b>
  password: dmFsdWUtMQ0KDQo= <b class="conum">(2)</b>
stringData:
  hostname: myapp.mydomain.com <b class="conum">(3)</b>
  secret.properties: |-     <b class="conum">(4)</b>
    property1=valueA
    property2=valueB</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>File contains decoded values.</p>
</li>
<li>
<p>File contains decoded values.</p>
</li>
<li>
<p>File contains the provided string.</p>
</li>
<li>
<p>File contains the provided data.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">YAML of a Pod Populating Files in a Volume with Secret Data</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  name: secret-example-pod
spec:
  containers:
    - name: secret-test-container
      image: busybox
      command: [ "/bin/sh", "-c", "cat /etc/secret-volume/*" ]
      volumeMounts:
          # name must match the volume name below
          - name: secret-volume
            mountPath: /etc/secret-volume
            readOnly: true
  volumes:
    - name: secret-volume
      secret:
        secretName: test-secret
  restartPolicy: Never</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">YAML of a Pod Populating Environment Variables with Secret Data</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  name: secret-example-pod
spec:
  containers:
    - name: secret-test-container
      image: busybox
      command: [ "/bin/sh", "-c", "export" ]
      env:
        - name: TEST_SECRET_USERNAME_ENV_VAR
          valueFrom:
            secretKeyRef:
              name: test-secret
              key: username
  restartPolicy: Never</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">YAML of a Build Config Populating Environment Variables with Secret Data</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: BuildConfig
metadata:
  name: secret-example-bc
spec:
  strategy:
    sourceStrategy:
      env:
      - name: TEST_SECRET_USERNAME_ENV_VAR
        valueFrom:
          secretKeyRef:
            name: test-secret
            key: username</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="builds-service-serving-certificate-secrets-creating-build-inputs">Service serving certificate secrets</h3>
<div class="paragraph">
<p>Service serving certificate secrets are intended to support complex middleware
applications that need out-of-the-box certificates. It has the same settings as
the server certificates generated by the administrator tooling for nodes and
masters.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To secure communication to your service, have the cluster generate a signed
serving certificate/key pair into a secret in your namespace.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set the <code>service.alpha.openshift.io/serving-cert-secret-name</code> annotation on your
service with the value set to the name you want to use for your secret.</p>
<div class="paragraph">
<p>Then, your <code>PodSpec</code> can mount that secret. When it is available, your pod will
run. The certificate will be good for the internal service DNS name,
<code>&lt;service.name&gt;.&lt;service.namespace&gt;.svc</code>.</p>
</div>
<div class="paragraph">
<p>The certificate and key are in PEM format, stored in <code>tls.crt</code> and <code>tls.key</code>
respectively. The certificate/key pair is automatically replaced when it gets
close to expiration. View the expiration date in the
<code>service.alpha.openshift.io/expiry</code> annotation on the secret, which is in
RFC3339 format.</p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>In most cases, the service DNS name
<code>&lt;service.name&gt;.&lt;service.namespace&gt;.svc</code> is not externally routable. The
primary use of <code>&lt;service.name&gt;.&lt;service.namespace&gt;.svc</code> is for intracluster or
intraservice communication, and with re-encrypt routes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Other pods can trust cluster-created certificates (which are only signed for
internal DNS names), by using the CA bundle in the
<strong><em>/var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt</em></strong> file that is
automatically mounted in their pod.</p>
</div>
<div class="paragraph">
<p>The signature algorithm for this feature is <code>x509.SHA256WithRSA</code>. To manually
rotate, delete the generated secret. A new certificate is created.</p>
</div>
</div>
<div class="sect2">
<h3 id="builds-secrets-restrictions-creating-build-inputs">Secrets restrictions</h3>
<div class="paragraph">
<p>To use a secret, a pod needs to reference the secret. A secret can be used with
a pod in three ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To populate environment variables for containers.</p>
</li>
<li>
<p>As files in a volume mounted on one or more of its containers.</p>
</li>
<li>
<p>By kubelet when pulling images for the pod.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Volume type secrets write data into the container as a file using the volume
mechanism. <strong>imagePullSecrets</strong> use service accounts for the automatic injection of
the secret into all pods in a namespaces.</p>
</div>
<div class="paragraph">
<p>When a template contains a secret definition, the only way for the template to
use the provided secret is to ensure that the secret volume sources are
validated and that the specified object reference actually points to an object
of type <code>Secret</code>. Therefore, a secret needs to be created before any pods that
depend on it. The most effective way to ensure this is to have it get injected
automatically through the use of a service account.</p>
</div>
<div class="paragraph">
<p>Secret API objects reside in a namespace. They can only be referenced by pods in
that same namespace.</p>
</div>
<div class="paragraph">
<p>Individual secrets are limited to 1MB in size. This is to discourage the
creation of large secrets that would exhaust apiserver and kubelet memory.
However, creation of a number of smaller secrets could also exhaust memory.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="managing-build-output">Managing build output</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the following sections for an overview of and instructions for managing
build output.</p>
</div>
<div class="sect2">
<h3 id="builds-docker-source-build-output-managing-build-output">Build output</h3>
<div class="paragraph">
<p>Builds that use the
<code>Docker</code> or
<code>Source-to-Image (S2I)</code> strategy result in the creation of a
new container image. The image is then pushed to the container image registry
specified in the <code>output</code> section of the <code>Build</code> specification.</p>
</div>
<div class="paragraph">
<p>If the output kind is <code>ImageStreamTag</code>, then the image will be pushed to the
integrated OpenShift Enterprise registry and tagged in the specified imagestream. If
the output is of type <code>DockerImage</code>, then the name of the output reference
will be used as a Docker push specification. The specification may contain a
registry or will default to DockerHub if no registry is specified. If the output
section of the build specification is empty, then the image will not be pushed
at the end of the build.</p>
</div>
<div class="listingblock">
<div class="title">Output to an ImageStreamTag</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  output:
    to:
      kind: "ImageStreamTag"
      name: "sample-image:latest"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output to a Docker Push Specification</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  output:
    to:
      kind: "DockerImage"
      name: "my-registry.mycompany.com:5000/myimages/myimage:tag"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="builds-output-image-environment-variables-managing-build-output">Output image environment variables</h3>
<div class="paragraph">
<p><code>Docker</code> and
<code>Source-to-Image (S2I)</code> strategy builds set the following environment variables
on output images:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variable</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OPENSHIFT_BUILD_NAME</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the build</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OPENSHIFT_BUILD_NAMESPACE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Namespace of the build</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OPENSHIFT_BUILD_SOURCE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The source URL of the build</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OPENSHIFT_BUILD_REFERENCE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Git reference used in the build</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OPENSHIFT_BUILD_COMMIT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Source commit used in the build</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Additionally, any user-defined environment variable, for example those
configured with
<code>S2I</code>]
or <code>Docker</code>
strategy options, will also be part of the output image environment variable
list.</p>
</div>
</div>
<div class="sect2">
<h3 id="builds-output-image-labels-managing-build-output">Output image labels</h3>
<div class="paragraph">
<p><code>Docker</code> and
<code>Source-to-Image (S2I)</code> builds set the following labels on output images:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Label</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.openshift.build.commit.author</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Author of the source commit used in the build</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.openshift.build.commit.date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date of the source commit used in the build</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.openshift.build.commit.id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hash of the source commit used in the build</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.openshift.build.commit.message</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message of the source commit used in the build</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.openshift.build.commit.ref</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Branch or reference specified in the source</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.openshift.build.source-location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Source URL for the build</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can also use the <code>BuildConfig.spec.output.imageLabels</code> field to specify a
list of custom labels that will be applied to each image built from the
<code>BuildConfig</code>.</p>
</div>
<div class="listingblock">
<div class="title">Custom Labels to be Applied to Built Images</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  output:
    to:
      kind: "ImageStreamTag"
      name: "my-image:latest"
    imageLabels:
    - name: "vendor"
      value: "MyCompany"
    - name: "authoritative-source-url"
      value: "registry.mycompany.com"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-build-strategies">Using build strategies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following sections define the primary supported build strategies, and how to
use them.</p>
</div>
<div class="sect2">
<h3 id="builds-strategy-docker-build-build-strategies">Docker build</h3>
<div class="paragraph">
<p>The Docker build strategy invokes the docker build command, and it expects a
repository with a <strong><em>Dockerfile</em></strong> and all required artifacts in it to produce a
runnable image.</p>
</div>
<div class="sect3">
<h4 id="builds-strategy-docker-from-image-build-strategies">Replacing Dockerfile FROM image</h4>
<div class="paragraph">
<p>You can replace the <code>FROM</code> instruction of the <strong><em>Dockerfile</em></strong> with the <code>from</code> of
the <code>BuildConfig</code>.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To replace the <code>FROM</code> instruction of the <strong><em>Dockerfile</em></strong> with the <code>from</code> of
the <code>BuildConfig</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">strategy:
  dockerStrategy:
    from:
      kind: "ImageStreamTag"
      name: "debian:latest"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="builds-strategy-dockerfile-path-build-strategies">Using Dockerfile path</h4>
<div class="paragraph">
<p>By default, Docker builds use a Dockerfile (named <strong><em>Dockerfile</em></strong>) located at the
root of the context specified in the <code>BuildConfig.spec.source.contextDir</code>
field.</p>
</div>
<div class="paragraph">
<p>The <code>dockerfilePath</code> field allows the build to use a different path to
locate your Dockerfile, relative to the <code>BuildConfig.spec.source.contextDir</code>
field. It can be a different file name than the default
<strong><em>Dockerfile</em></strong> (for example, <strong><em>MyDockerfile</em></strong>), or a path to a Dockerfile in a
subdirectory (for example, <strong><em>dockerfiles/app1/Dockerfile</em></strong>).</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To use the <code>dockerfilePath</code> field for the build to use a different path to
locate your Dockerfile, set:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">strategy:
  dockerStrategy:
    dockerfilePath: dockerfiles/app1/Dockerfile</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="builds-strategy-docker-environment-variables-build-strategies">Using Docker environment variables</h4>
<div class="paragraph">
<p>To make environment variables available to the Docker build
process and resulting image, you can add environment variables to the
<code>dockerStrategy</code> definition of the <code>BuildConfig</code>.</p>
</div>
<div class="paragraph">
<p>The environment variables defined there are inserted as a single <code>ENV</code>
Dockerfile instruction right after the <code>FROM</code> instruction, so that it can be
referenced later on within the Dockerfile.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>The variables are defined during build and stay in the output image, therefore
they will be present in any container that runs that image as well.</p>
</div>
<div class="paragraph">
<p>For example, defining a custom HTTP proxy to be used during build and runtime:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">dockerStrategy:
...
  env:
    - name: "HTTP_PROXY"
      value: "http://myproxy.net:5187/"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cluster administrators can also configure global build settings using Ansible.</p>
</div>
<div class="paragraph">
<p>You can also manage environment variables defined in the <code>BuildConfig</code> with the
<code>oc set env</code> command.</p>
</div>
</div>
<div class="sect3">
<h4 id="builds-strategy-docker-build-arguments-build-strategies">Adding Docker build arguments</h4>
<div class="paragraph">
<p>You can set <a href="http://docs.docker.com/v1.7/reference/api/hub_registry_spec/#docker-registry-1-0">Docker
build arguments</a> using the <code>BuildArgs</code> array. The build
arguments will be passed to Docker when a build is started.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To set Docker build arguments, add entries to the <code>BuildArgs</code> array, which is
located in the <code>dockerStrategy</code> definition of the <code>BuildConfig</code>. For example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">dockerStrategy:
...
  buildArgs:
    - name: "foo"
      value: "bar"</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="build-strategy-s2i-build-strategies">Source-to-Image (S2I) build</h3>
<div class="paragraph">
<p>Source-to-Image (S2I) is a tool for building reproducible, Docker-formatted
container images. It produces ready-to-run images by injecting application
source into a container image and assembling a new image. The new image
incorporates the base image (the builder) and built source and is ready to use
with the <code>buildah run</code> command. S2I supports incremental builds, which re-use
previously downloaded dependencies, previously built artifacts, etc.</p>
</div>
<div class="paragraph">
<p>The advantages of S2I include the following:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Image flexibility
</td>
<td class="hdlist2">
<p>S2I scripts can be written to inject
application code into almost any existing Docker-formatted container image,
taking advantage of the existing ecosystem. Note that, currently, S2I relies on
<code>tar</code> to inject application source, so the image needs to be able to process
tarred content.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Speed
</td>
<td class="hdlist2">
<p>With S2I, the assemble process can perform a large number of complex
operations without creating a new layer at each step, resulting in a fast
process. In addition, S2I scripts can be written to re-use artifacts stored in a
previous version of the application image, rather than having to download or
build them each time the build is run.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Patchability
</td>
<td class="hdlist2">
<p>S2I allows you to rebuild the application consistently if an
underlying image needs a patch due to a security issue.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Operational efficiency
</td>
<td class="hdlist2">
<p>By restricting build operations instead of allowing
arbitrary actions, as a <strong><em>Dockerfile</em></strong> would allow, the PaaS operator can avoid
accidental or intentional abuses of the build system.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Operational security
</td>
<td class="hdlist2">
<p>Building an arbitrary <strong><em>Dockerfile</em></strong> exposes the host
system to root privilege escalation. This can be exploited by a malicious user
because the entire Docker build process is run as a user with Docker privileges.
S2I restricts the operations performed as a root user and can run the scripts
as a non-root user.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
User efficiency
</td>
<td class="hdlist2">
<p>S2I prevents developers from performing arbitrary <code>yum
install</code> type operations, which could slow down development iteration, during
their application build.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Ecosystem
</td>
<td class="hdlist2">
<p>S2I encourages a shared ecosystem of images where you can leverage
best practices for your applications.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Reproducibility
</td>
<td class="hdlist2">
<p>Produced images can include all inputs including specific versions
of build tools and dependencies. This ensures that the image can be reproduced
precisely.</p>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="builds-strategy-s2i-incremental-builds-build-strategies">Performing Source-to-Image (S2I) incremental builds</h4>
<div class="paragraph">
<p>S2I can perform incremental builds, which means it reuses artifacts from
previously-built images.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To create an incremental build, create a <code>BuildConfig</code> with the following
modification to the strategy definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">strategy:
  sourceStrategy:
    from:
      kind: "ImageStreamTag"
      name: "incremental-image:latest" <b class="conum">(1)</b>
    incremental: true <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Specify an image that supports incremental builds. Consult the
documentation of the builder image to determine if it supports this behavior.</p>
</li>
<li>
<p>This flag controls whether an incremental build is attempted. If the builder
image does not support incremental builds, the build will still succeed, but you
will get a log message stating the incremental build was not successful because
of a missing <strong><em>save-artifacts</em></strong> script.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>See S2I Requirements for information on how to create a builder image
supporting incremental builds.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="builds-strategy-s2i-override-builder-image-scripts-build-strategies">Overriding Source-to-Image (S2I) builder image scripts</h4>
<div class="paragraph">
<p>You can override the <strong><em>assemble</em></strong>, <strong><em>run</em></strong>, and <strong><em>save-artifacts</em></strong>
S2I scripts provided by the builder image.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To override the <strong><em>assemble</em></strong>, <strong><em>run</em></strong>, and <strong><em>save-artifacts</em></strong> S2I scripts
provided by the builder image, either:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Provide an <strong><em>assemble</em></strong>, <strong><em>run</em></strong>, or <strong><em>save-artifacts</em></strong> script in the
<strong><em>.s2i/bin</em></strong> directory of your application source repository, or</p>
</li>
<li>
<p>Provide a URL of a directory containing the scripts as part of the strategy
definition. For example:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">strategy:
  sourceStrategy:
    from:
      kind: "ImageStreamTag"
      name: "builder-image:latest"
    scripts: "http://somehost.com/scripts_directory" <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This path will have <strong><em>run</em></strong>, <strong><em>assemble</em></strong>, and <strong><em>save-artifacts</em></strong> appended
to it. If any or all scripts are found they will be used in place of the same
named script(s) provided in the image.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Files located at the <code>scripts</code> URL take precedence over files located in
<strong><em>.s2i/bin</em></strong> of the source repository.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="builds-strategy-s2i-environment-variables-build-strategies">Source-to-Image (S2I) environment variables</h4>
<div class="paragraph">
<p>There are two ways to make environment variables available to the source build
process and resulting image. Environment files and <strong>BuildConfig</strong> environment
values. Variables provided will be present during the build process and in the
output image.</p>
</div>
<div class="sect4">
<h5 id="builds-strategy-s2i-environment-files-build-strategies">Using Source-to-Image (S2I) environment files</h5>
<div class="paragraph">
<p>Source build enables you to set environment values (one per line) inside your
application, by specifying them in a <strong><em>.s2i/environment</em></strong> file in the source
repository. The environment variables specified in this file are present during
the build process and in the output image.</p>
</div>
<div class="paragraph">
<p>If you provide a <strong><em>.s2i/environment</em></strong> file in your source repository, S2I reads
this file during the build. This allows customization of the build behavior as
the <strong><em>assemble</em></strong> script may use these variables.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>For example, to disable assets compilation for your Rails
application during the build:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add <code>DISABLE_ASSET_COMPILATION=true</code> in the <strong><em>.s2i/environment</em></strong> file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to builds, the specified environment variables are also available in
the running application itself. For example, to cause the Rails
application to start in <code>development</code> mode instead of <code>production</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add <code>RAILS_ENV=development</code> to the <strong><em>.s2i/environment</em></strong> file.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>The complete list of supported environment variables is available in the using
images section for each image.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="builds-strategy-s2i-buildconfig-environment-build-strategies">Using Source-to-Image (S2I) BuildConfig environment</h5>
<div class="paragraph">
<p>You can add environment variables to the <code>sourceStrategy</code> definition of the
<code>BuildConfig</code>. The environment variables defined there are visible during the
<strong><em>assemble</em></strong> script execution and will be defined in the output image, making
them also available to the <strong><em>run</em></strong> script and application code.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>For example, to disable assets compilation for your Rails application:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">sourceStrategy:
...
  env:
    - name: "DISABLE_ASSET_COMPILATION"
      value: "true"</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>The Build environment section provides more advanced instructions.</p>
</li>
<li>
<p>You can also manage environment variables defined in the <code>BuildConfig</code> with the
<code>oc set env</code> command.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="builds-strategy-s2i-ignore-source-files-build-strategies">Ignoring Source-to-Image (S2I) source files</h4>
<div class="paragraph">
<p>Source to image supports a <code>.s2iignore</code> file, which contains a list of file
patterns that should be ignored. Files in the build working directory, as
provided by the various input sources, that match a pattern found in the
<code>.s2iignore</code> file will not be made available to the <code>assemble</code> script.</p>
</div>
<div class="paragraph">
<p>For more details on the format of the <code>.s2iignore</code> file, see the source-to-image
documentation.</p>
</div>
</div>
<div class="sect3">
<h4 id="images-create-s2i-build-strategies">Creating images from source code with s2i</h4>
<div class="paragraph">
<p>Source-to-Image (S2I) is a framework that makes it easy to write images that
take application source code as an input and produce a new image that runs the
assembled application as output.</p>
</div>
<div class="paragraph">
<p>The main advantage of using S2I for building reproducible container images is
the ease of use for developers. As a builder image author, you must understand
two basic concepts in order for your images to provide the best possible S2I
performance: the build process and S2I scripts.</p>
</div>
<div class="sect4">
<h5 id="images-create-s2i-build-build-strategies">Understanding the s2i build process</h5>
<div class="paragraph">
<p>The build process consists of the following three fundamental elements, which
are combined into a final container image:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>sources</p>
</li>
<li>
<p>S2I scripts</p>
</li>
<li>
<p>builder image</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>During the build process, S2I must place sources and scripts inside the builder
image. To do so, S2I creates a <code>tar</code> file that contains the sources and
scripts, then streams that file into the builder image. Before executing the
<code>assemble</code> script, S2I un-tars that file and places its contents into the
location specified by the <code>io.openshift.s2i.destination</code>
label from the builder image, with the default location being the
<code>/tmp</code> directory.</p>
</div>
<div class="paragraph">
<p>For this process to happen, your image must supply the <code>tar</code> archiving utility
(the <code>tar</code> command available in <code>$PATH</code>) and the command line interpreter (the
<code>/bin/sh</code> command); this allows your image to use the fastest possible build
path. If the <code>tar</code> or <code>/bin/sh</code> command is not available, the <code>s2i build</code>
process is forced to automatically perform an additional container build to put
both the sources and the scripts inside the image, and only then run the usual
build.</p>
</div>
<div class="paragraph">
<p>See the following diagram for the basic S2I build workflow:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/s2i-flow.png" alt="S2I workflow">
</div>
<div class="title">Figure 1. Build Workflow</div>
</div>
<div class="paragraph">
<p>Run build&#8217;s responsibility is to un-tar the sources, scripts and artifacts
(if such exist) and invoke the <code>assemble</code> script. If this is the second run
(after catching <code>tar</code> or <code>/bin/sh</code> not found error) it is responsible only
for invoking <code>assemble</code> script, since both scripts and sources are already there.</p>
</div>
</div>
<div class="sect4">
<h5 id="images-create-s2i-scripts-build-strategies">Writing s2i scripts</h5>
<div class="paragraph">
<p>You can write S2I scripts in any programming language, as long as the scripts are
executable inside the builder image. S2I supports multiple options providing
<code>assemble</code>/<code>run</code>/<code>save-artifacts</code> scripts. All of these locations are checked on
each build in the following order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A script specified in the BuildConfig</p>
</li>
<li>
<p>A script found in the application source <code>.s2i/bin</code> directory</p>
</li>
<li>
<p>A script found at the default image URL (<code>io.openshift.s2i.scripts-url</code> label)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Both the <code>io.openshift.s2i.scripts-url</code> label specified in the image and the
script specified in a <code>BuildConfig</code> can take one of the following forms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>image:///path_to_scripts_dir</code> - absolute path inside the image to a directory where the S2I scripts are located</p>
</li>
<li>
<p><code>file:///path_to_scripts_dir</code> - relative or absolute path to a directory on the host where the S2I scripts are located</p>
</li>
<li>
<p><code>http(s)://path_to_scripts_dir</code> - URL to a directory where the S2I scripts are located</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. S2I Scripts</caption>
<colgroup>
<col style="width: 27.2727%;">
<col style="width: 72.7273%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Script</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong><em>assemble</em></strong>
(required)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The <strong><em>assemble</em></strong> script builds the application artifacts from a source
and places them into appropriate directories inside the image. The workflow for
this script is:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Restore build artifacts. If you want to support incremental builds, make sure to define <strong><em>save-artifacts</em></strong> as well (optional).</p>
</li>
<li>
<p>Place the application source in the desired location.</p>
</li>
<li>
<p>Build the application artifacts.</p>
</li>
<li>
<p>Install the artifacts into locations appropriate for them to run.</p>
</li>
</ol>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong><em>run</em></strong>
(required)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The <strong><em>run</em></strong> script executes your application.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong><em>save-artifacts</em></strong>
(optional)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The <strong><em>save-artifacts</em></strong> script gathers all dependencies that can speed up the
build processes that follow. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For Ruby, <strong>gems</strong> installed by Bundler.</p>
</li>
<li>
<p>For Java, <strong>.m2</strong> contents.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These dependencies are gathered into a tar file and streamed to the standard
output.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong><em>usage</em></strong>
(optional)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The <strong><em>usage</em></strong> script allows you to inform the user how to properly use your
image.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong><em>test/run</em></strong>
(optional)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The <strong><em>test/run</em></strong> script allows you to create a simple process to check if the
image is working correctly. The proposed flow of that process is:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Build the image.</p>
</li>
<li>
<p>Run the image to verify the <strong><em>usage</em></strong> script.</p>
</li>
<li>
<p>Run <code>s2i build</code> to verify the <strong><em>assemble</em></strong> script.</p>
</li>
<li>
<p>Run <code>s2i build</code> again to verify the <strong><em>save-artifacts</em></strong> and <strong><em>assemble</em></strong> scripts save and restore artifacts functionality. (optional)</p>
</li>
<li>
<p>Run the image to verify the test application is working.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The suggested location to put the test application built by your
<strong><em>test/run</em></strong> script is the <strong><em>test/test-app</em></strong> directory in your image repository.
See the <a href="https://github.com/openshift/source-to-image/blob/master/docs/cli.md#sti-create">S2I documentation</a>
for more information.
</td>
</tr>
</table>
</div></div></td>
</tr>
</tbody>
</table>
<div class="sect5">
<h6 id="_example-s2i-scripts">Example S2I Scripts</h6>
<div class="paragraph">
<p>The following example S2I scripts are written in Bash. Each
example assumes its tar
contents are unpacked into the <code>/tmp/s2i</code> directory.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. <code>assemble</code> script:</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap">#!/bin/bash

# restore build artifacts
if [ "$(ls /tmp/s2i/artifacts/ 2&gt;/dev/null)" ]; then
    mv /tmp/s2i/artifacts/* $HOME/.
fi

# move the application source
mv /tmp/s2i/src $HOME/src

# build application artifacts
pushd ${HOME}
make all

# install the artifacts
make install
popd</pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 2. <code>run</code> script:</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap">#!/bin/bash

# run the application
/opt/application/run.sh</pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 3. <strong><em>save-artifacts</em></strong> script:</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap">#!/bin/bash

pushd ${HOME}
if [ -d deps ]; then
    # all deps contents to tar stream
    tar cf - deps
fi
popd</pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 4. <code>usage</code> script:</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap">#!/bin/bash

# inform the user how to use the image
cat &lt;&lt;EOF
This is a S2I sample builder image, to use it, install
https://github.com/openshift/source-to-image
EOF</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="build-strategy-custom-build-build-strategies">Custom build</h3>
<div class="paragraph">
<p>The Custom build strategy allows developers to define a specific builder image
responsible for the entire build process. Using your own builder image allows
you to customize your build process.</p>
</div>
<div class="paragraph">
<p>A Custom builder image is a plain Docker-formatted container image embedded with
build process logic, for example for building RPMs or base images.</p>
</div>
<div class="paragraph">
<p>Custom builds run with a very high level of privilege and are not available to
users by default. Only users who can be trusted with cluster administration
permissions should be granted access to run custom builds.</p>
</div>
<div class="sect3">
<h4 id="builds-strategy-custom-from-image-build-strategies">Using FROM image for custom builds</h4>
<div class="paragraph">
<p>You can use the <code>customStrategy.from</code> section to indicate the image to use for the
custom build</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To set the <code>customStrategy.from</code> section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">strategy:
  customStrategy:
    from:
      kind: "DockerImage"
      name: "openshift/sti-image-builder"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="builds-strategy-custom-secrets-build-strategies">Using secrets in custom builds</h4>
<div class="paragraph">
<p>In addition to secrets for source and images that can be added to all build
types, custom strategies allow adding an arbitrary list of secrets to the
builder pod.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To mount each secret at a specific location:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">strategy:
  customStrategy:
    secrets:
      - secretSource: <b class="conum">(1)</b>
          name: "secret1"
        mountPath: "/tmp/secret1" <b class="conum">(2)</b>
      - secretSource:
          name: "secret2"
        mountPath: "/tmp/secret2"</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>secretSource</code> is a reference to a secret in the same namespace as the
build.</p>
</li>
<li>
<p><code>mountPath</code> is the path inside the custom builder where the secret should
be mounted.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="builds-strategy-custom-environment-variables-build-strategies">Using environment variables for custom builds</h4>
<div class="paragraph">
<p>To make environment variables available to the Custom build
process, you can add environment variables to the <code>customStrategy</code> definition
of the <code>BuildConfig</code>.</p>
</div>
<div class="paragraph">
<p>The environment variables defined there are passed to the pod that runs the
custom build.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To define a custom HTTP proxy to be used during build:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">customStrategy:
...
  env:
    - name: "HTTP_PROXY"
      value: "http://myproxy.net:5187/"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cluster administrators can also configure global build settings using Ansible.</p>
</div>
<div class="paragraph">
<p>You can also manage environment variables defined in the <code>BuildConfig</code> with the
<code>oc set env</code> command.</p>
</div>
</div>
<div class="sect3">
<h4 id="images-custom-build-strategies">Using custom builder images</h4>
<div class="paragraph">
<p>By allowing you to define a specific builder image responsible for the entire
build process, OpenShift Enterprise&#8217;s Custom build strategy was designed to fill a
gap created with the increased popularity of creating container images. When
there is a requirement for a build to still produce individual artifacts
(packages, JARs, WARs, installable ZIPs, and base images, for example), a
<em>Custom builder image</em> using the Custom build strategy is the perfect match to
fill that gap.</p>
</div>
<div class="paragraph">
<p>A Custom builder image is a plain container image embedded with build process
logic, for example for building RPMs or base container images.</p>
</div>
<div class="paragraph">
<p>Additionally, the Custom builder allows implementing any extended build process,
for example a CI/CD flow that runs unit or integration tests.</p>
</div>
<div class="paragraph">
<p>To fully leverage the benefits of the Custom build strategy, you must understand
how to create a Custom builder image that will be capable of building desired
objects.</p>
</div>
<div class="sect4">
<h5 id="_custom-builder-image">Custom builder image</h5>
<div class="paragraph">
<p>Upon invocation, a custom builder image will receive the following environment
variables with the information needed to proceed with the build:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Custom Builder Environment Variables</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variable Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BUILD</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The entire serialized JSON of the <code>Build</code> object definition. If you need to
use a specific API version for serialization, you can set the
<code>buildAPIVersion</code> parameter in the custom strategy
specification of the build configuration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SOURCE_REPOSITORY</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URL of a Git repository with source to be built.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SOURCE_URI</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses the same value as <code>SOURCE_REPOSITORY</code>. Either can be used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SOURCE_CONTEXT_DIR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the subdirectory of the Git repository to be used when building. Only
present if defined.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SOURCE_REF</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Git reference to be built.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ORIGIN_VERSION</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The version of the OpenShift Enterprise master that created this build object.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OUTPUT_REGISTRY</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The container image registry to push the image to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OUTPUT_IMAGE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The container image tag name for the image being built.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PUSH_DOCKERCFG_PATH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to the container registry credentials for running a <code>podman push</code> or <code>docker push</code> operation.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_custom-builder-workflow">Custom builder workflow</h5>
<div class="paragraph">
<p>Although custom builder image authors have great flexibility in defining the
build process, your builder image must still adhere to the following required
steps necessary for seamlessly running a build inside of OpenShift Enterprise:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>Build</code> object definition contains all the necessary information about input parameters for the build.</p>
</li>
<li>
<p>Run the build process.</p>
</li>
<li>
<p>If your build produces an image, push it to the build&#8217;s output location if it is defined. Other output locations can be passed with environment variables.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="builds-strategy-pipeline-build-build-strategies">Pipeline build</h3>
<div class="paragraph">
<p>The Pipeline build strategy allows developers to define a <em>Jenkins pipeline</em> for
execution by the Jenkins pipeline plugin. The build can be started, monitored,
and managed by OpenShift Enterprise in the same way as any other build type.</p>
</div>
<div class="paragraph">
<p>Pipeline workflows are defined in a Jenkinsfile, either embedded directly in the
build configuration, or supplied in a Git repository and referenced by the build
configuration.</p>
</div>
<div class="sect3">
<h4 id="builds-understanding-openshift-pipeline-build-strategies">Understanding OpenShift Enterprise pipelines</h4>
<div class="paragraph">
<p>Pipelines give you control over building, deploying, and promoting your
applications on OpenShift Enterprise. Using a combination of the Jenkins Pipeline
Build Strategy, Jenkinsfiles, and the OpenShift Enterprise Domain Specific Language
(DSL) (provided by the Jenkins Client Plug-in), you can create
advanced build, test, deploy, and promote pipelines for any scenario.</p>
</div>
<div class="paragraph">
<p><strong>OpenShift Enterprise Jenkins Sync Plugin</strong></p>
</div>
<div class="paragraph">
<p>The OpenShift Enterprise Jenkins Sync Plugin keeps <code>BuildConfig</code> and Build objects in
sync with Jenkins Jobs and Builds, and provides the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Dynamic job/run creation in Jenkins.</p>
</li>
<li>
<p>Dynamic creation of slave pod templates from ImageStreams, ImageStreamTags, or
ConfigMaps.</p>
</li>
<li>
<p>Injecting of environment variables.</p>
</li>
<li>
<p>Pipeline visualization in the OpenShift web console.</p>
</li>
<li>
<p>Integration with the Jenkins git plugin, which passes commit information from</p>
</li>
<li>
<p>Synchronizing secrets into Jenkins credential entries
OpenShift builds to the Jenkins git plugin.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>OpenShift Enterprise Jenkins Client Plugin</strong></p>
</div>
<div class="paragraph">
<p>The OpenShift Enterprise Jenkins Client Plugin is a Jenkins plugin which aims to
provide a readable, concise, comprehensive, and fluent Jenkins Pipeline syntax
for rich interactions with an OpenShift Enterprise API Server. The plugin leverages
the OpenShift command line tool (<code>oc</code>) which must be available on the nodes
executing the script.</p>
</div>
<div class="paragraph">
<p>The Jenkins Client Plug-in must be installed on your Jenkins
master so the OpenShift Enterprise DSL will be available to use within the JenkinsFile for
your application. This plug-in is installed and enabled by default when using
the OpenShift Enterprise Jenkins image.</p>
</div>
<div class="paragraph">
<p>For OpenShift Enterprise Pipelines within your project, you will must use
the Jenkins Pipeline Build Strategy. This strategy defaults to using a
<code>jenkinsfile</code> at the root of your source repository, but also provides the
following configuration options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An inline <code>jenkinsfile</code> field within your <code>BuildConfig</code>.</p>
</li>
<li>
<p>A <code>jenkinsfilePath</code> field within your <code>BuildConfig</code> that references the location
of the <code>jenkinsfile</code> to use relative to the source <code>contextDir</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The optional <code>jenkinsfilePath</code> field specifies the name of the file to use,
relative to the source <code>contextDir</code>. If <code>contextDir</code> is omitted, it defaults to
the root of the repository. If <code>jenkinsfilePath</code> is omitted, it defaults to
<code>jenkinsfile</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="builds-strategy-pipeline-providing-jenkinsfile-build-strategies">Providing the Jenkinsfile for pipeline builds</h4>
<div class="paragraph">
<p>The <code>jenkinsfile</code> uses the standard groovy language syntax to allow fine
grained control over the configuration, build, and deployment of your
application.</p>
</div>
<div class="paragraph">
<p>You can supply the <code>jenkinsfile</code> in one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A file located within your source code repository.</p>
</li>
<li>
<p>Embedded as part of your build configuration using the <code>jenkinsfile</code> field.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When using the first option, the <code>jenkinsfile</code> must be included in your
applications source code repository at one of the following locations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A file named <code>jenkinsfile</code> at the root of your repository.</p>
</li>
<li>
<p>A file named <code>jenkinsfile</code> at the root of the source <code>contextDir</code> of your
repository.</p>
</li>
<li>
<p>A file name specified via the <code>jenkinsfilePath</code> field of the
<code>JenkinsPiplineStrategy</code> section of your BuildConfig, which is relative to the
source <code>contextDir</code> if supplied, otherwise it defaults to the root of the
repository.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>jenkinsfile</code> is executed on the Jenkins slave pod, which must have the
OpenShift Client binaries available if you intend to use the OpenShift DSL.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To provide the Jenkinsfile, you can either:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Embed the Jenkinsfile in the build configuration.</p>
</li>
<li>
<p>Include in the build configuration a reference to the
Git repository that contains the Jenkinsfile.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Embedded Definition</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: "BuildConfig"
apiVersion: "v1"
metadata:
  name: "sample-pipeline"
spec:
  strategy:
    jenkinsPipelineStrategy:
      jenkinsfile: |-
        node('agent') {
          stage 'build'
          openshiftBuild(buildConfig: 'ruby-sample-build', showBuildLogs: 'true')
          stage 'deploy'
          openshiftDeploy(deploymentConfig: 'frontend')
        }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Reference to Git Repository</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: "BuildConfig"
apiVersion: "v1"
metadata:
  name: "sample-pipeline"
spec:
  source:
    git:
      uri: "https://github.com/openshift/ruby-hello-world"
  strategy:
    jenkinsPipelineStrategy:
      jenkinsfilePath: some/repo/dir/filename <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The optional <code>jenkinsfilePath</code> field specifies the name of the
file to use, relative to the source <code>contextDir</code>.
If <code>contextDir</code> is omitted, it defaults to the root of the repository.
If <code>jenkinsfilePath</code> is omitted, it defaults to <strong><em>Jenkinsfile</em></strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="builds-strategy-pipeline-environment-variables-build-strategies">Using environment variables for pipeline builds</h4>
<div class="paragraph">
<p>To make environment variables available to the Pipeline build process, you can
add environment variables to the <code>jenkinsPipelineStrategy</code> definition of the
<code>BuildConfig</code>.</p>
</div>
<div class="paragraph">
<p>Once defined, the environment variables will be set as parameters for any
Jenkins job associated with the <code>BuildConfig</code></p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To define environment variables to be used during build:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">jenkinsPipelineStrategy:
...
  env:
    - name: "FOO"
      value: "BAR"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also manage environment variables defined in the <code>BuildConfig</code> with the
<code>oc set env</code> command.</p>
</div>
<div class="sect4">
<h5 id="builds-strategy-pipeline-mapping-buildconfig-jenkins-build-strategies">Mapping Between BuildConfig Environment Variables and Jenkins Job Parameters</h5>
<div class="paragraph">
<p>When a Jenkins job is created or updated based on changes to a Pipeline
strategy <code>BuildConfig</code>, any environment variables in the <code>BuildConfig</code> are
mapped to Jenkins job parameters definitions, where the default values for the
Jenkins job parameters definitions are the current values of the associated
environment variables.</p>
</div>
<div class="paragraph">
<p>After the Jenkins job&#8217;s initial creation, you can still add additional
parameters to the job from the Jenkins console. The parameter names differ from
the names of the environment variables in the <code>BuildConfig</code>. The parameters are
honored when builds are started for those Jenkins jobs.</p>
</div>
<div class="paragraph">
<p>How you start builds for the Jenkins job dictates how the parameters are set.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you start with <code>oc start-build</code>, the values of the environment variables in the
<code>BuildConfig</code> are the parameters set for the corresponding job instance. Any
changes you make to the parameters' default values from the Jenkins console are
ignored. The <code>BuildConfig</code> values take precedence.</p>
</li>
<li>
<p>If you start with <code>oc start-build -e</code>, the values for the environment variables
specified in the <code>-e</code> option take precedence.</p>
<div class="ulist">
<ul>
<li>
<p>If you specify an environment variable not listed in the <code>BuildConfig</code>, they
will be added as a Jenkins job parameter definitions.</p>
</li>
<li>
<p>Any changes you make from the Jenkins console to the parameters corresponding
to the environment variables are ignored. The <code>BuildConfig</code> and what you specify
with <code>oc start-build -e</code> takes precedence.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If you start the Jenkins job with the Jenkins console, then you can control the
setting of the parameters with the Jenkins console as part of starting a build
for the job.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="builds-tutorial-pipeline-build-strategies">Pipeline build tutorial</h4>
<div class="paragraph">
<p>This example demonstrates how to create an OpenShift Pipeline that will build,
deploy, and verify a <code>Node.js/MongoDB</code> application using the
<code>nodejs-mongodb.json</code> template.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create the Jenkins master:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">  $ oc project &lt;project_name&gt; <b class="conum">(1)</b>
  $ oc new-app jenkins-ephemeral <b class="conum">(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Select the project that you want to use or create a new project with <code>oc
new-project &lt;project_name&gt;</code>.</p>
</li>
<li>
<p>If you want to use persistent storage, use <code>jenkins-persistent</code> instead.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create a file named <strong>nodejs-sample-pipeline.yaml</strong> with the following content:</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This creates a <code>BuildConfig</code> that employs the Jenkins pipeline strategy to build,
deploy, and scale the <code>Node.js/MongoDB</code> example application.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: "BuildConfig"
apiVersion: "v1"
metadata:
  name: "nodejs-sample-pipeline"
spec:
  strategy:
    jenkinsPipelineStrategy:
      jenkinsfile: &lt;pipeline content from below&gt;
    type: JenkinsPipeline</code></pre>
</div>
</div>
</li>
<li>
<p>Once you create a <code>BuildConfig</code> with a <code>jenkinsPipelineStrategy</code>, tell the
pipeline what to do by using an inline <code>jenkinsfile</code>:</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This example does not set up a Git repository for the application.</p>
</div>
<div class="paragraph">
<p>The following <code>jenkinsfile</code> content is written in Groovy using the OpenShift
DSL. For this example, include inline content in the <code>BuildConfig</code> using the YAML
Literal Style, though including a <code>jenkinsfile</code> in your source repository is the
preferred method.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-groovy" data-lang="groovy">def templatePath = 'https://raw.githubusercontent.com/openshift/nodejs-ex/master/openshift/templates/nodejs-mongodb.json' <b class="conum">(1)</b>
def templateName = 'nodejs-mongodb-example' <b class="conum">(2)</b>
pipeline {
  agent {
    node {
      label 'nodejs' <b class="conum">(3)</b>
    }
  }
  options {
    timeout(time: 20, unit: 'MINUTES') <b class="conum">(4)</b>
  }
  stages {
    stage('preamble') {
        steps {
            script {
                openshift.withCluster() {
                    openshift.withProject() {
                        echo "Using project: ${openshift.project()}"
                    }
                }
            }
        }
    }
    stage('cleanup') {
      steps {
        script {
            openshift.withCluster() {
                openshift.withProject() {
                  openshift.selector("all", [ template : templateName ]).delete() <b class="conum">(5)</b>
                  if (openshift.selector("secrets", templateName).exists()) { <b class="conum">(6)</b>
                    openshift.selector("secrets", templateName).delete()
                  }
                }
            }
        }
      }
    }
    stage('create') {
      steps {
        script {
            openshift.withCluster() {
                openshift.withProject() {
                  openshift.newApp(templatePath) <b class="conum">(7)</b>
                }
            }
        }
      }
    }
    stage('build') {
      steps {
        script {
            openshift.withCluster() {
                openshift.withProject() {
                  def builds = openshift.selector("bc", templateName).related('builds')
                  timeout(5) { <b class="conum">(8)</b>
                    builds.untilEach(1) {
                      return (it.object().status.phase == "Complete")
                    }
                  }
                }
            }
        }
      }
    }
    stage('deploy') {
      steps {
        script {
            openshift.withCluster() {
                openshift.withProject() {
                  def rm = openshift.selector("dc", templateName).rollout()
                  timeout(5) { <b class="conum">(9)</b>
                    openshift.selector("dc", templateName).related('pods').untilEach(1) {
                      return (it.object().status.phase == "Running")
                    }
                  }
                }
            }
        }
      }
    }
    stage('tag') {
      steps {
        script {
            openshift.withCluster() {
                openshift.withProject() {
                  openshift.tag("${templateName}:latest", "${templateName}-staging:latest") <b class="conum">(10)</b>
                }
            }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Path of the template to use.</p>
</li>
<li>
<p>Name of the template that will be created.</p>
</li>
<li>
<p>Spin up a <code>node.js</code> slave pod on which to run this build.</p>
</li>
<li>
<p>Set a timeout of 20 minutes for this pipeline.</p>
</li>
<li>
<p>Delete everything with this template label.</p>
</li>
<li>
<p>Delete any secrets with this template label.</p>
</li>
<li>
<p>Create a new application from the <code>templatePath</code>.</p>
</li>
<li>
<p>Wait up to five minutes for the build to complete.</p>
</li>
<li>
<p>Wait up to five minutes for the deployment to complete.</p>
</li>
<li>
<p>If everything else succeeded, tag the <code>$ {templateName}:latest</code> image as
<code>$ {templateName}-staging:latest</code>. A pipeline <code>BuildConfig</code> for the staging
environment can watch for the <code>$ {templateName}-staging:latest</code> image to change
and then deploy it to the staging environment.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The previous example was written using the <strong>declarative pipeline</strong> style,
but the older <strong>scripted pipeline</strong> style is also supported.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create the Pipeline <code>BuildConfig</code> in your OpenShift cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc create -f nodejs-sample-pipeline.yaml</code></pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If you do not want to create your own file, you can use the sample from the
Origin repository by running:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc create -f https://raw.githubusercontent.com/openshift/origin/master/examples/jenkins/pipeline/nodejs-sample-pipeline.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Start the Pipeline:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc start-build nodejs-sample-pipeline</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Alternatively, you can start your pipeline with the OpenShift Web Console by
navigating to the Builds &#8594; Pipeline section and clicking <strong>Start Pipeline</strong>, or
by visiting the Jenkins Console, navigating to the Pipeline that you created,
and clicking <strong>Build Now</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the pipeline is started, you should see the following actions performed
within your project:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A job instance is created on the Jenkins server.</p>
</li>
<li>
<p>A slave pod is launched, if your pipeline requires one.</p>
</li>
<li>
<p>The pipeline runs on the slave pod, or the master if no slave is required.</p>
<div class="ulist">
<ul>
<li>
<p>Any previously created resources with the <code>template=nodejs-mongodb-example</code>
label will be deleted.</p>
</li>
<li>
<p>A new application, and all of its associated resources, will be created from
the <code>nodejs-mongodb-example</code> template.</p>
</li>
<li>
<p>A build will be started using the <code>nodejs-mongodb-example</code> <code>BuildConfig</code>.</p>
<div class="ulist">
<ul>
<li>
<p>The pipeline will wait until the build has completed to trigger the next stage.</p>
</li>
</ul>
</div>
</li>
<li>
<p>A deployment will be started using the <code>nodejs-mongodb-example</code> deployment
configuration.</p>
<div class="ulist">
<ul>
<li>
<p>The pipeline will wait until the deployment has completed to trigger the next
stage.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If the build and deploy are successful, the <code>nodejs-mongodb-example:latest</code>
image will be tagged as <code>nodejs-mongodb-example:stage</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The slave pod is deleted, if one was required for the pipeline.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The best way to visualize the pipeline execution is by viewing it in the
OpenShift Web Console. You can view your pipelines by logging into the web
console and navigating to Builds &#8594; Pipelines.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="builds-strategy-secrets-web-console-build-strategies">Adding secrets with web console</h3>
<div class="paragraph">
<p>You can add a secret to your build configuration so that it can access a private
repository.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To add a secret to your build configuration so that it can access a private
repository:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new OpenShift Enterprise project.</p>
</li>
<li>
<p>Create a secret that contains credentials for accessing a private source code
repository.</p>
</li>
<li>
<p>Create a build configuration.</p>
</li>
<li>
<p>On the build configuration editor page or in the <code>create app from builder image</code>
page of the web console, set the <strong>Source Secret</strong>.</p>
</li>
<li>
<p>Click the <strong>Save</strong> button.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="builds-strategy-enable-pulling-pushing-build-strategies">Enabling pulling and pushing</h3>
<div class="paragraph">
<p>You can enable pulling to a private registry by setting the <code>Pull Secret</code> and
pushing by setting the <code>Push Secret</code> in the build configuration.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To enable pulling to a private registry:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set the <code>Pull Secret</code> in the build configuration.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To enable pushing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set the <code>Push Secret</code> in the build configuration.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="adding-a-docker-socket-to-custom-builds-with-buildah">Adding a Docker socket to custom builds with Buildah</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With OpenShift Enterprise 4.0, a Docker socket will not be present on the host
nodes. This means the <em>mount docker socket</em> option of a custom build is not
guaranteed to provide an accessible Docker socket for use within a custom build
image.</p>
</div>
<div class="paragraph">
<p>If you need this capability in order to build and push images, add the Buildah
tool your custom build image and use it to build and push the image within your
custom build logic. The following is an example of how to run custom builds with
Buildah.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Using the custom build strategy requires permissions that normal users do
not have by default because it allows the user to execute arbitrary code inside
a privileged container running on the cluster. This level of access can be used
to compromise the cluster and therefore should be granted only to users who are
trusted with administrative privileges on the cluster.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Review how to <a href="#securing-builds-by-strategy">grant custom build permissions</a>.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="builds-create-custom-build-artifacts-custom-builds-buildah">Creating custom build artifacts</h3>
<div class="paragraph">
<p>You need to create the image you want to use as your custom build image.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Starting with an empty directory, create a file named <code>Dockerfile</code> with the
following content:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">FROM docker.io/centos:7
RUN yum install -y buildah
# For simplicity, /tmp/build contains the inputs we’ll be building when we
# run this custom builder image. Normally the custom builder image would
# fetch this content from some location at build time. (e.g. via git clone).
ADD Dockerfile.sample /tmp/input/Dockerfile
ADD build.sh /usr/bin
RUN chmod a+x /usr/bin/build.sh
# /usr/bin/build.sh contains the actual custom build logic that will be executed when
# this custom builder image is executed.
ENTRYPOINT ["/usr/bin/build.sh"]</pre>
</div>
</div>
</li>
<li>
<p>In the same directory, create a file named <code>Dockerfile.sample</code>. This file will be
included in the custom build image and defines the image that will be produced
by the custom build:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">FROM docker.io/centos:7
RUN touch /tmp/built</pre>
</div>
</div>
</li>
<li>
<p>In the same directory, create a file named <code>build.sh</code>. This file contains the
logic that will be executed when the custom build runs:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">#!/bin/sh
# Note that in this case the build inputs are part of the custom builder image, but normally this
# would be retrieved from an external source.
cd /tmp/input
# OUTPUT_REGISTRY and OUTPUT_IMAGE are env variables provided by the custom
# build framework
TAG="${OUTPUT_REGISTRY}/${OUTPUT_IMAGE}"


# performs the build of the new image defined by Dockerfile.sample
buildah --storage-driver vfs bud --isolation chroot -t ${TAG} .


# buildah requires a slight modification to the push secret provided by the service
# account in order to use it for pushing the image
cp /var/run/secrets/openshift.io/push/.dockercfg /tmp
(echo "{ \"auths\": " ; cat /var/run/secrets/openshift.io/push/.dockercfg ; echo "}") &gt; /tmp/.dockercfg


# push the new image to the target for the build
buildah --storage-driver vfs push --tls-verify=false --authfile /tmp/.dockercfg ${TAG}</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="builds-build-custom-builder-image-custom-builds-buildah">Build custom builder image</h3>
<div class="paragraph">
<p>You can use OpenShift Enterprise to build and push custom builder images to use in
a custom strategy.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Define all the inputs that will go into creating your new custom builder image.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Define a <code>BuildConfig</code> that will build your custom builder image:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc new-build --binary --strategy=docker --name custom-builder-image</pre>
</div>
</div>
</li>
<li>
<p>From the directory in which you created your custom build image, run the build:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc start-build custom-builder-image --from-dir . -F</pre>
</div>
</div>
<div class="paragraph">
<p>After the build completes, your new custom builder image will be
available in your project in an imagestream tag named
<code>custom-builder-image:latest</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="builds-use-custom-builder-image-custom-builds-buildah">Use custom builder image</h3>
<div class="paragraph">
<p>You can define a <code>BuildConfig</code> that uses the custom strategy in conjunction with
your custom builder image to execute your custom build logic.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Define all the required inputs for new custom builder image.</p>
</li>
<li>
<p>Build your custom builder image.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a file named <code>buildconfig.yaml</code>. This file defines the <code>BuildConfig</code> that
is created in your project and executed:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: BuildConfig
apiVersion: v1
metadata:
  name: sample-custom-build
  labels:
    name: sample-custom-build
  annotations:
    template.alpha.openshift.io/wait-for-ready: 'true'
spec:
  strategy:
    type: Custom
    customStrategy:
      forcePull: true
      from:
        kind: ImageStreamTag
        name: custom-builder-image:latest
        namespace: &lt;yourproject&gt; <b class="conum">(1)</b>
  output:
    to:
      kind: ImageStreamTag
      name: sample-custom:latest</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Specify your project name.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create the BuildConfig:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create -f buildconfig.yaml</pre>
</div>
</div>
</li>
<li>
<p>Create a file named <code>imagestream.yaml</code>. This file defines the imagestream to
which the build will push the image:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: ImageStream
apiVersion: v1
metadata:
  name: sample-custom
spec: {}</code></pre>
</div>
</div>
</li>
<li>
<p>Create the imagestream:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create -f imagestream.yaml</pre>
</div>
</div>
</li>
<li>
<p>Run your custom build:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc start-build sample-custom-build -F</pre>
</div>
</div>
<div class="paragraph">
<p>When the build runs, it launches a pod running the custom builder image that
was built earlier. The pod runs the <code>build.sh</code> logic that is defined
as the entrypoint for the custom builder image. The <code>build.sh</code> logic invokes
Buildah to build the <code>Dockerfile.sample</code> that was embedded in the custom builder
image, and then uses Buildah to push the new image to the <code>sample-custom
imagestream</code>.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="performing-basic-builds">Performing basic builds</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following sections provide instructions for basic build operations including
starting and canceling builds, deleting BuildConfigs, viewing build details, and
accessing build logs.</p>
</div>
<div class="sect2">
<h3 id="builds-basic-start-build-basic-build-operations">Starting a build</h3>
<div class="paragraph">
<p>You can manually start a new build from an existing build configuration in your
current project.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To manually start a build, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc start-build &lt;buildconfig_name&gt;</pre>
</div>
</div>
<div class="sect3">
<h4 id="builds-basic-start-re-run-basic-build-operations">Re-running a build</h4>
<div class="paragraph">
<p>You can manually re-run a build using the <code>--from-build</code> flag.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To manually re-run a build, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc start-build --from-build=&lt;build_name&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="builds-basic-start-logs-basic-build-operations">Streaming build logs</h4>
<div class="paragraph">
<p>You can specify the <code>--follow</code> flag to stream the build&#8217;s logs in stdout.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To manually stream a build&#8217;s logs in stdout, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc start-build &lt;buildconfig_name&gt; --follow</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="builds-basic-start-environment-variable-basic-build-operations">Setting environment variables when starting a build</h4>
<div class="paragraph">
<p>You can specify the <code>--env</code> flag to set any desired environment variable for the
build.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To specify a desired environment variable, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc start-build &lt;buildconfig_name&gt; --env=&lt;key&gt;=&lt;value&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="builds-basic-start-source-basic-build-operations">Starting a build with source</h4>
<div class="paragraph">
<p>Rather than relying on a Git source pull
or a Dockerfile
for a build, you can
can also start a build by directly pushing your source, which could be the
contents of a Git or SVN working directory, a set of prebuilt binary artifacts
you want to deploy, or a single file. This can be done by specifying one of the
following options for the <code>start-build</code> command:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--from-dir=&lt;directory&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a directory that will be archived and used as a binary input for the
build.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--from-file=&lt;file&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a single file that will be the only file in the build source. The
file is placed in the root of an empty directory with the same file name as the original file provided.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--from-repo=&lt;local_source_repo&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a path to a local repository to use as the binary input for a build.
Add the <code>--commit</code> option to control which branch, tag, or commit is used for
the build.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When passing any of these options directly to the build, the contents are
streamed to the build and override the current build source settings.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Builds triggered from binary input will not preserve the source on the server,
so rebuilds triggered by base image changes will use the source specified in the
build configuration.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>For example, the following command sends the contents of a local Git repository
as an archive from the tag <code>v2</code> and starts a build:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc start-build hello-world --from-repo=../hello-world --commit=v2</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="builds-basic-cancel-build-basic-build-operations">Canceling a build</h3>
<div class="paragraph">
<p>You can cancel a build using the web console, or with the following CLI command.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To manually cancel a build, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc cancel-build &lt;build_name&gt;</pre>
</div>
</div>
<div class="sect3">
<h4 id="builds-basic-cancel-multiple-basic-build-operations">Canceling multiple builds</h4>
<div class="paragraph">
<p>You can cancel multiple builds with the following CLI command.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To manually cancel multiple builds, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc cancel-build &lt;build1_name&gt; &lt;build2_name&gt; &lt;build3_name&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="builds-basic-cancel-all-basic-build-operations">Canceling all builds</h4>
<div class="paragraph">
<p>You can cancel all builds from the build configuration with the following CLI
command.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To cancel all builds, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc cancel-build bc/&lt;buildconfig_name&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="builds-basic-cancel-all-state-basic-build-operations">Canceling all builds in a given state</h4>
<div class="paragraph">
<p>You can cancel all builds in a given state (for example, <strong>new</strong> or <strong>pending</strong>),
ignoring the builds in other states.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To cancel all in a given state, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc cancel-build bc/&lt;buildconfig_name&gt;</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="builds-basic-delete-buildconfig-basic-build-operations">Deleting a BuildConfig</h3>
<div class="paragraph">
<p>You can delete a <code>BuildConfig</code> using the following command.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To delete a <code>BuildConfig</code>, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc delete bc &lt;BuildConfigName&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>This also deletes all builds that were instantiated from this <code>BuildConfig</code>.
Specify the <code>--cascade=false</code> flag if you do not want to delete the builds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc delete --cascade=false bc &lt;BuildConfigName&gt;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="builds-basic-view-build-details-basic-build-operations">Viewing build details</h3>
<div class="paragraph">
<p>You can view build details with the web console or by using the <code>oc describe</code>
CLI command.</p>
</div>
<div class="paragraph">
<p>This displays information such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The build source</p>
</li>
<li>
<p>The build strategy</p>
</li>
<li>
<p>The output destination</p>
</li>
<li>
<p>Digest of the image in the destination registry</p>
</li>
<li>
<p>How the build was created</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the build uses the
<code>Docker</code> or
<code>Source</code> strategy, the <code>oc describe</code> output also
includes information about the source revision used for the build, including the
commit ID, author, committer, and message.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To view build details, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc describe build &lt;build_name&gt;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="builds-basic-access-build-logs-basic-build-operations">Accessing build logs</h3>
<div class="paragraph">
<p>You can access build logs using the web console or the CLI.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To stream the logs using the build directly, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc describe build &lt;build_name&gt;</pre>
</div>
</div>
<div class="sect3">
<h4 id="builds-basic-access-buildconfig-logs-basic-build-operations">Accessing BuildConfig logs</h4>
<div class="paragraph">
<p>You can access <code>BuildConfig</code> logs using the web console or the CLI.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To stream the logs of the latest build for a BuildConfig, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc logs -f bc/&lt;buildconfig_name&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="builds-basic-access-buildconfig-version-logs-basic-build-operations">Accessing BuildConfig logs for a given version build</h4>
<div class="paragraph">
<p>You can access logs for a given version build for a <code>BuildConfig</code> using the web
console or the CLI.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To stream the logs for a given version build for a BuildConfig, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc logs --version=&lt;number&gt; bc/&lt;buildconfig_name&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="builds-basic-access-build-verbosity-basic-build-operations">Enabling log verbosity</h4>
<div class="paragraph">
<p>You can enable a more verbose output by passing the <code>BUILD_LOGLEVEL</code> environment
variable as part of the <code>sourceStrategy</code>
or <code>dockerStrategy</code>
in a <code>BuildConfig</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>An administrator can set the default build verbosity for the entire
OpenShift Enterprise instance by configuring <code>env/BUILD_LOGLEVEL</code>. This default can
be overridden by specifying <code>BUILD_LOGLEVEL</code> in a given <code>BuildConfig</code>. You can
specify a higher priority override on the command line for non-binary builds by
passing <code>--build-loglevel</code> to <code>oc start-build</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Available log levels for Source builds are as follows:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Level 0
</td>
<td class="hdlist2">
<p>Produces output from containers running the <strong><em>assemble</em></strong> script and all encountered errors. This is the default.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Level 1
</td>
<td class="hdlist2">
<p>Produces basic information about the executed process.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Level 2
</td>
<td class="hdlist2">
<p>Produces very detailed information about the executed process.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Level 3
</td>
<td class="hdlist2">
<p>Produces very detailed information about the executed process, and a listing of the archive contents.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Level 4
</td>
<td class="hdlist2">
<p>Currently produces the same information as level 3.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Level 5
</td>
<td class="hdlist2">
<p>Produces everything mentioned on previous levels and additionally provides docker push messages.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To enable more verbose output, pass the <code>BUILD_LOGLEVEL</code> environment variable
as part of the <code>sourceStrategy</code>
or <code>dockerStrategy</code>
in a <code>BuildConfig</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">sourceStrategy:
...
  env:
    - name: "BUILD_LOGLEVEL"
      value: "2" <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Adjust this value to the desired log level.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="triggering-and-modifying-builds">Triggering and modifying builds</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following sections outline how to trigger builds and modify builds using
build hooks.</p>
</div>
<div class="sect2">
<h3 id="builds-triggers-triggering-builds-build-hooks">Build triggers</h3>
<div class="paragraph">
<p>When defining a <code>BuildConfig</code>, you can define triggers to control the
circumstances in which the <code>BuildConfig</code> should be run. The following build
triggers are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Webhook</p>
</li>
<li>
<p>Image change</p>
</li>
<li>
<p>Configuration change</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="builds-webhook-triggers-triggering-builds-build-hooks">Webhook triggers</h4>
<div class="paragraph">
<p>Webhook triggers allow you to trigger a new build by sending a request to the
OpenShift Enterprise API endpoint. You can define these triggers using
<a href="https://developer.github.com/webhooks/">GitHub</a>,
<a href="https://docs.gitlab.com/ce/user/project/integrations/webhooks.html">GitLab</a>,
<a href="https://confluence.atlassian.com/bitbucket/manage-webhooks-735643732.html">Bitbucket</a>,
or Generic webhooks.</p>
</div>
<div class="paragraph">
<p>Currently, OpenShift Enterprise webhooks only support the analogous versions of the
push event for each of the Git-based source code management systems (SCMs). All
other event types are ignored.</p>
</div>
<div class="paragraph">
<p>When the push events are processed, the OpenShift Enterprise master host confirms if
the branch reference inside the event matches the branch reference in the
corresponding <code>BuildConfig</code>. If so, it then checks out the exact commit
reference noted in the webhook event on the OpenShift Enterprise build. If they do
not match, no build is triggered.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p><code>oc new-app</code> and <code>oc new-build</code> will create GitHub and Generic webhook triggers
automatically, but any other needed webhook triggers must be added manually (see
Setting Triggers).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For all webhooks, you must define a <code>Secret</code> with a key named <code>WebHookSecretKey</code>
and the value being the value to be supplied when invoking the webhook. The
webhook definition must then reference the secret. The secret ensures the
uniqueness of the URL, preventing others from triggering the build. The value
of the key will be compared to the secret provided during the webhook
invocation.</p>
</div>
<div class="paragraph">
<p>For example here is a GitHub webhook with a reference
to a secret named <code>mysecret</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">type: "GitHub"
github:
  secretReference:
    name: "mysecret"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The secret is then defined as follows.  Note that the value of the secret is
base64 encoded as is required for any <code>data</code> field of a <code>Secret</code> object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">- kind: Secret
  apiVersion: v1
  metadata:
    name: mysecret
    creationTimestamp:
  data:
    WebHookSecretKey: c2VjcmV0dmFsdWUx</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://developer.github.com/webhooks/">GitHub</a></p>
</li>
<li>
<p><a href="https://docs.gitlab.com/ce/user/project/integrations/webhooks.html">GitLab</a></p>
</li>
<li>
<p><a href="https://confluence.atlassian.com/bitbucket/manage-webhooks-735643732.html">Bitbucket</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="builds-using-github-webhooks-triggering-builds-build-hooks">Using GitHub webhooks</h5>
<div class="paragraph">
<p><a href="https://developer.github.com/webhooks/creating/">GitHub webhooks</a> handle the
call made by GitHub when a repository is updated. When defining the trigger, you
must specify a <code>secret</code>, which will be part of the URL you supply to GitHub when
configuring the webhook.</p>
</div>
<div class="paragraph">
<p>Example GitHub webhook definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">type: "GitHub"
github:
  secretReference:
    name: "mysecret"</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The secret used in the webhook trigger configuration is not the same as <code>secret</code>
field you encounter when configuring webhook in GitHub UI. The former is to make
the webhook URL unique and hard to predict, the latter is an optional string field
used to create HMAC hex digest of the body, which is sent as an <code>X-Hub-Signature</code>
<a href="https://developer.github.com/webhooks/#delivery-headers">header</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The payload URL is returned as the GitHub Webhook URL by the <code>oc describe</code>
command (see Displaying Webhook URLs), and is
structured as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">http://&lt;openshift_api_host:port&gt;/oapi/v1/namespaces/&lt;namespace&gt;/buildconfigs/&lt;name&gt;/webhooks/&lt;secret&gt;/github</pre>
</div>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create a <code>BuildConfig</code> from a GitHub repository.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To configure a GitHub Webhook:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>After creating a <code>BuildConfig</code> from a GitHub repository, run:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc describe bc/&lt;name-of-your-BuildConfig&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>This generates a webhook GitHub URL that looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">&lt;https://api.starter-us-east-1.openshift.com:443/oapi/v1/namespaces/nsname/buildconfigs/bcname/webhooks/&lt;secret&gt;/github&gt;.</pre>
</div>
</div>
</li>
<li>
<p>Cut and paste this URL into GitHub, from the GitHub web console.</p>
</li>
<li>
<p>In your GitHub repository, select <strong>Add Webhook</strong> from <strong>Settings &#8594; Webhooks &amp;
Services</strong>.</p>
</li>
<li>
<p>Paste the URL output (similar to above) into the <strong>Payload URL</strong> field.</p>
</li>
<li>
<p>Change the <strong>Content Type</strong> from GitHub&#8217;s default
<code>application/x-www-form-urlencoded</code> to <code>application/json</code>.</p>
</li>
<li>
<p>Click <strong>Add webhook</strong>.</p>
<div class="paragraph">
<p>You should see a message from GitHub stating that your webhook was successfully
configured.</p>
</div>
<div class="paragraph">
<p>Now, whenever you push a change to your GitHub repository, a new build will
automatically start, and upon a successful build a new deployment will start.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p><a href="https://gogs.io">Gogs</a> supports the same webhook payload format as GitHub.
Therefore, if you are using a Gogs server, you can define a GitHub webhook
trigger on your <code>BuildConfig</code> and trigger it by your Gogs server as well.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Given a file containing a valid JSON payload, such as <code>payload.json</code>, you can
manually trigger the webhook with <code>curl</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ curl -H "X-GitHub-Event: push" -H "Content-Type: application/json" -k -X POST --data-binary @payload.json https://&lt;openshift_api_host:port&gt;/oapi/v1/namespaces/&lt;namespace&gt;/buildconfigs/&lt;name&gt;/webhooks/&lt;secret&gt;/github</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-k</code> argument is only necessary if your API server does not have a properly
signed certificate.</p>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://developer.github.com/webhooks/">GitHub</a></p>
</li>
<li>
<p><a href="https://gogs.io">Gogs</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="builds-using-gitlab-webhooks-triggering-builds-build-hooks">Using GitLab webhooks</h5>
<div class="paragraph">
<p><a href="https://docs.gitlab.com/ce/user/project/integrations/webhooks.html">GitLab webhooks</a>
handle the call made by GitLab when a repository is updated. As with the GitHub
triggers, you must specify a <code>secret</code>. The following example is
a trigger definition YAML within the <code>BuildConfig</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">type: "GitLab"
gitlab:
  secretReference:
    name: "mysecret"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The payload URL is returned as the GitLab Webhook URL by the <code>oc describe</code> command
(see Displaying Webhook URLs), and is structured as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">http://&lt;openshift_api_host:port&gt;/oapi/v1/namespaces/&lt;namespace&gt;/buildconfigs/&lt;name&gt;/webhooks/&lt;secret&gt;/gitlab</pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To configure a GitLab Webhook:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Describe the <code>BuildConfig</code> to get the webhook URL:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc describe bc &lt;name&gt;</pre>
</div>
</div>
</li>
<li>
<p>Copy the webhook URL, replacing <code>&lt;secret&gt;</code> with your secret value.</p>
</li>
<li>
<p>Follow the <a href="https://docs.gitlab.com/ce/user/project/integrations/webhooks.html#webhooks">GitLab setup instructions</a>
to paste the webhook URL into your GitLab repository settings.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Given a file containing a valid JSON payload, such as <code>payload.json</code>, you can
manually trigger the webhook with <code>curl</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ curl -H "X-GitLab-Event: Push Hook" -H "Content-Type: application/json" -k -X POST --data-binary @payload.json https://&lt;openshift_api_host:port&gt;/oapi/v1/namespaces/&lt;namespace&gt;/buildconfigs/&lt;name&gt;/webhooks/&lt;secret&gt;/gitlab</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-k</code> argument is only necessary if your API server does not have a properly
signed certificate.</p>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.gitlab.com/ce/user/project/integrations/webhooks.html">GitLab</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="builds-using-bitbucket-webhooks-triggering-builds-build-hooks">Using Bitbucket webhooks</h5>
<div class="paragraph">
<p><a href="https://confluence.atlassian.com/bitbucket/manage-webhooks-735643732.html">Bitbucket
webhooks</a> handle the call made by Bitbucket when a repository is updated.
Similar to the previous triggers, you must specify a <code>secret</code>. The following
example is a trigger definition YAML within the <code>BuildConfig</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">type: "Bitbucket"
bitbucket:
  secretReference:
    name: "mysecret"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The payload URL is returned as the Bitbucket Webhook URL by the <code>oc describe</code>
command (see Displaying Webhook URLs), and is
structured as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">http://&lt;openshift_api_host:port&gt;/oapi/v1/namespaces/&lt;namespace&gt;/buildconfigs/&lt;name&gt;/webhooks/&lt;secret&gt;/bitbucket</pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To configure a Bitbucket Webhook:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Describe the 'BuildConfig' to get the webhook URL:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc describe bc &lt;name&gt;</pre>
</div>
</div>
</li>
<li>
<p>Copy the webhook URL, replacing <code>&lt;secret&gt;</code> with your secret value.</p>
</li>
<li>
<p>Follow the
<a href="https://confluence.atlassian.com/bitbucket/manage-webhooks-735643732.html">Bitbucket
setup instructions</a> to paste the webhook URL into your Bitbucket repository
settings.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Given a file containing a valid JSON payload, such as <code>payload.json</code>, you can
manually trigger the webhook with <code>curl</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ curl -H "X-Event-Key: repo:push" -H "Content-Type: application/json" -k -X POST --data-binary @payload.json https://&lt;openshift_api_host:port&gt;/oapi/v1/namespaces/&lt;namespace&gt;/buildconfigs/&lt;name&gt;/webhooks/&lt;secret&gt;/bitbucket</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-k</code> argument is only necessary if your API server does not have a properly
signed certificate.</p>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://confluence.atlassian.com/bitbucket/manage-webhooks-735643732.html">Bitbucket</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="builds-using-generic-webhooks-triggering-builds-build-hooks">Using generic webhooks</h5>
<div class="paragraph">
<p>Generic webhooks are invoked from any system capable of making a web request.
As with the other webhooks, you must specify a secret, which will be part of
the URL that the caller must use to trigger the build. The secret ensures the
uniqueness of the URL, preventing others from triggering the build. The
following is an example trigger definition YAML within the <code>BuildConfig</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">type: "Generic"
generic:
  secretReference:
    name: "mysecret"
  allowEnv: true <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Set to <code>true</code> to allow a generic webhook to pass in environment variables.</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To set up the caller, supply the calling system with the URL of the generic
webhook endpoint for your build:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">http://&lt;openshift_api_host:port&gt;/oapi/v1/namespaces/&lt;namespace&gt;/buildconfigs/&lt;name&gt;/webhooks/&lt;secret&gt;/generic</pre>
</div>
</div>
<div class="paragraph">
<p>The caller must invoke the webhook as a <code>POST</code> operation.</p>
</div>
</li>
<li>
<p>To invoke the webhook manually you can use <code>curl</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ curl -X POST -k https://&lt;openshift_api_host:port&gt;/oapi/v1/namespaces/&lt;namespace&gt;/buildconfigs/&lt;name&gt;/webhooks/&lt;secret&gt;/generic</pre>
</div>
</div>
<div class="paragraph">
<p>The HTTP verb must be set to <code>POST</code>. The insecure <code>-k</code> flag is specified to
ignore certificate validation. This second flag is not necessary if your cluster
has properly signed certificates.</p>
</div>
<div class="paragraph">
<p>The endpoint can accept an optional payload with the following format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">git:
  uri: "&lt;url to git repository&gt;"
  ref: "&lt;optional git reference&gt;"
  commit: "&lt;commit hash identifying a specific git commit&gt;"
  author:
    name: "&lt;author name&gt;"
    email: "&lt;author e-mail&gt;"
  committer:
    name: "&lt;committer name&gt;"
    email: "&lt;committer e-mail&gt;"
  message: "&lt;commit message&gt;"
env: <b class="conum">(1)</b>
   - name: "&lt;variable name&gt;"
     value: "&lt;variable value&gt;"</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Similar to the <code>BuildConfig</code>
environment variables, the environment variables defined here are made
available to your build. If these variables collide with the <code>BuildConfig</code>
environment variables, these variables take precedence. By default, environment
variables passed by webhook are ignored. Set the <code>allowEnv</code> field to <code>true</code> on
the webhook definition to enable this behavior.</p>
</li>
</ol>
</div>
</li>
<li>
<p>To pass this payload using <code>curl</code>, define it in a file named
<strong><em>payload_file.yaml</em></strong> and run:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ curl -H "Content-Type: application/yaml" --data-binary @payload_file.yaml -X POST -k https://&lt;openshift_api_host:port&gt;/oapi/v1/namespaces/&lt;namespace&gt;/buildconfigs/&lt;name&gt;/webhooks/&lt;secret&gt;/generic</pre>
</div>
</div>
<div class="paragraph">
<p>The arguments are the same as the previous example with the addition of a header
and a payload. The <code>-H</code> argument sets the <code>Content-Type</code> header to
<code>application/yaml</code> or <code>application/json</code> depending on your payload format.
The <code>--data-binary</code> argument is used to send a binary payload with newlines
intact with the <code>POST</code> request.</p>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>OpenShift Enterprise permits builds to be triggered by the generic webhook even if
an invalid request payload is presented (for example, invalid content type,
unparsable or invalid content, and so on). This behavior is maintained for
backwards compatibility. If an invalid request payload is presented,
OpenShift Enterprise returns a warning in JSON format as part of its <code>HTTP 200 OK</code>
response.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="builds-displaying-webhook-urls-triggering-builds-build-hooks">Displaying webhook URLs</h5>
<div class="paragraph">
<p>You can use the following command to display webhook URLs associated with a
<code>BuildConfig</code>. If the command does not display any webhook URLs, then no webhook
trigger is defined for that build configuration. See Setting Triggers to
manually add triggers.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>To display any webhook URLs associated with a <code>BuildConfig</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc describe bc &lt;name&gt;</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="builds-using-image-change-triggers-triggering-builds-build-hooks">Using image change triggers</h4>
<div class="paragraph">
<p>Image change triggers allow your build to be automatically invoked when a new
version of an upstream image is available. For example, if a build is based on
top of a RHEL image, then you can trigger that build to run any time the RHEL
image changes. As a result, the application image is always running on the
latest RHEL base image.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Imagestreams that point to container images in
<a href="http://docs.docker.com/v1.7/reference/api/hub_registry_spec/#docker-registry-1-0">v1
container registries</a> only trigger a build once when the imagestream tag
becomes available and not on subsequent image updates. This is due to the lack
of uniquely identifiable images in v1 container registries.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Configuring an image change trigger requires the following actions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define an <code>ImageStream</code> that points to the upstream image you want to
trigger on:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: "ImageStream"
apiVersion: "v1"
metadata:
  name: "ruby-20-centos7"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This defines the imagestream that is tied to a container image repository
located at <strong><em>&lt;system-registry&gt;</em>/<em>&lt;namespace&gt;</em>/ruby-20-centos7</strong>. The
<strong><em>&lt;system-registry&gt;</em></strong> is defined as a service with the name <code>docker-registry</code>
running in OpenShift Enterprise.</p>
</div>
</li>
<li>
<p>If an imagestream is the base image for the build, set the from field in the
build strategy to point to the imagestream:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">strategy:
  sourceStrategy:
    from:
      kind: "ImageStreamTag"
      name: "ruby-20-centos7:latest"</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the <code>sourceStrategy</code> definition is consuming the <code>latest</code> tag of
the imagestream named <code>ruby-20-centos7</code> located within this namespace.</p>
</div>
</li>
<li>
<p>Define a build with one or more triggers that point to imagestreams:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">type: "imageChange" <b class="conum">(1)</b>
imageChange: {}
type: "imageChange" <b class="conum">(2)</b>
imageChange:
  from:
    kind: "ImageStreamTag"
    name: "custom-image:latest"</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>An image change trigger that monitors the <code>ImageStream</code> and <code>Tag</code> as
defined by the build strategy&#8217;s <code>from</code> field. The <code>imageChange</code> object here
must be empty.</p>
</li>
<li>
<p>An image change trigger that monitors an arbitrary imagestream. The
<code>imageChange</code> part in this case must include a <code>from</code> field that references
the <code>ImageStreamTag</code> to monitor.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>When using an image change trigger for the strategy imagestream, the generated
build is supplied with an immutable Docker tag that points to the latest image
corresponding to that tag. This new image reference will be used by the strategy
when it executes for the build.</p>
</div>
<div class="paragraph">
<p>For other image change triggers that do not reference the strategy imagestream,
a new build will be started, but the build strategy will not be updated with a
unique image reference.</p>
</div>
<div class="paragraph">
<p>Since this example has an image change trigger for the strategy, the
resulting build will be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">strategy:
  sourceStrategy:
    from:
      kind: "DockerImage"
      name: "172.30.17.3:5001/mynamespace/ruby-20-centos7:&lt;immutableid&gt;"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This ensures that the triggered build uses the new image that was just pushed to
the repository, and the build can be re-run any time with the same inputs.</p>
</div>
<div class="paragraph">
<p>You can pause an image change trigger to allow multiple changes on the referenced
imagestream before a build is started. You can also set the <code>paused</code> attribute
to true when initially adding an <code>ImageChangeTrigger</code> to a <code>BuildConfig</code> to prevent
a build from being immediately triggered.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">type: "ImageChange"
imageChange:
  from:
    kind: "ImageStreamTag"
    name: "custom-image:latest"
  paused: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to setting the image field for all <code>Strategy</code> types, for custom
builds, the <code>OPENSHIFT_CUSTOM_BUILD_BASE_IMAGE</code> environment variable is checked.
If it does not exist, then it is created with the immutable image reference. If
it does exist then it is updated with the immutable image reference.</p>
</div>
<div class="paragraph">
<p>If a build is triggered due to a webhook trigger or manual request,
the build that is created uses the <code>&lt;immutableid&gt;</code> resolved from the
<code>ImageStream</code> referenced by the <code>Strategy</code>. This ensures that builds
are performed using consistent image tags for ease of reproduction.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="http://docs.docker.com/v1.7/reference/api/hub_registry_spec/#docker-registry-1-0">v1
container registries</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="builds-configuration-change-triggers-triggering-builds-build-hooks">Configuration change triggers</h4>
<div class="paragraph">
<p>A configuration change trigger allows a build to be automatically invoked as
soon as a new <code>BuildConfig</code> is created.</p>
</div>
<div class="paragraph">
<p>The following is an example trigger definition YAML within the <code>BuildConfig</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">  type: "ConfigChange"</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Configuration change triggers currently only work when creating a new
<code>BuildConfig</code>. In a future release, configuration change triggers will also be
able to launch a build whenever a <code>BuildConfig</code> is updated.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="builds-setting-triggers-manually-triggering-builds-build-hooks">Setting triggers manually</h5>
<div class="paragraph">
<p>Triggers can be added to and removed from build configurations with <code>oc set
triggers</code>.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>To set a GitHub webhook trigger on a build configuration, use:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set triggers bc &lt;name&gt; --from-github</pre>
</div>
</div>
</li>
<li>
<p>To set an imagechange trigger, use</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set triggers bc &lt;name&gt; --from-image='&lt;image&gt;'</pre>
</div>
</div>
</li>
<li>
<p>To remove a trigger, add <code>--remove</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set triggers bc &lt;name&gt; --from-bitbucket --remove</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>When a webhook trigger already exists, adding it again regenerates the
webhook secret.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For more information, consult the help documentation with <code>oc set triggers
--help</code></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="builds-build-hooks-triggering-builds-build-hooks">Build hooks</h3>
<div class="paragraph">
<p>Build hooks allow behavior to be injected into the build process.</p>
</div>
<div class="paragraph">
<p>The <code>postCommit</code> field of a <code>BuildConfig</code> object executes commands inside a
temporary container that is running the build output image. The hook is executed
immediately after the last layer of the image has been committed and before the
image is pushed to a registry.</p>
</div>
<div class="paragraph">
<p>The current working directory is set to the image&#8217;s <code>WORKDIR</code>, which is the
default working directory of the container image. For most images, this is where
the source code is located.</p>
</div>
<div class="paragraph">
<p>The hook fails if the script or command returns a non-zero exit code or if
starting the temporary container fails. When the hook fails it marks the build
as failed and the image is not pushed to a registry. The reason for failing can
be inspected by looking at the build logs.</p>
</div>
<div class="paragraph">
<p>Build hooks can be used to run unit tests to verify the image before the build
is marked complete and the image is made available in a registry. If all tests
pass and the test runner returns with exit code 0, the build is marked
successful. In case of any test failure, the build is marked as failed. In all
cases, the build log will contain the output of the test runner, which can be
used to identify failed tests.</p>
</div>
<div class="paragraph">
<p>The <code>postCommit</code> hook is not only limited to running tests, but can be used
for other commands as well. Since it runs in a temporary container, changes made
by the hook do not persist, meaning that the hook execution cannot affect the
final image. This behavior allows for, among other uses, the installation and
usage of test dependencies that are automatically discarded and will be not
present in the final image.</p>
</div>
<div class="sect3">
<h4 id="builds-configuring-post-commit-build-hooks-triggering-builds-build-hooks">Configuring post commit build hooks</h4>
<div class="paragraph">
<p>There are different ways to configure the post build hook. All forms in the
following examples are equivalent and execute <code>bundle exec rake test --verbose</code>.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Shell script:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">postCommit:
  script: "bundle exec rake test --verbose"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>script</code> value is a shell script to be run with <code>/bin/sh -ic</code>. Use
this when a shell script is appropriate to execute the build hook. For example,
for running unit tests as above. To control the image entry point,
or if the image does not have <code>/bin/sh</code>, use <code>command</code> and/or <code>args</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The additional <code>-i</code> flag was introduced to improve the experience
working with CentOS and RHEL images, and may be removed in a future release.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Command as the image entry point:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">postCommit:
  command: ["/bin/bash", "-c", "bundle exec rake test --verbose"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this form, <code>command</code> is the command to run, which overrides the image
entry point in the exec form, as documented in the
<a href="https://docs.docker.com/engine/reference/builder/#entrypoint">Dockerfile reference</a>. This is needed if the image does not have <code>/bin/sh</code>, or if
you do not want to use a shell. In all other cases, using <code>script</code> might be
more convenient.</p>
</div>
</li>
<li>
<p>Command with arguments:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">postCommit:
  command: ["bundle", "exec", "rake", "test"]
  args: ["--verbose"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This form is equivalent to appending the arguments to <code>command</code>.</p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Providing both <code>script</code> and <code>command</code> simultaneously creates an invalid
build hook.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="builds-using-cli-post-commit-build-hooks-triggering-builds-build-hooks">Using the CLI to set post commit build hooks</h4>
<div class="paragraph">
<p>The <code>oc set build-hook</code> command can be used to set the build hook for a build
configuration.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To set a command as the post-commit build hook:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set build-hook bc/mybc \
    --post-commit \
    --command \
    -- bundle exec rake test --verbose</pre>
</div>
</div>
</li>
<li>
<p>To set a script as the post-commit build hook:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set build-hook bc/mybc --post-commit --script="bundle exec rake test --verbose"</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="performing-advanced-builds">Performing advanced builds</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following sections provide instructions for advanced build operations including
setting build resources and maximum duration, assigning builds to nodes, chaining
builds, build pruning, and build run policies.</p>
</div>
<div class="sect2">
<h3 id="builds-setting-build-resources-advanced-build-operations">Setting build resources</h3>
<div class="paragraph">
<p>By default, builds are completed by pods using unbound resources, such as memory
and CPU. These resources can be limited.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Limit resources by specifying resource limits in a project&#8217;s default container
limits.</p>
</li>
<li>
<p>Or limit resource use by specifying resource limits as part of the
build configuration. In the following example, each of the <code>resources</code>,
<code>cpu</code>, and <code>memory</code> parameters are optional:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: "v1"
kind: "BuildConfig"
metadata:
  name: "sample-build"
spec:
  resources:
    limits:
      cpu: "100m" <b class="conum">(1)</b>
      memory: "256Mi" <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>cpu</code> is in CPU units: <code>100m</code> represents 0.1 CPU units (100 * 1e-3).</p>
</li>
<li>
<p><code>memory</code> is in bytes: <code>256Mi</code> represents 268435456 bytes (256 * 2 ^ 20).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>However, if a quota has been defined for your project, one of the following two
items is required:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>resources</code> section set with an explicit <code>requests</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">resources:
  requests: <b class="conum">(1)</b>
    cpu: "100m"
    memory: "256Mi"</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>requests</code> object contains the list of resources that correspond to
the list of resources in the quota.</p>
</li>
</ol>
</div>
</li>
<li>
<p>A limit range defined in your project, where the
defaults from the <code>LimitRange</code> object apply to pods created during the
build process.</p>
<div class="paragraph">
<p>Otherwise, build pod creation will fail, citing a failure to satisfy quota.</p>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="builds-setting-maximum-duration-advanced-build-operations">Setting maximum duration</h3>
<div class="paragraph">
<p>When defining a <code>BuildConfig</code>, you can define its maximum duration by setting
the <code>completionDeadlineSeconds</code> field. It is specified in seconds and is not
set by default. When not set, there is no maximum duration enforced.</p>
</div>
<div class="paragraph">
<p>The maximum duration is counted from the time when a build pod gets scheduled in
the system, and defines how long it can be active, including the time needed to
pull the builder image. After reaching the specified timeout, the build is
terminated by OpenShift Enterprise.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>To set maximum duration, specify <code>completionDeadlineSeconds</code> in your
<code>BuildConfig</code>. The following example shows the part of a <code>BuildConfig</code>
specifying <code>completionDeadlineSeconds</code> field for 30 minutes:
*</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">spec:
  completionDeadlineSeconds: 1800</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This setting is not supported with the Pipeline Strategy option.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="builds-assigning-builds-to-nodes-advanced-build-operations">Assigning builds to specific nodes</h3>
<div class="paragraph">
<p>Builds can be targeted to run on specific nodes by specifying labels in the
<code>nodeSelector</code> field of a build configuration. The <code>nodeSelector</code> value is a set
of key/value pairs that are matched to <code>node</code> labels when scheduling the build
pod.</p>
</div>
<div class="paragraph">
<p>The <code>nodeSelector</code> value can also be controlled by cluster-wide default and
override values. Defaults will only be applied if the build configuration does
not define any key/value pairs for the <code>nodeSelector</code> and also does not define
an explicitly empty map value of <code>nodeSelector:{}</code>. Override values will replace
values in the build configuration on a key by key basis.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If the specified <code>NodeSelector</code> cannot be matched to a node with those labels,
the build still stay in the <code>Pending</code> state indefinitely.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Assign builds to run on specific nodes by assigning labels in the <code>nodeSelector</code>
field of the <code>BuildConfig</code>, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: "v1"
kind: "BuildConfig"
metadata:
  name: "sample-build"
spec:
  nodeSelector:<b class="conum">(1)</b>
    key1: value1
    key2: value2</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Builds associated with this build configuration will run only on nodes with the <code>key1=value2</code> and <code>key2=value2</code> labels.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="builds-chaining-builds-advanced-build-operations">Chained builds</h3>
<div class="paragraph">
<p>For compiled languages (such as Go, C, C++, and Java), including the dependencies
necessary for compilation in the application image might increase the size of
the image or introduce vulnerabilities that can be exploited.</p>
</div>
<div class="paragraph">
<p>To avoid these problems, two builds can be chained together: one that produces
the compiled artifact, and a second build that places that artifact in a
separate image that runs the artifact.</p>
</div>
<div class="paragraph">
<p>In the following example, a Source-to-Image build is combined with a Docker
build to compile an artifact that is then placed in a separate runtime image.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Although this example chains a Source-to-Image build and a Docker build, the
first build can use any strategy that will produce an image containing the
desired artifacts, and the second build can use any strategy that can consume
input content from an image.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The first build takes the application source and produces an image containing a
WAR file. The image is pushed to the <code>artifact-image</code> imagestream. The path of
the output artifact will depend on the <strong><em>assemble</em></strong> script of the
Source-to-Image builder used. In this case, it will be output to
<strong><em>/wildfly/standalone/deployments/ROOT.war</em></strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: BuildConfig
metadata:
  name: artifact-build
spec:
  output:
    to:
      kind: ImageStreamTag
      name: artifact-image:latest
  source:
    git:
      uri: https://github.com/openshift/openshift-jee-sample.git
  strategy:
    sourceStrategy:
      from:
        kind: ImageStreamTag
        name: wildfly:10.1
        namespace: openshift</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second build uses Image Source with a path to the WAR file inside the output
image from the first build. An inline <strong><em>Dockerfile</em></strong> copies that WAR file into a
runtime image.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: BuildConfig
metadata:
  name: image-build
spec:
  output:
    to:
      kind: ImageStreamTag
      name: image-build:latest
  source:
    dockerfile: |-
      FROM jee-runtime:latest
      COPY ROOT.war /deployments/ROOT.war
    images:
    - from: <b class="conum">(1)</b>
        kind: ImageStreamTag
        name: artifact-image:latest
      paths: <b class="conum">(2)</b>
      - sourcePath: /wildfly/standalone/deployments/ROOT.war
        destinationDir: "."
  strategy:
    dockerStrategy:
      from: <b class="conum">(3)</b>
        kind: ImageStreamTag
        name: jee-runtime:latest
  triggers:
  - imageChange: {}
    type: ImageChange</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>from</code> specifies that the Docker build should include the output of the image
from the <code>artifact-image</code> imagestream, which was the target of the previous
build.</p>
</li>
<li>
<p><code>paths</code> specifies which paths from the target image to include in the current
Docker build.</p>
</li>
<li>
<p>The runtime image is used as the source image for the Docker build.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The result of this setup is that the output image of the second build does not
need to contain any of the build tools that are needed to create the WAR file.
Also, because the second build contains an image change trigger,
whenever the first build is run and produces a new image with the binary
artifact, the second build is automatically triggered to produce a runtime image
that contains that artifact. Therefore, both builds behave as a single build
with two stages.</p>
</div>
</div>
<div class="sect2">
<h3 id="builds-build-pruning-advanced-build-operations">Pruning builds</h3>
<div class="paragraph">
<p>By default, builds that have completed their lifecycle are persisted
indefinitely. You can limit the number of previous builds that are retained.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Limit the number of previous builds that are retained by
supplying a positive integer value for <code>successfulBuildsHistoryLimit</code> or
<code>failedBuildsHistoryLimit</code> in your <code>BuildConfig</code>, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: "v1"
kind: "BuildConfig"
metadata:
  name: "sample-build"
spec:
  successfulBuildsHistoryLimit: 2 <b class="conum">(1)</b>
  failedBuildsHistoryLimit: 2 <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>successfulBuildsHistoryLimit</code> will retain up to two builds with a status of <code>completed</code>.</p>
</li>
<li>
<p><code>failedBuildsHistoryLimit</code> will retain up to two builds with a status of <code>failed</code>, <code>canceled</code>, or <code>error</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Trigger build pruning by one of the following actions:</p>
<div class="ulist">
<ul>
<li>
<p>Updating a build configuration.</p>
</li>
<li>
<p>Waiting for a build to complete its lifecycle.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Builds are sorted by their creation timestamp with the oldest builds being
pruned first.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Administrators can manually prune builds using the 'oc adm' object pruning command.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="builds-build-run-policy-advanced-build-operations">Build run policy</h3>
<div class="paragraph">
<p>The build run policy describes the order in which the builds created from the
build configuration should run. This can be done by changing the value of the
<code>runPolicy</code> field in the <code>spec</code> section of the <code>Build</code> specification.</p>
</div>
<div class="paragraph">
<p>It is also possible to change the <code>runPolicy</code> value for existing build
configurations.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Changing <code>Parallel</code> to <code>Serial</code> or <code>SerialLatestOnly</code> and triggering a
new build from this configuration will cause the new build to wait until all
parallel builds complete as the serial build can only run alone.</p>
</li>
<li>
<p>Changing <code>Serial</code> to <code>SerialLatestOnly</code> and triggering a new build will
cause cancellation of all existing builds in queue, except the currently
running build and the most recently created build. The newest build will
execute next.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="securing-builds-by-strategy">Securing builds by strategy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Builds in OpenShift Enterprise are run in privileged containers. Depending on the
build strategy used, this allows a user who can run builds to escalate their
permissions on the cluster and host nodes. As a security measure, limit who can
run builds and the strategy that is used for those builds. Custom builds are
inherently less safe than Source builds, because they can execute any code
within a privileged container, and are disabled by default. Grant Docker build
permissions with caution, because a vulnerability in the Dockerfile processing
logic could result in a privileges being granted on the host node.</p>
</div>
<div class="paragraph">
<p>By default, all users that can create builds are granted permission to use the
Docker and Source-to-Image (S2I) build strategies. Users with <strong>cluster-admin</strong>
privileges can enable the Custom build strategy, as referenced in the
restricting build strategies to a user globally section.</p>
</div>
<div class="paragraph">
<p>You can control who can build and which build strategies they can use by using
an authorization policy. Each build strategy has a corresponding build
subresource. A user must have permission to create a build <em>and</em> permission to
create on the build strategy subresource in order to create builds using that
strategy. Default roles are provided which grant the <strong>create</strong> permission on the
build strategy subresource.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Build Strategy Subresources and Roles</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Strategy</th>
<th class="tableblock halign-left valign-top">Subresource</th>
<th class="tableblock halign-left valign-top">Role</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Docker</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">builds/docker</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">system:build-strategy-docker</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Source-to-Image</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">builds/source</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">system:build-strategy-source</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">builds/custom</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">system:build-strategy-custom</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JenkinsPipeline</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">builds/jenkinspipeline</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">system:build-strategy-jenkinspipeline</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="builds-disabling-build-strategy-globally-securing-builds-by-strategy">Disabling access to a build strategy globally</h3>
<div class="paragraph">
<p>To prevent access to a particular build strategy globally, log in as a user with
<strong>cluster-admin</strong> privileges, remove the corresponding role from the
<strong>system:authenticated</strong> group, and apply the annotation
<code>rbac.authorization.kubernetes.io/autoupdate: "false"</code> to protect them from changes between
the API restarts. The following example shows disabling the docker build
strategy.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Apply the <code>rbac.authorization.kubernetes.io/autoupdate</code> annotation:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc edit clusterrolebinding system:build-strategy-docker-binding

apiVersion: v1
groupNames:
- system:authenticated
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "false" <b class="conum">(1)</b>
  creationTimestamp: 2018-08-10T01:24:14Z
  name: system:build-strategy-docker-binding
  resourceVersion: "225"
  selfLink: /oapi/v1/clusterrolebindings/system%3Abuild-strategy-docker-binding
  uid: 17b1f3d4-9c3c-11e8-be62-0800277d20bf
roleRef:
  name: system:build-strategy-docker
subjects:
- kind: SystemGroup
  name: system:authenticated
userNames:
- system:serviceaccount:management-infra:management-admin</pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Change the <code>rbac.authorization.kubernetes.io/autoupdate</code> annotation&#8217;s value to <code>"false"</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Remove the role:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm policy remove-cluster-role-from-group system:build-strategy-docker system:authenticated</pre>
</div>
</div>
</li>
<li>
<p>Ensure the build strategy subresources are also removed from these roles:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc edit clusterrole admin
$ oc edit clusterrole edit</pre>
</div>
</div>
</li>
<li>
<p>For each role, remove the line that corresponds to the resource of the strategy
to disable.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Disable the Docker Build Strategy for <strong>admin</strong>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: ClusterRole
metadata:
  name: admin
...
rules:
- resources:
  - builds/custom
  - builds/docker <b class="conum">(1)</b>
  - builds/source
  ...
...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Delete this line to disable Docker builds globally for users with the <strong>admin</strong>
role.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="builds-restricting-build-strategy-globally-securing-builds-by-strategy">Restricting build strategies to users globally</h3>
<div class="paragraph">
<p>You can allow a set of specific users to create builds with a particular
strategy.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Disable global access to the build strategy.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Assign the role that corresponds to the build strategy to a specific user. For
example, to add the <strong>system:build-strategy-docker</strong> cluster role to the user
<strong>devuser</strong>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm policy add-cluster-role-to-user system:build-strategy-docker devuser</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Granting a user access at the cluster level to the <strong>builds/docker</strong> subresource
means that the user can create builds with the Docker strategy in
any project in which they can create builds.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="builds-restricting-build-strategy-to-user-securing-builds-by-strategy">Restricting build strategies to a user within a project</h3>
<div class="paragraph">
<p>Similar to granting the build strategy role to a user globally, you can allow
only a set of specific users within a project to create builds with a particular
strategy.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Disable global access to the build strategy.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Assign the role that corresponds to the build strategy to a specific user within a
project. For example, to add the <strong>system:build-strategy-docker</strong> role within the
project <strong>devproject</strong> to the user <strong>devuser</strong>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm policy add-role-to-user system:build-strategy-docker devuser -n devproject</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="troubleshooting-builds">Troubleshooting builds</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the following to troubleshoot build issues.</p>
</div>
<div class="sect2">
<h3 id="builds-troubleshooting-access-resources-troubleshooting-builds">Resolving denial for access to resources</h3>
<div class="paragraph">
<p>If your request for access to resources is denied:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Issue</dt>
<dd>
<p>A build fails with:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">requested access to the resource is denied</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Resolution</dt>
<dd>
<p>You have exceeded one of the image quotas set on your project. Check your
current quota and verify the limits applied and storage in use:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc describe quota</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="builds-troubleshooting-service-certificate-generation-troubleshooting-builds">Service certificate generation failure</h3>
<div class="paragraph">
<p>If your request for access to resources is denied:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Issue</dt>
<dd>
<p>If a service certificate generation fails with (service&#8217;s
<code>service.alpha.openshift.io/serving-cert-generation-error</code> annotation
contains):</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">secret/ssl-key references serviceUID 62ad25ca-d703-11e6-9d6f-0e9c0057b608, which does not match 77b6dd80-d716-11e6-9d6f-0e9c0057b60</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Resolution</dt>
<dd>
<p>The service that generated the certificate no longer exists, or has a different
<code>serviceUID</code>. You must force certificates regeneration by removing the old
secret, and clearing the following annotations on the service
<code>service.alpha.openshift.io/serving-cert-generation-error</code>,
<code>service.alpha.openshift.io/serving-cert-generation-error-num</code>:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc delete secret &lt;secret_name&gt;
$ oc annotate service &lt;service_name&gt; service.alpha.openshift.io/serving-cert-generation-error-
$ oc annotate service &lt;service_name&gt; service.alpha.openshift.io/serving-cert-generation-error-num-</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The command removing annotation has a <code>-</code> after the annotation name to be
removed.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-04-12 23:56:12 UTC
</div>
</div>
</body>
</html>