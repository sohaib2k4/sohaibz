<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>Applications</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>Applications</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="_operators">Operators</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="what-operators-are">What Operators are</h3>
<div class="paragraph lead">
<p>Conceptually, <em>Operators</em> take human operational knowledge and encode it into
software that is more easily shared with consumers.</p>
</div>
<div class="paragraph">
<p>Operators are pieces of software that ease the operational complexity of running
another piece of software. They act like an extension of the software vendor&#8217;s
engineering team, watching over a Kubernetes environment (such as
OpenShift Enterprise) and using its current state to make decisions in real time.
Advanced Operators are designed to handle upgrades seamlessly, react to failures
automatically, and not take shortcuts, like skipping a software backup process
to save time.</p>
</div>
<div class="paragraph lead">
<p>More technically, <em>Operators</em> are a method of packaging, deploying, and managing a
Kubernetes application.</p>
</div>
<div class="paragraph">
<p>A Kubernetes application is an app that is both deployed on Kubernetes and
managed using the Kubernetes APIs and <code>kubectl</code> or <code>oc</code> tooling. To be able to
make the most of Kubernetes, you need a set of cohesive APIs to extend in order
to service and manage your apps that run on Kubernetes. Think of
Operators as the runtime that manages this type of app on Kubernetes.</p>
</div>
<div class="sect3">
<h4 id="olm-why-use-operators-olm-what-operators-are">Why use Operators?</h4>
<div class="paragraph">
<p>Operators provide:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Repeatability of installation and upgrade.</p>
</li>
<li>
<p>Constant health checks of every system component.</p>
</li>
<li>
<p>Over-the-air (OTA) updates for OpenShift components and ISV content.</p>
</li>
<li>
<p>A place to encapsulate knowledge from field engineers and spread it to all
users, not just one or two.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Why deploy on Kubernetes?</dt>
<dd>
<p>Kubernetes (and by extension, OpenShift Enterprise) contains all of the primitives
needed to build complex distributed systems – secret handling, load balancing,
service discovery, autoscaling – that work across on-premise and cloud
providers.</p>
</dd>
<dt class="hdlist1">Why manage your app with Kubernetes APIs and <code>kubectl</code> tooling?</dt>
<dd>
<p>These APIs are feature rich, have clients for all platforms and plug into the
cluster’s access control/auditing. An Operator uses the Kubernetes' extension
mechanism, Custom Resource Definitions (CRDs), so your custom object, for
example <code>MongoDB</code>, looks and acts just like the built-in, native Kubernetes
objects.</p>
</dd>
<dt class="hdlist1">How do Operators compare with Service Brokers?</dt>
<dd>
<p>A Service Broker is a step towards programmatic discovery and deployment of an
app. However, because it is not a long running process, it cannot execute Day 2
operations like upgrade, failover, or scaling. Customizations and
parameterization of tunables are provided at install time, versus an Operator
that is constantly watching your cluster&#8217;s current state. Off-cluster services
continue to be a good match for a Service Broker, although Operators exist for
these as well.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="olm-operator-framework-olm-what-operators-are">Operator Framework</h4>
<div class="paragraph">
<p>The Operator Framework is a family of tools and capabilities to deliver on the
customer experience described above. It is not just about writing code; testing,
delivering, and updating Operators is just as important. The Operator Framework
components consist of open source tools to tackle these problems:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Operator SDK</dt>
<dd>
<p>Assists Operator authors in bootstrapping, building, testing, and packaging
their own Operator based on their expertise without requiring knowledge of
Kubernetes API complexities.</p>
</dd>
<dt class="hdlist1">Operator Lifecycle Manager</dt>
<dd>
<p>Controls the installation, upgrade, and RBAC of Operators in a cluster. Deployed
by default in OpenShift Enterprise 4.</p>
</dd>
<dt class="hdlist1">Operator Metering</dt>
<dd>
<p>Collects operational metrics about Operators on the cluster for Day 2 management
and aggregating usage metrics.</p>
</dd>
<dt class="hdlist1">OperatorHub</dt>
<dd>
<p>Web console for discovering and installing Operators on your cluster. Deployed
by default in OpenShift Enterprise 4.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>These tools are designed to be composable, so you can use any that are useful to
you.</p>
</div>
</div>
<div class="sect3">
<h4 id="olm-maturity-model-olm-what-operators-are">Operator maturity model</h4>
<div class="paragraph">
<p>The level of sophistication of the management logic encapsulated within an
Operator can vary. This logic is also in general highly dependent on the type of
the service represented by the Operator.</p>
</div>
<div class="paragraph">
<p>One can however generalize the scale of the maturity of an Operator&#8217;s
encapsulated operations for certain set of capabilities that most Operators can
include. To this end, the following Operator Maturity model defines five phases
of maturity for generic day two operations of an Operator:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/operator-maturity-model.png" alt="operator maturity model">
</div>
<div class="title">Figure 1. Operator maturity model</div>
</div>
<div class="paragraph">
<p>The above model also shows how these capabilities can best be developed through
the Operator Framework’s Helm, Go, and Ansible capabilities.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding-operators-to-a-cluster">Adding Operators to a cluster</h3>
<div class="paragraph">
<p>This guide outlines the architecture of the Operator Lifecycle Manager (OLM) and
OperatorHub and walks cluster administrators through an example of installing
Operators to a cluster.</p>
</div>
<div class="sect3">
<h4 id="olm-operator-lifecycle-manager-olm-adding-operators-to-a-cluster">Understanding the Operator Lifecycle Manager</h4>
<div class="paragraph">
<p>In OpenShift Enterprise 4.0, the <em>Operator Lifecycle Manager</em> (OLM) helps users
install, update, and manage the lifecycle of all Operators and their associated
services running across their clusters. It is part of the
<a href="https://github.com/operator-framework">Operator Framework</a>,
an open source toolkit designed to manage Kubernetes native applications
(Operators) in an effective, automated, and scalable way.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/olm-workflow.png" alt="olm workflow">
</div>
<div class="title">Figure 2. Operator Lifecycle Manager workflow</div>
</div>
<div class="paragraph">
<p>The OLM runs by default in OpenShift Enterprise 4.0, which aids cluster
administrators in installing, upgrading, and granting access to Operators
running on their cluster. The OpenShift Enterprise web console provides management
screens for cluster administrators to install Operators, as well as grant
specific projects access to use the catalog of Operators available on the
cluster.</p>
</div>
<div class="paragraph">
<p>For developers, a self-service experience allows provisioning and configuring
instances of databases, monitoring, and big data services without having to be
subject matter experts, because the Operator has that knowledge baked into it.</p>
</div>
<div class="sect4">
<h5 id="olm-csv-olm-adding-operators-to-a-cluster">ClusterServiceVersions (CSVs)</h5>
<div class="paragraph">
<p>A <em>ClusterServiceVersion</em> (CSV) is a YAML manifest created from Operator
metadata that assists the OLM in running the Operator in a cluster. It is the
metadata that accompanies an Operator container image, used to populate user
interfaces with information like its logo, description, and version. It is also
a source of technical information needed to run the Operator, like the RBAC
rules it requires and which Custom Resources (CRs) it manages or depends on.</p>
</div>
<div class="paragraph">
<p>A CSV is composed of:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Metadata</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Application metadata:</p>
<div class="ulist">
<ul>
<li>
<p>Name, description, version, links, labels, icon, etc.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Install strategy</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Type: Deployment</p>
<div class="ulist">
<ul>
<li>
<p>Set of service accounts and required permissions</p>
</li>
<li>
<p>Set of Deployments.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">CRDs</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Type</p>
</li>
<li>
<p>Owned: Managed by this service</p>
</li>
<li>
<p>Required: Must exist in the cluster for this service to run</p>
</li>
<li>
<p>Resources: A list of resources that the Operator interacts with</p>
</li>
<li>
<p>Descriptors: Annotate CRD spec and status fields to provide semantic information</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="olm-architecture-olm-adding-operators-to-a-cluster">Architecture</h5>
<div class="paragraph">
<p>The Operator Lifecycle Manager is composed of two Operators: the OLM Operator
and the Catalog Operator.</p>
</div>
<div class="paragraph">
<p>Each of these Operators are responsible for managing the CRDs that are the basis
for the OLM framework:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. CRDs managed by OLM and Catalog Operators</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 66.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Resource</th>
<th class="tableblock halign-left valign-top">Short name</th>
<th class="tableblock halign-left valign-top">Owner</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>ClusterServiceVersion</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>csv</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>OLM</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Application metadata: name, version, icon, required resources, installation,
etc.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>InstallPlan</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>ip</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Catalog</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Calculated list of resources to be created in order to automatically install or
upgrade a CSV.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>CatalogSource</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>catsrc</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Catalog</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A repository of CSVs, CRDs, and packages that define an application.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Subscription</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>sub</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Catalog</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Used to keep CSVs up to date by tracking a channel in a package.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>OperatorGroup</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>og</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>OLM</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Method to group multiple namespaces and prepare for use by an Operator.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Each of these Operators are also responsible for creating resources:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Resources created by OLM and Catalog Operators</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Resource</th>
<th class="tableblock halign-left valign-top">Owner</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deployments</p></td>
<td class="tableblock halign-left valign-middle" rowspan="4"><p class="tableblock">OLM</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceAccounts</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Cluster)Roles</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Cluster)RoleBindings</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom Resource Definitions (CRDs)</p></td>
<td class="tableblock halign-left valign-middle" rowspan="2"><p class="tableblock">Catalog</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ClusterServiceVersions (CSVs)</p></td>
</tr>
</tbody>
</table>
<div class="sect5">
<h6 id="olm-architecture-olm-operator-olm-adding-operators-to-a-cluster">OLM Operator</h6>
<div class="paragraph">
<p>The OLM Operator is responsible for deploying applications defined by CSV
resources after the required resources specified in the CSV are present in the
cluster.</p>
</div>
<div class="paragraph">
<p>The OLM Operator is not concerned with the creation of the required resources;
users can choose to manually create these resources using the CLI, or users can
choose to create these resources using the Catalog Operator. This separation of
concern enables users incremental buy-in in terms of how much of the OLM
framework they choose to leverage for their application.</p>
</div>
<div class="paragraph">
<p>While the OLM Operator is often configured to watch all namespaces, it can also
be operated alongside other OLM Operators so long as they all manage separate
namespaces.</p>
</div>
<div class="ulist">
<div class="title">OLM Operator workflow</div>
<ul>
<li>
<p>Watches for ClusterServiceVersion (CSVs) in a namespace and checks that
requirements are met. If so, runs the install strategy for the CSV.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="olm-architecture-catalog-operator-olm-adding-operators-to-a-cluster">Catalog Operator</h6>
<div class="paragraph">
<p>The Catalog Operator is responsible for resolving and installing CSVs and the
required resources they specify. It is also responsible for watching
CatalogSources for updates to packages in channels and upgrading them
(optionally automatically) to the latest available versions.</p>
</div>
<div class="paragraph">
<p>A user that wishes to track a package in a channel creates a Subscription
resource configuring the desired package, channel, and the CatalogSource from
which to pull updates. When updates are found, an appropriate InstallPlan is
written into the namespace on behalf of the user.</p>
</div>
<div class="paragraph">
<p>Users can also create an InstallPlan resource directly, containing the names of
the desired CSV and an approval strategy, and the Catalog Operator creates an
execution plan for the creation of all of the required resources. After it is
approved, the Catalog Operator creates all of the resources in an InstallPlan;
this then independently satisfies the OLM Operator, which proceeds to install
the CSVs.</p>
</div>
<div class="ulist">
<div class="title">Catalog Operator workflow</div>
<ul>
<li>
<p>Has a cache of CRDs and CSVs, indexed by name.</p>
</li>
<li>
<p>Watches for unresolved InstallPlans created by a user:</p>
<div class="ulist">
<ul>
<li>
<p>Finds the CSV matching the name requested and adds it as a resolved resource.</p>
</li>
<li>
<p>For each managed or required CRD, adds it as a resolved resource.</p>
</li>
<li>
<p>For each required CRD, finds the CSV that manages it.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Watches for resolved InstallPlans and creates all of the discovered resources for it (if approved by a user or automatically).</p>
</li>
<li>
<p>Watches for CatalogSources and Subscriptions and creates InstallPlans based on them.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="olm-architecture-catalog-registry-olm-adding-operators-to-a-cluster">Catalog Registry</h6>
<div class="paragraph">
<p>The Catalog Registry stores CSVs and CRDs for creation in a cluster and stores
metadata about packages and channels.</p>
</div>
<div class="paragraph">
<p>A <em>package manifest</em> is an entry in the Catalog Registry that associates a
package identity with sets of CSVs. Within a package, channels point to a
particular CSV. Because CSVs explicitly reference the CSV that they replace, a
package manifest provides the Catalog Operator all of the information that is
required to update a CSV to the latest version in a channel (stepping through
each intermediate version).</p>
</div>
</div>
<div class="sect5">
<h6 id="olm-architecture-operatorgroups-olm-adding-operators-to-a-cluster">OperatorGroups</h6>
<div class="paragraph">
<p>The goal of <em>OperatorGroups</em> is to bring multitenancy features to running
Operators in a cluster in the easiest, most automated way.</p>
</div>
<div class="paragraph">
<p>An OperatorGroup consists of a group of target namespaces as specified by the
label selector in the spec, plus the namespace that the OperatorGroup is created
within, known as the <em>Operator namespace</em>. The Operator namespace is always
considered to also be a target namespace, without regard to matching the label
selector. The Operator namespace is where the Operator actually runs and the
target namespace(s) are namespaces within which the Operator has permissions to
operate.</p>
</div>
<div class="paragraph">
<p>After an OperatorGroup has been created, the focus is around the target
namespaces and the resources contained in those namespaces. The status for an
OperatorGroup is constantly updated to always list the namespaces matching the
label selector as specified in the spec. In addition to maintaining an updated
status, the OperatorGroup control loop also maintains creating RBAC rules and
providing OperatorGroup knowledge to Operators. Some operations, such as copying
CSVs and creating additional RBAC rules, are handled by the CSV control loop.</p>
</div>
<div class="paragraph">
<p>RBAC rules are created to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Restrict access to the API (CRDs) of the installed Operators. It is possible
that the administrator does not want the full functionality of the Operator to
be granted in all cases.</p>
</li>
<li>
<p>Give the Operator the necessary permissions to operate. This is tied to the
specified OperatorGroup service account.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>OperatorGroup target namespace information is made available to Operators via
annotations on the Deployment. Each CSV in the Operator namespace is copied into
the target namespace(s), which is done in case a user does not have access to
the Operator namespace. The copied CSV is annotated with the OperatorGroup name
and the Operator namespace (the target namespace list is intentionally not
included for security reasons).</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="olm-operatorhub-olm-adding-operators-to-a-cluster">Understanding the OperatorHub</h4>
<div class="paragraph">
<p>The <em>OperatorHub</em> is available via the OpenShift Enterprise web console and is the
interface that cluster administrators use to discover and install Operators.
With one click, an Operator can be pulled from their off-cluster source,
installed and subscribed on the cluster, and made ready for engineering teams to
self-service manage the product across deployment environments using the
Operator Lifecycle Manager (OLM).</p>
</div>
<div class="paragraph">
<p>Cluster administrators can choose from OperatorSources grouped into
the following categories:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Category</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Red Hat Operators</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Red Hat products packaged and shipped by Red Hat. Supported by Red Hat.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Certified Operators</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Products from leading independent software vendors (ISVs). Red Hat partners with
ISVs to package and ship. Supported by the ISV.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Community Operators</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Optionally-visible software maintained by relevant representatives in the
<a href="https://github.com/operator-framework/community-operators">operator-framework/community-operators</a>
GitHub repository. No official support.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Custom Operators</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Operators you add to the cluster yourself.
If you have not added any Custom Operators, the Custom category does not appear in
the Web console on your OperatorHub.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The OperatorHub component is installed and run as an Operator by default on
OpenShift Enterprise in the <code>openshift-marketplace</code> namespace.</p>
</div>
<div class="sect4">
<h5 id="olm-operatorhub-arch-olm-adding-operators-to-a-cluster">Architecture</h5>
<div class="paragraph">
<p>The OperatorHub component&#8217;s Operator manages two Custom Resource Definitions
(CRDs): an
<a href="https://github.com/operator-framework/operator-marketplace/blob/master/deploy/crds/operatorsource.crd.yaml">OperatorSource</a>
and a
<a href="https://github.com/operator-framework/operator-marketplace/blob/master/deploy/crds/catalogsourceconfig.crd.yaml">CatalogSourceConfig</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Although some OperatorSource and CatalogSourceConfig information is exposed
through the OperatorHub user interface, those files are only used directly
by those who are creating their own Operators.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="olm-operatorhub-arch-operatorsource-olm-adding-operators-to-a-cluster">OperatorSource</h6>
<div class="paragraph">
<p>For each Operator, the OperatorSource is used to define the external data store
used to store Operator bundles. A
<a href="https://github.com/operator-framework/operator-marketplace/blob/master/deploy/examples/community.operatorsource.cr.yaml">simple OperatorSource</a>
includes:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>type</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>To identify the data store as an application registry, <code>type</code> is set to <code>appregistry</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>endpoint</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Currently, Quay is the external data store used by the OperatorHub, so
the endpoint is set to <code>https:/quay.io/cnr</code> for the Quay.io <code>appregistry</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>registryNamespace</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>For a Community Operator, this is set to <code>community-operator</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>displayName</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Optionally set to a name that appears in the OperatorHub user interface for the
Operator.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>publisher</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Optionally set to the person or organization publishing the Operator, so it
can be displayed on the OperatorHub.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="olm-operatorhub-arch-catalogsourceconfig-olm-adding-operators-to-a-cluster">CatalogSourceConfig</h6>
<div class="paragraph">
<p>An Operator&#8217;s CatalogSourceConfig is used to enable an Operator present in the
OperatorSource on the cluster.</p>
</div>
<div class="paragraph">
<p>A
<a href="https://github.com/operator-framework/operator-marketplace/blob/master/deploy/examples/catalogsourceconfig.cr.yaml">simple CatalogSourceConfig</a>
must identify:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>targetNamespace</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The location where the Operator would be deployed and updated, such as
<code>openshift-operators</code>. This is a namespace that the OLM watches.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>packages</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A comma-separated list of packages that make up the content of the Operator.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="olm-installing-operators-from-operatorhub-olm-adding-operators-to-a-cluster">Installing Operators from the OperatorHub</h4>
<div class="paragraph">
<p>As a cluster administrator, you can install an Operator from the OperatorHub
using the OpenShift Enterprise web console or the CLI. You can then subscribe the
Operator to one or more namespaces to make it available for developers on your
cluster.</p>
</div>
<div class="paragraph">
<p>During installation, you must determine the following initial settings for the
Operator:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Installation Mode</dt>
<dd>
<p>Choose "All namespaces on the cluster (default)"
to have the operator installed on all namespaces or choose individual
namespaces, if available, to only install the Operator on selected namespaces.
This example chooses
"All namespaces" to make the Operator available to all users and projects.</p>
</dd>
<dt class="hdlist1">Update Channel</dt>
<dd>
<p>If an Operator is available through multiple channels, you can
choose which channel you want to subscribe to. For example, to deploy from the
<strong>stable</strong> channel, if available, select it from the list.</p>
</dd>
<dt class="hdlist1">Approval Strategy</dt>
<dd>
<p>You can choose Automatic or Manual updates. If you choose
Automatic updates for an installed Operator, when a new version of that Operator
is available, the OLM automatically upgrades the running instance of your
Operator without human intervention. If you select Manual updates, when a newer
version of an Operator is available, the OLM creates an update request. As a
cluster administrator, you must then manually approve that update request to
have the Operator updated to the new version.</p>
</dd>
</dl>
</div>
<div class="sect4">
<h5 id="olm-installing-from-operatorhub-using-web-console-olm-adding-operators-to-a-cluster">Installing from the OperatorHub using the web console</h5>
<div class="paragraph">
<p>This procedure uses the Couchbase Operator as an example to install and subscribe to
an Operator from the OperatorHub using the OpenShift Enterprise web console.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Access to an OpenShift Enterprise cluster using an account with <code>cluster-admin</code>
permissions.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Navigate in the web console to the <strong>Catalog → OperatorHub</strong> page.</p>
</li>
<li>
<p>Scroll or type a keyword into the <code>Filter by keyword</code> box (in this case, <code>Couchbase</code>) to find the Operator you want.</p>
<div class="imageblock">
<div class="content">
<img src="images/olm-operatorhub.png" alt="olm operatorhub">
</div>
</div>
</li>
<li>
<p>Select the Operator. For a Community Operator, you are warned
that Red Hat does not certify those Operators. You must acknowledge that
warning before continuing. Information about the Operator is displayed.</p>
</li>
<li>
<p>Read the information about the Operator and click <strong>Install</strong>.</p>
</li>
<li>
<p>On the <strong>Create Operator Subscription</strong> page, select:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><strong>All namespaces on the cluster (default)</strong> to install the Operator to all namespaces or
<strong>A specific namespace on the cluster</strong> to choose a specific, single namespace on which to
install the Operator. The <strong>All namespaces&#8230;&#8203;</strong> option is not always available.</p>
</li>
<li>
<p>An <strong>Update Channel</strong> (if more than one is available)</p>
</li>
<li>
<p><strong>Automatic</strong> or <strong>Manual</strong> approval strategy, as described earlier.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Click <strong>Subscribe</strong> to make the Operator available to the selected namespaces on this OpenShift Enterprise cluster.</p>
</li>
<li>
<p>Select <strong>Catalog → Installed Operators</strong> to verify that the <strong>Couchbase</strong>
ClusterServiceVersion (CSV) eventually shows up and its <strong>Status</strong> ultimately
resolves to <strong>InstallSucceeded</strong>.</p>
<div class="paragraph">
<p>If it does not, switch to the <strong>Catalog → Operator Management</strong> page and inspect
the <strong>Operator Subscriptions</strong> and <strong>Install Plans</strong> tabs for any failure or errors
under <strong>Status</strong>. Then, check the logs in any Pods in the <strong>openshift-operators</strong>
project (on the <strong>Workloads → Pods</strong> page) that are reporting issues to
troubleshoot further.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="olm-installing-operator-from-operatorhub-using-cli-olm-adding-operators-to-a-cluster">Installing from the OperatorHub using the CLI</h5>
<div class="paragraph">
<p>Instead of using the OpenShift Enterprise web console, you can install an Operator
from the OperatorHub using the CLI. Use the <code>oc</code> command to create or update a
CatalogSourceConfig object, then add a Subscription object.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The web console version of this procedure handles the creation of the
CatalogSourceConfig and Subscription objects behind the scenes for you,
appearing as if it was one step.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Access to an OpenShift Enterprise cluster using an account with <code>cluster-admin</code>
permissions.</p>
</li>
<li>
<p>Install the <strong>oc</strong> command to your local system.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>View the list of Operators available to the cluster from the OperatorHub:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get packagemanifests -n openshift-marketplace
NAME                     AGE
amq-streams              14h
packageserver            15h
couchbase-enterprise     14h
mongodb-enterprise       14h
etcd                     14h
myoperator               14h
...</pre>
</div>
</div>
</li>
<li>
<p>To identify the Operators to enable on the cluster, create a CatalogSourceConfig
object YAML file (for example, <code>csc.cr.yaml</code>). Include one or more packages
listed in the previous step (such as couchbase-enterprise or etcd). For example:</p>
<div class="listingblock">
<div class="title">Example CatalogSourceConfig</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: operators.coreos.com/v1
kind: CatalogSourceConfig
metadata:
  name: example
  namespace: openshift-marketplace
spec:
  targetNamespace: openshift-operators <b class="conum">(1)</b>
  packages: myoperator <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Set the <code>targetNamespace</code> to identify the namespace where you want the Operator
to be available. The <code>openshift-operators</code> namespace is watched by the Operator
Lifecycle Manager (OLM).</p>
</li>
<li>
<p>Set <code>packages</code> to a comma-separated list of Operators to which you want to
subscribe.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Operator generates a CatalogSource from your CatalogSourceConfig in the
namespace specified in <code>targetNamespace</code>.</p>
</div>
</li>
<li>
<p>Create the CatalogSourceConfig to enable the specified Operators in the selected
namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc apply -f csc.cr.yaml</pre>
</div>
</div>
</li>
<li>
<p>Create a Subscription object YAML file (for example, <code>myoperator-sub.yaml</code>) to
subscribe a namespace to an Operator. Note that the namespace you pick
must have an OperatorGroup that matches the installMode (either AllNamespaces or
SingleNamespace modes):</p>
<div class="listingblock">
<div class="title">Example Subscription</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: myoperator
  namespace: openshift-operators
spec:
  channel: alpha
  name: myoperator <b class="conum">(1)</b>
  source: example <b class="conum">(2)</b>
  sourceNamespace: openshift-operators</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Name of the Operator to subscribe to.</p>
</li>
<li>
<p>Name of the CatalogSource that was created.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create the Subscription object:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc apply -f myoperator-sub.yaml</pre>
</div>
</div>
<div class="paragraph">
<p>At this point, the OLM is now aware of the selected Operator. A
ClusterServiceVersion (CSV) for the Operator should appear in the target
namespace, and APIs provided by the Operator should be available for creation.</p>
</div>
</li>
<li>
<p>Later, if you want to install more Operators:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Update your CatalogSourceConfig file (in this example, <code>csc.cr.yaml</code>) with
more packages. For example:</p>
<div class="listingblock">
<div class="title">Example updated CatalogSourceConfig</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: operators.coreos.com/v1
kind: CatalogSourceConfig
metadata:
  name: example
  namespace: openshift-marketplace
spec:
  targetNamespace: global
  packages: myoperator,another-operator <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Add new packages to existing package list.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Update the CatalogSourceConfig object:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc apply -f csc.cr.yaml</pre>
</div>
</div>
</li>
<li>
<p>Create additional Subscription objects for the new Operators.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>To install custom Operators to a cluster using the OperatorHub, you must first
upload your Operator artifacts to Quay.io, then add your own <code>OperatorSource</code> to
your cluster. Optionally, you can add Secrets to your Operator to provide
authentication. After, you can manage the Operator in your cluster as you would
any other Operator. For these steps, see <a href="https://github.com/operator-framework/community-operators/blob/master/docs/testing-operators.md">Testing Operators</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="olm-deleting-operators-from-a-cluster">Deleting Operators from a cluster</h3>
<div class="paragraph">
<p>To delete (uninstall) an Operator from your cluster, you can simply
delete the subscription to remove it from the subscribed namespace.
If you want a clean slate, you can also remove the operator CSV and
deployment, then delete Operator&#8217;s entry in the CatalogSourceConfig.
The following text describes how to delete Operators from a cluster
using either the web console or the command line.</p>
</div>
<div class="sect3">
<h4 id="olm-deleting-operators-from-a-cluster-using-web-console-olm-deleting-operators-from-a-cluster">Deleting Operators from a cluster using the web console</h4>
<div class="paragraph">
<p>To delete an installed Operator from the selected namespace through the Web console, follow these steps:</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Navigate in the web console to the <strong>Catalog</strong> → <strong>Operator Management</strong> page.</p>
</li>
<li>
<p>Click the <strong>Operator Subscriptions</strong> tab to see the list of installed Operators
for the namespace.</p>
</li>
<li>
<p>Find the Operator you want to delete (in this example, jaeger) and click
the three-dot drop-down box in far right column.</p>
<div class="imageblock">
<div class="content">
<img src="images/olm-operator-delete.png" alt="olm operator delete">
</div>
</div>
</li>
<li>
<p>Click <strong>Remove Subscription</strong>.</p>
</li>
<li>
<p>When prompted from the <strong>Remove Subscription</strong> pop-up, optionally select the
<code>Also completely remove the jaeger Operator from the selected namespace</code>
checkbox, if you want all components related to the installation to be removed.
This removes the CSV, which in turn removes the pods, the deployments, the
CRDs, and CRs associated with the Operator.</p>
</li>
<li>
<p>Select <strong>Remove</strong>. This Operator will stop running and no longer receive updates.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Although the Operator is no longer installed or receiving updates, that
Operator will still appear on the Operator Catalogs list, ready to re-subscribe. To remove the Operator from that
listing, you can delete the Operator&#8217;s entry in the CatalogSourceConfig
from the command line (as shown in last step of "Deleting operators from a cluster using the CLI").</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="olm-deleting-operator-from-a-cluster-using-cli-olm-deleting-operators-from-a-cluster">Deleting operators from a cluster using the CLI</h4>
<div class="paragraph">
<p>Instead of using the OpenShift Enterprise web console, you can delete an Operator
from your cluster by using the CLI.
You do this by deleting the Subscription and ClusterServiceVersion
from the <code>targetNamespace</code>, then editing the CatalogSourceConfig to remove
the Operator&#8217;s package name.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Access to an OpenShift Enterprise cluster using an account with <code>cluster-admin</code>
permissions.</p>
</li>
<li>
<p>Install the <strong>oc</strong> command on your local system.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>In this example, there are two operators (Jaeger and Descheduler) installed in the
<code>openshift-operators</code> namespace. The goal is to remove Jaeger without removing Descheduler.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Delete the Operator&#8217;s subscription (for example, jaeger):</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc delete subscription jaeger -n openshift-operators
subscription.operators.coreos.com "jaeger" deleted</pre>
</div>
</div>
</li>
<li>
<p>Check the current version of the subscribed Operator (for example, jaeger):</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get subscription jaeger -n openshift-operators -o yaml | grep currentCSV
  currentCSV: jaeger-operator.v1.8.2</pre>
</div>
</div>
</li>
<li>
<p>Delete the CSV for the Operator (jaeger) in the <code>targetNamespace</code> (<code>openshift-operators</code>)</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc delete clusterserviceversion jaeger-operator.v1.8.2 -n openshift-operators
clusterserviceversion.operators.coreos.com "jaeger-operator.v1.8.2" deleted</pre>
</div>
</div>
</li>
<li>
<p>Display the contents of the <code>CatalogSourceConfig</code> resource and review the list
of packages in the <code>spec</code> section:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get catalogsourceconfig -n openshift-marketplace \
    installed-community-openshift-operators -o yaml</pre>
</div>
</div>
<div class="paragraph">
<p>For example, the spec section might appear as follows:</p>
</div>
<div class="listingblock">
<div class="title">Example of CatalogSourceConfig</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  csDisplayName: Community Operators
  csPublisher: Community
  packages: jaeger,descheduler
  targetNamespace: openshift-operators</code></pre>
</div>
</div>
</li>
<li>
<p>Remove the Operator from the CatalogSourceConfig in one of two ways:</p>
<div class="ulist">
<ul>
<li>
<p>If you have multiple Operators, edit the CatalogSourceConfig resource and remove the Operator&#8217;s package:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc edit catalogsourceconfig -n openshift-marketplace \
    installed-community-openshift-operators</pre>
</div>
</div>
<div class="paragraph">
<p>Remove the package from the <code>packages</code> line, as shown:</p>
</div>
<div class="listingblock">
<div class="title">Example of modified packages in CatalogSourceConfig</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">  packages: descheduler</code></pre>
</div>
</div>
<div class="paragraph">
<p>Save the change and the marketplace-operator will reconcile the CatalogSourceConfig.</p>
</div>
</li>
<li>
<p>If there is only one Operator in the CatalogSourceConfig, you can remove it
by simply deleting the entire CatalogSourceConfig as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc delete catalogsourceconfig -n openshift-marketplace \
    installed-community-openshift-operators</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-applications-from-installed-operators">Creating applications from installed Operators</h3>
<div class="paragraph">
<p>This guide walks developers through an example of creating applications from an
installed Operator using the OpenShift Enterprise 4.0 web console.</p>
</div>
<div class="sect3">
<h4 id="olm-creating-etcd-cluster-from-operator-olm-creating-apps-from-installed-operators">Creating an etcd cluster using an Operator</h4>
<div class="paragraph">
<p>This procedure walks through creating a new etcd cluster using the etcd
Operator, managed by the Operator Lifecycle Manager (OLM).</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Access to an OpenShift Enterprise 4.0 cluster</p>
</li>
<li>
<p>etcd Operator already installed to the cluster by an administrator</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a new project in the OpenShift Enterprise web console for this procedure. This
example uses a project called <strong>my-etcd</strong>.</p>
</li>
<li>
<p>Navigate to the <strong>Catalogs &#8594; Installed Operators</strong> page. The Operators that have
been installed to the cluster by the cluster administrator and are available for
use are shown here as a list of ClusterServiceVersions (CSVs). CSVs are used to
launch and manage the software provided by the Operator.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can get this list from the CLI using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get csv</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>On the <strong>Installed Operators</strong> page, click on the etcd Operator to view more
details and available actions:</p>
<div class="imageblock">
<div class="content">
<img src="images/etcd-operator-overview.png" alt="etcd operator overview">
</div>
<div class="title">Figure 3. etcd Operator overview</div>
</div>
<div class="paragraph">
<p>As shown under <strong>Provided APIs</strong>, this Operator makes available three new resource
types, including one for an <strong>etcd Cluster</strong> (the <code>EtcdCluster</code> resource). These
objects work similar to the built-in native Kubernetes ones, such as
<code>Deployments</code> or <code>ReplicaSets</code>, but contain logic specific to managing etcd.</p>
</div>
</li>
<li>
<p>Create a new etcd cluster:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the <strong>etcd Cluster</strong> API box, click <strong>Create New</strong>.</p>
</li>
<li>
<p>The next screen allows you to make any modifications to the minimal starting
template of an <code>EtcdCluster</code> object, such as the size of the cluster. For now,
click <strong>Create</strong> to finalize. This triggers the Operator to start up the Pods,
Services, and other components of the new etcd cluster.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Click the <strong>Resources</strong> tab to see that your project now contains a number of
resources created and configured automatically by the Operator.</p>
<div class="imageblock">
<div class="content">
<img src="images/etcd-operator-resources.png" alt="etcd operator resources">
</div>
<div class="title">Figure 4. etcd Operator resources</div>
</div>
<div class="paragraph">
<p>Verify that a Kubernetes service has been created that allows you to access the
database from other Pods in your project.</p>
</div>
</li>
<li>
<p>All users with the <code>edit</code> role in a given project can create, manage, and delete
application instances (an etcd cluster, in this example) managed by Operators
that have already been created in the project, in a self-service manner, just
like a cloud service. If you want to enable additional users with this ability,
project administrators can add the role using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc policy add-role-to-user edit &lt;user&gt; -n &lt;target_project&gt;</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You now have an etcd cluster that will react to failures and rebalance data as
Pods become unhealthy or are migrated between nodes in the cluster. Most
importantly, cluster administrators or developers with proper access can now
easily use the database with their applications.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_service-brokers">Service brokers</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="installing-the-service-catalog">Installing the service catalog</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>The service catalog is deprecated in OpenShift Enterprise 4. Equivalent and better
functionality is present in the Operator Framework and Operator Lifecycle
Manager (OLM).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="sb-about-service-catalog-sb-installing-service-catalog">About the service catalog</h4>
<div class="paragraph">
<p>When developing microservices-based applications to run on cloud native
platforms, there are many ways to provision different resources and share their
coordinates, credentials, and configuration, depending on the service
provider and the platform.</p>
</div>
<div class="paragraph">
<p>To give developers a more seamless experience, OpenShift Enterprise includes a
<em>service catalog</em>, an implementation of the
<a href="https://openservicebrokerapi.org/">Open Service Broker API</a> (OSB API) for
Kubernetes. This allows users to connect any of their applications deployed in
OpenShift Enterprise to a wide variety of service brokers.</p>
</div>
<div class="paragraph">
<p>The service catalog allows cluster administrators to integrate multiple
platforms using a single API specification. The OpenShift Enterprise web console
displays the cluster service classes offered by service brokers in the service
catalog, allowing users to discover and instantiate those services for use with
their applications.</p>
</div>
<div class="paragraph">
<p>As a result, service users benefit from ease and consistency of use across
different types of services from different providers, while service providers
benefit from having one integration point that gives them access to multiple
platforms.</p>
</div>
<div class="paragraph">
<p>The service catalog is not installed by default in OpenShift Enterprise 4.</p>
</div>
</div>
<div class="sect3">
<h4 id="sb-install-service-catalog-sb-installing-service-catalog">Installing service catalog</h4>
<div class="paragraph">
<p>If you plan on using any of the services from the OpenShift Ansible Broker or Template Service Broker, you must install the service catalog by completing the following steps.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Enable the service catalog API server.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Use the following command to edit the service catalog API server resource.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc edit servicecatalogapiservers</pre>
</div>
</div>
</li>
<li>
<p>Under <code>spec</code>, set the <code>managementState</code> field to <code>Managed</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  logLevel: Normal
  managementState: Managed</code></pre>
</div>
</div>
</li>
<li>
<p>Save the file to apply the changes.</p>
<div class="paragraph">
<p>The Operator installs the service catalog API server component. As of
OpenShift Enterprise 4, this component is installed into the
<code>openshift-service-catalog-apiserver</code> namespace.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Enable the service catalog controller manager.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Use the following command to edit the service catalog controller manager resource.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc edit servicecatalogcontrollermanagers</pre>
</div>
</div>
</li>
<li>
<p>Under <code>spec</code>, set the <code>managementState</code> field to <code>Managed</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  logLevel: Normal
  managementState: Managed</code></pre>
</div>
</div>
</li>
<li>
<p>Save the file to apply the changes.</p>
<div class="paragraph">
<p>The Operator installs the service catalog controller manager component. As of
OpenShift Enterprise 4, this component is installed into the
<code>openshift-service-catalog-controller-manager</code> namespace.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="installing-the-template-service-broker">Installing the Template Service Broker</h3>
<div class="paragraph">
<p>You can install the Template Service Broker to gain access to the template
applications that it provides.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>The Template Service Broker is deprecated in OpenShift Enterprise 4. Equivalent and better
functionality is present in the Operator Framework and Operator Lifecycle
Manager (OLM).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#sb-install-service-catalog-sb-installing-service-catalog">Install the service catalog</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="sb-about-template-service-broker-sb-installing-tsb">About the Template Service Broker</h4>
<div class="paragraph">
<p>The <em>Template Service Broker</em> gives the service catalog visibility into the
default Instant App and Quickstart templates that have shipped with
OpenShift Enterprise since its initial release. The Template Service Broker can also
make available as a service anything for which an OpenShift Enterprise template has
been written, whether provided by Red Hat, a cluster administrator or user, or a third-party vendor.</p>
</div>
<div class="paragraph">
<p>By default, the Template Service Broker shows objects that are globally
available from the <code>openshift</code> project. It can also be configured to watch any
other project that a cluster administrator chooses.</p>
</div>
<div class="paragraph">
<p>The Template Service Broker is not installed by default in OpenShift Enterprise 4.</p>
</div>
</div>
<div class="sect3">
<h4 id="sb-install-tsb-operator-sb-installing-tsb">Installing the Template Service Broker Operator</h4>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have installed the service catalog.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>The following procedure installs the Template Service Broker Operator using the
web console.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a namespace.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate in the web console to <strong>Administration</strong> &#8594; <strong>Namespaces</strong> and click <strong>Create Namespace</strong>.</p>
</li>
<li>
<p>Enter <code>openshift-template-service-broker</code> in the <strong>Name</strong> field and click <strong>Create</strong>.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The namespace must start with <code>openshift-</code>.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Navigate to the <strong>Catalog</strong> &#8594; <strong>OperatorHub</strong> page. Verify that the <code>openshift-template-service-broker</code> project is selected.</p>
</li>
<li>
<p>Select <strong>Template Service Broker Operator</strong>.</p>
<div class="paragraph">
<p>A pop-up window appears, warning you that you are installing a Community
Operator. Click <strong>Continue</strong> to acknowledge the <strong>Show Community Operator</strong> warning.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This Operator will be available under the <strong>Red Hat</strong> category in the GA release.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Read the information about the Operator and click <strong>Install</strong>.</p>
</li>
<li>
<p>Review the default selections and click <strong>Subscribe</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Next, you must start the Template Service Broker in order to access the template
applications it provides.</p>
</div>
</div>
<div class="sect3">
<h4 id="sb-start-tsb-sb-installing-tsb">Starting the Template Service Broker</h4>
<div class="paragraph">
<p>After you have installed the Template Service Broker Operator, you can start the
Template Service Broker using the following procedure.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have installed the service catalog.</p>
</li>
<li>
<p>You have installed the Template Service Broker Operator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Navigate in the web console to <strong>Catalog</strong> &#8594; <strong>Installed Operators</strong> and select the <code>openshift-template-service-broker</code> project.</p>
</li>
<li>
<p>Select the <strong>Template Service Broker Operator</strong>.</p>
</li>
<li>
<p>Under <strong>Provided APIs</strong>, click <strong>Create New</strong> for <strong>Template Service Broker</strong>.</p>
</li>
<li>
<p>Review the default YAML and click <strong>Create</strong>.</p>
</li>
<li>
<p>Verify that the Template Service Broker has started.</p>
<div class="paragraph">
<p>After the Template Service Broker has started, you can view the available
template applications by navigating to <strong>Catalog</strong> &#8594; <strong>Developer Catalog</strong> and
selecting the <strong>Service Class</strong> checkbox. Note that it may take a few minutes for
the Template Service Broker to start and the template applications to be
available.</p>
</div>
<div class="paragraph">
<p>If you do not yet see these Service classes, you can check the status of the
following items:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Template Service Broker Pod status</p>
<div class="ulist">
<ul>
<li>
<p>From the <strong>Workloads</strong> &#8594; <strong>Pods</strong> page for the <strong>openshift-template-service-broker</strong>
project, verify that the Pod that starts with <code>apiserver-</code> has a status of
<strong>Running</strong> and readiness of <strong>Ready</strong>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cluster service broker status</p>
<div class="ulist">
<ul>
<li>
<p>From the <strong>Catalog</strong> &#8594; <strong>Broker Management</strong> &#8594; <strong>Service Brokers</strong> page, verify
that the <strong>template-service-broker</strong> service broker has a status of <strong>Ready</strong>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Service catalog controller manager Pod logs</p>
<div class="ulist">
<ul>
<li>
<p>From the <strong>Workloads</strong> &#8594; <strong>Pods</strong> page for the
<strong>openshift-service-catalog-controller-manager</strong> project, review the logs for
each of the Pods and verify that you see a log entry with the message
<code>Successfully fetched catalog entries from broker</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="provisioning-template-applications">Provisioning template applications</h3>
<div class="sect3">
<h4 id="sb-provision-template-application-sb-provisioning-template-application">Provisioning template applications</h4>
<div class="paragraph">
<p>The following procedure provisions an example PostgreSQL template application
that was made available by the Template Service Broker.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The service catalog is installed.</p>
</li>
<li>
<p>The Template Service Broker is installed.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a project.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate in the web console to <strong>Home</strong> &#8594; <strong>Projects</strong> and click
<strong>Create Project</strong>.</p>
</li>
<li>
<p>Enter <code>test-postgresql</code> in the <strong>Name</strong> field and click <strong>Create</strong>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create a service instance.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to the <strong>Catalog</strong> &#8594; <strong>Developer Catalog</strong> page.</p>
</li>
<li>
<p>Select the <strong>PostgreSQL (Ephemeral)</strong> template application and click
<strong>Create Service Instance</strong>.</p>
</li>
<li>
<p>Review the default selections and set any other required fields, and click
<strong>Create</strong>.</p>
</li>
<li>
<p>Go to <strong>Catalog</strong> &#8594; <strong>Provisioned Services</strong> and verify that the
<strong>postgresql-ephemeral</strong> service instance is created and has a status of <strong>Ready</strong>.</p>
<div class="paragraph">
<p>You can check the progress on the <strong>Home</strong> &#8594; <strong>Events</strong> page. After a few moments,
you should see an event for <strong>postgresql-ephemeral</strong> with the message "The
instance was provisioned successfully".</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Create a service binding.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>From the <strong>Provisioned Services</strong> page, click <strong>postgresql-ephemeral</strong> and click
<strong>Create Service Binding</strong>.</p>
</li>
<li>
<p>Review the default service binding name and click <strong>Create</strong>.</p>
<div class="paragraph">
<p>This creates a new secret for binding using the name provided.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Review the secret that was created.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to <strong>Workloads</strong> &#8594; <strong>Secrets</strong> and verify that a secret named
<strong>postgresql-ephemeral</strong> was created.</p>
</li>
<li>
<p>Click <strong>postgresql-ephemeral</strong> and review the key-value pairs in the <strong>Data</strong>
section, which are used for binding to other apps.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="uninstalling-the-template-service-broker">Uninstalling the Template Service Broker</h3>
<div class="paragraph">
<p>You can uninstall the Template Service Broker if you no longer need access to the template
applications that it provides.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>The Template Service Broker is deprecated in OpenShift Enterprise 4. Equivalent and better
functionality is present in the Operator Framework and Operator Lifecycle
Manager (OLM).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="sb-uninstall-tsb-sb-uninstalling-tsb">Uninstalling the Template Service Broker</h4>
<div class="paragraph">
<p>The following procedure uninstalls the Template Service Broker and its Operator using the
web console.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Do not uninstall the Template Service Broker if there are any provisioned services from it in your cluster, otherwise you might encounter errors when trying to manage the services.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Template Service Broker is installed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>This procedure assumes that you installed the Template Service Broker into the
<code>openshift-template-service-broker</code> project.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Uninstall the Template Service Broker.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to <strong>Catalog</strong> &#8594; <strong>Installed Operators</strong> and select the
<strong>openshift-template-service-broker</strong> project from the drop-down menu.</p>
</li>
<li>
<p>Click <strong>Template Service Broker Operator</strong>.</p>
</li>
<li>
<p>Select the <strong>Template Service Broker</strong> tab.</p>
</li>
<li>
<p>Click <strong>template-service-broker</strong>.</p>
</li>
<li>
<p>From the <strong>Actions</strong> drop-down menu, select <strong>Delete Template Service Broker</strong>.</p>
</li>
<li>
<p>Click <strong>Delete</strong> from the confirmation pop-up window.</p>
<div class="paragraph">
<p>The Template Service Broker is now uninstalled, and template applications will soon be
removed from the Developer Catalog.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Uninstall the Template Service Broker Operator.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to <strong>Catalog</strong> &#8594; <strong>Operator Management</strong> and select the
<strong>openshift-template-service-broker</strong> project from the drop-down menu.</p>
</li>
<li>
<p>Click <strong>View subscription</strong> for the <strong>Template Service Broker Operator</strong>.</p>
</li>
<li>
<p>Select <strong>templateservicebroker</strong>.</p>
</li>
<li>
<p>From the <strong>Actions</strong> drop-down menu, select <strong>Remove Subscription</strong>.</p>
</li>
<li>
<p>Verify that the checkbox is checked next to <strong>Also completely remove the templateservicebroker Operator from the selected namespace</strong> and click <strong>Remove</strong>.</p>
<div class="paragraph">
<p>The Template Service Broker Operator is no longer installed in your cluster.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>After the Template Service Broker is uninstalled, users will no longer have access to the
template applications provided by the Template Service Broker.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="installing-the-openshift-ansible-broker">Installing the OpenShift Ansible Broker</h3>
<div class="paragraph">
<p>You can install the OpenShift Ansible Broker to gain access to the service bundles that it
provides.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>The OpenShift Ansible Broker is deprecated in OpenShift Enterprise 4. Equivalent and better
functionality is present in the Operator Framework and Operator Lifecycle
Manager (OLM).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#sb-install-service-catalog-sb-installing-service-catalog">Install the service catalog</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="sb-about-ansible-service-broker-sb-installing-asb">About the OpenShift Ansible Broker</h4>
<div class="paragraph">
<p>The <em>OpenShift Ansible Broker</em> is an implementation of the Open Service Broker (OSB) API that
manages applications defined by <em>Ansible playbook bundles</em> (APBs). APBs provide
a method for defining and distributing container applications in
OpenShift Enterprise, and consist of a bundle of Ansible playbooks built into a
container image with an Ansible runtime. APBs leverage Ansible to create a
standard mechanism to automate complex deployments.</p>
</div>
<div class="paragraph">
<p>The OpenShift Ansible Broker follows this basic workflow:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A user requests the list of available applications from the service catalog
using the OpenShift Enterprise web console.</p>
</li>
<li>
<p>The service catalog requests the list of available applications from the OpenShift Ansible Broker.</p>
</li>
<li>
<p>The OpenShift Ansible Broker communicates with a defined container image registry to learn
which APBs are available.</p>
</li>
<li>
<p>The user issues a request to provision a specific APB.</p>
</li>
<li>
<p>The OpenShift Ansible Broker fulfills the user&#8217;s provision request by invoking the provision
method on the APB.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The OpenShift Ansible Broker is not installed by default in OpenShift Enterprise 4.</p>
</div>
<div class="sect4">
<h5 id="sb-ansible-playbook-bundles-sb-installing-asb">Ansible playbook bundles</h5>
<div class="paragraph">
<p>An Ansible playbook bundle (APB) is a lightweight application definition that
allows you to leverage existing investment in Ansible roles and playbooks.</p>
</div>
<div class="paragraph">
<p>APBs use a simple directory with named playbooks to perform OSB API actions,
such as provision and bind. Metadata defined in the <code>apb.yml</code> file contains a
list of required and optional parameters for use during deployment.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://github.com/automationbroker/apb">Ansible playbook bundle repository</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sb-install-asb-operator-sb-installing-asb">Installing the OpenShift Ansible Broker Operator</h4>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have installed the service catalog.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>The following procedure installs the OpenShift Ansible Broker Operator using the web console.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a namespace.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate in the web console to <strong>Administration</strong> &#8594; <strong>Namespaces</strong> and click <strong>Create Namespace</strong>.</p>
</li>
<li>
<p>Enter <code>openshift-ansible-service-broker</code> in the <strong>Name</strong> field and click <strong>Create</strong>.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The namespace must start with <code>openshift-</code>.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Create a cluster role binding.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to <strong>Administration</strong> &#8594; <strong>Role Bindings</strong> and click <strong>Create Binding</strong>.</p>
</li>
<li>
<p>For the <strong>Binding Type</strong>, select <strong>Cluster-wide Role Binding (ClusterRoleBinding)</strong>.</p>
</li>
<li>
<p>For the <strong>Role Binding</strong>, enter <code>ansible-service-broker</code> in the <strong>Name</strong> field.</p>
</li>
<li>
<p>For the <strong>Role</strong>, select <strong>admin</strong>.</p>
</li>
<li>
<p>For the <strong>Subject</strong>, choose the <strong>Service Account</strong> option, select the
<code>openshift-ansible-service-broker</code> namespace, and enter <code>openshift-ansible-service-broker-operator</code> in the
<strong>Subject Name</strong> field.</p>
</li>
<li>
<p>Click <strong>Create</strong>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Navigate to the <strong>Catalog</strong> &#8594; <strong>OperatorHub</strong> page. Verify that the <code>openshift-ansible-service-broker</code> project is selected.</p>
</li>
<li>
<p>Select <strong>Automation Broker Operator</strong>.</p>
<div class="paragraph">
<p>A pop-up window appears, warning you that you are installing a Community
Operator. Click <strong>Continue</strong> to acknowledge the <strong>Show Community Operator</strong> warning.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This Operator will be named <strong>OpenShift Ansible Service Broker Operator</strong> and will be available under the <strong>Red Hat</strong> category in the GA release.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Read the information about the Operator and click <strong>Install</strong>.</p>
</li>
<li>
<p>Review the default selections and click <strong>Subscribe</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Next, you must start the OpenShift Ansible Broker in order to access the service
bundles it provides.</p>
</div>
</div>
<div class="sect3">
<h4 id="sb-start-asb-sb-installing-asb">Starting the OpenShift Ansible Broker</h4>
<div class="paragraph">
<p>After you have installed the OpenShift Ansible Broker Operator, you can start the OpenShift Ansible Broker
using the following procedure.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have installed the service catalog.</p>
</li>
<li>
<p>You have installed the OpenShift Ansible Broker Operator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Navigate in the web console to <strong>Catalog</strong> &#8594; <strong>Installed Operators</strong> and select the <code>openshift-ansible-service-broker</code> project.</p>
</li>
<li>
<p>Select the <strong>Automation Broker Operator</strong>.</p>
</li>
<li>
<p>Under <strong>Provided APIs</strong>, click <strong>Create New</strong> for <strong>Automation Broker</strong>.</p>
</li>
<li>
<p>Review the default YAML, set any additional OpenShift Ansible Broker configuration options,
and click <strong>Create</strong>.</p>
</li>
<li>
<p>Verify that the OpenShift Ansible Broker has started.</p>
<div class="paragraph">
<p>After the OpenShift Ansible Broker has started, you can view the available service bundles by
navigating to <strong>Catalog</strong> &#8594; <strong>Developer Catalog</strong> and selecting the <strong>Service Class</strong>
checkbox. Note that it may take a few minutes for the OpenShift Ansible Broker to start and
the service bundles to be available.</p>
</div>
<div class="paragraph">
<p>If you do not yet see these Service classes, you can check the status of the
following items:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OpenShift Ansible Broker Pod status</p>
<div class="ulist">
<ul>
<li>
<p>From the <strong>Workloads</strong> &#8594; <strong>Pods</strong> page for the <strong>openshift-ansible-service-broker</strong> project,
verify that the Pod that starts with <code>asb-</code> has a status of <strong>Running</strong> and
readiness of <strong>Ready</strong>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cluster service broker status</p>
<div class="ulist">
<ul>
<li>
<p>From the <strong>Catalog</strong> &#8594; <strong>Broker Management</strong> &#8594; <strong>Service Brokers</strong> page, verify
that the <strong>ansible-service-broker</strong> service broker has a status of <strong>Ready</strong>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Service catalog controller manager Pod logs</p>
<div class="ulist">
<ul>
<li>
<p>From the <strong>Workloads</strong> &#8594; <strong>Pods</strong> page for the
<strong>openshift-service-catalog-controller-manager</strong> project, review the logs for
each of the Pods and verify that you see a log entry with the message
<code>Successfully fetched catalog entries from broker</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="sb-ansible-service-broker-config-options-sb-installing-asb">OpenShift Ansible Broker configuration options</h5>
<div class="paragraph">
<p>You can set the following options for your OpenShift Ansible Broker.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. OpenShift Ansible Broker configuration options</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 50%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">YAML key</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>brokerName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name used to identify the broker instance.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>ansible-service-broker</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>brokerNamespace</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The namespace where the broker resides.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>openshift-ansible-service-broker</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>brokerImage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The fully qualified image used for the broker.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>docker.io/ansibleplaybookbundle/origin-ansible-service-broker:v3.11</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>brokerImagePullPolicy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The pull policy used for the broker image itself.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>IfNotPresent</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>brokerNodeSelector</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The node selector string used for the broker&#8217;s deployment.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>''</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>registries</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expressed as a yaml list of broker registry configs, allowing the user to configure the image registries the broker will discover and source its APBs from.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>See the <a href="#sb-default-registries-array-sb-installing-asb">default registries array</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>logLevel</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The log level used for the broker&#8217;s logs.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>info</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>apbPullPolicy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The pull policy used for APB Pods.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>IfNotPresent</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sandboxRole</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The role granted to the service account used to execute APBs.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>admin</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>keepNamespace</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the transient namespace created to run the APB is deleted after the conclusion of the APB, regardless of the result.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>keepNamespaceOnError</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the transient namespace created to run the APB is deleted after the conclusion of the APB, only in the event of an error result.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bootstrapOnStartup</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether or not the broker should run its bootstrap routine on startup.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>refreshInterval</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The interval of time between broker bootstraps, refreshing its inventory of APBs.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>600s</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>launchApbOnBind</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Experimental:</em> Toggles the broker executing APBs on bind operations.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>autoEscalate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the broker should escalate the permissions of a user while running the APB. This should typically remain <code>false</code> since the broker performs originating user authorization to ensure that the user has permissions granted to the APB sandbox.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>outputRequest</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to output the low level HTTP requests that the broker receives.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
</tbody>
</table>
<div id="sb-default-registries-array-sb-installing-asb" class="listingblock">
<div class="title">Default array for <code>registries</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">- type: rhcc
  name: rhcc
  url: https://registry.redhat.io
  white_list:
  - ".*-apb$"
  auth_type: secret
  auth_name: asb-registry-auth</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-the-openshift-ansible-broker">Configuring the OpenShift Ansible Broker</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>The OpenShift Ansible Broker is deprecated in OpenShift Enterprise 4. Equivalent and better
functionality is present in the Operator Framework and Operator Lifecycle
Manager (OLM).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="sb-configuring-ansible-service-broker-sb-configuring-asb">Configuring the OpenShift Ansible Broker</h4>
<div class="paragraph">
<p>The following procedure customizes the settings for your OpenShift Ansible Broker.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have installed and started the OpenShift Ansible Broker.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>This procedure assumes that you used <code>ansible-service-broker</code> both as the OpenShift Ansible Broker name and the project that it was installed into.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate in the web console to <strong>Catalog</strong> &#8594; <strong>Installed Operators</strong> and select the <code>ansible-service-broker</code> project.</p>
</li>
<li>
<p>Select the <strong>Automation Broker Operator</strong>.</p>
</li>
<li>
<p>On the <strong>Automation Broker</strong> tab, select <code>ansible-service-broker</code>.</p>
</li>
<li>
<p>On the <strong>YAML</strong> tab, add or update any OpenShift Ansible Broker configuration options under the <code>spec</code> field.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  keepNamespace: true
  sandboxRole: edit</code></pre>
</div>
</div>
</li>
<li>
<p>Click <strong>Save</strong> to apply these changes.</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="sb-ansible-service-broker-config-options-sb-configuring-asb">OpenShift Ansible Broker configuration options</h5>
<div class="paragraph">
<p>You can set the following options for your OpenShift Ansible Broker.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. OpenShift Ansible Broker configuration options</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 50%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">YAML key</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>brokerName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name used to identify the broker instance.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>ansible-service-broker</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>brokerNamespace</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The namespace where the broker resides.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>openshift-ansible-service-broker</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>brokerImage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The fully qualified image used for the broker.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>docker.io/ansibleplaybookbundle/origin-ansible-service-broker:v3.11</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>brokerImagePullPolicy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The pull policy used for the broker image itself.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>IfNotPresent</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>brokerNodeSelector</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The node selector string used for the broker&#8217;s deployment.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>''</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>registries</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expressed as a yaml list of broker registry configs, allowing the user to configure the image registries the broker will discover and source its APBs from.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>See the <a href="#sb-default-registries-array-sb-configuring-asb">default registries array</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>logLevel</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The log level used for the broker&#8217;s logs.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>info</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>apbPullPolicy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The pull policy used for APB Pods.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>IfNotPresent</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sandboxRole</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The role granted to the service account used to execute APBs.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>admin</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>keepNamespace</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the transient namespace created to run the APB is deleted after the conclusion of the APB, regardless of the result.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>keepNamespaceOnError</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the transient namespace created to run the APB is deleted after the conclusion of the APB, only in the event of an error result.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bootstrapOnStartup</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether or not the broker should run its bootstrap routine on startup.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>refreshInterval</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The interval of time between broker bootstraps, refreshing its inventory of APBs.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>600s</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>launchApbOnBind</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Experimental:</em> Toggles the broker executing APBs on bind operations.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>autoEscalate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the broker should escalate the permissions of a user while running the APB. This should typically remain <code>false</code> since the broker performs originating user authorization to ensure that the user has permissions granted to the APB sandbox.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>outputRequest</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to output the low level HTTP requests that the broker receives.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
</tbody>
</table>
<div id="sb-default-registries-array-sb-configuring-asb" class="listingblock">
<div class="title">Default array for <code>registries</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">- type: rhcc
  name: rhcc
  url: https://registry.redhat.io
  white_list:
  - ".*-apb$"
  auth_type: secret
  auth_name: asb-registry-auth</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="provisioning-service-bundles">Provisioning service bundles</h3>
<div class="sect3">
<h4 id="sb-provision-service-bundle-sb-provisioning-service-bundles">Provisioning service bundles</h4>
<div class="paragraph">
<p>The following procedure provisions an example PostgreSQL service bundle (APB)
that was made available by the OpenShift Ansible Broker.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The service catalog is installed.</p>
</li>
<li>
<p>The OpenShift Ansible Broker is installed.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a project.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate in the web console to <strong>Home</strong> &#8594; <strong>Projects</strong> and click
<strong>Create Project</strong>.</p>
</li>
<li>
<p>Enter <code>test-postgresql-apb</code> in the <strong>Name</strong> field and click <strong>Create</strong>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create a service instance.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to the <strong>Catalog</strong> &#8594; <strong>Developer Catalog</strong> page.</p>
</li>
<li>
<p>Select the <strong>PostgreSQL (APB)</strong> service bundle and click
<strong>Create Service Instance</strong>.</p>
</li>
<li>
<p>Review the default selections and set any other required fields, and click
<strong>Create</strong>.</p>
</li>
<li>
<p>Go to <strong>Catalog</strong> &#8594; <strong>Provisioned Services</strong> and verify that the
<strong>dh-postgresql-apb</strong> service instance is created and has a status of <strong>Ready</strong>.</p>
<div class="paragraph">
<p>You can check the progress on the <strong>Home</strong> &#8594; <strong>Events</strong> page. After a few moments,
you should see an event for <strong>dh-postgresql-apb</strong> with the message "The
instance was provisioned successfully".</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Create a service binding.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>From the <strong>Provisioned Services</strong> page, click <strong>dh-postgresql-apb</strong> and click
<strong>Create Service Binding</strong>.</p>
</li>
<li>
<p>Review the default service binding name and click <strong>Create</strong>.</p>
<div class="paragraph">
<p>This creates a new secret for binding using the name provided.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Review the secret that was created.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to <strong>Workloads</strong> &#8594; <strong>Secrets</strong> and verify that a secret named
<strong>dh-postgresql-apb</strong> was created.</p>
</li>
<li>
<p>Click <strong>dh-postgresql-apb</strong> and review the key-value pairs in the <strong>Data</strong>
section, which are used for binding to other apps.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="uninstalling-the-openshift-ansible-broker">Uninstalling the OpenShift Ansible Broker</h3>
<div class="paragraph">
<p>You can uninstall the OpenShift Ansible Broker if you no longer need access to the service
bundles that it provides.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>The OpenShift Ansible Broker is deprecated in OpenShift Enterprise 4. Equivalent and better
functionality is present in the Operator Framework and Operator Lifecycle
Manager (OLM).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="sb-uninstall-asb-sb-uninstalling-asb">Uninstalling the OpenShift Ansible Broker</h4>
<div class="paragraph">
<p>The following procedure uninstalls the OpenShift Ansible Broker and its Operator using the
web console.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Do not uninstall the OpenShift Ansible Broker if there are any provisioned services from it in your cluster, otherwise you might encounter errors when trying to manage the services.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The OpenShift Ansible Broker is installed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>This procedure assumes that you installed the OpenShift Ansible Broker into the
<code>openshift-ansible-service-broker</code> project.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Uninstall the OpenShift Ansible Broker.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to <strong>Catalog</strong> &#8594; <strong>Installed Operators</strong> and select the
<strong>openshift-ansible-service-broker</strong> project from the drop-down menu.</p>
</li>
<li>
<p>Click <strong>Automation Broker Operator</strong>.</p>
</li>
<li>
<p>Select the <strong>Automation Broker</strong> tab.</p>
</li>
<li>
<p>Click <strong>ansible-service-broker</strong>.</p>
</li>
<li>
<p>From the <strong>Actions</strong> drop-down menu, select <strong>Delete Automation Broker</strong>.</p>
</li>
<li>
<p>Click <strong>Delete</strong> from the confirmation pop-up window.</p>
<div class="paragraph">
<p>The OpenShift Ansible Broker is now uninstalled, and service bundles will soon be removed
from the Developer Catalog.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Uninstall the OpenShift Ansible Broker Operator.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to <strong>Catalog</strong> &#8594; <strong>Operator Management</strong> and select the
<strong>openshift-ansible-service-broker</strong> project from the drop-down menu.</p>
</li>
<li>
<p>Click <strong>View subscription</strong> for the <strong>Automation Broker Operator</strong>.</p>
</li>
<li>
<p>Select <strong>automationbroker</strong>.</p>
</li>
<li>
<p>From the <strong>Actions</strong> drop-down menu, select <strong>Remove Subscription</strong>.</p>
</li>
<li>
<p>Verify that the checkbox is checked next to <strong>Also completely remove the automationbroker Operator from the selected namespace</strong> and click <strong>Remove</strong>.</p>
<div class="paragraph">
<p>The OpenShift Ansible Broker Operator is no longer installed in your cluster.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>After the OpenShift Ansible Broker is uninstalled, users will no longer have access to the
service bundles provided by the OpenShift Ansible Broker.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deployments">Deployments</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="what-deployments-and-deploymentconfigs-are">What Deployments and DeploymentConfigs are</h3>
<div class="paragraph">
<p><em>Deployments</em> and <em>DeploymentConfigs</em> in OpenShift Enterprise are API objects that
provide two similar but different methods for fine-grained management over
common user applications. They are comprised of the following separate API
objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A DeploymentConfig or a Deployment, either of which describes the desired state
of a particular component of the application as a Pod template.</p>
</li>
<li>
<p>DeploymentConfigs involve one or more <em>ReplicationControllers</em>, which contain a
point-in-time record of the state of a DeploymentConfig as a Pod template.
Similarly, Deployments involve one or more <em>ReplicaSets</em>, a successor of
ReplicationControllers.</p>
</li>
<li>
<p>One or more Pods, which represent an instance of a particular version of an
application.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="what-deployments-are-build-blocks">Building blocks of a deployment</h4>
<div class="paragraph">
<p>Deployments and DeploymentConfigs are enabled by the use of native Kubernetes
API objects ReplicationControllers and ReplicaSets, respectively, as their
building blocks.</p>
</div>
<div class="paragraph">
<p>Users do not need to manipulate ReplicationControllers, ReplicaSets, or Pods
owned by DeploymentConfigs or Deployments. The deployment systems ensures
changes are propagated appropriately.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>If the existing deployment strategies are not suited for your use case and you
have the need to run manual steps during the lifecycle of your deployment, then
you should consider creating a Custom deployment strategy.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following sections provide further details on these objects.</p>
</div>
<div class="sect4">
<h5 id="deployments-replicationcontrollers-what-deployments-are">ReplicationControllers</h5>
<div class="paragraph">
<p>A ReplicationController ensures that a specified number of replicas of a Pod are running at
all times. If Pods exit or are deleted, the ReplicationController acts to
instantiate more up to the defined number. Likewise, if there are more running
than desired, it deletes as many as necessary to match the defined amount.</p>
</div>
<div class="paragraph">
<p>A ReplicationController configuration consists of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The number of replicas desired (which can be adjusted at runtime).</p>
</li>
<li>
<p>A Pod definition to use when creating a replicated Pod.</p>
</li>
<li>
<p>A selector for identifying managed Pods.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A selector is a set of labels assigned to
the Pods that are managed by the ReplicationController. These labels are
included in the Pod definition that the ReplicationController instantiates.
The ReplicationController uses the selector to determine how many
instances of the Pod are already running in order to adjust as needed.</p>
</div>
<div class="paragraph">
<p>The ReplicationController does not perform auto-scaling based on load or
traffic, as it does not track either. Rather, this requires its replica
count to be adjusted by an external auto-scaler.</p>
</div>
<div class="paragraph">
<p>The following is an example definition of a ReplicationController:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ReplicationController
metadata:
  name: frontend-1
spec:
  replicas: 1  <b class="conum">(1)</b>
  selector:    <b class="conum">(2)</b>
    name: frontend
  template:    <b class="conum">(3)</b>
    metadata:
      labels:  <b class="conum">(4)</b>
        name: frontend <b class="conum">(5)</b>
    spec:
      containers:
      - image: openshift/hello-openshift
        name: helloworld
        ports:
        - containerPort: 8080
          protocol: TCP
      restartPolicy: Always</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The number of copies of the Pod to run.</p>
</li>
<li>
<p>The label selector of the Pod to run.</p>
</li>
<li>
<p>A template for the Pod the controller creates.</p>
</li>
<li>
<p>Labels on the Pod should include those from the label selector.</p>
</li>
<li>
<p>The maximum name length after expanding any parameters is 63 characters.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="deployments-repliasets-what-deployments-are">ReplicaSets</h5>
<div class="paragraph">
<p>Similar to a ReplicationController, a ReplicaSet is a native Kubernetes API
object that ensures a specified number of pod replicas are running at any given
time. The difference between a ReplicaSet and a ReplicationController is that
a ReplicaSet supports set-based selector requirements whereas a replication
controller only supports equality-based selector requirements.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Only use ReplicaSets if you require custom update orchestration or do not
require updates at all. Otherwise, use Deployments. ReplicaSets can be used
independently, but are used by deployments to orchestrate pod creation,
deletion, and updates. Deployments manage their ReplicaSets automatically,
provide declarative updates to pods, and do not have to manually manage the
ReplicaSets that they create.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following is an example <code>ReplicaSet</code> definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: frontend-1
  labels:
    tier: frontend
spec:
  replicas: 3
  selector: <b class="conum">(1)</b>
    matchLabels: <b class="conum">(2)</b>
      tier: frontend
    matchExpressions: <b class="conum">(3)</b>
      - {key: tier, operator: In, values: [frontend]}
  template:
    metadata:
      labels:
        tier: frontend
    spec:
      containers:
      - image: openshift/hello-openshift
        name: helloworld
        ports:
        - containerPort: 8080
          protocol: TCP
      restartPolicy: Always</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>A label query over a set of resources. The result of <code>matchLabels</code> and
<code>matchExpressions</code> are logically conjoined.</p>
</li>
<li>
<p>Equality-based selector to specify resources with labels that match the
selector.</p>
</li>
<li>
<p>Set-based selector to filter keys. This selects all resources with key equal
to <code>tier</code> and value equal to <code>frontend</code>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="deployments-and-deploymentconfigs-what-deployments-are">DeploymentConfigs</h4>
<div class="paragraph">
<p>Building on ReplicationControllers, OpenShift Enterprise adds expanded support for
the software development and deployment lifecycle with the concept of
<em>DeploymentConfigs</em>. In the simplest case, a DeploymentConfig creates a new
ReplicationController and lets it start up Pods.</p>
</div>
<div class="paragraph">
<p>However, OpenShift Enterprise deployments from DeploymentConfigs also provide the
ability to transition from an existing deployment of an image to a new one and
also define hooks to be run before or after creating the ReplicationController.</p>
</div>
<div class="paragraph">
<p>The DeploymentConfig deployment system provides the following capabilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A DeploymentConfig, which is a template for running applications.</p>
</li>
<li>
<p>Triggers that drive automated deployments in response to events.</p>
</li>
<li>
<p>User-customizable deployment strategies to transition from the previous version
to the new version. A strategy runs inside a Pod commonly referred as the
deployment process.</p>
</li>
<li>
<p>A set of hooks (lifecycle hooks) for executing custom behavior in different
points during the lifecycle of a deployment.</p>
</li>
<li>
<p>Versioning of your application in order to support rollbacks either manually or
automatically in case of deployment failure.</p>
</li>
<li>
<p>Manual replication scaling and autoscaling.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you create a DeploymentConfig, a ReplicationController is created
representing the DeploymentConfig&#8217;s Pod template. If the DeploymentConfig
changes, a new ReplicationController is created with the latest Pod template,
and a deployment process runs to scale down the old ReplicationController and
scale up the new one.</p>
</div>
<div class="paragraph">
<p>Instances of your application are automatically added and removed from both
service load balancers and routers as they are created. As long as your
application supports graceful shutdown when it receives the <code>TERM</code> signal, you
can ensure that running user connections are given a chance to complete
normally.</p>
</div>
<div class="paragraph">
<p>The OpenShift Enterprise <code>DeploymentConfig</code> object defines the following details:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The elements of a <code>ReplicationController</code> definition.</p>
</li>
<li>
<p>Triggers for creating a new deployment automatically.</p>
</li>
<li>
<p>The strategy for transitioning between deployments.</p>
</li>
<li>
<p>Lifecycle hooks.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Each time a deployment is triggered, whether manually or automatically, a
deployer Pod manages the deployment (including scaling down the old
ReplicationController, scaling up the new one, and running hooks). The
deployment pod remains for an indefinite amount of time after it completes the
Deployment in order to retain its logs of the Deployment. When a deployment is
superseded by another, the previous ReplicationController is retained to enable
easy rollback if needed.</p>
</div>
<div class="listingblock">
<div class="title">Example DeploymentConfig definition</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: DeploymentConfig
metadata:
  name: frontend
spec:
  replicas: 5
  selector:
    name: frontend
  template: { ... }
  triggers:
  - type: ConfigChange <b class="conum">(1)</b>
  - imageChangeParams:
      automatic: true
      containerNames:
      - helloworld
      from:
        kind: ImageStreamTag
        name: hello-openshift:latest
    type: ImageChange  <b class="conum">(2)</b>
  strategy:
    type: Rolling      <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>A <code>ConfigChange</code> trigger causes a new Deployment to be created any time the ReplicationController template changes.</p>
</li>
<li>
<p>An <code>ImageChange</code> trigger causes a new Deployment to be created each time a new version of the backing image is available in the named imagestream.</p>
</li>
<li>
<p>The default <code>Rolling</code> strategy makes a downtime-free transition between Deployments.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="deployments-kube-deployments-what-deployments-are">Deployments</h4>
<div class="paragraph">
<p>Kubernetes provides a first-class, native API object type in OpenShift Enterprise
called <em>Deployments</em>. Deployments serve as a descendant of the
OpenShift Enterprise-specific DeploymentConfig.</p>
</div>
<div class="paragraph">
<p>Like DeploymentConfigs, Deployments describe the desired state of a particular
component of an application as a Pod template. Deployments create ReplicaSets,
which orchestrate Pod lifecycles.</p>
</div>
<div class="paragraph">
<p>For example, the following Deployment definition creates a ReplicaSet to bring
up one <code>hello-openshift</code> Pod:</p>
</div>
<div class="listingblock">
<div class="title">Deployment definition</div>
<div class="content">
<pre class="nowrap">apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-openshift
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hello-openshift
  template:
    metadata:
      labels:
        app: hello-openshift
    spec:
      containers:
      - name: hello-openshift
        image: openshift/hello-openshift:latest
        ports:
        - containerPort: 80</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="deployments-comparing-deploymentconfigs-what-deployments-are">Comparing Deployments and DeploymentConfigs</h4>
<div class="paragraph">
<p>Both Kubernetes Deployments and OpenShift Enterprise-provided
DeploymentConfigs are supported in OpenShift Enterprise; however, it is
recommended to use Deployments unless you need a specific feature or behavior
provided by DeploymentConfigs.</p>
</div>
<div class="paragraph">
<p>The following sections go into more detail on the differences between the two
object types to further help you decide which type to use.</p>
</div>
<div class="sect4">
<h5 id="deployments-design-what-deployments-are">Design</h5>
<div class="paragraph">
<p>One important difference between Deployments and DeploymentConfigs is the
properties of the <a href="https://en.wikipedia.org/wiki/CAP_theorem">CAP theorem</a>
that each design has chosen for the rollout process. DeploymentConfigs prefer
consistency, whereas Deployments take availability over consistency.</p>
</div>
<div class="paragraph">
<p>For DeploymentConfigs, if a node running a deployer Pod goes down, it will
not get replaced. The process waits until the node comes back online or is
manually deleted. Manually deleting the node also deletes the corresponding Pod.
This means that you can not delete the Pod to unstick the rollout, as the
kubelet is responsible for deleting the associated Pod.</p>
</div>
<div class="paragraph">
<p>However, Deployments rollouts are driven from a controller manager. The
controller manager runs in high availability mode on masters and uses leader
election algorithms to value availability over consistency. During a failure it
is possible for other masters to act on the same Deployment at the same time,
but this issue will be reconciled shortly after the failure occurs.</p>
</div>
</div>
<div class="sect4">
<h5 id="delpoymentconfigs-specific-features-what-deployments-are">DeploymentConfigs-specific features</h5>
<h7 id="_automatic-rollbacks" class="discrete">Automatic rollbacks</h7>
<div class="paragraph">
<p>Currently, Deployments do not support automatically rolling back to the last
successfully deployed ReplicaSet in case of a failure.</p>
</div>
<h7 id="_triggers" class="discrete">Triggers</h7>
<div class="paragraph">
<p>Deployments have an implicit <code>ConfigChange</code> trigger in that every
change in the pod template of a deployment automatically triggers a new rollout.
If you do not want new rollouts on pod template changes, pause the deployment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc rollout pause deployments/&lt;name&gt;</pre>
</div>
</div>
<h7 id="_lifecycle-hooks" class="discrete">Lifecycle hooks</h7>
<div class="paragraph">
<p>Deployments do not yet support any lifecycle hooks.</p>
</div>
<h7 id="_custom-strategies" class="discrete">Custom strategies</h7>
<div class="paragraph">
<p>Deployments do not support user-specified Custom deployment
strategies yet.</p>
</div>
</div>
<div class="sect4">
<h5 id="delpoyments-specific-features-what-deployments-are">Deployments-specific features</h5>
<h7 id="_rollover" class="discrete">Rollover</h7>
<div class="paragraph">
<p>The deployment process for Deployments is driven by a controller
loop, in contrast to DeploymentConfigs which use deployer pods for every
new rollout. This means that a Deployment can have as many active
ReplicaSets as possible, and eventually the deployment controller will scale
down all old ReplicaSets and scale up the newest one.</p>
</div>
<div class="paragraph">
<p>DeploymentConfigs can have at most one deployer pod running, otherwise
multiple deployers end up conflicting while trying to scale up what they think
should be the newest ReplicationController. Because of this, only two
ReplicationControllers can be active at any point in time. Ultimately, this
translates to faster rapid rollouts for Deployments.</p>
</div>
<h7 id="_proportional-scaling" class="discrete">Proportional scaling</h7>
<div class="paragraph">
<p>Because the Deployment controller is the sole source of truth for the sizes of
new and old ReplicaSets owned by a Deployment, it is able to scale ongoing
rollouts. Additional replicas are distributed proportionally based on the size
of each ReplicaSet.</p>
</div>
<div class="paragraph">
<p>DeploymentConfigs cannot be scaled when a rollout is ongoing because the
DeploymentConfig controller will end up having issues with the deployer
process about the size of the new ReplicationController.</p>
</div>
<h7 id="_pausing-mid-rollout" class="discrete">Pausing mid-rollout</h7>
<div class="paragraph">
<p>Deployments can be paused at any point in time, meaning you can also
pause ongoing rollouts. On the other hand, you cannot pause deployer pods
currently, so if you try to pause a DeploymentConfig in the middle of a
rollout, the deployer process will not be affected and will continue until it
finishes.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="managing-deployment-processes">Managing deployment processes</h3>
<div class="sect3">
<h4 id="deploymentconfig-operations">Managing DeploymentConfigs</h4>
<div class="paragraph">
<p>DeploymentConfigs can be managed from the OpenShift Enterprise web console&#8217;s
<strong>Workloads</strong> page or using the <code>oc</code> CLI. The following procedures show CLI usage
unless otherwise stated.</p>
</div>
<div class="sect4">
<h5 id="deployments-starting-a-deployment-deployment-operations">Starting a deployment</h5>
<div class="paragraph">
<p>You can start a <em>rollout</em> to begin the deployment process of your application.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To start a new deployment process from an existing DeploymentConfig, run the
following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc rollout latest dc/&lt;name&gt;</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If a deployment process is already in progress, the command displays a
message and a new ReplicationController will not be deployed.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="deployments-viewing-a-deployment-deployment-operations">Viewing a deployment</h5>
<div class="paragraph">
<p>You can view a deployment to get basic information about all the available
revisions of your application.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To show details about all recently created ReplicationControllers for the
provided DeploymentConfig, including any currently running deployment process,
run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc rollout history dc/&lt;name&gt;</pre>
</div>
</div>
</li>
<li>
<p>To view details specific to a revision, add the <code>--revision</code> flag:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc rollout history dc/&lt;name&gt; --revision=1</pre>
</div>
</div>
</li>
<li>
<p>For more detailed information about a deployment configuration and its latest
revision, use the <code>oc describe</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc describe dc &lt;name&gt;</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="deployments-retrying-deployment-deployment-operations">Retrying a deployment</h5>
<div class="paragraph">
<p>If the current revision of your DeploymentConfig failed to deploy, you can
restart the deployment process.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To restart a failed deployment process:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc rollout retry dc/&lt;name&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>If the latest revision of it was deployed successfully, the command displays a
message and the deployment process is not be retried.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Retrying a deployment restarts the deployment process and does not create a new
deployment revision. The restarted ReplicationController has the same
configuration it had when it failed.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="deployments-rolling-back-deployment-operations">Rolling back a deployment</h5>
<div class="paragraph">
<p>Rollbacks revert an application back to a previous revision and can be
performed using the REST API, the CLI, or the web console.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To rollback to the last successful deployed revision of your configuration:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc rollout undo dc/&lt;name&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The DeploymentConfig&#8217;s template is reverted to match the deployment
revision specified in the undo command, and a new ReplicationController is
started. If no revision is specified with <code>--to-revision</code>, then the last
successfully deployed revision is used.</p>
</div>
</li>
<li>
<p>Image change triggers on the DeploymentConfig are disabled as part of
the rollback to prevent accidentally starting a new deployment process soon after
the rollback is complete.</p>
<div class="paragraph">
<p>To re-enable the image change triggers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set triggers dc/&lt;name&gt; --auto</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>DeploymentConfigs also support automatically rolling back to the last successful
revision of the configuration in case the latest deployment process fails. In
that case, the latest template that failed to deploy stays intact by the system
and it is up to users to fix their configurations.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="deployments-exe-cmd-in-container-deployment-operations">Executing commands inside a container</h5>
<div class="paragraph">
<p>You can add a command to a container, which modifies the container&#8217;s startup
behavior by overruling the image&#8217;s <code>ENTRYPOINT</code>. This is different from a
lifecycle hook, which instead can be run once per deployment at a specified
time.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the <code>command</code> parameters to the <code>spec</code> field of the DeploymentConfig. You
can also add an <code>args</code> field, which modifies the <code>command</code> (or the <code>ENTRYPOINT</code>
if <code>command</code> does not exist).</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">spec:
  containers:
    -
    name: &lt;container_name&gt;
    image: 'image'
    command:
      - '&lt;command&gt;'
    args:
      - '&lt;argument_1&gt;'
      - '&lt;argument_2&gt;'
      - '&lt;argument_3&gt;'</pre>
</div>
</div>
<div class="paragraph">
<p>For example, to execute the <code>java</code> command with the <code>-jar</code> and
<code>/opt/app-root/springboots2idemo.jar</code> arguments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">spec:
  containers:
    -
    name: example-spring-boot
    image: 'image'
    command:
      - java
    args:
      - '-jar'
      - /opt/app-root/springboots2idemo.jar</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="deployments-viewing-logs-deployment-operations">Viewing deployment logs</h5>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To stream the logs of the latest revision for a given DeploymentConfig:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc logs -f dc/&lt;name&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>If the latest revision is running or failed, the command returns the logs of the
process that is responsible for deploying your pods. If it is successful, it
returns the logs from a Pod of your application.</p>
</div>
</li>
<li>
<p>You can also view logs from older failed deployment processes, if and only if
these processes (old ReplicationControllers and their deployer Pods) exist and
have not been pruned or deleted manually:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc logs --version=1 dc/&lt;name&gt;</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="deployments-triggers-deployment-operations">Deployment triggers</h5>
<div class="paragraph">
<p>A DeploymentConfig can contain triggers, which drive the creation of new
deployment processes in response to events inside the cluster.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If no triggers are defined on a DeploymentConfig, a <code>ConfigChange</code>
trigger is added by default. If triggers are defined as an empty field, deployments
must be started manually.</p>
</div>
</td>
</tr>
</table>
</div>
<h7 id="deployments-configchange-trigger-deployment-operations" class="discrete">ConfigChange deployment triggers</h7>
<div class="paragraph">
<p>The <code>ConfigChange</code> trigger results in a new ReplicationController whenever
configuration changes are detected in the Pod template of the DeploymentConfig.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If a <code>ConfigChange</code> trigger is defined on a DeploymentConfig, the first
ReplicationController is automatically created soon after the DeploymentConfig
itself is created and it is not paused.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">ConfigChange deployment trigger</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">triggers:
  - type: "ConfigChange"</code></pre>
</div>
</div>
<h7 id="deployments-imagechange-trigger-deployment-operations" class="discrete">ImageChange deployment triggers</h7>
<div class="paragraph">
<p>The <code>ImageChange</code> trigger results in a new ReplicationController whenever the
content of an imagestream tag changes (when a new version of the image is
pushed).</p>
</div>
<div class="listingblock">
<div class="title">ImageChange deployment trigger</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">triggers:
  - type: "ImageChange"
    imageChangeParams:
      automatic: true <b class="conum">(1)</b>
      from:
        kind: "ImageStreamTag"
        name: "origin-ruby-sample:latest"
        namespace: "myproject"
      containerNames:
        - "helloworld"</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>If the <code>imageChangeParams.automatic</code> field is set to <code>false</code>, the trigger is
disabled.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>With the above example, when the <code>latest</code> tag value of the <code>origin-ruby-sample</code>
imagestream changes and the new image value differs from the current image
specified in the DeploymentConfig&#8217;s <code>helloworld</code> container, a new
ReplicationController is created using the new image for the <code>helloworld</code>
container.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If an <code>ImageChange</code> trigger is defined on a DeploymentConfig (with a
<code>ConfigChange</code> trigger and <code>automatic=false</code>, or with <code>automatic=true</code>) and the
<code>ImageStreamTag</code> pointed by the <code>ImageChange</code> trigger does not exist yet, then
the initial deployment process will automatically start as soon as an image is
imported or pushed by a build to the <code>ImageStreamTag</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="deployments-setting-triggers-deployment-operations">Setting deployment triggers</h6>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>You can set deployment triggers for a DeploymentConfig using the <code>oc set triggers</code>
command. For example, to set a <code>ImageChangeTrigger</code>, use the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set triggers dc/&lt;dc_name&gt; \
    --from-image=&lt;project&gt;/&lt;image&gt;:&lt;tag&gt; -c &lt;container_name&gt;</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect4">
<h5 id="deployments-setting-resources-deployment-operations">Setting deployment resources</h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This resource is available only if a cluster administrator has enabled the
ephemeral storage technology preview. This feature is disabled by default.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A deployment is completed by a Pod that consumes resources (memory, CPU, and
ephemeral storage) on a node. By default, Pods consume unbounded node resources.
However, if a project specifies default container limits, then Pods consume
resources up to those limits.</p>
</div>
<div class="paragraph">
<p>You can also limit resource use by specifying resource limits as part of the
deployment strategy. Deployment resources can be used with the Recreate,
Rolling, or Custom deployment strategies.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the following example, each of <code>resources</code>, <code>cpu</code>, <code>memory</code>, and
<code>ephemeral-storage</code> is optional:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">type: "Recreate"
resources:
  limits:
    cpu: "100m" <b class="conum">(1)</b>
    memory: "256Mi" <b class="conum">(2)</b>
    ephemeral-storage: "1Gi" <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>cpu</code> is in CPU units: <code>100m</code> represents 0.1 CPU units (100 * 1e-3).</p>
</li>
<li>
<p><code>memory</code> is in bytes: <code>256Mi</code> represents 268435456 bytes (256 * 2 ^ 20).</p>
</li>
<li>
<p><code>ephemeral-storage</code> is in bytes: <code>1Gi</code> represents 1073741824 bytes (2 ^ 30).
This applies only if your cluster administrator enabled the ephemeral storage
technology preview.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>However, if a quota has been defined for your project, one of the following two
items is required:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>A <code>resources</code> section set with an explicit <code>requests</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">  type: "Recreate"
  resources:
    requests: <b class="conum">(1)</b>
      cpu: "100m"
      memory: "256Mi"
      ephemeral-storage: "1Gi"</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>requests</code> object contains the list of resources that correspond to
the list of resources in the quota.</p>
</li>
</ol>
</div>
</li>
<li>
<p>A limit range defined in your project, where the defaults from the <code>LimitRange</code>
object apply to Pods created during the deployment process.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>To set deployment resources, choose one of the above options. Otherwise, deploy
Pod creation fails, citing a failure to satisfy quota.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="deployments-scaling-manually-deployment-operations">Scaling manually</h5>
<div class="paragraph">
<p>In addition to rollbacks, you can exercise fine-grained control over the number
of replicas by manually scaling them.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Pods can also be autoscaled using the <code>oc autoscale</code> command.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To manually scale a DeploymentConfig, use the <code>oc scale</code> command. For example,
the following command sets the replicas in the <code>frontend</code> DeploymentConfig to
<code>3</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc scale dc frontend --replicas=3</pre>
</div>
</div>
<div class="paragraph">
<p>The number of replicas eventually propagates to the desired and current
state of the deployment configured by the DeploymentConfig <code>frontend</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="deployments-accessing-private-repos-deployment-operations">Accessing private repositories from DeploymentConfigs</h5>
<div class="paragraph">
<p>You can add a Secret to your DeploymentConfig so that it can access images from
a private repository. This procedure shows the OpenShift Enterprise web console
method.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a new project.</p>
</li>
<li>
<p>From the <strong>Workloads</strong> page, create a Secret that contains credentials for
accessing a private image repository.</p>
</li>
<li>
<p>Create a DeploymentConfig.</p>
</li>
<li>
<p>On the DeploymentConfig editor page, set the <strong>Pull Secret</strong> and save your
changes.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="deployments-assigning-pods-to-nodes-deployment-operations">Assigning pods to specific nodes</h5>
<div class="paragraph">
<p>You can use node selectors in conjunction with labeled nodes to control Pod
placement.</p>
</div>
<div class="paragraph">
<p>Cluster administrators can set the default node selector for a project in order
to restrict Pod placement to specific nodes. As a developer, you can set a node
selector on a Pod configuration to restrict nodes even further.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To add a node selector when creating a pod, edit the Pod configuration, and add
the <code>nodeSelector</code> value. This can be added to a single Pod configuration, or in
a Pod template:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">apiVersion: v1
kind: Pod
spec:
  nodeSelector:
    disktype: ssd
...</pre>
</div>
</div>
<div class="paragraph">
<p>Pods created when the node selector is in place are assigned to nodes with the
specified labels. The labels specified here are used in conjunction with the
labels added by a cluster administrator.</p>
</div>
<div class="paragraph">
<p>For example, if a project has the <code>type=user-node</code> and <code>region=east</code> labels
added to a project by the cluster administrator, and you add the above
<code>disktype: ssd</code> label to a Pod, the Pod is only ever scheduled on nodes that
have all three labels.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Labels can only be set to one value, so setting a node selector of <code>region=west</code>
in a Pod configuration that has <code>region=east</code> as the administrator-set default,
results in a Pod that will never be scheduled.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="deployments-running-pod-svc-acct-deployment-operations">Running a Pod with a different service account</h5>
<div class="paragraph">
<p>You can run a Pod with a service account other than the default.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the DeploymentConfig:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc edit dc/&lt;deployment_config&gt;</pre>
</div>
</div>
</li>
<li>
<p>Add the <code>serviceAccount</code> and <code>serviceAccountName</code> parameters to the <code>spec</code>
field, and specify the service account you want to use:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">spec:
  securityContext: {}
  serviceAccount: &lt;service_account&gt;
  serviceAccountName: &lt;service_account&gt;</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-deploymentconfig-strategies">Using DeploymentConfig strategies</h3>
<div class="paragraph">
<p>A <em>deployment strategy</em> is a way to change or upgrade an application. The aim
is to make the change without downtime in a way that the user barely notices the
improvements.</p>
</div>
<div class="paragraph">
<p>Because the end user usually accesses the application through a route handled by
a router, the deployment strategy can focus on DeploymentConfig features or
routing features. Strategies that focus on the DeploymentConfig impact all
routes that use the application. Strategies that use router features target
individual routes.</p>
</div>
<div class="paragraph">
<p>Many deployment strategies are supported through the DeploymentConfig, and some
additional strategies are supported through router features. DeploymentConfig
strategies are discussed in this section.</p>
</div>
<div class="paragraph">
<p><strong>Choosing a deployment strategy</strong></p>
</div>
<div class="paragraph">
<p>Consider the following when choosing a deployment strategy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Long-running connections must be handled gracefully.</p>
</li>
<li>
<p>Database conversions can be complex and must be done and rolled back along with
the application.</p>
</li>
<li>
<p>If the application is a hybrid of microservices and traditional components,
downtime might be required to complete the transition.</p>
</li>
<li>
<p>You need the infrastructure to do this.</p>
</li>
<li>
<p>If you have a non-isolated test environment, you can break both new and old
versions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A deployment strategy uses readiness checks to determine if a new Pod is ready
for use. If a readiness check fails, the DeploymentConfig retries to run the
Pod until it times out. The default timeout is <code>10m</code>, a value set in
<code>TimeoutSeconds</code> in <code>dc.spec.strategy.*params</code>.</p>
</div>
<div class="sect3">
<h4 id="deployments-rolling-strategy-deployment-strategies">Rolling strategy</h4>
<div class="paragraph">
<p>A rolling deployment slowly replaces instances of the previous version of an
application with instances of the new version of the application. The Rolling
strategy is the default deployment strategy used if no strategy is specified on
a DeploymentConfig.</p>
</div>
<div class="paragraph">
<p>A rolling deployment typically waits for new pods to become <code>ready</code> via a
<code>readiness check</code> before scaling down the old components. If a significant issue
occurs, the rolling deployment can be aborted.</p>
</div>
<div class="paragraph">
<p><strong>When to use a Rolling deployment:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>When you want to take no downtime during an application update.</p>
</li>
<li>
<p>When your application supports having old code and new code running at the same time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A Rolling deployment means you to have both old and new versions of your code
running at the same time. This typically requires that your application handle
N-1 compatibility.</p>
</div>
<div class="listingblock">
<div class="title">Example Rolling strategy definition</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">strategy:
  type: Rolling
  rollingParams:
    updatePeriodSeconds: 1 <b class="conum">(1)</b>
    intervalSeconds: 1 <b class="conum">(2)</b>
    timeoutSeconds: 120 <b class="conum">(3)</b>
    maxSurge: "20%" <b class="conum">(4)</b>
    maxUnavailable: "10%" <b class="conum">(5)</b>
    pre: {} <b class="conum">(6)</b>
    post: {}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The time to wait between individual Pod updates. If unspecified, this value defaults to <code>1</code>.</p>
</li>
<li>
<p>The time to wait between polling the deployment status after update. If unspecified, this value defaults to <code>1</code>.</p>
</li>
<li>
<p>The time to wait for a scaling event before giving up. Optional; the default is <code>600</code>. Here, <em>giving up</em> means
automatically rolling back to the previous complete deployment.</p>
</li>
<li>
<p><code>maxSurge</code> is optional and defaults to <code>25%</code> if not specified. See the information below the following procedure.</p>
</li>
<li>
<p><code>maxUnavailable</code> is optional and defaults to <code>25%</code> if not specified. See the information below the following procedure.</p>
</li>
<li>
<p><code>pre</code> and <code>post</code> are both lifecycle hooks.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Rolling strategy:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Executes any <code>pre</code> lifecycle hook.</p>
</li>
<li>
<p>Scales up the new ReplicationController based on the surge count.</p>
</li>
<li>
<p>Scales down the old ReplicationController based on the max unavailable count.</p>
</li>
<li>
<p>Repeats this scaling until the new ReplicationController has reached the desired
replica count and the old ReplicationController has been scaled to zero.</p>
</li>
<li>
<p>Executes any <code>post</code> lifecycle hook.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>When scaling down, the Rolling strategy waits for Pods to become ready so it can
decide whether further scaling would affect availability. If scaled up Pods
never become ready, the deployment process will eventually time out and result in a
deployment failure.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>maxUnavailable</code> parameter is the maximum number of Pods that can be
unavailable during the update. The <code>maxSurge</code> parameter is the maximum number
of Pods that can be scheduled above the original number of Pods. Both parameters
can be set to either a percentage (e.g., <code>10%</code>) or an absolute value (e.g.,
<code>2</code>). The default value for both is <code>25%</code>.</p>
</div>
<div class="paragraph">
<p>These parameters allow the deployment to be tuned for availability and speed. For
example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>maxUnavailable*=0</code> and <code>maxSurge*=20%</code> ensures full capacity is maintained
during the update and rapid scale up.</p>
</li>
<li>
<p><code>maxUnavailable*=10%</code> and <code>maxSurge*=0</code> performs an update using no extra
capacity (an in-place update).</p>
</li>
<li>
<p><code>maxUnavailable*=10%</code> and <code>maxSurge*=10%</code> scales up and down quickly with
some potential for capacity loss.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Generally, if you want fast rollouts, use <code>maxSurge</code>. If you need to take into
account resource quota and can accept partial unavailability, use
<code>maxUnavailable</code>.</p>
</div>
<div class="sect4">
<h5 id="deployments-canary-deployments-deployment-strategies">Canary deployments</h5>
<div class="paragraph">
<p>All Rolling deployments in OpenShift Enterprise are <em>canary deployments</em>; a new
version (the canary) is tested before all of the old instances are replaced. If
the readiness check never succeeds, the canary instance is removed and the
DeploymentConfig will be automatically rolled back.</p>
</div>
<div class="paragraph">
<p>The readiness check is part of the application code and can be as sophisticated
as necessary to ensure the new instance is ready to be used. If you need to
implement more complex checks of the application (such as sending real user
workloads to the new instance), consider implementing a Custom deployment or
using a blue-green deployment strategy.</p>
</div>
</div>
<div class="sect4">
<h5 id="deployments-creating-rolling-deployment-deployment-strategies">Creating a Rolling deployment</h5>
<div class="paragraph">
<p>Rolling deployments are the default type in OpenShift Enterprise. You can create a
Rolling deployment using the CLI.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create an application based on the example deployment images found in
<a href="https://hub.docker.com/r/openshift/deployment-example/">DockerHub</a>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc new-app openshift/deployment-example</pre>
</div>
</div>
</li>
<li>
<p>If you have the router installed, make the application available via a route (or
use the service IP directly)</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc expose svc/deployment-example</pre>
</div>
</div>
</li>
<li>
<p>Browse to the application at <code>deployment-example.&lt;project&gt;.&lt;router_domain&gt;</code> to
verify you see the <code>v1</code> image.</p>
</li>
<li>
<p>Scale the DeploymentConfig up to three replicas:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc scale dc/deployment-example --replicas=3</pre>
</div>
</div>
</li>
<li>
<p>Trigger a new deployment automatically by tagging a new version of the example
as the <code>latest</code> tag:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc tag deployment-example:v2 deployment-example:latest</pre>
</div>
</div>
</li>
<li>
<p>In your browser, refresh the page until you see the <code>v2</code> image.</p>
</li>
<li>
<p>When using the CLI, the following command shows how many Pods are on version 1
and how many are on version 2. In the web console, the Pods are progressively
added to v2 and removed from v1:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc describe dc deployment-example</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>During the deployment process, the new ReplicationController is incrementally
scaled up. After the new Pods are marked as <code>ready</code> (by passing their readiness
check), the deployment process continues.</p>
</div>
<div class="paragraph">
<p>If the Pods do not become ready, the process aborts, and the DeploymentConfig
rolls back to its previous version.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="deployments-recreate-strategy-deployment-strategies">Recreate strategy</h4>
<div class="paragraph">
<p>The Recreate strategy has basic rollout behavior and supports lifecycle hooks
for injecting code into the deployment process.</p>
</div>
<div class="listingblock">
<div class="title">Example Recreate strategy definition</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">strategy:
  type: Recreate
  recreateParams: <b class="conum">(1)</b>
    pre: {} <b class="conum">(2)</b>
    mid: {}
    post: {}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>recreateParams</code> are optional.</p>
</li>
<li>
<p><code>pre</code>, <code>mid</code>, and <code>post</code> are lifecycle hooks.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Recreate strategy:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Executes any <code>pre</code> lifecycle hook.</p>
</li>
<li>
<p>Scales down the previous deployment to zero.</p>
</li>
<li>
<p>Executes any <code>mid</code> lifecycle hook.</p>
</li>
<li>
<p>Scales up the new deployment.</p>
</li>
<li>
<p>Executes any <code>post</code> lifecycle hook.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>During scale up, if the replica count of the deployment is greater than one, the
first replica of the deployment will be validated for readiness before fully
scaling up the deployment. If the validation of the first replica fails, the
deployment will be considered a failure.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>When to use a Recreate deployment:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>When you must run migrations or other data transformations before your new code
starts.</p>
</li>
<li>
<p>When you do not support having new and old versions of your application code
running at the same time.</p>
</li>
<li>
<p>When you want to use a RWO volume, which is not supported being shared between
multiple replicas.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A Recreate deployment incurs downtime because, for a brief period, no instances
of your application are running. However, your old code and new code do not run
at the same time.</p>
</div>
</div>
<div class="sect3">
<h4 id="deployments-custom-strategy-deployment-strategies">Custom strategy</h4>
<div class="paragraph">
<p>The Custom strategy allows you to provide your own deployment behavior.</p>
</div>
<div class="listingblock">
<div class="title">Example Custom strategy definition</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">strategy:
  type: Custom
  customParams:
    image: organization/strategy
    command: [ "command", "arg1" ]
    environment:
      - name: ENV_1
        value: VALUE_1</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, the <code>organization/strategy</code> container image provides the
deployment behavior. The optional <code>command</code> array overrides any <code>CMD</code> directive
specified in the image&#8217;s <code>Dockerfile</code>. The optional environment variables
provided are added to the execution environment of the strategy process.</p>
</div>
<div class="paragraph">
<p>Additionally, OpenShift Enterprise provides the following environment variables to the
deployment process:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Environment variable</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>OPENSHIFT_DEPLOYMENT_NAME</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the new deployment (a ReplicationController).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>OPENSHIFT_DEPLOYMENT_NAMESPACE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name space of the new deployment.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The replica count of the new deployment will initially be zero. The
responsibility of the strategy is to make the new deployment active using the
logic that best serves the needs of the user.</p>
</div>
<div class="paragraph">
<p>Alternatively, use <code>customParams</code> to inject the custom deployment logic into the
existing deployment strategies. Provide a custom shell script logic and call the
<code>openshift-deploy</code> binary. Users do not have to supply their custom deployer
container image; in this case, the default OpenShift Enterprise deployer image is
used instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">strategy:
  type: Rolling
  customParams:
    command:
    - /bin/sh
    - -c
    - |
      set -e
      openshift-deploy --until=50%
      echo Halfway there
      openshift-deploy
      echo Complete</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in following deployment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">Started deployment #2
--&gt; Scaling up custom-deployment-2 from 0 to 2, scaling down custom-deployment-1 from 2 to 0 (keep 2 pods available, don't exceed 3 pods)
    Scaling custom-deployment-2 up to 1
--&gt; Reached 50% (currently 50%)
Halfway there
--&gt; Scaling up custom-deployment-2 from 1 to 2, scaling down custom-deployment-1 from 2 to 0 (keep 2 pods available, don't exceed 3 pods)
    Scaling custom-deployment-1 down to 1
    Scaling custom-deployment-2 up to 2
    Scaling custom-deployment-1 down to 0
--&gt; Success
Complete</pre>
</div>
</div>
<div class="paragraph">
<p>If the custom deployment strategy process requires access to the OpenShift Enterprise
API or the Kubernetes API the container that executes the strategy can use the
service account token available inside the container for authentication.</p>
</div>
</div>
<div class="sect3">
<h4 id="deployments-lifecycle-hooks-deployment-strategies">Lifecycle hooks</h4>
<div class="paragraph">
<p>The Rolling and Recreate strategies support <em>lifecycle hooks</em>, or deployment
hooks, which allow behavior to be injected into the deployment process at
predefined points within the strategy:</p>
</div>
<div class="listingblock">
<div class="title">Example <code>pre</code> lifecycle hook</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">pre:
  failurePolicy: Abort
  execNewPod: {} <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>execNewPod</code> is a Pod-based lifecycle hook.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Every hook has a <code>failurePolicy</code>, which defines the action the strategy should
take when a hook failure is encountered:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>Abort</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The deployment process will be considered a failure if the hook fails.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>Retry</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The hook execution should be retried until it succeeds.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>Ignore</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any hook failure should be ignored and the deployment should proceed.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Hooks have a type-specific field that describes how to execute the hook.
Currently, Pod-based hooks are the only supported hook type, specified by the
<code>execNewPod</code> field.</p>
</div>
<h7 id="_pod-based-lifecycle-hook" class="discrete">Pod-based lifecycle hook</h7>
<div class="paragraph">
<p>Pod-based lifecycle hooks execute hook code in a new Pod derived from the
template in a DeploymentConfig.</p>
</div>
<div class="paragraph">
<p>The following simplified example DeploymentConfig uses the Rolling strategy.
Triggers and some other minor details are omitted for brevity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: DeploymentConfig
apiVersion: v1
metadata:
  name: frontend
spec:
  template:
    metadata:
      labels:
        name: frontend
    spec:
      containers:
        - name: helloworld
          image: openshift/origin-ruby-sample
  replicas: 5
  selector:
    name: frontend
  strategy:
    type: Rolling
    rollingParams:
      pre:
        failurePolicy: Abort
        execNewPod:
          containerName: helloworld <b class="conum">(1)</b>
          command: [ "/usr/bin/command", "arg1", "arg2" ] <b class="conum">(2)</b>
          env: <b class="conum">(3)</b>
            - name: CUSTOM_VAR1
              value: custom_value1
          volumes:
            - data <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>helloworld</code> name refers to <code>spec.template.spec.containers[0].name</code>.</p>
</li>
<li>
<p>This <code>command</code> overrides any <code>ENTRYPOINT</code> defined by the <code>openshift/origin-ruby-sample</code> image.</p>
</li>
<li>
<p><code>env</code> is an optional set of environment variables for the hook container.</p>
</li>
<li>
<p><code>volumes</code> is an optional set of volume references for the hook container.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In this example, the <code>pre</code> hook will be executed in a new Pod using the
<code>openshift/origin-ruby-sample</code> image from the <code>helloworld</code> container. The hook
Pod has the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The hook command is <code>/usr/bin/command arg1 arg2</code>.</p>
</li>
<li>
<p>The hook container has the <code>CUSTOM_VAR1=custom_value1</code> environment variable.</p>
</li>
<li>
<p>The hook failure policy is <code>Abort</code>, meaning the deployment process fails if the hook fails.</p>
</li>
<li>
<p>The hook Pod inherits the <code>data</code> volume from the DeploymentConfig Pod.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="deployments-setting-lifecycle-hooks-deployment-strategies">Setting lifecycle hooks</h5>
<div class="paragraph">
<p>You can set lifecycle hooks, or deployment hooks, for a DeploymentConfig using
the CLI.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Use the <code>oc set deployment-hook</code> command to set the type of hook you want:
<code>--pre</code>, <code>--mid</code>, or <code>--post</code>. For example, to set a pre-deployment hook:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set deployment-hook dc/frontend \
    --pre -c helloworld -e CUSTOM_VAR1=custom_value1 \
    -v data --failure-policy=abort -- /usr/bin/command arg1 arg2</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-route-based-deployment-strategies">Using route-based deployment strategies</h3>
<div class="paragraph">
<p>Deployment strategies provide a way for the application to evolve. Some
strategies use DeploymentConfigs to make changes that are seen by users of all
routes that resolve to the application. Other advanced strategies, such as the
ones described in this section, use router features in conjunction with
DeploymentConfigs to impact specific routes.</p>
</div>
<div class="paragraph">
<p>The most common route-based strategy is to use a <em>blue-green deployment</em>. The
new version (the blue version) is brought up for testing and evaluation, while
the users still use the stable version (the green version). When ready, the
users are switched to the blue version. If a problem arises, you can switch back
to the green version.</p>
</div>
<div class="paragraph">
<p>A common alternative strategy is to use <em>A/B versions</em> that are both active at
the same time and some users use one version, and some users use the other
version. This can be used for experimenting with user interface changes and
other features to get user feedback. It can also be used to verify proper
operation in a production context where problems impact a limited number of
users.</p>
</div>
<div class="paragraph">
<p>A canary deployment tests the new version but when a problem is detected it
quickly falls back to the previous version. This can be done with both of the
above strategies.</p>
</div>
<div class="paragraph">
<p>The route-based deployment strategies do not scale the number of Pods in the
services. To maintain desired performance characteristics the deployment
configurations may need to be scaled.</p>
</div>
<div class="sect3">
<h4 id="deployments-proxy-shard-route-based-deployment-strategies">Proxy shards and traffic splitting</h4>
<div class="paragraph">
<p>In production environments, you can precisely control the distribution of
traffic that lands on a particular shard. When dealing with large numbers of
instances, you can use the relative scale of individual shards to implement
percentage based traffic. That combines well with a <em>proxy shard</em>, which
forwards or splits the traffic it receives to a separate service or application
running elsewhere.</p>
</div>
<div class="paragraph">
<p>In the simplest configuration, the proxy forwards requests unchanged. In
more complex setups, you can duplicate the incoming requests and send to
both a separate cluster as well as to a local instance of the application, and
compare the result. Other patterns include keeping the caches of a DR
installation warm, or sampling incoming traffic for analysis purposes.</p>
</div>
<div class="paragraph">
<p>Any TCP (or UDP) proxy could be run under the desired shard. Use the <code>oc scale</code>
command to alter the relative number of instances serving requests under the
proxy shard. For more complex traffic management, consider customizing the
OpenShift Enterprise router with proportional balancing capabilities.</p>
</div>
</div>
<div class="sect3">
<h4 id="deployments-n1-compatibility-route-based-deployment-strategies">N-1 compatibility</h4>
<div class="paragraph">
<p>Applications that have new code and old code running at the same time must be
careful to ensure that data written by the new code can be read and handled (or
gracefully ignored) by the old version of the code. This is sometimes called
<em>schema evolution</em> and is a complex problem.</p>
</div>
<div class="paragraph">
<p>This can take many forms: data stored on disk, in a database, in a temporary
cache, or that is part of a user&#8217;s browser session. While most web applications
can support rolling deployments, it is important to test and design your
application to handle it.</p>
</div>
<div class="paragraph">
<p>For some applications, the period of time that old code and new code is running
side by side is short, so bugs or some failed user transactions are acceptable.
For others, the failure pattern may result in the entire application becoming
non-functional.</p>
</div>
<div class="paragraph">
<p>One way to validate N-1 compatibility is to use an A/B deployment: run the old
code and new code at the same time in a controlled way in a test environment,
and verify that traffic that flows to the new deployment does not cause failures
in the old deployment.</p>
</div>
</div>
<div class="sect3">
<h4 id="deployments-graceful-termination-route-based-deployment-strategies">Graceful termination</h4>
<div class="paragraph">
<p>OpenShift Enterprise and Kubernetes give application instances time to shut down
before removing them from load balancing rotations. However, applications must
ensure they cleanly terminate user connections as well before they exit.</p>
</div>
<div class="paragraph">
<p>On shutdown, OpenShift Enterprise sends a <code>TERM</code> signal to the processes in the
container. Application code, on receiving <code>SIGTERM</code>, stop accepting new
connections. This ensures that load balancers route traffic to other active
instances. The application code then waits until all open connections are closed
(or gracefully terminate individual connections at the next opportunity) before
exiting.</p>
</div>
<div class="paragraph">
<p>After the graceful termination period expires, a process that has not exited is
sent the <code>KILL</code> signal, which immediately ends the process. The
<code>terminationGracePeriodSeconds</code> attribute of a Pod or Pod template controls the
graceful termination period (default 30 seconds) and may be customized per
application as necessary.</p>
</div>
</div>
<div class="sect3">
<h4 id="deployments-blue-green-route-based-deployment-strategies">Blue-green deployments</h4>
<div class="paragraph">
<p>Blue-green deployments involve running two versions of an application at the
same time and moving traffic from the in-production version (the green version)
to the newer version (the blue version). You can use a Rolling strategy or
switch services in a route.</p>
</div>
<div class="paragraph">
<p>Because many applications depend on persistent data, you must have an
application that supports <em>N-1 compatibility</em>, which means it shares data and
implements live migration between the database, store, or disk by creating two
copies of the data layer.</p>
</div>
<div class="paragraph">
<p>Consider the data used in testing the new version. If it is the production data,
a bug in the new version can break the production version.</p>
</div>
<div class="sect4">
<h5 id="deployments-blue-green-setting-up-route-based-deployment-strategies">Setting up a blue-green deployment</h5>
<div class="paragraph">
<p>Blue-green deployments use two DeploymentConfigs. Both are running, and
the one in production depends on the service the route specifies, with each
DeploymentConfig exposed to a different service.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Routes are intended for web (HTTP and HTTPS) traffic, so this technique is best
suited for web applications.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can create a new route to the new version and test it. When ready, change
the service in the production route to point to the new service and the
new (blue) version is live.</p>
</div>
<div class="paragraph">
<p>If necessary, you can roll back to the older (green) version by switching
the service back to the previous version.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create two copies of the example application:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc new-app openshift/deployment-example:v1 --name=example-green
$ oc new-app openshift/deployment-example:v2 --name=example-blue</pre>
</div>
</div>
<div class="paragraph">
<p>This creates two independent application components: one running the <code>v1</code> image
under the <code>example-green</code> service, and one using the <code>v2</code> image under the
<code>example-blue</code> service.</p>
</div>
</li>
<li>
<p>Create a route that points to the old service:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc expose svc/example-green --name=bluegreen-example</pre>
</div>
</div>
</li>
<li>
<p>Browse to the application at <code>example-green.&lt;project&gt;.&lt;router_domain&gt;</code> to
verify you see the <code>v1</code> image.</p>
</li>
<li>
<p>Edit the route and change the service name to <code>example-blue</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc patch route/bluegreen-example -p '{"spec":{"to":{"name":"example-blue"}}}'</pre>
</div>
</div>
</li>
<li>
<p>To verify that the route has changed, refresh the browser until you see the
<code>v2</code> image.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="deployments-ab-testing-route-based-deployment-strategies">A/B deployments</h4>
<div class="paragraph">
<p>The A/B deployment strategy lets you try a new version of the application in a
limited way in the production environment. You can specify that the production
version gets most of the user requests while a limited fraction of requests go
to the new version.</p>
</div>
<div class="paragraph">
<p>Because you control the portion of requests to each version, as testing
progresses you can increase the fraction of requests to the new version and
ultimately stop using the previous version. As you adjust the request load on
each version, the number of Pods in each service may need to be scaled as well
to provide the expected performance.</p>
</div>
<div class="paragraph">
<p>In addition to upgrading software, you can use this feature to experiment with
versions of the user interface. Since some users get the old version and some
the new, you can evaluate the user&#8217;s reaction to the different versions to
inform design decisions.</p>
</div>
<div class="paragraph">
<p>For this to be effective, both the old and new versions must be similar enough
that both can run at the same time. This is common with bug fix releases and
when new features do not interfere with the old. The versions require N-1
compatibility to properly work together.</p>
</div>
<div class="paragraph">
<p>OpenShift Enterprise supports N-1 compatibility through the web console as well as
the CLI.</p>
</div>
<div class="sect4">
<h5 id="deployments-ab-testing-lb-route-based-deployment-strategies">Load balancing for A/B testing</h5>
<div class="paragraph">
<p>The user sets up a route with multiple services. Each service handles a version
of the application.</p>
</div>
<div class="paragraph">
<p>Each service is assigned a <code>weight</code> and the portion of requests to each service
is the <code>service_weight</code> divided by the <code>sum_of_weights</code>. The <code>weight</code> for each
service is distributed to the service&#8217;s endpoints so that the sum of the
endpoint <code>weights</code> is the service <code>weight</code>.</p>
</div>
<div class="paragraph">
<p>The route can have up to four services. The <code>weight</code> for the service can be
between <code>0</code> and <code>256</code>. When the <code>weight</code> is <code>0</code>, the service does not participate in load-balancing
but continues to serve existing persistent connections. When the service <code>weight</code>
is not <code>0</code>, each endpoint has a minimum <code>weight</code> of <code>1</code>. Because of this, a
service with a lot of endpoints can end up with higher <code>weight</code> than desired.
In this case, reduce the number of Pods to get the desired load balance
<code>weight</code>.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To set up the A/B environment:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the two applications and give them different names. Each creates a
DeploymentConfig. The applications are versions of the same program; one
is usually the current production version and the other the proposed new
version:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc new-app openshift/deployment-example --name=ab-example-a
$ oc new-app openshift/deployment-example --name=ab-example-b</pre>
</div>
</div>
<div class="paragraph">
<p>Both applications are deployed and services are created.</p>
</div>
</li>
<li>
<p>Make the application available externally via a route. At this point, you can
expose either. It can be convenient to expose the current production version
first and later modify the route to add the new version.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc expose svc/ab-example-a</pre>
</div>
</div>
<div class="paragraph">
<p>Browse to the application at <code>ab-example-&lt;project&gt;.&lt;router_domain&gt;</code> to verify
that you see the desired version.</p>
</div>
</li>
<li>
<p>When you deploy the route, the router balances the traffic according to the
<code>weights</code> specified for the services. At this point, there is a single service
with default <code>weight=1</code> so all requests go to it. Adding the other service as an
<code>alternateBackends</code> and adjusting the <code>weights</code> brings the A/B setup to
life. This can be done by the <code>oc set route-backends</code> command or by editing the
route.</p>
<div class="paragraph">
<p>Setting the <code>oc set route-backend</code> to <code>0</code> means the service does not participate
in load-balancing, but continues to serve existing persistent connections.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Changes to the route just change the portion of traffic to the various services.
You might need to scale the DeploymentConfigs to adjust the number of Pods
to handle the anticipated loads.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To edit the route, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc edit route &lt;route_name&gt;
...
metadata:
  name: route-alternate-service
  annotations:
    haproxy.router.openshift.io/balance: roundrobin
spec:
  host: ab-example.my-project.my-domain
  to:
    kind: Service
    name: ab-example-a
    weight: 10
  alternateBackends:
  - kind: Service
    name: ab-example-b
    weight: 15
...</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="deployments-ab-testing-lb-web-route-based-deployment-strategies">Managing weights using the web console</h6>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Navigate to the Route details page (Applications/Routes).</p>
</li>
<li>
<p>Select <strong>Edit</strong> from the Actions menu.</p>
</li>
<li>
<p>Check <strong>Split traffic across multiple services</strong>.</p>
</li>
<li>
<p>The <strong>Service Weights</strong> slider sets the percentage of traffic sent to each service.</p>
<div class="paragraph">
<p>For traffic split between more than two services, the relative weights are
specified by integers between 0 and 256 for each service.</p>
</div>
<div class="paragraph">
<p>Traffic weightings are shown on the <strong>Overview</strong> in the expanded rows of the
applications between which traffic is split.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="deployments-ab-testing-lb-cli-route-based-deployment-strategies">Managing weights using the CLI</h6>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To manage the services and corresponding weights load balanced by the route,
use the <code>oc set route-backends</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set route-backends ROUTENAME \
    [--zero|--equal] [--adjust] SERVICE=WEIGHT[%] [...] [options]</pre>
</div>
</div>
<div class="paragraph">
<p>For example, the following sets <code>ab-example-a</code> as the primary service with
<code>weight=198</code> and <code>ab-example-b</code> as the first alternate service with a
<code>weight=2</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set route-backends ab-example ab-example-a=198 ab-example-b=2</pre>
</div>
</div>
<div class="paragraph">
<p>This means 99% of traffic is sent to service <code>ab-example-a</code> and 1% to
service <code>ab-example-b</code>.</p>
</div>
<div class="paragraph">
<p>This command does not scale the DeploymentConfigs. You might be required to do
so to have enough Pods to handle the request load.</p>
</div>
</li>
<li>
<p>Run the command with no flags to verify the current configuration:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set route-backends ab-example
NAME                    KIND     TO           WEIGHT
routes/ab-example       Service  ab-example-a 198 (99%)
routes/ab-example       Service  ab-example-b 2   (1%)</pre>
</div>
</div>
</li>
<li>
<p>To alter the weight of an individual service relative to itself or to the
primary service, use the <code>--adjust</code> flag. Specifying a percentage adjusts the
service relative to either the primary or the first alternate (if you specify
the primary). If there are other backends, their weights are kept proportional
to the changed.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set route-backends ab-example --adjust ab-example-a=200 ab-example-b=10
$ oc set route-backends ab-example --adjust ab-example-b=5%
$ oc set route-backends ab-example --adjust ab-example-b=+15%</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>--equal</code> flag sets the <code>weight</code> of all services to <code>100</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set route-backends ab-example --equal</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>--zero</code> flag sets the <code>weight</code> of all services to <code>0</code>. All requests then
return with a 503 error.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Not all routers may support multiple or weighted backends.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="deployments-ab-one-service-multi-dc-route-based-deployment-strategies">One service, multiple DeploymentConfigs</h6>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a new application, adding a label <code>ab-example=true</code> that will be common
to all shards:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc new-app openshift/deployment-example --name=ab-example-a</pre>
</div>
</div>
<div class="paragraph">
<p>The application is deployed and a service is created. This is the first shard.</p>
</div>
</li>
<li>
<p>Make the application available via a route (or use the service IP directly):</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc expose svc/ab-example-a --name=ab-example</pre>
</div>
</div>
</li>
<li>
<p>Browse to the application at <code>ab-example-&lt;project&gt;.&lt;router_domain&gt;</code> to verify
you see the <code>v1</code> image.</p>
</li>
<li>
<p>Create a second shard based on the same source image and label as the first
shard, but with a different tagged version and unique environment variables:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc new-app openshift/deployment-example:v2 \
    --name=ab-example-b --labels=ab-example=true \
    SUBTITLE="shard B" COLOR="red"</pre>
</div>
</div>
</li>
<li>
<p>At this point, both sets of Pods are being served under the route. However,
because both browsers (by leaving a connection open) and the router (by default,
through a cookie) attempt to preserve your connection to a back-end server,
you might not see both shards being returned to you.</p>
<div class="paragraph">
<p>To force your browser to one or the other shard:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Use the <code>oc scale</code> command to reduce replicas of <code>ab-example-a</code> to <code>0</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc scale dc/ab-example-a --replicas=0</pre>
</div>
</div>
<div class="paragraph">
<p>Refresh your browser to show <code>v2</code> and <code>shard B</code> (in red).</p>
</div>
</li>
<li>
<p>Scale <code>ab-example-a</code> to <code>1</code> replica and <code>ab-example-b</code> to <code>0</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc scale dc/ab-example-a --replicas=1; oc scale dc/ab-example-b --replicas=0</pre>
</div>
</div>
<div class="paragraph">
<p>Refresh your browser to show <code>v1</code> and <code>shard A</code> (in blue).</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>If you trigger a deployment on either shard, only the Pods in that shard are
affected. You can trigger a deployment by changing the <code>SUBTITLE</code> environment
variable in either DeploymentConfig:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc edit dc/ab-example-a</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc edit dc/ab-example-b</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_crds">CRDs</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="extending-the-kubernetes-api-with-crds">Extending the Kubernetes API with Custom Resource Definitions</h3>
<div class="paragraph">
<p>This guide describes how cluster administrators can extend their OpenShift Enterprise
cluster by creating and managing Custom Resource Definitions (CRDs).</p>
</div>
<div class="sect3">
<h4 id="crd-custom-resource-definitions-crd-extending-api-with-crds">Custom Resource Definitions</h4>
<div class="paragraph">
<p>In the Kubernetes API, a resource is an endpoint that stores a collection of API
objects of a certain kind. For example, the built-in Pods resource contains a
collection of Pod objects.</p>
</div>
<div class="paragraph">
<p>A <em>Custom Resource Definition</em> (CRD) object defines a new, unique object <code>Kind</code>
in the cluster and lets the Kubernetes API server handle its entire lifecycle.</p>
</div>
<div class="paragraph">
<p><em>Custom Resource</em> (CR) objects are created from CRDs that have been added to
the cluster by a cluster administrator, allowing all cluster users to add the
new resource type into projects.</p>
</div>
<div class="paragraph">
<p>When a cluster administrator adds a new CRD to the cluster, the Kubernetes API
server reacts by creating a new RESTful resource path that can be accessed by
the entire cluster or a single project (namespace) and begins serving the
specified CR.</p>
</div>
<div class="paragraph">
<p>Cluster administrators that want to grant access to the CRD to other users can
use cluster role aggregation to grant access to users with the <code>admin</code>, <code>edit</code>,
or <code>view</code> default cluster roles. Cluster role aggregation allows the insertion
of custom policy rules into these cluster roles. This behavior integrates the
new resource into the cluster&#8217;s RBAC policy as if it was a built-in resource.</p>
</div>
<div class="paragraph">
<p>Operators in particular make use of CRDs by packaging them with any required
RBAC policy and other software-specific logic. Cluster administrators can also
add CRDs manually to the cluster outside of an Operator&#8217;s lifecycle, making them
available to all users.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>While only cluster administrators can create CRDs, developers can create the CR
from an existing CRD if they have read and write permission to it.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="crd-creating-custom-resources-definition-crd-extending-api-with-crds">Creating a Custom Resource Definition</h4>
<div class="paragraph">
<p>To create Custom Resource (CR) objects, cluster administrators must first create
a Custom Resource Definition (CRD).</p>
</div>
<div class="ulist">
<div class="title">Prereqiusites</div>
<ul>
<li>
<p>Access to an OpenShift Enterprise cluster with <code>cluster-admin</code> user privileges.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To create a CRD:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a YAML file that contains the following field types:</p>
<div class="listingblock">
<div class="title">Example YAML file for a CRD</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: apiextensions.k8s.io/v1beta1 <b class="conum">(1)</b>
kind: CustomResourceDefinition
metadata:
  name: crontabs.stable.example.com <b class="conum">(2)</b>
spec:
  group: stable.example.com <b class="conum">(3)</b>
  version: v1 <b class="conum">(4)</b>
  scope: Namespaced <b class="conum">(5)</b>
  names:
    plural: crontabs <b class="conum">(6)</b>
    singular: crontab <b class="conum">(7)</b>
    kind: CronTab <b class="conum">(8)</b>
    shortNames:
    - ct <b class="conum">(9)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Use the <code>apiextensions.k8s.io/v1beta1</code> API.</p>
</li>
<li>
<p>Specify a name for the definition. This must be in the &lt;plural-name&gt;.&lt;group&gt; format using the values from the <code>group</code> and <code>plural</code> fields.</p>
</li>
<li>
<p>Specify a group name for the API. An API group is a collection of objects that are logically related. For example, all batch objects like <code>Job</code> or <code>ScheduledJob</code> could be in the batch API Group (such as batch.api.example.com). A good practice is to use a fully-qualified-domain name of your organization.</p>
</li>
<li>
<p>Specify a version name to be used in the URL. Each API Group can exist in multiple versions. For example: <code>v1alpha</code>, <code>v1beta</code>, <code>v1</code>.</p>
</li>
<li>
<p>Specify whether the custom objects are available to a project (<code>Namespaced</code>) or all projects
in the cluster (<code>Cluster</code>).</p>
</li>
<li>
<p>Specify the plural name to use in the URL. The <code>plural</code> field is the same as a resource in an API URL.</p>
</li>
<li>
<p>Specify a singular name to use as an alias on the CLI and for display.</p>
</li>
<li>
<p>Specify the kind of objects that can be created. The type can be in CamelCase.</p>
</li>
<li>
<p>Specify a shorter string to match your resource on the CLI.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>By default, a CRD is cluster-scoped and available to all projects.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create the CRD object:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create -f &lt;file_name&gt;.yaml</pre>
</div>
</div>
<div class="paragraph">
<p>A new RESTful API endpoint is created at:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">/apis/&lt;spec:group&gt;/&lt;spec:version&gt;/&lt;scope&gt;/*/&lt;names-plural&gt;/...</pre>
</div>
</div>
<div class="paragraph">
<p>For example, using the example file, the following endpoint is created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">/apis/stable.example.com/v1/namespaces/*/crontabs/...</pre>
</div>
</div>
<div class="paragraph">
<p>You can now use this endpoint URL to create and manage CRs. The object <code>Kind</code> is
based on the <code>spec.kind</code> field of the CRD object you created.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="crd-creating-aggregated-cluster-role-crd-extending-api-with-crds">Creating cluster roles for Custom Resource Definitions</h4>
<div class="paragraph">
<p>After creating a cluster-scoped Custom Resource Definition (CRD), cluster
administrators can grant permissions to it. If you use the <code>admin</code>, <code>edit</code>, and
<code>view</code> default cluster roles, take advantage of cluster role aggregation for
their rules.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>You must explicitly assign permissions to each of these roles. The roles with
more permissions do not inherit rules from roles with fewer permissions. If you
assign a rule to a role, you must also assign that verb to roles that have more
permissions. For example, if you grant the <code>get crontabs</code> permission to the view
role, you must also grant it to the edit and admin roles. The admin or edit role
is usually assigned to the user that created a project through the project
template.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create a CRD.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a cluster role definition file for the CRD. The cluster role definition
is a YAML file that contains the rules that apply to each cluster role. The
OpenShift Enterprise controller adds the rules that you specify to the default
cluster roles.</p>
<div class="listingblock">
<div class="title">Example YAML file for a cluster role definition</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1 <b class="conum">(1)</b>
metadata:
  name: aggregate-cron-tabs-admin-edit <b class="conum">(2)</b>
  labels:
    rbac.authorization.k8s.io/aggregate-to-admin: "true" <b class="conum">(3)</b>
    rbac.authorization.k8s.io/aggregate-to-edit: "true" <b class="conum">(4)</b>
rules:
- apiGroups: ["stable.example.com"] <b class="conum">(5)</b>
  resources: ["crontabs"] <b class="conum">(6)</b>
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete", "deletecollection"] <b class="conum">(7)</b>
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: aggregate-cron-tabs-view <b class="conum">(2)</b>
  labels:
    # Add these permissions to the "view" default role.
    rbac.authorization.k8s.io/aggregate-to-view: "true" <b class="conum">(8)</b>
    rbac.authorization.k8s.io/aggregate-to-cluster-reader: "true" <b class="conum">(9)</b>
rules:
- apiGroups: ["stable.example.com"] <b class="conum">(5)</b>
  resources: ["crontabs"] <b class="conum">(6)</b>
  verbs: ["get", "list", "watch"] <b class="conum">(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Use the <code>rbac.authorization.k8s.io/v1</code> API.</p>
</li>
<li>
<p>Specify a name for the definition.</p>
</li>
<li>
<p>Specify this label to grant permissions to the admin default role.</p>
</li>
<li>
<p>Specify this label to grant permissions to the edit default role.</p>
</li>
<li>
<p>Specify the group name of the CRD.</p>
</li>
<li>
<p>Specify the plural name of the CRD that these rules apply to.</p>
</li>
<li>
<p>Specify the verbs that represent the permissions that are granted to the role.
For example, apply read and write permissions to the <code>admin</code> and <code>edit</code> roles
and only read permission to the <code>view</code> role.</p>
</li>
<li>
<p>Specify this label to grant permissions to the <code>view</code> default role.</p>
</li>
<li>
<p>Specify this label to grant permissions to the <code>cluster-reader</code> default role.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create the cluster role:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create -f &lt;file_name&gt;.yaml</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="crd-creating-custom-resources-from-file-crd-extending-api-with-crds">Creating Custom Resources from a file</h4>
<div class="paragraph">
<p>After a Custom Resource Definition (CRD) has been added to the cluster by a
cluster administrator, Custom Resources (CRs) can be created with the CLI from a
file using the CR specification.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>CRD added to the cluster by a cluster administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a YAML file for the CR. In the following example definition, the
<code>cronSpec</code> and <code>image</code> custom fields are set in a CR of <code>Kind: CronTab</code>. The
<code>Kind</code> comes from the <code>spec.kind</code> field of the CRD object.</p>
<div class="listingblock">
<div class="title">Example YAML file for a CR</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: "stable.example.com/v1" <b class="conum">(1)</b>
kind: CronTab <b class="conum">(2)</b>
metadata:
  name: my-new-cron-object <b class="conum">(3)</b>
  finalizers: <b class="conum">(4)</b>
  - finalizer.stable.example.com
spec: <b class="conum">(5)</b>
  cronSpec: "* * * * /5"
  image: my-awesome-cron-image</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Specify the group name and API version (name/version) from the Custom Resource Definition.</p>
</li>
<li>
<p>Specify the type in the CRD.</p>
</li>
<li>
<p>Specify a name for the object.</p>
</li>
<li>
<p>Specify the
<a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/extend-api-custom-resource-definitions/#finalizers">finalizers</a>
for the object, if any. Finalizers allow controllers to implement conditions
that must be completed before the object can be deleted.</p>
</li>
<li>
<p>Specify conditions specific to the type of object.</p>
</li>
</ol>
</div>
</li>
<li>
<p>After you create the file, create the object:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create -f &lt;file_name&gt;.yaml</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="crd-inspecting-custom-resources-crd-extending-api-with-crds">Inspecting Custom Resources</h4>
<div class="paragraph">
<p>After you create a Custom Resource (CR) object, you can inspect and get
information about the created object using the CLI.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create a CR object.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To get information on a specific <code>Kind</code> of a CR, run:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get &lt;kind&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get crontab

NAME                 KIND
my-new-cron-object   CronTab.v1.stable.example.com</pre>
</div>
</div>
<div class="paragraph">
<p>Resource names are not case-sensitive, and you can use either the singular or
plural forms defined in the CRD, as well as any short name. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get crontabs
$ oc get crontab
$ oc get ct</pre>
</div>
</div>
</li>
<li>
<p>You can also view the raw YAML data for a CR:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get &lt;kind&gt; -o yaml</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get ct -o yaml

apiVersion: v1
items:
- apiVersion: stable.example.com/v1
  kind: CronTab
  metadata:
    clusterName: ""
    creationTimestamp: 2017-05-31T12:56:35Z
    deletionGracePeriodSeconds: null
    deletionTimestamp: null
    name: my-new-cron-object
    namespace: default
    resourceVersion: "285"
    selfLink: /apis/stable.example.com/v1/namespaces/default/crontabs/my-new-cron-object
    uid: 9423255b-4600-11e7-af6a-28d2447dc82b
  spec:
    cronSpec: '* * * * /5' <b class="conum">(1)</b>
    image: my-awesome-cron-image <b class="conum">(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Custom data from the YAML that you used to create the object displays.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="managing-resources-from-crds">Managing resources from Custom Resource Definitions</h3>
<div class="paragraph">
<p>This guide describes how developers can manage Custom Resources (CRs) that come
from Custom Resource Definitions (CRDs).</p>
</div>
<div class="sect3">
<h4 id="crd-custom-resource-definitions-crd-managing-resources-from-crds">Custom Resource Definitions</h4>
<div class="paragraph">
<p>In the Kubernetes API, a resource is an endpoint that stores a collection of API
objects of a certain kind. For example, the built-in Pods resource contains a
collection of Pod objects.</p>
</div>
<div class="paragraph">
<p>A <em>Custom Resource Definition</em> (CRD) object defines a new, unique object <code>Kind</code>
in the cluster and lets the Kubernetes API server handle its entire lifecycle.</p>
</div>
<div class="paragraph">
<p><em>Custom Resource</em> (CR) objects are created from CRDs that have been added to
the cluster by a cluster administrator, allowing all cluster users to add the
new resource type into projects.</p>
</div>
<div class="paragraph">
<p>Operators in particular make use of CRDs by packaging them with any required
RBAC policy and other software-specific logic. Cluster administrators can also
add CRDs manually to the cluster outside of an Operator&#8217;s lifecycle, making them
available to all users.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>While only cluster administrators can create CRDs, developers can create the CR
from an existing CRD if they have read and write permission to it.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="crd-creating-custom-resources-from-file-crd-managing-resources-from-crds">Creating Custom Resources from a file</h4>
<div class="paragraph">
<p>After a Custom Resource Definition (CRD) has been added to the cluster by a
cluster administrator, Custom Resources (CRs) can be created with the CLI from a
file using the CR specification.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>CRD added to the cluster by a cluster administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a YAML file for the CR. In the following example definition, the
<code>cronSpec</code> and <code>image</code> custom fields are set in a CR of <code>Kind: CronTab</code>. The
<code>Kind</code> comes from the <code>spec.kind</code> field of the CRD object.</p>
<div class="listingblock">
<div class="title">Example YAML file for a CR</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: "stable.example.com/v1" <b class="conum">(1)</b>
kind: CronTab <b class="conum">(2)</b>
metadata:
  name: my-new-cron-object <b class="conum">(3)</b>
  finalizers: <b class="conum">(4)</b>
  - finalizer.stable.example.com
spec: <b class="conum">(5)</b>
  cronSpec: "* * * * /5"
  image: my-awesome-cron-image</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Specify the group name and API version (name/version) from the Custom Resource Definition.</p>
</li>
<li>
<p>Specify the type in the CRD.</p>
</li>
<li>
<p>Specify a name for the object.</p>
</li>
<li>
<p>Specify the
<a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/extend-api-custom-resource-definitions/#finalizers">finalizers</a>
for the object, if any. Finalizers allow controllers to implement conditions
that must be completed before the object can be deleted.</p>
</li>
<li>
<p>Specify conditions specific to the type of object.</p>
</li>
</ol>
</div>
</li>
<li>
<p>After you create the file, create the object:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create -f &lt;file_name&gt;.yaml</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="crd-inspecting-custom-resources-crd-managing-resources-from-crds">Inspecting Custom Resources</h4>
<div class="paragraph">
<p>After you create a Custom Resource (CR) object, you can inspect and get
information about the created object using the CLI.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create a CR object.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To get information on a specific <code>Kind</code> of a CR, run:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get &lt;kind&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get crontab

NAME                 KIND
my-new-cron-object   CronTab.v1.stable.example.com</pre>
</div>
</div>
<div class="paragraph">
<p>Resource names are not case-sensitive, and you can use either the singular or
plural forms defined in the CRD, as well as any short name. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get crontabs
$ oc get crontab
$ oc get ct</pre>
</div>
</div>
</li>
<li>
<p>You can also view the raw YAML data for a CR:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get &lt;kind&gt; -o yaml</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get ct -o yaml

apiVersion: v1
items:
- apiVersion: stable.example.com/v1
  kind: CronTab
  metadata:
    clusterName: ""
    creationTimestamp: 2017-05-31T12:56:35Z
    deletionGracePeriodSeconds: null
    deletionTimestamp: null
    name: my-new-cron-object
    namespace: default
    resourceVersion: "285"
    selfLink: /apis/stable.example.com/v1/namespaces/default/crontabs/my-new-cron-object
    uid: 9423255b-4600-11e7-af6a-28d2447dc82b
  spec:
    cronSpec: '* * * * /5' <b class="conum">(1)</b>
    image: my-awesome-cron-image <b class="conum">(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Custom data from the YAML that you used to create the object displays.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quotas">Quotas</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="resource-quotas-per-project">Resource quotas per project</h3>
<div class="paragraph">
<p>A <em>resource quota</em>, defined by a ResourceQuota object, provides constraints that
limit aggregate resource consumption per project. It can limit the quantity of
objects that can be created in a project by type, as well as the total amount of
compute resources and storage that may be consumed by resources in that project.</p>
</div>
<div class="paragraph">
<p>This guide describes how resource quotas work, how cluster administrators can
set and manage resource quotas on a per project basis, and how developers and
cluster administrators can view them.</p>
</div>
<div class="sect3">
<h4 id="quotas-resources-managed-quotas-setting-per-project">Resources managed by quotas</h4>
<div class="paragraph">
<p>The following describes the set of compute resources and object types that can
be managed by a quota.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>A pod is in a terminal state if <code>status.phase in (Failed, Succeeded)</code> is true.</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Compute resources managed by quota</caption>
<colgroup>
<col style="width: 27.2727%;">
<col style="width: 72.7273%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Resource Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>cpu</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The sum of CPU requests across all pods in a non-terminal state cannot exceed
this value. <code>cpu</code> and <code>requests.cpu</code> are the same value and can be used
interchangeably.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>memory</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The sum of memory requests across all pods in a non-terminal state cannot
exceed this value. <code>memory</code> and <code>requests.memory</code> are the same value and can
be used interchangeably.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>ephemeral-storage</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The sum of local ephemeral storage requests across all pods in a non-terminal
state cannot exceed this value. <code>ephemeral-storage</code> and
<code>requests.ephemeral-storage</code> are the same value and can be used
interchangeably. This resource is available only if you enabled the ephemeral
storage technology preview. This feature is disabled by
default.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>requests.cpu</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The sum of CPU requests across all pods in a non-terminal state cannot exceed
this value. <code>cpu</code> and <code>requests.cpu</code> are the same value and can be used
interchangeably.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>requests.memory</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The sum of memory requests across all pods in a non-terminal state cannot
exceed this value. <code>memory</code> and <code>requests.memory</code> are the same value and can
be used interchangeably.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>requests.ephemeral-storage</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The sum of ephemeral storage requests across all pods in a non-terminal state
cannot exceed this value. <code>ephemeral-storage</code> and
<code>requests.ephemeral-storage</code> are the same value and can be used
interchangeably. This resource is available only if you enabled the ephemeral
storage technology preview. This feature is disabled by default.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>limits.cpu</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The sum of CPU limits across all pods in a non-terminal state cannot exceed
this value.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>limits.memory</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The sum of memory limits across all pods in a non-terminal state cannot exceed
this value.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>limits.ephemeral-storage</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The sum of ephemeral storage limits across all pods in a non-terminal state
cannot exceed this value. This resource is available only if you enabled the
ephemeral storage technology preview. This feature is disabled by default.</p>
</div></div></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Storage resources managed by quota</caption>
<colgroup>
<col style="width: 27.2727%;">
<col style="width: 72.7273%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Resource Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>requests.storage</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The sum of storage requests across all persistent volume claims in any state
cannot exceed this value.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>persistentvolumeclaims</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of persistent volume claims that can exist in the project.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&lt;storage-class-name&gt;.storageclass.storage.k8s.io/requests.storage</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The sum of storage requests across all persistent volume claims in any state
that have a matching storage class, cannot exceed this value.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&lt;storage-class-name&gt;.storageclass.storage.k8s.io/persistentvolumeclaims</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of persistent volume claims with a matching storage class that
can exist in the project.</p>
</div></div></td>
</tr>
</tbody>
</table>
<table id="quotas-object-counts-managed-quotas-setting-per-project" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Object counts managed by quota</caption>
<colgroup>
<col style="width: 27.2727%;">
<col style="width: 72.7273%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Resource Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>pods</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of pods in a non-terminal state that can exist in the project.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>replicationcontrollers</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of ReplicationControllers that can exist in the project.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>resourcequotas</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of resource quotas that can exist in the project.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>services</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of services that can exist in the project.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>secrets</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of secrets that can exist in the project.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>configmaps</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of <code>ConfigMap</code> objects that can exist in the project.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>persistentvolumeclaims</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of persistent volume claims that can exist in the project.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>openshift.io/imagestreams</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of imagestreams that can exist in the project.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="quotas-scopes-quotas-setting-per-project">Quota scopes</h4>
<div class="paragraph">
<p>Each quota can have an associated set of <em>scopes</em>. A quota only measures usage
for a resource if it matches the intersection of enumerated scopes.</p>
</div>
<div class="paragraph">
<p>Adding a scope to a quota restricts the set of resources to which that quota can
apply. Specifying a resource outside of the allowed set results in a validation
error.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scope</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Terminating</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Match pods where <code>spec.activeDeadlineSeconds &gt;= 0</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotTerminating</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Match pods where <code>spec.activeDeadlineSeconds</code> is <code>nil</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BestEffort</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Match pods that have best effort quality of service for either <code>cpu</code> or
<code>memory</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotBestEffort</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Match pods that do not have best effort quality of service for <code>cpu</code> and
<code>memory</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A <code>BestEffort</code> scope restricts a quota to limiting the following resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>pods</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A <code>Terminating</code>, <code>NotTerminating</code>, and <code>NotBestEffort</code> scope restricts a quota
to tracking the following resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>pods</code></p>
</li>
<li>
<p><code>memory</code></p>
</li>
<li>
<p><code>requests.memory</code></p>
</li>
<li>
<p><code>limits.memory</code></p>
</li>
<li>
<p><code>cpu</code></p>
</li>
<li>
<p><code>requests.cpu</code></p>
</li>
<li>
<p><code>limits.cpu</code></p>
</li>
<li>
<p><code>ephemeral-storage</code></p>
</li>
<li>
<p><code>requests.ephemeral-storage</code></p>
</li>
<li>
<p><code>limits.ephemeral-storage</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Ephemeral storage requests and limits apply only if you enabled the
ephemeral storage technology preview. This feature is
disabled by default.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="quota-enforcement-quotas-setting-per-project">Quota enforcement</h4>
<div class="paragraph">
<p>After a resource quota for a project is first created, the project restricts the
ability to create any new resources that may violate a quota constraint until it
has calculated updated usage statistics.</p>
</div>
<div class="paragraph">
<p>After a quota is created and usage statistics are updated, the project accepts
the creation of new content. When you create or modify resources, your quota
usage is incremented immediately upon the request to create or modify the
resource.</p>
</div>
<div class="paragraph">
<p>When you delete a resource, your quota use is decremented during the next full
recalculation of quota statistics for the project. A configurable amount of time
determines how long it takes to reduce quota usage statistics to their current
observed system value.</p>
</div>
<div class="paragraph">
<p>If project modifications exceed a quota usage limit, the server denies the
action, and an appropriate error message is returned to the user explaining the
quota constraint violated, and what their currently observed usage statistics
are in the system.</p>
</div>
</div>
<div class="sect3">
<h4 id="quotas-requests-vs-limits-quotas-setting-per-project">Requests versus limits</h4>
<div class="paragraph">
<p>When allocating compute resources, each container might specify a request and a
limit value each for CPU, memory, and ephemeral storage. Quotas can restrict any
of these values.</p>
</div>
<div class="paragraph">
<p>If the quota has a value specified for <code>requests.cpu</code> or <code>requests.memory</code>,
then it requires that every incoming container make an explicit request for
those resources. If the quota has a value specified for <code>limits.cpu</code> or
<code>limits.memory</code>, then it requires that every incoming container specify an
explicit limit for those resources.</p>
</div>
</div>
<div class="sect3">
<h4 id="quotas-sample-resource-quota-definitions-quotas-setting-per-project">Sample resource quota definitions</h4>
<div class="listingblock">
<div class="title"><code>core-object-counts.yaml</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ResourceQuota
metadata:
  name: core-object-counts
spec:
  hard:
    configmaps: "10" <b class="conum">(1)</b>
    persistentvolumeclaims: "4" <b class="conum">(2)</b>
    replicationcontrollers: "20" <b class="conum">(3)</b>
    secrets: "10" <b class="conum">(4)</b>
    services: "10" <b class="conum">(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The total number of <code>ConfigMap</code> objects that can exist in the project.</p>
</li>
<li>
<p>The total number of persistent volume claims (PVCs) that can exist in the
project.</p>
</li>
<li>
<p>The total number of ReplicationControllers that can exist in the project.</p>
</li>
<li>
<p>The total number of secrets that can exist in the project.</p>
</li>
<li>
<p>The total number of services that can exist in the project.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title"><code>openshift-object-counts.yaml</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ResourceQuota
metadata:
  name: openshift-object-counts
spec:
  hard:
    openshift.io/imagestreams: "10" <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The total number of imagestreams that can exist in the project.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title"><code>compute-resources.yaml</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ResourceQuota
metadata:
  name: compute-resources
spec:
  hard:
    pods: "4" <b class="conum">(1)</b>
    requests.cpu: "1" <b class="conum">(2)</b>
    requests.memory: 1Gi <b class="conum">(3)</b>
    requests.ephemeral-storage: 2Gi <b class="conum">(4)</b>
    limits.cpu: "2" <b class="conum">(5)</b>
    limits.memory: 2Gi <b class="conum">(6)</b>
    limits.ephemeral-storage: 4Gi <b class="conum">(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The total number of pods in a non-terminal state that can exist in the
project.</p>
</li>
<li>
<p>Across all pods in a non-terminal state, the sum of CPU requests cannot
exceed 1 core.</p>
</li>
<li>
<p>Across all pods in a non-terminal state, the sum of memory requests cannot
exceed 1Gi.</p>
</li>
<li>
<p>Across all pods in a non-terminal state, the sum of ephemeral storage requests cannot
exceed 2Gi.</p>
</li>
<li>
<p>Across all pods in a non-terminal state, the sum of CPU limits cannot exceed
2 cores.</p>
</li>
<li>
<p>Across all pods in a non-terminal state, the sum of memory limits cannot
exceed 2Gi.</p>
</li>
<li>
<p>Across all pods in a non-terminal state, the sum of ephemeral storage limits cannot
exceed 4Gi.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title"><code>besteffort.yaml</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ResourceQuota
metadata:
  name: besteffort
spec:
  hard:
    pods: "1" <b class="conum">(1)</b>
  scopes:
  - BestEffort <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The total number of pods in a non-terminal state with <code>BestEffort</code> quality
of service that can exist in the project.</p>
</li>
<li>
<p>Restricts the quota to only matching pods that have <code>BestEffort</code> quality of
service for either memory or CPU.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title"><code>compute-resources-long-running.yaml</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ResourceQuota
metadata:
  name: compute-resources-long-running
spec:
  hard:
    pods: "4" <b class="conum">(1)</b>
    limits.cpu: "4" <b class="conum">(2)</b>
    limits.memory: "2Gi" <b class="conum">(3)</b>
    limits.ephemeral-storage: "4Gi" <b class="conum">(4)</b>
  scopes:
  - NotTerminating <b class="conum">(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The total number of pods in a non-terminal state.</p>
</li>
<li>
<p>Across all pods in a non-terminal state, the sum of CPU limits cannot exceed
this value.</p>
</li>
<li>
<p>Across all pods in a non-terminal state, the sum of memory limits cannot exceed
this value.</p>
</li>
<li>
<p>Across all pods in a non-terminal state, the sum of ephemeral storage limits cannot exceed
this value.</p>
</li>
<li>
<p>Restricts the quota to only matching pods where <code>spec.activeDeadlineSeconds</code> is
set to <code>nil</code>. Build pods will fall under <code>NotTerminating</code> unless the
<code>RestartNever</code> policy is applied.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title"><code>compute-resources-time-bound.yaml</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ResourceQuota
metadata:
  name: compute-resources-time-bound
spec:
  hard:
    pods: "2" <b class="conum">(1)</b>
    limits.cpu: "1" <b class="conum">(2)</b>
    limits.memory: "1Gi" <b class="conum">(3)</b>
    limits.ephemeral-storage: "1Gi" <b class="conum">(4)</b>
  scopes:
  - Terminating <b class="conum">(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The total number of pods in a non-terminal state.</p>
</li>
<li>
<p>Across all pods in a non-terminal state, the sum of CPU limits cannot exceed this value.</p>
</li>
<li>
<p>Across all pods in a non-terminal state, the sum of memory limits cannot exceed this value.</p>
</li>
<li>
<p>Across all pods in a non-terminal state, the sum of ephemeral storage limits cannot exceed this value.</p>
</li>
<li>
<p>Restricts the quota to only matching pods where <code>spec.activeDeadlineSeconds &gt;=0</code>.  For example,
this quota would charge for build or deployer pods, but not long running pods like a web server or database.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title"><strong>storage-consumption.yaml</strong></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ResourceQuota
metadata:
  name: storage-consumption
spec:
  hard:
    persistentvolumeclaims: "10" <b class="conum">(1)</b>
    requests.storage: "50Gi" <b class="conum">(2)</b>
    gold.storageclass.storage.k8s.io/requests.storage: "10Gi" <b class="conum">(3)</b>
    silver.storageclass.storage.k8s.io/requests.storage: "20Gi" <b class="conum">(4)</b>
    silver.storageclass.storage.k8s.io/persistentvolumeclaims: "5" <b class="conum">(5)</b>
    bronze.storageclass.storage.k8s.io/requests.storage: "0" <b class="conum">(6)</b>
    bronze.storageclass.storage.k8s.io/persistentvolumeclaims: "0" <b class="conum">(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The total number of persistent volume claims in a project</p>
</li>
<li>
<p>Across all persistent volume claims in a project, the sum of storage requested cannot exceed this value.</p>
</li>
<li>
<p>Across all persistent volume claims in a project, the sum of storage requested in the gold storage class cannot exceed this value.</p>
</li>
<li>
<p>Across all persistent volume claims in a project, the sum of storage requested in the silver storage class cannot exceed this value.</p>
</li>
<li>
<p>Across all persistent volume claims in a project, the total number of claims in the silver storage class cannot exceed this value.</p>
</li>
<li>
<p>Across all persistent volume claims in a project, the sum of storage requested in the bronze storage class cannot exceed this value. When this is set to <code>0</code>, it means bronze storage class cannot request storage.</p>
</li>
<li>
<p>Across all persistent volume claims in a project, the sum of storage requested in the bronze storage class cannot exceed this value. When this is set to <code>0</code>, it means bronze storage class cannot create claims.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="quotas-creating-a-quota-quotas-setting-per-project">Creating a quota</h4>
<div class="paragraph">
<p>You can create a quota to constrain resource usage in a given project.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Define the quota in a file.</p>
</li>
<li>
<p>Use the file to create the quota and apply it to a project:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create -f &lt;file&gt; [-n &lt;project_name&gt;]</pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create -f core-object-counts.yaml -n demoproject</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="quota-creating-object-count-quotas-quotas-setting-per-project">Creating object count quotas</h5>
<div class="paragraph">
<p>You can create an object count quota for all OpenShift Enterprise standard namespaced
resource types, such as <code>BuildConfig</code>, and <code>DeploymentConfig</code>. An object quota
count places a defined quota on all standard namespaced resource types.</p>
</div>
<div class="paragraph">
<p>When using a resource quota, an object is charged against the quota if it exists
in server storage. These types of quotas are useful to protect against
exhaustion of storage resources.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To configure an object count quota for a resource:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create quota &lt;name&gt; \
    --hard=count/&lt;resource&gt;.&lt;group&gt;=&lt;quota&gt;,count/&lt;resource&gt;.&lt;group&gt;=&lt;quota&gt; <b class="conum">(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>&lt;resource&gt;</code> is the name of the resource, and <code>&lt;group&gt;</code> is the API group, if
applicable. Use the <code>kubectl api-resources</code> command for a list of resources and
their associated API groups.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create quota test \
    --hard=count/deployments.extensions=2,count/replicasets.extensions=4,count/pods=3,count/secrets=4
resourcequota "test" created</pre>
</div>
</div>
<div class="paragraph">
<p>This example limits the listed resources to the hard limit in each project in
the cluster.</p>
</div>
</li>
<li>
<p>Verify that the quota was created:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc describe quota test
Name:                         test
Namespace:                    quota
Resource                      Used  Hard
--------                      ----  ----
count/deployments.extensions  0     2
count/pods                    0     3
count/replicasets.extensions  0     4
count/secrets                 0     4</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="setting-resource-quota-for-extended-resources-quotas-setting-per-project">Setting resource quota for extended resources</h5>
<div class="paragraph">
<p>Overcommitment of resources is not allowed for extended resources, so you must
specify <code>requests</code> and <code>limits</code> for the same extended resource in a quota.
Currently, only quota items with the prefix <code>requests.</code> is allowed for extended
resources. The following is an example scenario of how to set resource quota for
the GPU resource <code>nvidia.com/gpu</code>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Determine how many GPUs are available on a node in your cluster. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># oc describe node ip-172-31-27-209.us-west-2.compute.internal | egrep 'Capacity|Allocatable|gpu'
                    openshift.com/gpu-accelerator=true
Capacity:
 nvidia.com/gpu:  2
Allocatable:
 nvidia.com/gpu:  2
  nvidia.com/gpu  0           0</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, 2 GPUs are available.</p>
</div>
</li>
<li>
<p>Set a quota in the namespace <code>nvidia</code>. In this example, the quota is <code>1</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cat gpu-quota.yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: gpu-quota
  namespace: nvidia
spec:
  hard:
    requests.nvidia.com/gpu: 1</pre>
</div>
</div>
</li>
<li>
<p>Create the quota:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># oc create -f gpu-quota.yaml
resourcequota/gpu-quota created</pre>
</div>
</div>
</li>
<li>
<p>Verify that the namespace has the correct quota set:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># oc describe quota gpu-quota -n nvidia
Name:                    gpu-quota
Namespace:               nvidia
Resource                 Used  Hard
--------                 ----  ----
requests.nvidia.com/gpu  0     1</pre>
</div>
</div>
</li>
<li>
<p>Run a pod that asks for a single GPU:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># oc create -f gpu-pod.yaml</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">apiVersion: v1
kind: Pod
metadata:
  generateName: gpu-pod-
  namespace: nvidia
spec:
  restartPolicy: OnFailure
  containers:
  - name: rhel7-gpu-pod
    image: rhel7
    env:
      - name: NVIDIA_VISIBLE_DEVICES
        value: all
      - name: NVIDIA_DRIVER_CAPABILITIES
        value: "compute,utility"
      - name: NVIDIA_REQUIRE_CUDA
        value: "cuda&gt;=5.0"
    command: ["sleep"]
    args: ["infinity"]
    resources:
      limits:
        nvidia.com/gpu: 1</pre>
</div>
</div>
</li>
<li>
<p>Verify that the pod is running:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># oc get pods
NAME              READY     STATUS      RESTARTS   AGE
gpu-pod-s46h7     1/1       Running     0          1m</pre>
</div>
</div>
</li>
<li>
<p>Verify that the quota <code>Used</code> counter is correct:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># oc describe quota gpu-quota -n nvidia
Name:                    gpu-quota
Namespace:               nvidia
Resource                 Used  Hard
--------                 ----  ----
requests.nvidia.com/gpu  1     1</pre>
</div>
</div>
</li>
<li>
<p>Attempt to create a second GPU pod in the <code>nvidia</code> namespace. This is
technically available on the node because it has 2 GPUs:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># oc create -f gpu-pod.yaml
Error from server (Forbidden): error when creating "gpu-pod.yaml": pods "gpu-pod-f7z2w" is forbidden: exceeded quota: gpu-quota, requested: requests.nvidia.com/gpu=1, used: requests.nvidia.com/gpu=1, limited: requests.nvidia.com/gpu=1</pre>
</div>
</div>
<div class="paragraph">
<p>This <strong>Forbidden</strong> error message is expected because you have a quota of 1 GPU and
this pod tried to allocate a second GPU, which exceeds its quota.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="quota-viewing-quotas-quotas-setting-per-project">Viewing a quota</h4>
<div class="paragraph">
<p>You can view usage statistics related to any hard limits defined in a project&#8217;s
quota by navigating in the web console to the project&#8217;s <strong>Quota</strong> page.</p>
</div>
<div class="paragraph">
<p>You can also use the CLI to view quota details.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Get the list of quotas defined in the project. For example, for a project called
<code>demoproject</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get quota -n demoproject
NAME                AGE
besteffort          11m
compute-resources   2m
core-object-counts  29m</pre>
</div>
</div>
</li>
<li>
<p>Describe the quota you are interested in, for example the <code>core-object-counts</code>
quota:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc describe quota core-object-counts -n demoproject
Name:			core-object-counts
Namespace:		demoproject
Resource		Used	Hard
--------		----	----
configmaps		3	10
persistentvolumeclaims	0	4
replicationcontrollers	3	20
secrets			9	10
services		2	10</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="quotas-configuring-quota-sync-period-quotas-setting-per-project">Configuring quota synchronization period</h4>
<div class="paragraph">
<p>When a set of resources are deleted, but before quota usage is restored, a user
might encounter problems when attempting to reuse the resources. The
synchronization time frame of resources is determined by the
<code>resource-quota-sync-period</code> setting, which can be configured by a cluster
administrator.</p>
</div>
<div class="paragraph">
<p>Adjusting the regeneration time can be helpful for creating resources and
determining resource usage when automation is used.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>resource-quota-sync-period</code> setting is designed to balance system
performance. Reducing the sync period can result in a heavy load on the master.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To configure the quota synchronization period:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Change the <code>resource-quota-sync-period</code> setting to have the set of resources
regenerate at the desired amount of time (in seconds) and for the resources to
be available again:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kubernetesMasterConfig:
  apiLevels:
  - v1beta3
  - v1
  apiServerArguments: null
  controllerArguments:
    resource-quota-sync-period:
      - "10s"</code></pre>
</div>
</div>
</li>
<li>
<p>Restart the master services to apply the changes:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># master-restart api
# master-restart controllers</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="quota-requiring-explicit-quota-quotas-setting-per-project">Requiring explicit quota to consume a resource</h4>
<div class="paragraph">
<p>If a resource is not managed by quota, a user has no restriction on the amount
of resource that can be consumed.  For example, if there is no quota on storage
related to the gold storage class, the amount of gold storage a project can
create is unbounded.</p>
</div>
<div class="paragraph">
<p>For high-cost compute or storage resources, administrators might want to require
an explicit quota be granted in order to consume a resource.  For example, if a
project was not explicitly given quota for storage related to the gold storage
class, users of that project would not be able to create any storage of that
type.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To require explicit quota to consume a particular resource:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the following stanza to the master configuration:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">admissionConfig:
  pluginConfig:
    ResourceQuota:
      configuration:
        apiVersion: resourcequota.admission.k8s.io/v1alpha1
        kind: Configuration
        limitedResources:
        - resource: persistentvolumeclaims <b class="conum">(1)</b>
        matchContains:
        - gold.storageclass.storage.k8s.io/requests.storage <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The group/resource to whose consumption is limited by default.</p>
</li>
<li>
<p>The name of the resource tracked by quota associated with the group/resource to
limit by default.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the above example, the quota system intercepts every operation that
creates or updates a <code>PersistentVolumeClaim</code>. It checks what resources understood
by quota would be consumed, and if there is no covering quota for those resources
in the project, the request is denied.</p>
</div>
<div class="paragraph">
<p>In this example, if a user creates a <code>PersistentVolumeClaim</code> that uses storage
associated with the gold storage class, and there is no matching quota in the
project, the request is denied.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="resource-quotas-across-multiple-projects">Resource quotas across multiple projects</h3>
<div class="paragraph">
<p>A multi-project quota, defined by a ClusterResourceQuota object, allows quotas
to be shared across multiple projects. Resources used in each selected project
are aggregated and that aggregate is used to limit resources across all the
selected projects.</p>
</div>
<div class="paragraph">
<p>This guide describes how cluster administrators can set and manage resource
quotas across multiple projects.</p>
</div>
<div class="sect3">
<h4 id="quotas-setting-projects-setting-quotas-across-multiple-projects">Selecting multiple projects during quota creation</h4>
<div class="paragraph">
<p>When creating quotas, you can select multiple projects based on annotation
selection, label selection, or both.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To select projects based on annotations, run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create clusterquota for-user \
     --project-annotation-selector openshift.io/requester=&lt;user_name&gt; \
     --hard pods=10 \
     --hard secrets=20</pre>
</div>
</div>
<div class="paragraph">
<p>This creates the following ClusterResourceQuota object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ClusterResourceQuota
metadata:
  name: for-user
spec:
  quota: <b class="conum">(1)</b>
    hard:
      pods: "10"
      secrets: "20"
  selector:
    annotations: <b class="conum">(2)</b>
      openshift.io/requester: &lt;user_name&gt;
    labels: null <b class="conum">(3)</b>
status:
  namespaces: <b class="conum">(4)</b>
  - namespace: ns-one
    status:
      hard:
        pods: "10"
        secrets: "20"
      used:
        pods: "1"
        secrets: "9"
  total: <b class="conum">(5)</b>
    hard:
      pods: "10"
      secrets: "20"
    used:
      pods: "1"
      secrets: "9"</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>ResourceQuotaSpec</code> object that will be enforced over the selected projects.</p>
</li>
<li>
<p>A simple key-value selector for annotations.</p>
</li>
<li>
<p>A label selector that can be used to select projects.</p>
</li>
<li>
<p>A per-namespace map that describes current quota usage in each selected project.</p>
</li>
<li>
<p>The aggregate usage across all selected projects.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This multi-project quota document controls all projects requested by
<code>&lt;user_name&gt;</code> using the default project request endpoint. You are limited to 10
pods and 20 secrets.</p>
</div>
</li>
<li>
<p>Similarly, to select projects based on labels, run this command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$  oc create clusterresourcequota for-name \ <b class="conum">(1)</b>
    --project-label-selector=name=frontend \ <b class="conum">(2)</b>
    --hard=pods=10 --hard=secrets=20</pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Both <code>clusterresourcequota</code> and <code>clusterquota</code> are aliases of the same
command. <code>for-name</code> is the name of the ClusterResourceQuota object.</p>
</li>
<li>
<p>To select projects by label, provide a key-value pair by using the format <code>--project-label-selector=key=value</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This creates the following ClusterResourceQuota object definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ClusterResourceQuota
metadata:
  creationTimestamp: null
  name: for-name
spec:
  quota:
    hard:
      pods: "10"
      secrets: "20"
  selector:
    annotations: null
    labels:
      matchLabels:
        name: frontend</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="quotas-viewing-clusterresourcequotas-setting-quotas-across-multiple-projects">Viewing applicable ClusterResourceQuotas</h4>
<div class="paragraph">
<p>A project administrator is not allowed to create or modify the multi-project
quota that limits his or her project, but the administrator is allowed to view the
multi-project quota documents that are applied to his or her project. The
project administrator can do this via the <code>AppliedClusterResourceQuota</code>
resource.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To view quotas applied to a project, run:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc describe AppliedClusterResourceQuota</pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">Name:   for-user
Namespace:  &lt;none&gt;
Created:  19 hours ago
Labels:   &lt;none&gt;
Annotations:  &lt;none&gt;
Label Selector: &lt;null&gt;
AnnotationSelector: map[openshift.io/requester:&lt;user-name&gt;]
Resource  Used  Hard
--------  ----  ----
pods        1     10
secrets     9     20</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="quotas-selection-granularity-setting-quotas-across-multiple-projects">Selection granularity</h4>
<div class="paragraph">
<p>Because of the locking consideration when claiming quota allocations, the number of
active projects selected by a multi-project quota is an important consideration.
Selecting more than 100 projects under a single multi-project quota can have
detrimental effects on API server responsiveness in those projects.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="idling-applications">Idling applications</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cluster administrators can idle applications to reduce resource consumption.
This is useful when the cluster is deployed on a public cloud where cost is
related to resource consumption.</p>
</div>
<div class="paragraph">
<p>If any scalable resources are not in use, OpenShift Enterprise discovers and idles
them by scaling their replicas to <code>0</code>. The next time network traffic is directed
to the resources, the resources are unidled by scaling up the replicas, and
normal operation continues.</p>
</div>
<div class="paragraph">
<p>Applications are made of services, as well as other scalable resources, such as
DeploymentConfigs. The action of idling an application involves idling
all associated resources.</p>
</div>
<div class="sect2">
<h3 id="idle-idling-applications-idling-applications">Idling applications</h3>
<div class="paragraph">
<p>Idling an application involves finding the scalable resources (deployment
configurations, replication controllers, and others) associated with a service.
Idling an application finds the service and marks it as idled, scaling down the
resources to zero replicas.</p>
</div>
<div class="paragraph">
<p>You can use the <code>oc idle</code> command to idle a single service, or use the
<code>--resource-names-file</code> option to idle multiple services.</p>
</div>
<div class="sect3">
<h4 id="idle-idling-applications-single-idling-applications">Idling a single service</h4>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To idle a single service, run:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc idle &lt;service&gt;</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="idle-idling-applications-multiple-idling-applications">Idling multiple services</h4>
<div class="paragraph">
<p>Idling multiple services is helpful if an application spans across a set of
services within a project, or when idling multiple services in conjunction with
a script in order to idle multiple applications in bulk within the same project.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a file containing a list of the services, each on their own line.</p>
</li>
<li>
<p>Idle the services using the <code>--resource-names-file</code> option:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc idle --resource-names-file &lt;filename&gt;</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>idle</code> command is limited to a single project. For idling applications across
a cluster, run the <code>idle</code> command for each project individually.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="idle-unidling-applications-idling-applications">Unidling applications</h3>
<div class="paragraph">
<p>Application services become active again when they receive network traffic and
are scaled back up their previous state. This includes both traffic to the
services and traffic passing through routes.</p>
</div>
<div class="paragraph">
<p>Applications can also be manually unidled by scaling up the resources.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To scale up a DeploymentConfig, run:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc scale --replicas=1 dc &lt;dc_name&gt;</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Automatic unidling by a router is currently only supported by the default
HAProxy router.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pruning-objects-to-reclaim-resources">Pruning objects to reclaim resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Over time, API objects created in OpenShift Enterprise can accumulate in the
cluster&#8217;s etcd data store through normal user operations, such as when building
and deploying applications.</p>
</div>
<div class="paragraph">
<p>Cluster administrators can periodically prune older versions of objects from the
cluster that are no longer needed. For example, by pruning images you can delete
older images and layers that are no longer in use, but are still taking up disk
space.</p>
</div>
<div class="sect2">
<h3 id="pruning-basic-operations-pruning-objects">Basic pruning operations</h3>
<div class="paragraph">
<p>The CLI groups prune operations under a common parent command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm prune &lt;object_type&gt; &lt;options&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>This specifies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>&lt;object_type&gt;</code> to perform the action on, such as <code>groups</code>, <code>builds</code>,
<code>deployments</code>, or <code>images</code>.</p>
</li>
<li>
<p>The <code>&lt;options&gt;</code> supported to prune that object type.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="pruning-groups-pruning-objects">Pruning groups</h3>
<div class="paragraph">
<p>To prune groups records from an external provider, administrators can run the
following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm prune groups \
    --sync-config=path/to/sync/config [&lt;options&gt;]</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Prune groups CLI configuration options</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Options</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--confirm</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicate that pruning should occur, instead of performing a dry-run.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--blacklist</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path to the group blacklist file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--whitelist</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path to the group whitelist file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--sync-config</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path to the synchronization configuration file.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To see the groups that the prune command deletes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm prune groups --sync-file=ldap-sync-config.yaml</pre>
</div>
</div>
<div class="paragraph">
<p>To perform the prune operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm prune groups --sync-file=ldap-sync-config.yaml --confirm</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pruning-deployments-pruning-objects">Pruning deployments</h3>
<div class="paragraph">
<p>In order to prune deployments that are no longer required by the system due to
age and status, administrators can run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm prune deployments [&lt;options&gt;]</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Prune deployments CLI configuration options</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--confirm</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicate that pruning should occur, instead of performing a dry-run.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--orphans</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prune all deployments that no longer have a DeploymentConfig, has status
is <code>Complete</code> or <code>Failed</code>, and has a replica count of zero.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--keep-complete=&lt;N&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Per DeploymentConfig, keep the last <code>N</code> deployments that have a status
of <code>Complete</code> and replica count of zero. (default <code>5</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--keep-failed=&lt;N&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Per  DeploymentConfig, keep the last <code>N</code> deployments that have a status
of <code>Failed</code> and replica count of zero. (default <code>1</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--keep-younger-than=&lt;duration&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do not prune any object that is younger than <code>&lt;duration&gt;</code> relative to the
current time. (default <code>60m</code>) Valid units of measurement include nanoseconds
(<code>ns</code>), microseconds (<code>us</code>), milliseconds (<code>ms</code>), seconds (<code>s</code>), minutes (<code>m</code>),
and hours (<code>h</code>).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To see what a pruning operation would delete:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm prune deployments --orphans --keep-complete=5 --keep-failed=1 \
    --keep-younger-than=60m</pre>
</div>
</div>
<div class="paragraph">
<p>To actually perform the prune operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm prune deployments --orphans --keep-complete=5 --keep-failed=1 \
    --keep-younger-than=60m --confirm</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pruning-builds-pruning-objects">Pruning builds</h3>
<div class="paragraph">
<p>In order to prune builds that are no longer required by the system due to age
and status, administrators can run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm prune builds [&lt;options&gt;]</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Prune builds CLI configuration options</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--confirm</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicate that pruning should occur, instead of performing a dry-run.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--orphans</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prune all builds whose Build Configuration no longer exists, status is complete,
failed, error, or canceled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--keep-complete=&lt;N&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Per Build Configuration, keep the last <code>N</code> builds whose status is complete (default
<code>5</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--keep-failed=&lt;N&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Per Build Configuration, keep the last <code>N</code> builds whose status is failed, error, or
canceled (default <code>1</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--keep-younger-than=&lt;duration&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do not prune any object that is younger than <code>&lt;duration&gt;</code> relative to the
current time (default <code>60m</code>).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To see what a pruning operation would delete:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm prune builds --orphans --keep-complete=5 --keep-failed=1 \
    --keep-younger-than=60m</pre>
</div>
</div>
<div class="paragraph">
<p>To actually perform the prune operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm prune builds --orphans --keep-complete=5 --keep-failed=1 \
    --keep-younger-than=60m --confirm</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Developers can enable automatic build pruning by modifying their Build
Configuration.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_enterprise/4.0/html-single/builds/#builds-build-pruning-advanced-build-operations">Performing advanced builds &#8594; Pruning builds</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="pruning-images-pruning-objects">Pruning images</h3>
<div class="paragraph">
<p>In order to prune images that are no longer required by the system due to age,
status, or exceed limits, administrators can run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm prune images [&lt;options&gt;]</pre>
</div>
</div>
<div class="paragraph">
<p>Currently, to prune images you must first log in to the CLI as a user with an
access token. The user must also have the cluster role <code>system:image-pruner</code> or
greater (for example, <code>cluster-admin</code>).</p>
</div>
<div class="paragraph">
<p>Pruning images removes data from the integrated registry unless
<code>--prune-registry=false</code> is used. For this operation to work properly, the
registry must be configured with <code>storage:delete:enabled</code> set to <code>true</code>.</p>
</div>
<div class="paragraph">
<p>Pruning images with the <code>--namespace</code> flag does not remove images, only image
streams. Images are non-namespaced resources. Therefore, limiting pruning to a
particular namespace makes it impossible to calculate their current usage.</p>
</div>
<div class="paragraph">
<p>By default, the integrated registry caches blobs metadata to reduce the number
of requests to storage, and increase the speed of processing the request.
Pruning does not update the integrated registry cache. Images pushed after
pruning that contain pruned layers will be broken, because the pruned layers
that have metadata in the cache will not be pushed. Therefore, it is necessary
to clear the cache after pruning. This can be accomplished by redeploying the
registry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc rollout latest dc/docker-registry</pre>
</div>
</div>
<div class="paragraph">
<p>If the integrated registry uses a Redis cache, you must clean the database
manually.</p>
</div>
<div class="paragraph">
<p>If redeploying the registry after pruning is not an option, then you must
permanently disable the cache.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Prune images CLI configuration options</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--all</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Include images that were not pushed to the registry, but have been mirrored by
pullthrough. This is on by default. To limit the pruning to images that were
pushed to the integrated registry, pass <code>--all=false</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--certificate-authority</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to a certificate authority file to use when communicating with the
OpenShift Enterprise-managed registries. Defaults to the certificate authority data
from the current user&#8217;s configuration file. If provided, a secure connection is
initiated.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--confirm</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicate that pruning should occur, instead of performing a dry-run. This
requires a valid route to the integrated container image registry. If this
command is run outside of the cluster network, the route must be provided
using <code>--registry-url</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--force-insecure</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use caution with this option. Allow an insecure connection to the container
registry that is hosted via HTTP or has an invalid HTTPS certificate.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--keep-tag-revisions=&lt;N&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For each imagestream, keep up to at most <code>N</code> image revisions per tag (default
<code>3</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--keep-younger-than=&lt;duration&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do not prune any image that is younger than <code>&lt;duration&gt;</code> relative to the
current time. Do not prune any image that is referenced by any other object that
is younger than <code>&lt;duration&gt;</code> relative to the current time (default <code>60m</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--prune-over-size-limit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prune each image that exceeds the smallest limit defined in the same project.
This flag cannot be combined with <code>--keep-tag-revisions</code> nor
<code>--keep-younger-than</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--registry-url</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The address to use when contacting the registry. The command attempts to use a
cluster-internal URL determined from managed images and imagestreams. In case
it fails (the registry cannot be resolved or reached), an alternative route that
works needs to be provided using this flag. The registry host name can be
prefixed by <code>https://</code> or <code>http://</code> which enforces particular connection
protocol.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>--prune-registry</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In conjunction with the conditions stipulated by the other options, this option
controls whether the data in the registry corresponding to the OpenShift Enterprise
image API object is pruned. By default, image pruning processes both the image
API objects and corresponding data in the registry. This options is useful when
you are only concerned with removing etcd content, possibly to reduce the number
of image objects (but are not concerned with cleaning up registry storage) or
intend to do that separately by hard pruning the registry, possibly during an
appropriate maintenance window for the registry.</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="pruning-images-conditions-pruning-objects">Image prune conditions</h4>
<div class="ulist">
<ul>
<li>
<p>Remove any image "managed by OpenShift Enterprise" (images with the annotation
<code>openshift.io/image.managed</code>) that was created at least <code>--keep-younger-than</code>
minutes ago and is not currently referenced by:</p>
<div class="ulist">
<ul>
<li>
<p>any Pod created less than <code>--keep-younger-than</code> minutes ago.</p>
</li>
<li>
<p>any imagestream created less than <code>--keep-younger-than</code> minutes ago.</p>
</li>
<li>
<p>any running Pods.</p>
</li>
<li>
<p>any pending Pods.</p>
</li>
<li>
<p>any ReplicationControllers.</p>
</li>
<li>
<p>any DeploymentConfigs.</p>
</li>
<li>
<p>any Build Configurations.</p>
</li>
<li>
<p>any Builds.</p>
</li>
<li>
<p>the <code>--keep-tag-revisions</code> most recent items in <code>stream.status.tags[].items</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Remove any image "managed by OpenShift Enterprise" (images with the annotation
<code>openshift.io/image.managed</code>) that is exceeding the smallest limit defined in
the same project and is not currently referenced by:</p>
<div class="ulist">
<ul>
<li>
<p>any running Pods.</p>
</li>
<li>
<p>any pending Pods.</p>
</li>
<li>
<p>any ReplicationControllers.</p>
</li>
<li>
<p>any DeploymentConfigs.</p>
</li>
<li>
<p>any Build Configurations.</p>
</li>
<li>
<p>any Builds.</p>
</li>
</ul>
</div>
</li>
<li>
<p>There is no support for pruning from external registries.</p>
</li>
<li>
<p>When an image is pruned, all references to the image are removed from all
imagestreams that have a reference to the image in <code>status.tags</code>.</p>
</li>
<li>
<p>Image layers that are no longer referenced by any images are removed.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>--prune-over-size-limit</code> flag cannot be combined with
<code>--keep-tag-revisions</code> nor <code>--keep-younger-than</code> flags. Doing so returns
information that this operation is not allowed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Separating the removal of OpenShift Enterprise image API objects and image data from
the Registry by using <code>--prune-registry=false</code> followed by hard pruning the
registry narrows some timing windows and is safer when compared to trying to
prune both through one command. However, timing windows are not completely
removed.</p>
</div>
<div class="paragraph">
<p>For example, you can still create a Pod referencing an image as pruning
identifies that image for pruning. You should still keep track of an API Object
created during the pruning operations that might reference images, so you can
mitigate any references to deleted content.</p>
</div>
<div class="paragraph">
<p>Also, keep in mind that re-doing the pruning without the <code>--prune-registry</code> option or with
<code>--prune-registry=true</code> does not lead to pruning the associated storage in the image registry
for images previously pruned by <code>--prune-registry=false</code>.
Any images that were pruned with <code>--prune-registry=false</code> can only be deleted from
registry storage by hard pruning the registry.</p>
</div>
</div>
<div class="sect3">
<h4 id="pruning-images-running-operation-pruning-objects">Running the image prune operation</h4>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To see what a pruning operation would delete:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Keeping up to three tag revisions, and keeping resources (images, image
streams and Pods) younger than sixty minutes:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm prune images --keep-tag-revisions=3 --keep-younger-than=60m</pre>
</div>
</div>
</li>
<li>
<p>Pruning every image that exceeds defined limits:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm prune images --prune-over-size-limit</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>To actually perform the prune operation with the options from the previous step:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm prune images --keep-tag-revisions=3 --keep-younger-than=60m --confirm</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm prune images --prune-over-size-limit --confirm</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="pruning-images-secure-insecure-pruning-objects">Using secure or insecure connections</h4>
<div class="paragraph">
<p>The secure connection is the preferred and recommended approach. It is done over
HTTPS protocol with a mandatory certificate verification. The <code>prune</code> command
always attempts to use it if possible. If it is not possible, in some cases it
can fall-back to insecure connection, which is dangerous. In this case, either
certificate verification is skipped or plain HTTP protocol is used.</p>
</div>
<div class="paragraph">
<p>The fall-back to insecure connection is allowed in the following cases unless
<code>--certificate-authority</code> is specified:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>prune</code> command is run with the <code>--force-insecure</code> option.</p>
</li>
<li>
<p>The provided <code>registry-url</code> is prefixed with the <code>http://</code> scheme.</p>
</li>
<li>
<p>The provided <code>registry-url</code> is a local-link address or <code>localhost</code>.</p>
</li>
<li>
<p>The configuration of the current user allows for an insecure connection. This
can be caused by the user either logging in using <code>--insecure-skip-tls-verify</code>
or choosing the insecure connection when prompted.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>If the registry is secured by a certificate authority different from the one
used by OpenShift Enterprise, it must be specified using the
<code>--certificate-authority</code> flag. Otherwise, the <code>prune</code> command fails with an
error.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="pruning-images-problems-pruning-objects">Image pruning problems</h4>
<h6 id="pruning-images-not-being-pruned-pruning-objects" class="discrete">Images not being pruned</h6>
<div class="paragraph">
<p>If your images keep accumulating and the <code>prune</code> command removes just a small
portion of what you expect, ensure that you understand the image prune
conditions that must apply for an image to be considered a candidate for
pruning.</p>
</div>
<div class="paragraph">
<p>Ensure that images you want removed occur at higher positions in each tag
history than your chosen tag revisions threshold. For example, consider an old
and obsolete image named <code>sha:abz</code>. By running the following command in
namespace <code>N</code>, where the image is tagged, the image is tagged three times in a
single imagestream named <code>myapp</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ image_name="sha:abz"
$ oc get is -n N -o go-template='{{range $isi, $is := .items}}{{range $ti, $tag := $is.status.tags}}'\
  '{{range $ii, $item := $tag.items}}{{if eq $item.image "'"${image_name}"\
  $'"}}{{$is.metadata.name}}:{{$tag.tag}} at position {{$ii}} out of {{len $tag.items}}\n'\
  '{{end}}{{end}}{{end}}{{end}}'
myapp:v2 at position 4 out of 5
myapp:v2.1 at position 2 out of 2
myapp:v2.1-may-2016 at position 0 out of 1</pre>
</div>
</div>
<div class="paragraph">
<p>When default options are used, the image is never pruned because it occurs at
position <code>0</code> in a history of <code>myapp:v2.1-may-2016</code> tag. For an image to be
considered for pruning, the administrator must either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Specify <code>--keep-tag-revisions=0</code> with the <code>oc adm prune images</code> command.</p>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph">
<p>This action effectively removes all the tags from all the namespaces with
underlying images, unless they are younger or they are referenced by objects
younger than the specified threshold.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Delete all the <code>istags</code> where the position is below the revision threshold,
which means <code>myapp:v2.1</code> and <code>myapp:v2.1-may-2016</code>.</p>
</li>
<li>
<p>Move the image further in the history, either by running new Builds pushing to
the same <code>istag</code>, or by tagging other image. Unfortunately, this is not always
desirable for old release tags.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Tags having a date or time of a particular image&#8217;s Build in their names should
be avoided, unless the image must be preserved for an undefined amount of time.
Such tags tend to have just one image in its history, which effectively prevents
them from ever being pruned.</p>
</div>
<h6 id="pruning-images-secure-against-insecure-pruning-objects" class="discrete">Using a secure connection against insecure registry</h6>
<div class="paragraph">
<p>If you see a message similar to the following in the output of the <code>oadm prune
images</code> command, then your registry is not secured and the <code>oadm prune images</code>
client attempts to use a secure connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">error: error communicating with registry: Get https://172.30.30.30:5000/healthz: http: server gave HTTP response to HTTPS client</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The recommend solution is to secure the registry. Otherwise, you can force the
client to use an insecure connection by appending <code>--force-insecure</code>  to the
command, however this is not recommended.</p>
</li>
</ol>
</div>
<h6 id="pruning-images-insecure-against-secure-pruning-objects" class="discrete">Using an insecure connection against a secured registry</h6>
<div class="paragraph">
<p>If you see one of the following errors in the output of the <code>oadm prune images</code>
command, it means that your registry is secured using a certificate signed by a
certificate authority other than the one used by <code>oadm prune images</code> client for
connection verification:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">error: error communicating with registry: Get http://172.30.30.30:5000/healthz: malformed HTTP response "\x15\x03\x01\x00\x02\x02"
error: error communicating with registry: [Get https://172.30.30.30:5000/healthz: x509: certificate signed by unknown authority, Get http://172.30.30.30:5000/healthz: malformed HTTP response "\x15\x03\x01\x00\x02\x02"]</pre>
</div>
</div>
<div class="paragraph">
<p>By default, the certificate authority data stored in the user&#8217;s configuration
file are used; the same is true for communication with the master API.</p>
</div>
<div class="paragraph">
<p>Use the <code>--certificate-authority</code> option to provide the right certificate
authority for the container image registry server.</p>
</div>
<h6 id="pruning-images-wrong-ca-pruning-objects" class="discrete">Using the wrong certificate authority</h6>
<div class="paragraph">
<p>The following error means that the certificate authority used to sign the
certificate of the secured container image registry is different than the
authority used by the client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">error: error communicating with registry: Get https://172.30.30.30:5000/: x509: certificate signed by unknown authority</pre>
</div>
</div>
<div class="paragraph">
<p>Make sure to provide the right one with the flag <code>--certificate-authority</code>.</p>
</div>
<div class="paragraph">
<p>As a workaround, the <code>--force-insecure</code> flag can be added instead. However, this
is not recommended.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_enterprise/4.0/html-single/registry/#accessing-the-registry">Accessing the registry</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_enterprise/4.0/html-single/registry/#securing-exposing-registry">Securing and exposing the registry</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pruning-hard-pruning-registry-pruning-objects">Hard pruning the registry</h3>
<div class="paragraph">
<p>The OpenShift Container Registry can accumulate blobs that are not referenced by
the OpenShift Enterprise cluster&#8217;s etcd. The basic pruning images procedure,
therefore, is unable to operate on them. These are called <em>orphaned blobs</em>.</p>
</div>
<div class="paragraph">
<p>Orphaned blobs can occur from the following scenarios:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Manually deleting an image with <code>oc delete image &lt;sha256:image-id&gt;</code> command,
which only removes the image from etcd, but not from the registry&#8217;s storage.</p>
</li>
<li>
<p>Pushing to the registry initiated by <code>docker</code> daemon failures, which causes some
blobs to get uploaded, but the image manifest (which is uploaded as the very
last component) does not. All unique image blobs become orphans.</p>
</li>
<li>
<p>OpenShift Enterprise refusing an image because of quota restrictions.</p>
</li>
<li>
<p>The standard image pruner deleting an image manifest, but is interrupted before
it deletes the related blobs.</p>
</li>
<li>
<p>A bug in the registry pruner, which fails to remove the intended blobs, causing
the image objects referencing them to be removed and the blobs becoming orphans.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>Hard pruning</em> the registry, a separate procedure from basic image pruning,
allows cluster administrators to remove orphaned blobs. You should hard prune if
you are running out of storage space in your OpenShift Container Registry and
believe you have orphaned blobs.</p>
</div>
<div class="paragraph">
<p>This should be an infrequent operation and is necessary only when you have
evidence that significant numbers of new orphans have been created. Otherwise,
you can perform standard image pruning at regular intervals, for example, once a
day (depending on the number of images being created).</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To hard prune orphaned blobs from the registry:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Log in.</strong></p>
<div class="paragraph">
<p>Log in to the cluster with the CLI as a user with an access token.</p>
</div>
</li>
<li>
<p><strong>Run a basic image prune</strong>.</p>
<div class="paragraph">
<p>Basic image pruning removes additional images that are no longer needed. The
hard prune does not remove images on its own. It only removes blobs stored in
the registry storage. Therefore, you should run this just before the hard prune.</p>
</div>
</li>
<li>
<p><strong>Switch the registry to read-only mode.</strong></p>
<div class="paragraph">
<p>If the registry is not running in read-only mode, any pushes happening at the
same time as the prune will either:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>fail and cause new orphans, or</p>
</li>
<li>
<p>succeed although the images cannot be pulled (because some of the
referenced blobs were deleted).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Pushes will not succeed until the registry is switched back to read-write mode.
Therefore, the hard prune must be carefully scheduled.</p>
</div>
<div class="paragraph">
<p>To switch the registry to read-only mode:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Set the following environment variable:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set env -n default \
    dc/docker-registry \
    'REGISTRY_STORAGE_MAINTENANCE_READONLY={"enabled":true}'</pre>
</div>
</div>
</li>
<li>
<p>By default, the registry automatically redeploys when the previous step
completes; wait for the redeployment to complete before continuing. However, if
you have disabled these triggers, you must manually redeploy the registry so
that the new environment variables are picked up:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc rollout -n default \
    latest dc/docker-registry</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Add the <code>system:image-pruner</code> role.</strong></p>
<div class="paragraph">
<p>The service account used to run the registry instances requires additional
permissions in order to list some resources.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Get the service account name:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ service_account=$(oc get -n default \
    -o jsonpath=$'system:serviceaccount:{.metadata.namespace}:{.spec.template.spec.serviceAccountName}\n' \
    dc/docker-registry)</pre>
</div>
</div>
</li>
<li>
<p>Add the <code>system:image-pruner</code> cluster role to the service account:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc adm policy add-cluster-role-to-user \
    system:image-pruner \
    ${service_account}</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>(Optional) Run the pruner in dry-run mode.</strong></p>
<div class="paragraph">
<p>To see how many blobs would be removed, run the hard pruner in dry-run mode. No
changes are actually made:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc -n default \
    exec -i -t "$(oc -n default get pods -l deploymentconfig=docker-registry \
    -o jsonpath=$'{.items[0].metadata.name}\n')" \
    -- /usr/bin/dockerregistry -prune=check</pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, to get the exact paths for the prune candidates, increase the
logging level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc -n default \
    exec "$(oc -n default get pods -l deploymentconfig=docker-registry \
      -o jsonpath=$'{.items[0].metadata.name}\n')" \
    -- /bin/sh \
    -c 'REGISTRY_LOG_LEVEL=info /usr/bin/dockerregistry -prune=check'</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Truncated sample output</div>
<div class="content">
<pre class="nowrap">$ oc exec docker-registry-3-vhndw \
    -- /bin/sh -c 'REGISTRY_LOG_LEVEL=info /usr/bin/dockerregistry -prune=check'

time="2017-06-22T11:50:25.066156047Z" level=info msg="start prune (dry-run mode)" distribution_version="v2.4.1+unknown" kubernetes_version=v1.6.1+$Format:%h$ openshift_version=unknown
time="2017-06-22T11:50:25.092257421Z" level=info msg="Would delete blob: sha256:00043a2a5e384f6b59ab17e2c3d3a3d0a7de01b2cabeb606243e468acc663fa5" go.version=go1.7.5 instance.id=b097121c-a864-4e0c-ad6c-cc25f8fdf5a6
time="2017-06-22T11:50:25.092395621Z" level=info msg="Would delete blob: sha256:0022d49612807cb348cabc562c072ef34d756adfe0100a61952cbcb87ee6578a" go.version=go1.7.5 instance.id=b097121c-a864-4e0c-ad6c-cc25f8fdf5a6
time="2017-06-22T11:50:25.092492183Z" level=info msg="Would delete blob: sha256:0029dd4228961086707e53b881e25eba0564fa80033fbbb2e27847a28d16a37c" go.version=go1.7.5 instance.id=b097121c-a864-4e0c-ad6c-cc25f8fdf5a6
time="2017-06-22T11:50:26.673946639Z" level=info msg="Would delete blob: sha256:ff7664dfc213d6cc60fd5c5f5bb00a7bf4a687e18e1df12d349a1d07b2cf7663" go.version=go1.7.5 instance.id=b097121c-a864-4e0c-ad6c-cc25f8fdf5a6
time="2017-06-22T11:50:26.674024531Z" level=info msg="Would delete blob: sha256:ff7a933178ccd931f4b5f40f9f19a65be5eeeec207e4fad2a5bafd28afbef57e" go.version=go1.7.5 instance.id=b097121c-a864-4e0c-ad6c-cc25f8fdf5a6
time="2017-06-22T11:50:26.674675469Z" level=info msg="Would delete blob: sha256:ff9b8956794b426cc80bb49a604a0b24a1553aae96b930c6919a6675db3d5e06" go.version=go1.7.5 instance.id=b097121c-a864-4e0c-ad6c-cc25f8fdf5a6
...
Would delete 13374 blobs
Would free up 2.835 GiB of disk space
Use -prune=delete to actually delete the data</pre>
</div>
</div>
</li>
<li>
<p><strong>Run the hard prune.</strong></p>
<div class="paragraph">
<p>Execute the following command inside one running instance of a <code>docker-registry</code>
pod to run the hard prune:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc -n default \
    exec -i -t "$(oc -n default get pods -l deploymentconfig=docker-registry -o jsonpath=$'{.items[0].metadata.name}\n')" \
    -- /usr/bin/dockerregistry -prune=delete</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample output</div>
<div class="content">
<pre class="nowrap">$ oc exec docker-registry-3-vhndw \
    -- /usr/bin/dockerregistry -prune=delete

Deleted 13374 blobs
Freed up 2.835 GiB of disk space</pre>
</div>
</div>
</li>
<li>
<p><strong>Switch the registry back to read-write mode.</strong></p>
<div class="paragraph">
<p>After the prune is finished, the registry can be switched back to read-write
mode by executing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc set env -n default dc/docker-registry REGISTRY_STORAGE_MAINTENANCE_READONLY-</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="pruning-cronjobs-pruning-objects">Pruning cron jobs</h3>
<div class="paragraph">
<p>Cron jobs can perform pruning of successful jobs, but might not properly handle
failed jobs. Therefore, the cluster administrator should perform regular cleanup of
jobs manually. They should also restrict the access to cron jobs to a small
group of trusted users and set appropriate quota to prevent the cron job from
creating too many jobs and pods.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_enterprise/4.0/html-single/nodes/#nodes-nodes-jobs_nodes-nodes-jobs">Running tasks in pods using jobs</a></p>
</li>
<li>
<p><a href="#resource-quotas-across-multiple-projects">Resource quotas across multiple projects</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_enterprise/4.0/html-single/authentication/#using-rbac">Using RBAC to define and apply permissions</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_operator-sdk">Operator SDK</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="getting-started-with-the-operator-sdk">Getting started with the Operator SDK</h3>
<div class="paragraph">
<p>This guide outlines the basics of the Operator SDK and walks Operator authors
with cluster administrator access to a Kubernetes-based cluster (such as
OpenShift Enterprise) through an example of building a simple Go-based Memcached
Operator and managing its lifecycle from installation to upgrade.</p>
</div>
<div class="paragraph">
<p>This is accomplished using two centerpieces of the Operator Framework: the
Operator SDK (the <code>operator-sdk</code> CLI tool and <code>controller-runtime</code> library API)
and the Operator Lifecycle Manager (OLM).</p>
</div>
<div class="sect3">
<h4 id="osdk-architecture-osdk-getting-started">Architecture of the Operator SDK</h4>
<div class="paragraph">
<p>The <a href="https://coreos.com/operators/">Operator Framework</a> is an open source
toolkit to manage Kubernetes native applications, called <em>Operators</em>, in an
effective, automated, and scalable way. Operators take advantage of Kubernetes'
extensibility to deliver the automation advantages of cloud services like
provisioning, scaling, and backup and restore, while being able to run anywhere
that Kubernetes can run.</p>
</div>
<div class="paragraph">
<p>Operators make it easy to manage complex, stateful applications on top of
Kubernetes. However, writing an Operator today can be difficult because of
challenges such as using low-level APIs, writing boilerplate, and a lack of
modularity, which leads to duplication.</p>
</div>
<div class="paragraph">
<p>The Operator SDK is a framework designed to make writing Operators easier by
providing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>High-level APIs and abstractions to write the operational logic more intuitively</p>
</li>
<li>
<p>Tools for scaffolding and code generation to quickly bootstrap a new project</p>
</li>
<li>
<p>Extensions to cover common Operator use cases</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="osdk-architecture-workflow-osdk-getting-started">Workflow</h5>
<div class="paragraph">
<p>The Operator SDK provides the following workflow to develop a new Operator:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new Operator project using the Operator SDK command line interface (CLI).</p>
</li>
<li>
<p>Define new resource APIs by adding Custom Resource Definitions (CRDs).</p>
</li>
<li>
<p>Specify resources to watch using the Operator SDK API.</p>
</li>
<li>
<p>Define the Operator reconciling logic in a designated handler and use the Operator SDK API to interact with resources.</p>
</li>
<li>
<p>Use the Operator SDK CLI to build and generate the Operator deployment manifests.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/osdk-workflow.png" alt="osdk workflow">
</div>
<div class="title">Figure 5. Operator SDK workflow</div>
</div>
<div class="paragraph">
<p>At a high level, an Operator using the Operator SDK processes events for watched
resources in an Operator author-defined handler and takes actions to reconcile
the state of the application.</p>
</div>
</div>
<div class="sect4">
<h5 id="osdk-architecture-manager-osdk-getting-started">Manager file</h5>
<div class="paragraph">
<p>The main program for the Operator is the manager file at <code>cmd/manager/main.go</code>.
The manager automatically registers the scheme for all Custom Resources (CRs)
defined under <code>pkg/apis/</code> and runs all controllers under <code>pkg/controller/</code>.</p>
</div>
<div class="paragraph">
<p>The manager can restrict the namespace that all controllers watch for resources:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">mgr, err := manager.New(cfg, manager.Options{Namespace: namespace})</pre>
</div>
</div>
<div class="paragraph">
<p>By default, this is the namespace that the Operator is running in. To watch all
namespaces, you can leave the namespace option empty:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">mgr, err := manager.New(cfg, manager.Options{Namespace: ""})</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="osdk-monitoring-prometheus-operator-support-osdk-getting-started">Prometheus Operator support</h5>
<div class="paragraph">
<p><a href="https://prometheus.io/">Prometheus</a> is an open-source systems monitoring and
alerting toolkit. The Prometheus Operator creates, configures, and manages
Prometheus clusters running on Kubernetes-based clusters, such as
OpenShift Enterprise.</p>
</div>
<div class="paragraph">
<p>Helper functions exist in the Operator SDK by default to automatically set up
metrics in any generated Go-based Operator for use on clusters where the
Prometheus Operator is deployed.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="osdk-installing-cli-osdk-getting-started">Installing the Operator SDK CLI</h4>
<div class="paragraph">
<p>The Operator SDK has a CLI tool that assists developers in creating, building,
and deploying a new Operator project. You can install the SDK CLI on your
workstation so you are prepared to start authoring your own Operators.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="https://golang.github.io/dep/docs/installation.html">dep</a> v0.5.0+</p>
</li>
<li>
<p><a href="https://git-scm.com/downloads">Git</a></p>
</li>
<li>
<p><a href="https://golang.org/dl/">Go</a> v1.10+</p>
</li>
<li>
<p><a href="https://docs.docker.com/install/"><code>docker</code></a> v17.03+</p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/"><code>kubectl</code></a> v1.11.3+</p>
</li>
<li>
<p>Access to a cluster based on Kubernetes v1.11.3+</p>
</li>
<li>
<p>Access to a container registry</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This guide uses
<a href="https://github.com/kubernetes/minikube#installation">minikube</a> v0.25.0+ as
the local Kubernetes cluster and <a href="https://quay.io/">quay.io</a> for the public
registry.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Clone and <code>operator-sdk</code> repository:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ mkdir -p $GOPATH/src/github.com/operator-framework
$ cd $GOPATH/src/github.com/operator-framework
$ git clone https://github.com/operator-framework/operator-sdk
$ cd operator-sdk</pre>
</div>
</div>
</li>
<li>
<p>Check out the desired release branch:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ git checkout master</pre>
</div>
</div>
</li>
<li>
<p>Install the SDK CLI tool:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ make dep
$ make install</pre>
</div>
</div>
<div class="paragraph">
<p>This installs the CLI binary <code>operator-sdk</code> at <strong><em>$GOPATH/bin</em></strong>.</p>
</div>
</li>
<li>
<p>Verify that the CLI tool was installed correctly:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk -h</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="building-memcached-operator-using-osdk-osdk-getting-started">Building a Go-based Memcached Operator using the Operator SDK</h4>
<div class="paragraph">
<p>The Operator SDK makes it easier to build Kubernetes native applications, a
process that can require deep, application-specific operational knowledge. The
SDK not only lowers that barrier, but it also helps reduce the amount of
boilerplate code needed for many common management capabilities, such as
metering or monitoring.</p>
</div>
<div class="paragraph">
<p>This procedure walks through an example of building a simple Memcached Operator
using tools and libraries provided by the SDK.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Operator SDK CLI installed on the development workstation</p>
</li>
<li>
<p>Operator Lifecycle Manager (OLM) installed on a Kubernetes-based cluster (v1.8
or above to support the <code>apps/v1beta2</code> API group), for example OpenShift Enterprise 4.0</p>
</li>
<li>
<p>Access to the cluster using an account with <code>cluster-admin</code> permissions</p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/"><code>kubectl</code></a> v1.11.3+
(can alternatively use <code>oc</code>)</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p><strong>Create a new project.</strong></p>
<div class="paragraph">
<p>Use the CLI to create a new <code>memcached-operator</code> project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ cd $GOPATH/src/github.com/example-inc/
$ operator-sdk new memcached-operator
$ cd memcached-operator</pre>
</div>
</div>
</li>
<li>
<p><strong>Add a new Custom Resource Definition (CRD).</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Use the CLI to add a new CRD API called <code>Memcached</code>, with <code>APIVersion</code> set to
<code>cache.example.com/v1apha1</code> and <code>Kind</code> set to <code>Memcached</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk add api \
    --api-version=cache.example.com/v1alpha1 \
    --kind=Memcached</pre>
</div>
</div>
<div class="paragraph">
<p>This scaffolds the Memcached resource API under <code>pkg/apis/cache/v1alpha1/</code>.</p>
</div>
</li>
<li>
<p>Modify the spec and status of the <code>Memcached</code> Custom Resource (CR) at the
<code>pkg/apis/cache/v1alpha1/memcached_types.go</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">type MemcachedSpec struct {
	// Size is the size of the memcached deployment
	Size int32 `json:"size"`
}
type MemcachedStatus struct {
	// Nodes are the names of the memcached pods
	Nodes []string `json:"nodes"`
}</pre>
</div>
</div>
</li>
<li>
<p>After modifying the <code>*_types.go</code> file, always run the following command to
update the generated code for that resource type:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk generate k8s</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Add a new Controller.</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Add a new Controller to the project to watch and reconcile the Memcached
resource:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk add controller \
    --api-version=cache.example.com/v1alpha1 \
    --kind=Memcached</pre>
</div>
</div>
<div class="paragraph">
<p>This scaffolds a new Controller implementation under
<code>pkg/controller/memcached/</code>.</p>
</div>
</li>
<li>
<p>For this example, replace the generated controller file
<code>pkg/controller/memcached/memcached_controller.go</code> with the
<a href="https://github.com/operator-framework/operator-sdk/blob/master/example/memcached-operator/memcached_controller.go.tmpl">example implementation</a>.</p>
<div class="paragraph">
<p>The example controller executes the following reconciliation logic for each
<code>Memcached</code> CR:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Create a Memcached Deployment if it does not exist.</p>
</li>
<li>
<p>Ensure that the Deployment size is the same as specified by the <code>Memcached</code> CR spec.</p>
</li>
<li>
<p>Update the <code>Memcached</code> CR status with the names of the Memcached Pods.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>The next two sub-steps inspect how the Controller watches resources and how the
reconcile loop is triggered. You can skip these steps
to go directly to building and running the Operator.</p>
</div>
</li>
<li>
<p>Inspect the Controller implementation at the
<code>pkg/controller/memcached/memcached_controller.go</code> file to see how the
Controller watches resources.</p>
<div class="paragraph">
<p>The first watch is for the Memcached type as the primary resource. For each Add,
Update, or Delete event, the reconcile loop is sent a reconcile <code>Request</code> (a
<code>&lt;namespace&gt;:&lt;name&gt;</code> key) for that Memcached object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">err := c.Watch(
  &amp;source.Kind{Type: &amp;cachev1alpha1.Memcached{}}, &amp;handler.EnqueueRequestForObject{})</pre>
</div>
</div>
<div class="paragraph">
<p>The next watch is for Deployments, but the event handler maps each event to a
reconcile <code>Request</code> for the owner of the Deployment. In this case, this is the
Memcached object for which the Deployment was created. This allows the
controller to watch Deployments as a secondary resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">err := c.Watch(&amp;source.Kind{Type: &amp;appsv1.Deployment{}}, &amp;handler.EnqueueRequestForOwner{
		IsController: true,
		OwnerType:    &amp;cachev1alpha1.Memcached{},
	})</pre>
</div>
</div>
</li>
<li>
<p>Every Controller has a Reconciler object with a <code>Reconcile()</code> method that
implements the reconcile loop. The reconcile loop is passed the <code>Request</code>
argument which is a <code>&lt;namespace&gt;:&lt;name&gt;</code> key used to lookup the primary resource
object, Memcached, from the cache:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">func (r *ReconcileMemcached) Reconcile(request reconcile.Request) (reconcile.Result, error) {
  // Lookup the Memcached instance for this reconcile request
  memcached := &amp;cachev1alpha1.Memcached{}
  err := r.client.Get(context.TODO(), request.NamespacedName, memcached)
  ...
}</pre>
</div>
</div>
<div class="paragraph">
<p>Based on the return value of <code>Reconcile()</code> the reconcile <code>Request</code> may be
requeued and the loop may be triggered again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">// Reconcile successful - don't requeue
return reconcile.Result{}, nil
// Reconcile failed due to error - requeue
return reconcile.Result{}, err
// Requeue for any reason other than error
return reconcile.Result{Requeue: true}, nil</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Build and run the Operator.</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Before running the Operator, the CRD must be registered with the Kubernetes API
server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl create \
    -f deploy/crds/cache_v1alpha1_memcached_crd.yaml</pre>
</div>
</div>
</li>
<li>
<p>After registering the CRD, there are two options for running the Operator:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>As a Deployment inside a Kubernetes cluster</p>
</li>
<li>
<p>As Go program outside a cluster</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Choose one of the following methods.</p>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><em>Option A:</em> Running as a Deployment inside the cluster.</p>
<div class="olist upperalpha">
<ol class="upperalpha" type="A">
<li>
<p>Build the <code>memcached-operator</code> image and push it to a registry:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk build quay.io/example/memcached-operator:v0.0.1</pre>
</div>
</div>
</li>
<li>
<p>The Deployment manifest is generated at <code>deploy/operator.yaml</code>. Update the
Deployment image as follows since the default is just a placeholder:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ sed -i 's|REPLACE_IMAGE|quay.io/example/memcached-operator:v0.0.1|g' deploy/operator.yaml</pre>
</div>
</div>
</li>
<li>
<p>Ensure you have an account on <a href="https://quay.io">quay.io</a> for the next step,
or substitute your preferred container registry. On the registry,
<a href="https://quay.io/new/">create a new public image</a> repository named
<code>memcached-operator</code>.</p>
</li>
<li>
<p>Push the image to the registry:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ docker push quay.io/example/memcached-operator:v0.0.1</pre>
</div>
</div>
</li>
<li>
<p>Setup RBAC and deploy <code>memcached-operator</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl create -f deploy/role.yaml
$ kubectl create -f deploy/role_binding.yaml
# TODO: $ kubectl create -f deploy/service_account.yaml
$ kubectl create -f deploy/operator.yaml</pre>
</div>
</div>
</li>
<li>
<p>Verify that <code>memcached-operator</code> is up and running:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get deployment
NAME                     DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
memcached-operator       1         1         1            1           1m</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><em>Option B:</em> Running locally outside the cluster.</p>
<div class="paragraph">
<p>This method is preferred during development cycle to deploy and test faster.</p>
</div>
<div class="paragraph">
<p>Run the Operator locally with the default Kubernetes configuration file present
at <code>$HOME/.kube/config</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk up local --namespace=default
2018/09/30 23:10:11 Go Version: go1.10.2
2018/09/30 23:10:11 Go OS/Arch: darwin/amd64
2018/09/30 23:10:11 operator-sdk Version: 0.0.6+git
2018/09/30 23:10:12 Registering Components.
2018/09/30 23:10:12 Starting the Cmd.</pre>
</div>
</div>
<div class="paragraph">
<p>You can use a specific <code>kubeconfig</code> using the flag
<code>--kubeconfig=&lt;path/to/kubeconfig&gt;</code>.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Verify that the Operator can deploy a Memcached application</strong> by creating a
Memcached CR.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Create the example <code>Memcached</code> CR that was generated at
<code>deploy/crds/cache_v1alpha1_memcached_cr.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ cat deploy/crds/cache_v1alpha1_memcached_cr.yaml
apiVersion: "cache.example.com/v1alpha1"
kind: "Memcached"
metadata:
  name: "example-memcached"
spec:
  size: 3

$ kubectl apply -f deploy/crds/cache_v1alpha1_memcached_cr.yaml</pre>
</div>
</div>
</li>
<li>
<p>Ensure that <code>memcached-operator</code> creates the Deployment for the CR:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get deployment
NAME                     DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
memcached-operator       1         1         1            1           2m
example-memcached        3         3         3            3           1m</pre>
</div>
</div>
</li>
<li>
<p>Check the Pods and CR status to confirm the status is updated with the
<code>memcached</code> Pod names:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get pods
NAME                                  READY     STATUS    RESTARTS   AGE
example-memcached-6fd7c98d8-7dqdr     1/1       Running   0          1m
example-memcached-6fd7c98d8-g5k7v     1/1       Running   0          1m
example-memcached-6fd7c98d8-m7vn7     1/1       Running   0          1m
memcached-operator-7cc7cfdf86-vvjqk   1/1       Running   0          2m

$ kubectl get memcached/example-memcached -o yaml
apiVersion: cache.example.com/v1alpha1
kind: Memcached
metadata:
  clusterName: ""
  creationTimestamp: 2018-03-31T22:51:08Z
  generation: 0
  name: example-memcached
  namespace: default
  resourceVersion: "245453"
  selfLink: /apis/cache.example.com/v1alpha1/namespaces/default/memcacheds/example-memcached
  uid: 0026cc97-3536-11e8-bd83-0800274106a1
spec:
  size: 3
status:
  nodes:
  - example-memcached-6fd7c98d8-7dqdr
  - example-memcached-6fd7c98d8-g5k7v
  - example-memcached-6fd7c98d8-m7vn7</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Verify that the Operator can manage a deployed Memcached application</strong> by
updating the size of the deployment.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Change the <code>spec.size</code> field in the <code>memcached</code> CR from <code>3</code> to <code>4</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ cat deploy/crds/cache_v1alpha1_memcached_cr.yaml
apiVersion: "cache.example.com/v1alpha1"
kind: "Memcached"
metadata:
  name: "example-memcached"
spec:
  size: 4</pre>
</div>
</div>
</li>
<li>
<p>Apply the change:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl apply -f deploy/crds/cache_v1alpha1_memcached_cr.yaml</pre>
</div>
</div>
</li>
<li>
<p>Confirm that the Operator changes the Deployment size:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get deployment
NAME                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
example-memcached    4         4         4            4           5m</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Clean up the resources:</strong></p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl delete -f deploy/crds/cache_v1alpha1_memcached_cr.yaml
$ kubectl delete -f deploy/crds/cache_v1alpha1_memcached_crd.yaml
$ kubectl delete -f deploy/operator.yaml
$ kubectl delete -f deploy/role.yaml
$ kubectl delete -f deploy/role_binding.yaml
$ kubectl delete -f deploy/service_account.yaml</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="managing-memcached-operator-using-olm-osdk-getting-started">Managing a Memcached Operator using the Operator Lifecycle Manager</h4>
<div class="paragraph">
<p>The previous section has covered manually running an Operator. In the next
sections, we will explore using the Operator Lifecycle Manager (OLM), which is
what enables a more robust deployment model for Operators being run in
production environments.</p>
</div>
<div class="paragraph">
<p>The OLM helps you to install, update, and generally manage the lifecycle of all
of the Operators (and their associated services) on a Kubernetes cluster. It
runs as an Kubernetes extension and lets you use <code>kubectl</code> for all the lifecycle
management functions without any additional tools.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>OLM installed on a Kubernetes-based cluster (v1.8 or above to support the
<code>apps/v1beta2</code> API group), for example OpenShift Enterprise 4.0
Preview OLM enabled</p>
</li>
<li>
<p>Memcached Operator built</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p><strong>Generate an Operator manifest.</strong></p>
<div class="paragraph">
<p>An Operator manifest describes how to display, create, and manage the
application, in this case Memcached, as a whole. It is defined by a
<code>CustomServiceVersion</code> (CSV) object and is required for the OLM to function.</p>
</div>
<div class="paragraph">
<p>For the purpose of this guide, we will continue with this
<a href="https://github.com/operator-framework/getting-started/blob/master/memcachedoperator.0.0.1.csv.yaml">predefined manifest file</a>
for the next steps. You can alter the image field within this manifest to
reflect the image you built in previous steps, but it is unnecessary. In the
future, the Operator SDK CLI will generate an Operator manifest for you, a
feature that is planned for the next release of the Operator SDK.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>See
<a href="https://github.com/operator-framework/operator-lifecycle-manager/blob/master/Documentation/design/building-your-csv.md">Building a CSV for the Operator Framework</a>
for more information on manually defining a manifest file.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p><strong>Deploy the Operator.</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Deploy an Operator by applying the Operator’s manifest to the desired namespace
in the cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ curl -Lo memcachedoperator.0.0.1.csv.yaml https://raw.githubusercontent.com/operator-framework/getting-started/master/memcachedoperator.0.0.1.csv.yaml
$ kubectl apply -f memcachedoperator.0.0.1.csv.yaml
$ kubectl get ClusterServiceVersion memcachedoperator.v0.0.1 -o json | jq '.status'</pre>
</div>
</div>
</li>
<li>
<p>After applying this manifest, nothing has happened yet, because the cluster does
not meet the requirements specified in our manifest. Create the RBAC rules and
<code>CustomResourceDefinition</code> for the Memcached type managed by the Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl apply -f deploy/rbac.yaml
$ kubectl apply -f deploy/crd.yaml</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>rbac.yaml</code> and <code>crd.yaml</code> files were generated into the <code>deploy/</code>
directory by the Operator SDK when you built the Memcached Operator.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Because the OLM creates Operators in a particular namespace when a manifest is
applied, administrators can leverage the native Kubernetes RBAC permission model
to restrict which users are allowed to install Operators.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Create an application instance.</strong></p>
<div class="paragraph">
<p>The Memcached Operator is now running in the <code>memcached</code> namespace. Users
interact with Operators via instances of <code>CustomResources</code>; in this case, the
resource has the kind <code>Memcached</code>. Native Kubernetes RBAC also applies to
<code>CustomResources</code>, providing administrators control over who can interact with
each Operator.</p>
</div>
<div class="paragraph">
<p>Creating instances of Memcached in this namespace will now trigger the Memcached
Operator to instantiate pods running the memcached server that are managed by
the Operator. The more <code>CustomResources</code> you create, the more unique instances
of Memcached are managed by the Memcached Operator running in this namespace.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: "cache.example.com/v1alpha1"
kind: "Memcached"
metadata:
  name: "memcached-for-wordpress"
spec:
  size: 1
EOF

$ cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: "cache.example.com/v1alpha1"
kind: "Memcached"
metadata:
  name: "memcached-for-drupal"
spec:
  size: 1
EOF

$ kubectl get Memcached
NAME                      AGE
memcached-for-drupal      22s
memcached-for-wordpress   27s

$ kubectl get pods
NAME                                       READY     STATUS    RESTARTS   AGE
memcached-app-operator-66b5777b79-pnsfj    1/1       Running   0          14m
memcached-for-drupal-5476487c46-qbd66      1/1       Running   0          3s
memcached-for-wordpress-65b75fd8c9-7b9x7   1/1       Running   0          8s</pre>
</div>
</div>
</li>
<li>
<p><strong>Update an application.</strong></p>
<div class="paragraph">
<p>Manually apply an update to the Operator by creating a new Operator manifest
with a <code>replaces</code> field that references the old Operator manifest. The OLM
ensures that all resources being managed by the old Operator have their
ownership moved to the new Operator without fear of any programs stopping
execution. It is up to the Operators themselves to execute any data migrations
required to upgrade resources to run under a new version of the Operator.</p>
</div>
<div class="paragraph">
<p>The following command demonstrates applying a new
<a href="https://github.com/operator-framework/getting-started/blob/master/memcachedoperator.0.0.2.csv.yaml">Operator manifest file</a>
using a new version of the Operator and shows that the pods remain executing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ curl -Lo memcachedoperator.0.0.2.csv.yaml https://raw.githubusercontent.com/operator-framework/getting-started/master/memcachedoperator.0.0.2.csv.yaml
$ kubectl apply -f memcachedoperator.0.0.2.csv.yaml
$ kubectl get pods
NAME                                       READY     STATUS    RESTARTS   AGE
memcached-app-operator-66b5777b79-pnsfj    1/1       Running   0          3s
memcached-for-drupal-5476487c46-qbd66      1/1       Running   0          14m
memcached-for-wordpress-65b75fd8c9-7b9x7   1/1       Running   0          14m</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="osdk-getting-started-addtl-resources">Additional resources</h4>
<div class="ulist">
<ul>
<li>
<p>See
<a href="#osdk-project-scaffolding-layout-operator-appendices">Appendices</a>
to learn about the project directory structures created by the Operator SDK.</p>
</li>
<li>
<p><a href="https://operators.gitbook.io/operator-developer-guide-for-red-hat-partners/">Operator Development Guide for Red Hat Partners</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-ansible-based-operators">Creating Ansible-based Operators</h3>
<div class="paragraph">
<p>This guide outlines Ansible support in the Operator SDK and walks Operator
authors through examples building and running Ansible-based Operators with the
<code>operator-sdk</code> CLI tool that use Ansible playbooks and modules.</p>
</div>
<div class="sect3">
<h4 id="osdk-ansible-support-osdk-ansible">Ansible support in the Operator SDK</h4>
<div class="paragraph">
<p>The <a href="https://coreos.com/operators/">Operator Framework</a> is an open source
toolkit to manage Kubernetes native applications, called <em>Operators</em>, in an
effective, automated, and scalable way. This framework includes the Operator
SDK, which assists developers in bootstrapping and building an Operator based on
their expertise without requiring knowledge of Kubernetes API complexities.</p>
</div>
<div class="paragraph">
<p>One of the Operator SDK&#8217;s options for generating an Operator project includes
leveraging existing Ansible playbooks and modules to deploy Kubernetes resources
as a unified application, without having to write any Go code.</p>
</div>
<div class="sect4">
<h5 id="osdk-ansible-custom-resource-files-osdk-ansible">Custom Resource files</h5>
<div class="paragraph">
<p>Operators use the Kubernetes' extension mechanism, Custom Resource Definitions
(CRDs), so your Custom Resource (CR) looks and acts just like the built-in,
native Kubernetes objects.</p>
</div>
<div class="paragraph">
<p>The CR file format is a Kubernetes resource file. The object has mandatory and
optional fields:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. Custom Resource fields</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>apiVersion</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version of the CR to be created.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kind</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kind of the CR to be created.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>metadata</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kubernetes-specific metadata to be created.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec</code> (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key-value list of variables which are passed to Ansible. This field is empty by
default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>status</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Summarizes the current state of the object. For Ansible-based Operators, the
<a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/#status-subresource"><code>status</code> subresource</a>
is enabled for CRDs and managed by the <code>k8s_status</code> Ansible module by default,
which includes <code>condition</code> information to the CR&#8217;s <code>status</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>annotations</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kubernetes-specific annotations to be appended to the CR.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following list of CR annotations modify the behavior of the Operator:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. Ansible-based Operator annotations</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ansible.operator-sdk/reconcile-period</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the reconciliation interval for the CR. This value is parsed using
the standard Golang package <a href="https://golang.org/pkg/time/"><code>time</code></a>.
Specifically, <a href="https://golang.org/pkg/time/#ParseDuration"><code>ParseDuration</code></a>
is used which applies the default suffix of <code>s</code>, giving the value in seconds.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example Ansible-based Operator annotation</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: "foo.example.com/v1alpha1"
kind: "Foo"
metadata:
  name: "example"
annotations:
  ansible.operator-sdk/reconcile-period: "30s"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="osdk-ansible-watches-file-osdk-ansible">Watches file</h5>
<div class="paragraph">
<p>The Watches file contains a list of mappings from Custom Resources (CRs),
identified by its <code>Group</code>, <code>Version</code>, and <code>Kind</code>, to an Ansible role or
playbook. The Operator expects this mapping file in a predefined location,
<code>/opt/ansible/watches.yaml</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. Watches file mappings</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Group of CR to watch.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version of CR to watch.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kind</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kind of CR to watch</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>role</code> (default)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path to the Ansible role added to the container. For example, if your <code>roles</code>
directory is at <code>/opt/ansible/roles/</code> and your role is named <code>busybox</code>, this
value would be <code>/opt/ansible/roles/busybox</code>. This field is mutually exclusive
with the <code>playbook</code> field.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>playbook</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path to the Ansible playbook added to the container. This playbook is expected
to be simply a way to call roles. This field is mutually exclusive with the
<code>role</code> field.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>reconcilePeriod</code> (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The reconciliation interval, how often the role or playbook is run, for a given
CR.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>manageStatus</code> (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When set to <code>true</code> (default), the Operator manages the status of the CR
generically. When set to <code>false</code>, the status of the CR is managed elsewhere, by
the specified role or playbook or in a separate controller.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example Watches file</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">- version: v1alpha1 <b class="conum">(1)</b>
  group: foo.example.com
  kind: Foo
  role: /opt/ansible/roles/Foo

- version: v1alpha1 <b class="conum">(2)</b>
  group: bar.example.com
  kind: Bar
  playbook: /opt/ansible/playbook.yml

- version: v1alpha1 <b class="conum">(3)</b>
  group: baz.example.com
  kind: Baz
  playbook: /opt/ansible/baz.yml
  reconcilePeriod: 0
  manageStatus: false</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Simple example mapping <code>Foo</code> to the <code>Foo</code> role.</p>
</li>
<li>
<p>Simple example mapping <code>Bar</code> to a playbook.</p>
</li>
<li>
<p>More complex example for the <code>Baz</code> kind. Disables re-queuing and managing
the CR status in the playbook.</p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="osdk-ansible-watches-file-advanced-osdk-ansible">Advanced options</h6>
<div class="paragraph">
<p>Advanced features can be enabled by adding them to your Watches file per GVK
(group, version, and kind). They can go below the <code>group</code>, <code>version</code>, <code>kind</code> and
<code>playbook</code> or <code>role</code> fields.</p>
</div>
<div class="paragraph">
<p>Some features can be overridden per resource using an annotation on that Custom
Resource (CR). The options that can be overridden have the annotation specified
below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 15. Advanced Watches file options</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 16.6666%;">
<col style="width: 33.3333%;">
<col style="width: 16.6666%;">
<col style="width: 8.3335%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Feature</th>
<th class="tableblock halign-left valign-top">YAML key</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Annotation for override</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reconcile period</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>reconcilePeriod</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time between reconcile runs for a particular CR.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ansbile.operator-sdk/reconcile-period</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1m</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manage status</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>manageStatus</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows the Operator to manage the <code>conditions</code> section of each CR&#8217;s <code>status</code>
section.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Watch dependent resources</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>watchDependentResources</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows the Operator to dynamically watch resources that are created by Ansible.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Watch cluster-scoped resources</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>watchClusterScopedResources</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows the Operator to watch cluster-scoped resources that are created by Ansible.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max runner artifacts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxRunnerArtifacts</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manages the number of
<a href="https://ansible-runner.readthedocs.io/en/latest/intro.html#runner-artifacts-directory-hierarchy">artifact directories</a>
that Ansible Runner keeps in the Operator container for each individual
resource.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ansible.operator-sdk/max-runner-artifacts</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>20</code></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example Watches file with advanced options</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">- version: v1alpha1
  group: app.example.com
  kind: AppService
  playbook: /opt/ansible/playbook.yml
  maxRunnerArtifacts: 30
  reconcilePeriod: 5s
  manageStatus: False
  watchDependentResources: False</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="osdk-ansible-extra-variables-osdk-ansible">Extra variables sent to Ansible</h5>
<div class="paragraph">
<p>Extra variables can be sent to Ansible, which are then managed by the Operator.
The <code>spec</code> section of the Custom Resource (CR) passes along the key-value pairs
as extra variables. This is equivalent to extra variables passed in to the
<code>ansible-playbook</code> command.</p>
</div>
<div class="paragraph">
<p>The Operator also passes along additional variables under the <code>meta</code> field for
the name of the CR and the namespace of the CR.</p>
</div>
<div class="paragraph">
<p>For the following CR example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: "app.example.com/v1alpha1"
kind: "Database"
metadata:
  name: "example"
spec:
  message:"Hello world 2"
  newParameter: "newParam"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The structure passed to Ansible as extra variables is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{ "meta": {
        "name": "&lt;cr_name&gt;",
        "namespace": "&lt;cr_namespace&gt;",
  },
  "message": "Hello world 2",
  "new_parameter": "newParam",
  "_app_example_com_database": {
     &lt;full_crd&gt;
   },
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>message</code> and <code>newParameter</code> fields are set in the top level as extra
variables, and <code>meta</code> provides the relevant metadata for the CR as defined in
the Operator. The <code>meta</code> fields can be accessed using dot notation in Ansible,
for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">- debug:
    msg: "name: {{ meta.name }}, {{ meta.namespace }}"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="osdk-ansible-runner-directory-osdk-ansible">Ansible Runner directory</h5>
<div class="paragraph">
<p>Ansible Runner keeps information about Ansible runs in the container. This
is located at
<code>/tmp/ansible-operator/runner/&lt;group&gt;/&lt;version&gt;/&lt;kind&gt;/&lt;namespace&gt;/&lt;name&gt;</code>.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>To learn more about the <code>runner</code> directory, see the
<a href="https://ansible-runner.readthedocs.io/en/latest/index.html">Ansible Runner documentation</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="osdk-installing-cli-osdk-ansible">Installing the Operator SDK CLI</h4>
<div class="paragraph">
<p>The Operator SDK has a CLI tool that assists developers in creating, building,
and deploying a new Operator project. You can install the SDK CLI on your
workstation so you are prepared to start authoring your own Operators.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="https://golang.github.io/dep/docs/installation.html">dep</a> v0.5.0+</p>
</li>
<li>
<p><a href="https://git-scm.com/downloads">Git</a></p>
</li>
<li>
<p><a href="https://golang.org/dl/">Go</a> v1.10+</p>
</li>
<li>
<p><a href="https://docs.docker.com/install/"><code>docker</code></a> v17.03+</p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/"><code>kubectl</code></a> v1.11.3+</p>
</li>
<li>
<p>Access to a cluster based on Kubernetes v1.11.3+</p>
</li>
<li>
<p>Access to a container registry</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This guide uses
<a href="https://github.com/kubernetes/minikube#installation">minikube</a> v0.25.0+ as
the local Kubernetes cluster and <a href="https://quay.io/">quay.io</a> for the public
registry.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Clone and <code>operator-sdk</code> repository:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ mkdir -p $GOPATH/src/github.com/operator-framework
$ cd $GOPATH/src/github.com/operator-framework
$ git clone https://github.com/operator-framework/operator-sdk
$ cd operator-sdk</pre>
</div>
</div>
</li>
<li>
<p>Check out the desired release branch:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ git checkout master</pre>
</div>
</div>
</li>
<li>
<p>Install the SDK CLI tool:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ make dep
$ make install</pre>
</div>
</div>
<div class="paragraph">
<p>This installs the CLI binary <code>operator-sdk</code> at <strong><em>$GOPATH/bin</em></strong>.</p>
</div>
</li>
<li>
<p>Verify that the CLI tool was installed correctly:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk -h</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="osdk-building-ansible-operator-osdk-ansible">Building an Ansible-based Operator using the Operator SDK</h4>
<div class="paragraph">
<p>This procedure walks through an example of building a simple Memcached Operator
powered by Ansible playbooks and modules using tools and libraries provided by
the Operator SDK.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Operator SDK CLI installed on the development workstation</p>
</li>
<li>
<p>Access to a Kubernetes-based cluster v1.11.3+ (for example OpenShift Enterprise 4.0)
using an account with <code>cluster-admin</code> permissions</p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/"><code>kubectl</code></a> v1.11.3+
(can alternatively use <code>oc</code>)</p>
</li>
<li>
<p><a href="https://docs.ansible.com/ansible/latest/index.html"><code>ansible</code></a> v2.6.0+</p>
</li>
<li>
<p><a href="https://ansible-runner.readthedocs.io/en/latest/install.html"><code>ansible-runner</code></a> v1.1.0+</p>
</li>
<li>
<p><a href="https://github.com/ansible/ansible-runner-http"><code>ansible-runner-http</code></a> v1.0.0+</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p><strong>Create a new Operator project,</strong> either namespace-scoped or cluster-scoped,
using the <code>operator-sdk new</code> command. Choose one of the following:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>A <em>namespace-scoped Operator</em> (the default) watches and manages resources in a
single namespace. Namespace-scoped operators are preferred because of their
flexibility. They enable decoupled upgrades, namespace isolation for failures
and monitoring, and differing API definitions.</p>
<div class="paragraph">
<p>To create a new Ansible-based, namespace-scoped <code>memcached-operator</code> project and
change to its directory, use the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk new memcached-operator \
    --api-version=cache.example.com/v1alpha1 \
    --kind=Memcached \
    --type=ansible
$ cd memcached-operator</pre>
</div>
</div>
<div class="paragraph">
<p>This creates the <code>memcached-operator</code> project specifically for watching the
Memcached resource with APIVersion <code>example.com/v1apha1</code> and Kind <code>Memcached</code>.</p>
</div>
</li>
<li>
<p>A <em>cluster-scoped Operator</em> watches and manages resources cluster-wide, which
can be useful in certain cases. For example, the <code>cert-manager</code> operator is
often deployed with cluster-scoped permissions and watches so that it can manage
issuing certificates for an entire cluster.</p>
<div class="paragraph">
<p>To create your <code>memcached-operator</code> project to be cluster-scoped and change to
its directory, use the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk new memcached-operator \
    --cluster-scoped \
    --api-version=cache.example.com/v1alpha1 \
    --kind=Memcached \
    --type=ansible
$ cd memcached-operator</pre>
</div>
</div>
<div class="paragraph">
<p>Using the <code>--cluster-scoped</code> flag scaffolds the new Operator with the following
modifications:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>deploy/operator.yaml</code>: Set <code>WATCH_NAMESPACE=""</code> instead of setting it to the
Pod&#8217;s namespace.</p>
</li>
<li>
<p><code>deploy/role.yaml</code>: Use <code>ClusterRole</code> instead of <code>Role</code>.</p>
</li>
<li>
<p><code>deploy/role_binding.yaml</code>:</p>
<div class="ulist">
<ul>
<li>
<p>Use <code>ClusterRoleBinding</code> instead of <code>RoleBinding</code>.</p>
</li>
<li>
<p>Set the subject namespace to <code>REPLACE_NAMESPACE</code>. This must be changed to the
namespace in which the Operator is deployed.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Customize the Operator logic.</strong></p>
<div class="paragraph">
<p>For this example, the <code>memcached-operator</code> executes the following reconciliation
logic for each <code>Memcached</code> Custom Resource (CR):</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Create a <code>memcached</code> Deployment if it does not exist.</p>
</li>
<li>
<p>Ensure that the Deployment size is the same as specified by the <code>Memcached</code> CR.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>By default, the <code>memcached-operator</code> watches <code>Memcached</code> resource events as
shown in the <code>watches.yaml</code> file and executes the Ansible role <code>Memcached</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">- version: v1alpha1
  group: cache.example.com
  kind: Memcached</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can optionally customize the following logic in the <code>watches.yaml</code> file:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Specifying a <code>role</code> option configures the Operator to use this specified path
when launching <code>ansible-runner</code> with an Ansible role. By default, the new
command fills in an absolute path to where your role should go:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">- version: v1alpha1
  group: cache.example.com
  kind: Memcached
  role: /opt/ansible/roles/memcached</code></pre>
</div>
</div>
</li>
<li>
<p>Specifying a <code>playbook</code> option in the <code>watches.yaml</code> file configures the
Operator to use this specified path when launching <code>ansible-runner</code> with an
Ansible playbook:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">- version: v1alpha1
  group: cache.example.com
  kind: Memcached
  playbook: /opt/ansible/playbook.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Build the Memcached Ansible role.</strong></p>
<div class="paragraph">
<p>Modify the generated Ansible role under the <code>roles/memcached/</code> directory. This
Ansible role controls the logic that is executed when a resource is modified.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><strong>Define the <code>Memcached</code> spec.</strong></p>
<div class="paragraph">
<p>Defining the spec for an Ansible-based Operator can be done entirely in Ansible.
The Ansible Operator passes all key-value pairs listed in the CR spec field
along to Ansible as
<a href="https://docs.ansible.com/ansible/2.5/user_guide/playbooks_variables.html#passing-variables-on-the-command-line">variables</a>.
The names of all variables in the spec field are converted to snake case
(lowercase with an underscore) by the Operator before running Ansible. For
example, <code>serviceAccount</code> in the spec becomes <code>service_account</code> in Ansible.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You should perform some type validation in Ansible on the variables to ensure
that your application is receiving expected input.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In case the user does not set the <code>spec</code> field, set a default by modifying the
<code>roles/memcached/defaults/main.yml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">size: 1</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Define the <code>Memcached</code> Deployment.</strong></p>
<div class="paragraph">
<p>With the <code>Memcached</code> spec now defined, you can define what Ansible is actually
executed on resource changes. Because this is an Ansible role, the default
behavior executes the tasks in the <code>roles/memcached/tasks/main.yml</code> file.</p>
</div>
<div class="paragraph">
<p>The goal is for Ansible to create a Deployment if it does not exist, which runs
the <code>memcached:1.4.36-alpine</code> image. Ansible 2.7+ supports the
<a href="https://docs.ansible.com/ansible/2.7/modules/k8s_module.html">k8s Ansible module</a>,
which this example leverages to control the Deployment definition.</p>
</div>
<div class="paragraph">
<p>Modify the <code>roles/memcached/tasks/main.yml</code> to match the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">- name: start memcached
  k8s:
    definition:
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: '{{ meta.name }}-memcached'
        namespace: '{{ meta.namespace }}'
      spec:
        replicas: "{{size}}"
        selector:
          matchLabels:
            app: memcached
        template:
          metadata:
            labels:
              app: memcached
          spec:
            containers:
            - name: memcached
              command:
              - memcached
              - -m=64
              - -o
              - modern
              - -v
              image: "docker.io/memcached:1.4.36-alpine"
              ports:
                - containerPort: 11211</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This example used the <code>size</code> variable to control the number of replicas of the
<code>Memcached</code> Deployment. This example sets the default to <code>1</code>, but any user can
create a CR that overwrites the default.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Deploy the CRD.</strong></p>
<div class="paragraph">
<p>Before running the Operator, Kubernetes needs to know about the new Custom
Resource Definition (CRD) the Operator will be watching. Deploy the <code>Memcached</code>
CRD:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl create -f deploy/crds/cache_v1alpha1_memcached_crd.yaml</pre>
</div>
</div>
</li>
<li>
<p><strong>Build and run the Operator.</strong></p>
<div class="paragraph">
<p>There are two ways to build and run the Operator:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>As a Pod inside a Kubernetes cluster.</p>
</li>
<li>
<p>As a Go program outside the cluster using the <code>operator-sdk up</code> command.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Choose one of the following methods:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><strong>Run as a Pod</strong> inside a Kubernetes cluster. This is the preferred
method for production use.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Build the <code>memcached-operator</code> image and push it to a registry:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk build quay.io/example/memcached-operator:v0.0.1
$ podman push quay.io/example/memcached-operator:v0.0.1</pre>
</div>
</div>
</li>
<li>
<p>Deployment manifests are generated in the <code>deploy/operator.yaml</code> file. The
deployment image in this file needs to be modified from the placeholder
<code>REPLACE_IMAGE</code> to the previous built image. To do this, run:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ sed -i 's|REPLACE_IMAGE|quay.io/example/memcached-operator:v0.0.1|g' deploy/operator.yaml</pre>
</div>
</div>
</li>
<li>
<p>If you created your Operator using the <code>--cluster-scoped=true</code> flag, update the
service account namespace in the generated <code>ClusterRoleBinding</code> to match where
you are deploying your Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ export OPERATOR_NAMESPACE=$(kubectl config view --minify -o jsonpath='{.contexts[0].context.namespace}')
$ sed -i "s|REPLACE_NAMESPACE|$OPERATOR_NAMESPACE|g" deploy/role_binding.yaml</pre>
</div>
</div>
<div class="paragraph">
<p>If you are performing these steps on OSX, use the following commands instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ sed -i "" 's|REPLACE_IMAGE|quay.io/example/memcached-operator:v0.0.1|g' deploy/operator.yaml
$ sed -i "" "s|REPLACE_NAMESPACE|$OPERATOR_NAMESPACE|g" deploy/role_binding.yaml</pre>
</div>
</div>
</li>
<li>
<p>Deploy the <code>memcached-operator</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl create -f deploy/service_account.yaml
$ kubectl create -f deploy/role.yaml
$ kubectl create -f deploy/role_binding.yaml
$ kubectl create -f deploy/operator.yaml</pre>
</div>
</div>
</li>
<li>
<p>Verify that the <code>memcached-operator</code> is up and running:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get deployment
NAME                     DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
memcached-operator       1         1         1            1           1m</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Run outside the cluster.</strong> This method is preferred during the
development cycle to speed up deployment and testing.</p>
<div class="paragraph">
<p>Ensure that Ansible Runner and Ansible Runner HTTP Plug-in are installed or else
you will see unexpected errors from Ansible Runner when a CR is created.</p>
</div>
<div class="paragraph">
<p>It is also important that the role path referenced in the <code>watches.yaml</code> file
exists on your machine. Because normally a container is used where the role is
put on disk, the role must be manually copied to the configured Ansible roles
path (for example <code>/etc/ansible/roles</code>).</p>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>To run the Operator locally with the default Kubernetes configuration file
present at <code>$HOME/.kube/config</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk up local
INFO[0000] Go Version: go1.10
INFO[0000] Go OS/Arch: darwin/amd64
INFO[0000] operator-sdk Version: 0.0.5+git</pre>
</div>
</div>
<div class="paragraph">
<p>To run the Operator locally with a provided Kubernetes configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk up local --kubeconfig=config
INFO[0000] Go Version: go1.10
INFO[0000] Go OS/Arch: darwin/amd64
INFO[0000] operator-sdk Version: 0.0.5+git</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Create a <code>Memcached</code> CR.</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Modify the <code>deploy/crds/cache_v1alpha1_memcached_cr.yaml</code> file as shown and
create a <code>Memcached</code> CR:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ cat deploy/crds/cache_v1alpha1_memcached_cr.yaml
apiVersion: "cache.example.com/v1alpha1"
kind: "Memcached"
metadata:
  name: "example-memcached"
spec:
  size: 3

$ kubectl apply -f deploy/crds/cache_v1alpha1_memcached_cr.yaml</pre>
</div>
</div>
</li>
<li>
<p>Ensure that the <code>memcached-operator</code> creates the Deployment for the CR:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get deployment
NAME                     DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
memcached-operator       1         1         1            1           2m
example-memcached        3         3         3            3           1m</pre>
</div>
</div>
</li>
<li>
<p>Check the Pods to confirm three replicas were created:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get pods
NAME                                  READY     STATUS    RESTARTS   AGE
example-memcached-6fd7c98d8-7dqdr     1/1       Running   0          1m
example-memcached-6fd7c98d8-g5k7v     1/1       Running   0          1m
example-memcached-6fd7c98d8-m7vn7     1/1       Running   0          1m
memcached-operator-7cc7cfdf86-vvjqk   1/1       Running   0          2m</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Update the size.</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Change the <code>spec.size</code> field in the <code>memcached</code> CR from <code>3</code> to <code>4</code> and apply the
change:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ cat deploy/crds/cache_v1alpha1_memcached_cr.yaml
apiVersion: "cache.example.com/v1alpha1"
kind: "Memcached"
metadata:
  name: "example-memcached"
spec:
  size: 4

$ kubectl apply -f deploy/crds/cache_v1alpha1_memcached_cr.yaml</pre>
</div>
</div>
</li>
<li>
<p>Confirm that the Operator changes the Deployment size:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get deployment
NAME                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
example-memcached    4         4         4            4           5m</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Clean up the resources:</strong></p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl delete -f deploy/crds/cache_v1alpha1_memcached_cr.yaml
$ kubectl delete -f deploy/operator.yaml
$ kubectl delete -f deploy/role_binding.yaml
$ kubectl delete -f deploy/role.yaml
$ kubectl delete -f deploy/service_account.yaml
$ kubectl delete -f deploy/crds/cache_v1alpha1_memcached_crd.yaml</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="osdk-ansible-k8s-module">Managing application lifecycle using the k8s Ansible module</h4>
<div class="paragraph">
<p>To manage the lifecycle of your application on Kubernetes using Ansible, you
can use the <a href="https://docs.ansible.com/ansible/2.7/modules/k8s_module.html"><code>k8s</code> Ansible module</a>.
This Ansible module allows a developer to either leverage their existing
Kubernetes resource files (written in YAML) or express the lifecycle management
in native Ansible.</p>
</div>
<div class="paragraph">
<p>One of the biggest benefits of using Ansible in conjunction with existing
Kubernetes resource files is the ability to use Jinja templating so that you can
customize resources with the simplicity of a few variables in Ansible.</p>
</div>
<div class="paragraph">
<p>This section goes into detail on usage of the <code>k8s</code> Ansible module. To get
started, install the module on your local workstation and test it using a
playbook before moving on to using it within an Operator.</p>
</div>
<div class="sect4">
<h5 id="osdk-ansible-k8s-module-installing-osdk-ansible">Installing the k8s Ansible module</h5>
<div class="paragraph">
<p>To install the <code>k8s</code> Ansible module on your local workstation:</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Install Ansible 2.6+:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ sudo yum install ansible</pre>
</div>
</div>
</li>
<li>
<p>Install the
<a href="https://github.com/openshift/openshift-restclient-python">OpenShift python client</a>
package using <code>pip</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ pip install openshift</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="osdk-ansible-k8s-module-testing-locally-osdk-ansible">Testing the k8s Ansible module locally</h5>
<div class="paragraph">
<p>Sometimes, it is beneficial for a developer to run the Ansible code from their
local machine as opposed to running and rebuilding the Operator each time.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Initialize a new Ansible-based Operator project:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk new --type ansible --kind Foo --api-version foo.example.com/v1alpha1 foo-operator
Create foo-operator/tmp/init/galaxy-init.sh
Create foo-operator/tmp/build/Dockerfile
Create foo-operator/tmp/build/test-framework/Dockerfile
Create foo-operator/tmp/build/go-test.sh
Rendering Ansible Galaxy role [foo-operator/roles/Foo]...
Cleaning up foo-operator/tmp/init
Create foo-operator/watches.yaml
Create foo-operator/deploy/rbac.yaml
Create foo-operator/deploy/crd.yaml
Create foo-operator/deploy/cr.yaml
Create foo-operator/deploy/operator.yaml
Run git init ...
Initialized empty Git repository in /home/dymurray/go/src/github.com/dymurray/opsdk/foo-operator/.git/
Run git init done</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ cd foo-operator</pre>
</div>
</div>
</li>
<li>
<p>Modify the <code>roles/Foo/tasks/main.yml</code> file with the desired Ansible logic.
This example creates and deletes a namespace with the switch of a variable.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">- name: set test namespace to {{ state }}
  k8s:
    api_version: v1
    kind: Namespace
    state: "{{ state }}"
  ignore_errors: true <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Setting <code>ignore_errors: true</code> ensures that deleting a nonexistent project does
not fail.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Modify the <code>roles/Foo/defaults/main.yml</code> file to set <code>state</code> to <code>present</code> by default.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">state: present</code></pre>
</div>
</div>
</li>
<li>
<p>Create an Ansible playbook <code>playbook.yml</code> in the top-level directory, which
includes the <code>Foo</code> role:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">- hosts: localhost
  roles:
    - Foo</code></pre>
</div>
</div>
</li>
<li>
<p>Run the playbook:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ ansible-playbook playbook.yml
 [WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match 'all'

PLAY [localhost] ***************************************************************************

TASK [Gathering Facts] *********************************************************************
ok: [localhost]

Task [Foo : set test namespace to present]
changed: [localhost]

PLAY RECAP *********************************************************************************
localhost                  : ok=2    changed=1    unreachable=0    failed=0</pre>
</div>
</div>
</li>
<li>
<p>Check that the namespace was created:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get namespace
NAME          STATUS    AGE
default       Active    28d
kube-public   Active    28d
kube-system   Active    28d
test          Active    3s</pre>
</div>
</div>
</li>
<li>
<p>Rerun the playbook setting <code>state</code> to <code>absent</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ ansible-playbook playbook.yml --extra-vars state=absent
 [WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match 'all'

PLAY [localhost] ***************************************************************************

TASK [Gathering Facts] *********************************************************************
ok: [localhost]

Task [Foo : set test namespace to absent]
changed: [localhost]

PLAY RECAP *********************************************************************************
localhost                  : ok=2    changed=1    unreachable=0    failed=0</pre>
</div>
</div>
</li>
<li>
<p>Check that the namespace was deleted:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get namespace
NAME          STATUS    AGE
default       Active    28d
kube-public   Active    28d
kube-system   Active    28d</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="osdk-ansible-k8s-module-inside-operator-osdk-ansible">Testing the k8s Ansible module inside an Operator</h5>
<div class="paragraph">
<p>After you are familiar using the <code>k8s</code> Ansible module locally, you can trigger
the same Ansible logic inside of an Operator when a Custom Resource (CR)
changes. This example maps an Ansible role to a specific Kubernetes resource
that the Operator watches. This mapping is done in the Watches file.</p>
</div>
<div class="sect5">
<h6 id="osdk-ansible-k8s-module-inside-operator-testing-local-osdk-ansible">Testing an Ansible-based Operator locally</h6>
<div class="paragraph">
<p>After getting comfortable testing Ansible workflows locally, you can test the
logic inside of an Ansible-based Operator running locally.</p>
</div>
<div class="paragraph">
<p>To do so, use the <code>operator-sdk up local</code> command from the top-level directory
of your Operator project. This command reads from the <code>./watches.yaml</code> file and
uses the <code>~/.kube/config</code> file to communicate with a Kubernetes cluster just as
the <code>k8s</code> Ansible module does.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Because the <code>up local</code> command reads from the <code>./watches.yaml</code> file, there are
options available to the Operator author. If <code>role</code> is left alone (by default,
<code>/opt/ansible/roles/&lt;name&gt;</code>) you must copy the role over to the
<code>/opt/ansible/roles/</code> directory from the Operator directly.</p>
<div class="paragraph">
<p>This is cumbersome because changes are not reflected from the current directory.
Instead, change the <code>role</code> field to point to the current directory and comment
out the existing line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">- version: v1alpha1
  group: foo.example.com
  kind: Foo
  #  role: /opt/ansible/roles/Foo
  role: /home/user/foo-operator/Foo</code></pre>
</div>
</div>
</li>
<li>
<p>Create a Custom Resource Definiton (CRD) and proper role-based access control
(RBAC) definitions for the Custom Resource (CR) <code>Foo</code>. The <code>operator-sdk</code>
command autogenerates these files inside of the <code>deploy/</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl create -f deploy/crds/foo_v1alpha1_foo_crd.yaml
$ kubectl create -f deploy/service_account.yaml
$ kubectl create -f deploy/role.yaml
$ kubectl create -f deploy/role_binding.yaml</pre>
</div>
</div>
</li>
<li>
<p>Run the <code>up local</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk up local
INFO[0000] Go Version: go1.10.3
INFO[0000] Go OS/Arch: linux/amd64
INFO[0000] operator-sdk Version: 0.0.6+git
INFO[0000] Starting to serve on 127.0.0.1:8888

INFO[0000] Watching foo.example.com/v1alpha1, Foo, default</pre>
</div>
</div>
</li>
<li>
<p>Now that the Operator is watching the resource <code>Foo</code> for events, the creation
of a CR triggers your Ansible role to execute. View the <code>deploy/cr.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: "foo.example.com/v1alpha1"
kind: "Foo"
metadata:
  name: "example"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the <code>spec</code> field is not set, Ansible is invoked with no extra variables.
The next section covers how extra variables are passed from a CR to Ansible.
This is why it is important to set sane defaults for the Operator.</p>
</div>
</li>
<li>
<p>Create a CR instance of <code>Foo</code> with the default variable <code>state</code> set to
<code>present</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl create -f deploy/cr.yaml</pre>
</div>
</div>
</li>
<li>
<p>Check that the namespace <code>test</code> was created:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get namespace
NAME          STATUS    AGE
default       Active    28d
kube-public   Active    28d
kube-system   Active    28d
test          Active    3s</pre>
</div>
</div>
</li>
<li>
<p>Modify the <code>deploy/cr.yaml</code> file to set the <code>state</code> field to <code>absent</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: "foo.example.com/v1alpha1"
kind: "Foo"
metadata:
  name: "example"
spec:
  state: "absent"</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes and confirm that the namespace is deleted:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl apply -f deploy/cr.yaml

$ kubectl get namespace
NAME          STATUS    AGE
default       Active    28d
kube-public   Active    28d
kube-system   Active    28d</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="osdk-ansible-k8s-module-inside-operator-testing-cluster-osdk-ansible">Testing an Ansible-based Operator on a cluster</h6>
<div class="paragraph">
<p>After getting familiar running Ansible logic inside of an Ansible-based Operator
locally, you can test the Operator inside of a Pod on a Kubernetes cluster, such
as OpenShift Enterprise. Running as a Pod on a cluster is preferred for production
use.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Build the <code>foo-operator</code> image and push it to a registry:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk build quay.io/example/foo-operator:v0.0.1
$ podman push quay.io/example/foo-operator:v0.0.1</pre>
</div>
</div>
</li>
<li>
<p>Deployment manifests are generated in the <code>deploy/operator.yaml</code> file. The
Deployment image in this file must be modified from the placeholder
<code>REPLACE_IMAGE</code> to the previously-built image. To do so, run the following
command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ sed -i 's|REPLACE_IMAGE|quay.io/example/foo-operator:v0.0.1|g' deploy/operator.yaml</pre>
</div>
</div>
<div class="paragraph">
<p>If you are performing these steps on OSX, use the following command instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ sed -i "" 's|REPLACE_IMAGE|quay.io/example/foo-operator:v0.0.1|g' deploy/operator.yaml</pre>
</div>
</div>
</li>
<li>
<p>Deploy the <code>foo-operator</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl create -f deploy/crds/foo_v1alpha1_foo_crd.yaml # if CRD doesn't exist already
$ kubectl create -f deploy/service_account.yaml
$ kubectl create -f deploy/role.yaml
$ kubectl create -f deploy/role_binding.yaml
$ kubectl create -f deploy/operator.yaml</pre>
</div>
</div>
</li>
<li>
<p>Verify that the <code>foo-operator</code> is up and running:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get deployment
NAME                     DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
foo-operator       1         1         1            1           1m</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="osdk-ansible-managing-cr-status-osdk-ansible">Managing Custom Resource status using the k8s_status Ansible module</h4>
<div class="paragraph">
<p>Ansible-based Operators automatically update Custom Resource (CR)
<a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/#status-subresource"><code>status</code> subresources</a>
with generic information about the previous Ansible run. This includes the
number of successful and failed tasks and relevant error messages as shown:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">status:
  conditions:
    - ansibleResult:
      changed: 3
      completion: 2018-12-03T13:45:57.13329
      failures: 1
      ok: 6
      skipped: 0
    lastTransitionTime: 2018-12-03T13:45:57Z
    message: 'Status code was -1 and not [200]: Request failed: &lt;urlopen error [Errno
      113] No route to host&gt;'
    reason: Failed
    status: "True"
    type: Failure
  - lastTransitionTime: 2018-12-03T13:46:13Z
    message: Running reconciliation
    reason: Running
    status: "True"
    type: Running</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ansible-based Operators also allow Operator authors to supply custom status
values with the
<a href="https://github.com/fabianvf/ansible-k8s-status-module"><code>k8s_status</code></a> Ansible
module. This allows the author to update the <code>status</code> from within Ansible with
any key-value pair as desired.</p>
</div>
<div class="paragraph">
<p>By default, Ansible-based Operators always include the generic Ansible
run output as shown above. If you would prefer your application did <em>not</em> update
the status with Ansible output, you can track the status manually
from your application.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To track CR status manually from your application, update the Watches file
with a <code>manageStatus</code> field set to <code>false</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">- version: v1
  group: api.example.com
  kind: Foo
  role: /opt/ansible/roles/Foo
  manageStatus: false</code></pre>
</div>
</div>
</li>
<li>
<p>Then, use the <code>k8s_status</code> Ansible module to update the subresource. For
example, to update with key <code>foo</code> and value <code>bar</code>, <code>k8s_status</code> can be used as
shown:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">- k8s_status:
  api_version: app.example.com/v1
  kind: Foo
  name: "{{ meta.name }}"
  namespace: "{{ meta.namespace }}"
  status:
    foo: bar</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more details about user-driven status management from Ansible-based
Operators, see the
<a href="https://github.com/operator-framework/operator-sdk/blob/master/doc/proposals/ansible-operator-status.md">Ansible Operator Status Proposal</a>.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="osdk-ansible-managing-cr-status-locally-osdk-ansible">Using the k8s_status Ansible module when testing locally</h5>
<div class="paragraph">
<p>If your Operator takes advantage of the <code>k8s_status</code> Ansible module and you want
to test the Operator locally with the <code>operator-sdk up local</code> command, you must
install the module in a location that Ansible expects. This is done with the
<code>library</code> configuration option for Ansible.</p>
</div>
<div class="paragraph">
<p>For this example, assume the user is placing third-party Ansible modules in the
<code>/usr/share/ansible/library/</code> directory.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To install the <code>k8s_status</code> module, set the <code>ansible.cfg</code> file to search in
the <code>/usr/share/ansible/library/</code> directory for installed Ansible modules:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ echo "library=/usr/share/ansible/library/" &gt;&gt; /etc/ansible/ansible.cfg</pre>
</div>
</div>
</li>
<li>
<p>Add the <code>k8s_status.py</code> file to the <code>/usr/share/ansible/library/</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ wget https://raw.githubusercontent.com/openshift/ocp-release-operator-sdk/master/library/k8s_status.py -O /usr/share/ansible/library/k8s_status.py</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="osdk-ansible-addtl-resources">Additional resources</h4>
<div class="ulist">
<ul>
<li>
<p>See
<a href="#osdk-project-scaffolding-layout-operator-appendices">Appendices</a>
to learn about the project directory structures created by the Operator SDK.</p>
</li>
<li>
<p><a href="https://blog.openshift.com/reaching-for-the-stars-with-ansible-operator/">Reaching for the Stars with Ansible Operator</a> - Red Hat OpenShift Blog</p>
</li>
<li>
<p><a href="https://operators.gitbook.io/operator-developer-guide-for-red-hat-partners/">Operator Development Guide for Red Hat Partners</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-helm-based-operators">Creating Helm-based Operators</h3>
<div class="paragraph">
<p>This guide outlines Helm chart support in the Operator SDK and walks Operator
authors through an example of building and running an Nginx Operator with the
<code>operator-sdk</code> CLI tool that uses an existing Helm chart.</p>
</div>
<div class="sect3">
<h4 id="osdk-helm-chart-support-osdk-helm">Helm chart support in the Operator SDK</h4>
<div class="paragraph">
<p>The <a href="https://coreos.com/operators/">Operator Framework</a> is an open source
toolkit to manage Kubernetes native applications, called <em>Operators</em>, in an
effective, automated, and scalable way. This framework includes the Operator
SDK, which assists developers in bootstrapping and building an Operator based on
their expertise without requiring knowledge of Kubernetes API complexities.</p>
</div>
<div class="paragraph">
<p>One of the Operator SDK&#8217;s options for generating an Operator project includes
leveraging an existing Helm chart to deploy Kubernetes resources as a unified
application, without having to write any Go code. Such Helm-based Operators are
designed to excel at stateless applications that require very little logic when
rolled out, because changes should be applied to the Kubernetes objects that are
generated as part of the chart. This may sound limiting, but can be sufficient
for a surprising amount of use-cases as shown by the proliferation of Helm
charts built by the Kubernetes community.</p>
</div>
<div class="paragraph">
<p>The main function of an Operator is to read from a custom object that represents
your application instance and have its desired state match what is running. In
the case of a Helm-based Operator, the object&#8217;s spec field is a list of
configuration options that are typically described in Helm&#8217;s <code>values.yaml</code> file.
Instead of setting these values with flags using the Helm CLI (for example, <code>helm install -f values.yaml</code>),
you can express them within a Custom Resource (CR), which, as a native
Kubernetes object, enables the benefits of RBAC applied to it and an audit
trail.</p>
</div>
<div class="paragraph">
<p>For an example of a simple CR called <code>Tomcat</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">apiVersion: apache.org/v1alpha1
kind: Tomcat
metadata:
  name: example-app
spec:
  replicaCount: 2</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>replicaCount</code> value, <code>2</code> in this case, is propagated into the chart&#8217;s
templates where following is used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">{{ .Values.replicaCount }}</pre>
</div>
</div>
<div class="paragraph">
<p>After an Operator is built and deployed, you can deploy a new instance of an app
by creating a new instance of a CR, or list the different instances running in
all environments using a <code>kubectl</code> or <code>oc</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get Tomcats --all-namespaces</pre>
</div>
</div>
<div class="paragraph">
<p>There is no need to use the Helm CLI or install Tiller; Helm-based Operators
import code from the Helm project. All you need to do is have an instance of the
Operator running and register the CR with a Custom Resource Definition (CRD).
And because it obeys RBAC, you can more easily prevent production changes.</p>
</div>
</div>
<div class="sect3">
<h4 id="osdk-installing-cli-osdk-helm">Installing the Operator SDK CLI</h4>
<div class="paragraph">
<p>The Operator SDK has a CLI tool that assists developers in creating, building,
and deploying a new Operator project. You can install the SDK CLI on your
workstation so you are prepared to start authoring your own Operators.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="https://golang.github.io/dep/docs/installation.html">dep</a> v0.5.0+</p>
</li>
<li>
<p><a href="https://git-scm.com/downloads">Git</a></p>
</li>
<li>
<p><a href="https://golang.org/dl/">Go</a> v1.10+</p>
</li>
<li>
<p><a href="https://docs.docker.com/install/"><code>docker</code></a> v17.03+</p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/"><code>kubectl</code></a> v1.11.3+</p>
</li>
<li>
<p>Access to a cluster based on Kubernetes v1.11.3+</p>
</li>
<li>
<p>Access to a container registry</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This guide uses
<a href="https://github.com/kubernetes/minikube#installation">minikube</a> v0.25.0+ as
the local Kubernetes cluster and <a href="https://quay.io/">quay.io</a> for the public
registry.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Clone and <code>operator-sdk</code> repository:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ mkdir -p $GOPATH/src/github.com/operator-framework
$ cd $GOPATH/src/github.com/operator-framework
$ git clone https://github.com/operator-framework/operator-sdk
$ cd operator-sdk</pre>
</div>
</div>
</li>
<li>
<p>Check out the desired release branch:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ git checkout master</pre>
</div>
</div>
</li>
<li>
<p>Install the SDK CLI tool:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ make dep
$ make install</pre>
</div>
</div>
<div class="paragraph">
<p>This installs the CLI binary <code>operator-sdk</code> at <strong><em>$GOPATH/bin</em></strong>.</p>
</div>
</li>
<li>
<p>Verify that the CLI tool was installed correctly:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk -h</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="osdk-building-helm-operator-osdk-helm">Building a Helm-based Operator using the Operator SDK</h4>
<div class="paragraph">
<p>This procedure walks through an example of building a simple Nginx Operator
powered by a Helm chart using tools and libraries provided by the Operator SDK.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>It is best practice to build a new Operator for each chart. This can allow for
more native-behaving Kubernetes APIs (for example, <code>oc get Nginx</code>) and
flexibility if you ever want to write a fully-fledged Operator in Go, migrating
away from a Helm-based Operator.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Operator SDK CLI installed on the development workstation</p>
</li>
<li>
<p>Access to a Kubernetes-based cluster v1.11.3+ (for example OpenShift Enterprise 4.0)
using an account with <code>cluster-admin</code> permissions</p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/"><code>kubectl</code></a> v1.11.3+
(can alternatively use <code>oc</code>)</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p><strong>Create a new Operator project,</strong> either namespace-scoped or cluster-scoped,
using the <code>operator-sdk new</code> command. Choose one of the following:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>A <em>namespace-scoped Operator</em> (the default) watches and manages resources in a
single namespace. Namespace-scoped operators are preferred because of their
flexibility. They enable decoupled upgrades, namespace isolation for failures
and monitoring, and differing API definitions.</p>
<div class="paragraph">
<p>To create a new Helm-based, namespace-scoped
<code>nginx-operator</code> project, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk new nginx-operator \
  --api-version=example.com/v1alpha1 \
  --kind=Nginx \
  --type=helm
$ cd nginx-operator</pre>
</div>
</div>
<div class="paragraph">
<p>This creates the <code>nginx-operator</code> project specifically for watching the Nginx
resource with APIVersion <code>example.com/v1apha1</code> and Kind <code>Nginx</code>.</p>
</div>
</li>
<li>
<p>A <em>cluster-scoped Operator</em> watches and manages resources cluster-wide, which
can be useful in certain cases. For example, the <code>cert-manager</code> operator is
often deployed with cluster-scoped permissions and watches so that it can manage
issuing certificates for an entire cluster.</p>
<div class="paragraph">
<p>To create your <code>nginx-operator</code> project to be cluster-scoped, use the
following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk new nginx-operator \
    --cluster-scoped \
    --api-version=example.com/v1alpha1 \
    --kind=Nginx \
    --type=helm</pre>
</div>
</div>
<div class="paragraph">
<p>Using the <code>--cluster-scoped</code> flag scaffolds the new Operator with the following
modifications:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>deploy/operator.yaml</code>: Set <code>WATCH_NAMESPACE=""</code> instead of setting it to the
Pod&#8217;s namespace.</p>
</li>
<li>
<p><code>deploy/role.yaml</code>: Use <code>ClusterRole</code> instead of <code>Role</code>.</p>
</li>
<li>
<p><code>deploy/role_binding.yaml</code>:</p>
<div class="ulist">
<ul>
<li>
<p>Use <code>ClusterRoleBinding</code> instead of <code>RoleBinding</code>.</p>
</li>
<li>
<p>Set the subject namespace to <code>REPLACE_NAMESPACE</code>. This must be changed to the
namespace in which the Operator is deployed.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Customize the Operator logic.</strong></p>
<div class="paragraph">
<p>For this example, the <code>nginx-operator</code> executes the following reconciliation
logic for each <code>Nginx</code> Custom Resource (CR):</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Create a Nginx Deployment if it does not exist.</p>
</li>
<li>
<p>Create a Nginx Service if it does not exist.</p>
</li>
<li>
<p>Create a Nginx Ingress if it is enabled and does not exist.</p>
</li>
<li>
<p>Ensure that the Deployment, Service, and optional Ingress match the desired
configuration (for example, replica count, image, service type) as specified by
the Nginx CR.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>By default, the <code>nginx-operator</code> watches <code>Nginx</code> resource events as shown in the
<code>watches.yaml</code> file and executes Helm releases using the specified chart:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">- version: v1alpha1
  group: example.com
  kind: Nginx
  chart: /opt/helm/helm-charts/nginx</code></pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><strong>Review the Nginx Helm chart.</strong></p>
<div class="paragraph">
<p>When a Helm Operator project is created, the Operator SDK creates an example Helm chart that contains a set of templates for a simple Nginx release.</p>
</div>
<div class="paragraph">
<p>For this example, templates are available for Deployment, Service, and Ingress
resources, along with a <code>NOTES.txt</code> template, which Helm chart developers use to
convey helpful information about a release.</p>
</div>
<div class="paragraph">
<p>If you are not already familiar with Helm Charts, take a moment to review the
<a href="https://docs.helm.sh/developing_charts/">Helm Chart developer documentation</a>.</p>
</div>
</li>
<li>
<p><strong>Understand the Nginx CR spec.</strong></p>
<div class="paragraph">
<p>Helm uses a concept called
<a href="https://docs.helm.sh/using_helm/#customizing-the-chart-before-installing">values</a>
to provide customizations to a Helm chart&#8217;s defaults, which are defined in the
Helm chart&#8217;s <code>values.yaml</code> file.</p>
</div>
<div class="paragraph">
<p>Override these defaults by setting the desired values in the CR spec. You can
use the number of replicas as an example:</p>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>First, inspect the <code>helm-charts/nginx/values.yaml</code> file to find that the chart
has a value called <code>replicaCount</code> and it is set to <code>1</code> by default. To have 2
Nginx instances in your deployment, your CR spec must contain <code>replicaCount: 2</code>.</p>
<div class="paragraph">
<p>Update the <code>deploy/crds/example_v1alpha1_nginx_cr.yaml</code> file to look like the
following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: example.com/v1alpha1
kind: Nginx
metadata:
  name: example-nginx
spec:
  replicaCount: 2</code></pre>
</div>
</div>
</li>
<li>
<p>Similarly, the default service port is set to <code>80</code>. To instead use <code>8080</code>,
update the <code>deploy/crds/example_v1alpha1_nginx_cr.yaml</code> file again by adding the
service port override:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: example.com/v1alpha1
kind: Nginx
metadata:
  name: example-nginx
spec:
  replicaCount: 2
  service:
    port: 8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Helm Operator applies the entire spec as if it was the contents of a values
file, just like the <code>helm install -f ./overrides.yaml</code> command works.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Deploy the CRD.</strong></p>
<div class="paragraph">
<p>Before running the Operator, Kubernetes needs to know about the new custom
resource definition (CRD) the operator will be watching. Deploy the following CRD:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl create -f deploy/crds/example_v1alpha1_nginx_crd.yaml</pre>
</div>
</div>
</li>
<li>
<p><strong>Build and run the Operator.</strong></p>
<div class="paragraph">
<p>There are two ways to build and run the Operator:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>As a Pod inside a Kubernetes cluster.</p>
</li>
<li>
<p>As a Go program outside the cluster using the <code>operator-sdk up</code> command.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Choose one of the following methods:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><strong>Run as a Pod</strong> inside a Kubernetes cluster. This is the preferred
method for production use.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Build the <code>nginx-operator</code> image and push it to a registry:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk build quay.io/example/nginx-operator:v0.0.1
$ docker push quay.io/example/nginx-operator:v0.0.1</pre>
</div>
</div>
</li>
<li>
<p>Deployment manifests are generated in the <code>deploy/operator.yaml</code> file. The
deployment image in this file needs to be modified from the placeholder
<code>REPLACE_IMAGE</code> to the previous built image. To do this, run:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ sed -i 's|REPLACE_IMAGE|quay.io/example/nginx-operator:v0.0.1|g' deploy/operator.yaml</pre>
</div>
</div>
</li>
<li>
<p>If you created your Operator using the <code>--cluster-scoped=true</code> flag, update the
service account namespace in the generated <code>ClusterRoleBinding</code> to match where
you are deploying your Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ export OPERATOR_NAMESPACE=$(kubectl config view --minify -o jsonpath='{.contexts[0].context.namespace}')
$ sed -i "s|REPLACE_NAMESPACE|$OPERATOR_NAMESPACE|g" deploy/role_binding.yaml</pre>
</div>
</div>
<div class="paragraph">
<p>If you are performing these steps on OSX, use the following commands instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ sed -i "" 's|REPLACE_IMAGE|quay.io/example/nginx-operator:v0.0.1|g' deploy/operator.yaml
$ sed -i "" "s|REPLACE_NAMESPACE|$OPERATOR_NAMESPACE|g" deploy/role_binding.yaml</pre>
</div>
</div>
</li>
<li>
<p>Deploy the <code>nginx-operator</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl create -f deploy/service_account.yaml
$ kubectl create -f deploy/role.yaml
$ kubectl create -f deploy/role_binding.yaml
$ kubectl create -f deploy/operator.yaml</pre>
</div>
</div>
</li>
<li>
<p>Verify that the <code>nginx-operator</code> is up and running:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get deployment
NAME                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
nginx-operator       1         1         1            1           1m</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Run outside the cluster.</strong> This method is preferred during the development
cycle to speed up deployment and testing.</p>
<div class="paragraph">
<p>It is important that the chart path referenced in the <code>watches.yaml</code> file exists
on your machine. By default, the <code>watches.yaml</code> file is scaffolded to work with
an Operator image built with the <code>operator-sdk build</code> command. When developing
and testing your operator with the <code>operator-sdk up local</code> command, the SDK
looks in your local file system for this path.</p>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Create a symlink at this location to point to your Helm chart&#8217;s path:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ sudo mkdir -p /opt/helm/helm-charts
$ sudo ln -s $PWD/helm-charts/nginx /opt/helm/helm-charts/nginx</pre>
</div>
</div>
</li>
<li>
<p>To run the Operator locally with the default Kubernetes configuration file
present at <code>$HOME/.kube/config</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk up local
INFO[0000] Go Version: go1.10.3
INFO[0000] Go OS/Arch: linux/amd64
INFO[0000] operator-sdk Version: v0.3.0+git</pre>
</div>
</div>
<div class="paragraph">
<p>To run the Operator locally with a provided Kubernetes configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk up local --kubeconfig=&lt;path_to_config&gt;
INFO[0000] Go Version: go1.10.3
INFO[0000] Go OS/Arch: linux/amd64
INFO[0000] operator-sdk Version: v0.3.0+git</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Deploy the <code>Nginx</code> CR.</strong></p>
<div class="paragraph">
<p>Apply the <code>Nginx</code> CR that you modified earlier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl apply -f deploy/crds/example_v1alpha1_nginx_cr.yaml</pre>
</div>
</div>
<div class="paragraph">
<p>Ensure that the <code>nginx-operator</code> creates the Deployment for the CR:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get deployment
NAME                                           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
example-nginx-b9phnoz9spckcrua7ihrbkrt1        2         2         2            2           1m</pre>
</div>
</div>
<div class="paragraph">
<p>Check the Pods to confirm two replicas were created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get pods
NAME                                                      READY     STATUS    RESTARTS   AGE
example-nginx-b9phnoz9spckcrua7ihrbkrt1-f8f9c875d-fjcr9   1/1       Running   0          1m
example-nginx-b9phnoz9spckcrua7ihrbkrt1-f8f9c875d-ljbzl   1/1       Running   0          1m</pre>
</div>
</div>
<div class="paragraph">
<p>Check that the Service port is set to <code>8080</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get service
NAME                                      TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE
example-nginx-b9phnoz9spckcrua7ihrbkrt1   ClusterIP   10.96.26.3   &lt;none&gt;        8080/TCP   1m</pre>
</div>
</div>
</li>
<li>
<p><strong>Update the <code>replicaCount</code> and remove the port.</strong></p>
<div class="paragraph">
<p>Change the <code>spec.replicaCount</code> field from <code>2</code> to <code>3</code>, remove the <code>spec.service</code>
field, and apply the change:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ cat deploy/crds/example_v1alpha1_nginx_cr.yaml
apiVersion: "example.com/v1alpha1"
kind: "Nginx"
metadata:
  name: "example-nginx"
spec:
  replicaCount: 3

$ kubectl apply -f deploy/crds/example_v1alpha1_nginx_cr.yaml</pre>
</div>
</div>
<div class="paragraph">
<p>Confirm that the Operator changes the Deployment size:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get deployment
NAME                                           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
example-nginx-b9phnoz9spckcrua7ihrbkrt1        3         3         3            3           1m</pre>
</div>
</div>
<div class="paragraph">
<p>Check that the Service port is set to the default <code>80</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl get service
NAME                                      TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)  AGE
example-nginx-b9phnoz9spckcrua7ihrbkrt1   ClusterIP   10.96.26.3   &lt;none&gt;        80/TCP   1m</pre>
</div>
</div>
</li>
<li>
<p><strong>Clean up the resources:</strong></p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kubectl delete -f deploy/crds/example_v1alpha1_nginx_cr.yaml
$ kubectl delete -f deploy/operator.yaml
$ kubectl delete -f deploy/role_binding.yaml
$ kubectl delete -f deploy/role.yaml
$ kubectl delete -f deploy/service_account.yaml
$ kubectl delete -f deploy/crds/example_v1alpha1_nginx_crd.yaml</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="osdk-helm-addtl-resources">Additional resources</h4>
<div class="ulist">
<ul>
<li>
<p>See
<a href="#osdk-project-scaffolding-layout-operator-appendices">Appendices</a>
to learn about the project directory structures created by the Operator SDK.</p>
</li>
<li>
<p><a href="https://operators.gitbook.io/operator-developer-guide-for-red-hat-partners/">Operator Development Guide for Red Hat Partners</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="generating-a-clusterserviceversion-csv">Generating a ClusterServiceVersion (CSV)</h3>
<div class="paragraph">
<p>A <em>ClusterServiceVersion</em> (CSV) is a YAML manifest created from Operator
metadata that assists the Operator Lifecycle Manager (OLM) in running the
Operator in a cluster. It is the metadata that accompanies an Operator container
image, used to populate user interfaces with information like its logo,
description, and version. It is also a source of technical information needed to
run the Operator, like the RBAC rules it requires and which Custom Resources
(CRs) it manages or depends on.</p>
</div>
<div class="paragraph">
<p>The Operator SDK includes the <code>olm-catalog gen-csv</code> subcommand to generate a
<em>ClusterServiceVersion</em> (CSV) for the current Operator project customized using
information contained in manually-defined YAML manifests and Operator source
files.</p>
</div>
<div class="paragraph">
<p>A CSV-generating command removes the responsibility of Operator authors having
in-depth Operator Lifecycle Manager (OLM) knowledge in order for their Operator
to interact with OLM or publish metadata to the Catalog Registry. Further,
because the CSV spec will likely change over time as new Kubernetes and OLM
features are implemented, the Operator SDK is equipped to easily extend its
update system to handle new CSV features going forward.</p>
</div>
<div class="paragraph">
<p>The CSV version is the same as the Operator&#8217;s, and a new CSV is generated when
upgrading Operator versions. Operator authors can use the <code>--csv-version</code> flag
to have their Operators' state encapsulated in a CSV with the supplied version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk olm-catalog gen-csv --csv-version &lt;version&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>This action is idempotent and only updates the CSV file when a new version is
supplied, or a YAML manifest or source file is changed. Operator authors should
not have to directly modify most fields in a CSV manifest. Those that require
modification are defined in this guide. For example, the CSV version must be
included in <code>metadata.name</code>.</p>
</div>
<div class="sect3">
<h4 id="osdk-how-csv-gen-works-osdk-generating-csvs">How CSV generation works</h4>
<div class="paragraph">
<p>An Operator project&#8217;s <code>deploy/</code> directory is the standard location for all
manifests required to deploy an Operator. The Operator SDK can use data from
manifests in <code>deploy/</code> to write a CSV. The following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk olm-catalog gen-csv --csv-version &lt;version&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>writes a CSV YAML file to the <code>deploy/olm-catalog/</code> directory by default.</p>
</div>
<div class="paragraph">
<p>Exactly three types of manifests are required to generate a CSV:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>operator.yaml</code></p>
</li>
<li>
<p><code>*_{crd,cr}.yaml</code></p>
</li>
<li>
<p>RBAC role files, for example <code>role.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Operator authors may have different versioning requirements for these files and
can configure which specific files are included in the
<code>deploy/olm-catalog/csv-config.yaml</code> file.</p>
</div>
<h5 id="osdk-how-csv-gen-works-workflow-osdk-generating-csvs" class="discrete">Workflow</h5>
<div class="paragraph">
<p>Depending on whether an existing CSV is detected, and assuming all configuration
defaults are used, the <code>olm-catalog gen-csv</code> subcommand either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creates a new CSV, with the same location and naming convention as exists
currently, using available data in YAML manifests and source files.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The update mechanism checks for an existing CSV in <code>deploy/</code>. When one is not
found, it creates a ClusterServiceVersion object, referred to here as a <em>cache</em>,
and populates fields easily derived from Operator metadata, such as Kubernetes
API <code>ObjectMeta</code>.</p>
</li>
<li>
<p>The update mechanism searches <code>deploy/</code> for manifests that contain data a CSV
uses, such as a Deployment resource, and sets the appropriate CSV fields in the
cache with this data.</p>
</li>
<li>
<p>After the search completes, every cache field populated is written back to a
CSV YAML file.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>or:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Updates an existing CSV at the currently pre-defined location, using available
data in YAML manifests and source files.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The update mechanism checks for an existing CSV in <code>deploy/</code>. When one is
found, the CSV YAML file contents are marshaled into a ClusterServiceVersion
cache.</p>
</li>
<li>
<p>The update mechanism searches <code>deploy/</code> for manifests that contain data a CSV
uses, such as a Deployment resource, and sets the appropriate CSV fields in the
cache with this data.</p>
</li>
<li>
<p>After the search completes, every cache field populated is written back to a
CSV YAML file.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Individual YAML fields are overwritten and not the entire file, as descriptions
and other non-generated parts of a CSV should be preserved.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="osdk-configuring-csv-composition-osdk-generating-csvs">CSV composition configuration</h4>
<div class="paragraph">
<p>Operator authors can configure CSV composition by populating several fields in
the <code>deploy/olm-catalog/csv-config.yaml</code> file:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>operator-path</code> (string)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The Operator resource manifest file path. Defaults to <code>deploy/operator.yaml</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>crd-cr-path-list</code> (string(, string)*)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A list of CRD and CR manifest file paths. Defaults to <code>[deploy/crds/*_{crd,cr}.yaml]</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>rbac-path-list</code> (string(, string)*)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A list of RBAC role manifest file paths. Defaults to <code>[deploy/role.yaml]</code>.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="osdk-manually-defined-csv-fields-osdk-generating-csvs">Manually-defined CSV fields</h4>
<div class="paragraph">
<p>Many CSV fields cannot be populated using generated, non-SDK-specific manifests.
These fields are mostly human-written, English metadata about the Operator and
various Custom Resource Definitions (CRDs).</p>
</div>
<div class="paragraph">
<p>Operator authors must directly modify their CSV YAML file, adding personalized
data to the following required fields. The Operator SDK gives a warning CSV
generation when a lack of data in any of the required fields is detected.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 16. Required</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>metadata.name</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A unique name for this CSV. Operator version should be included in the name to
ensure uniqueness, for example <code>app-operator.v0.1.1</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>spec.displayName</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A public name to identify the Operator.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>spec.description</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A short description of the Operator&#8217;s functionality.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>spec.keywords</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Keywords describing the operator.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>spec.maintainers</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Human or organizational entities maintaining the Operator, with a <code>name</code> and
<code>email</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>spec.provider</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The Operators' provider (usually an organization), with a <code>name</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>spec.labels</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Key-value pairs to be used by Operator internals.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>spec.version</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Semantic version of the Operator, for example <code>0.1.1</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>spec.customresourcedefinitions</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Any CRDs the Operator uses. This field is populated automatically by the
Operator SDK if any CRD YAML files are present in <code>deploy/</code>. However, several
fields not in the CRD manifest spec that require user input (more details in the
<a href="https://github.com/operator-framework/operator-lifecycle-manager/blob/master/Documentation/design/building-your-csv.md#owned-crds">CSV CRD spec section</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>description</code>: description of the CRD.</p>
</li>
<li>
<p><code>resources</code>: any Kubernetes resources leveraged by the CRD, for example Pods and StatefulSets.</p>
</li>
<li>
<p><code>specDescriptors</code>: UI hints for inputs and outputs of the Operator.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 17. Optional</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>spec.replaces</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The name of the CSV being replaced by this CSV.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>spec.links</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>URLs (for example, websites and documentation) pertaining to the Operator or
application being managed, each with a <code>name</code> and <code>url</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>spec.selector</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Selectors by which the Operator can pair resources in a cluster.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>spec.icon</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A base64-encoded icon unique to the Operator, set in a <code>base64data</code> field with
a <code>mediatype</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>spec.maturity</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The Operator&#8217;s capability level according to the Operator maturity model, for
example <code>Seamless Upgrades</code>.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Further details on what data each field above should hold are found in the
<a href="https://github.com/operator-framework/operator-lifecycle-manager/blob/master/Documentation/design/building-your-csv.md">CSV spec</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Several YAML fields currently requiring user intervention can potentially be
parsed from Operator code; such Operator SDK functionality will be addressed in
a future design document.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#olm-maturity-model-olm-what-operators-are">Operator maturity model</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="osdk-generating-a-csv-osdk-generating-csvs">Generating a CSV</h4>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>An Operator project generated using the Operator SDK</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In your Operator project, configure your CSV composition by modifying the <code>deploy/olm-catalog/csv-config.yaml</code> file, if desired.</p>
</li>
<li>
<p>Generate the CSV:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk olm-catalog gen-csv --csv-version &lt;version&gt;</pre>
</div>
</div>
</li>
<li>
<p>In the new CSV generated in the <code>deploy/olm-catalog/</code> directory, ensure all
required, manually-defined fields are set appropriately.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-built-in-monitoring-with-prometheus">Configuring built-in monitoring with Prometheus</h3>
<div class="paragraph">
<p>This guide describes the built-in monitoring support provided by the Operator
SDK using the Prometheus Operator and details usage for Operator authors.</p>
</div>
<div class="sect3">
<h4 id="osdk-monitoring-prometheus-operator-support-osdk-monitoring-prometheus">Prometheus Operator support</h4>
<div class="paragraph">
<p><a href="https://prometheus.io/">Prometheus</a> is an open-source systems monitoring and
alerting toolkit. The Prometheus Operator creates, configures, and manages
Prometheus clusters running on Kubernetes-based clusters, such as
OpenShift Enterprise.</p>
</div>
<div class="paragraph">
<p>Helper functions exist in the Operator SDK by default to automatically set up
metrics in any generated Go-based Operator for use on clusters where the
Prometheus Operator is deployed.</p>
</div>
</div>
<div class="sect3">
<h4 id="osdk-monitoring-prometheus-metrics-helper-osdk-monitoring-prometheus">Metrics helper</h4>
<div class="paragraph">
<p>In Go-based Operators generated using the Operator SDK, the following helper
function exposes general metrics about the running program:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-go" data-lang="go">func ExposeMetricsPort(ctx context.Context, port int32) (*v1.Service, error)</code></pre>
</div>
</div>
<div class="paragraph">
<p>These metrics are inherited from the <code>controller-runtime</code> library API. The
metrics are by default served on <code>:8383/metrics</code>.</p>
</div>
<div class="paragraph">
<p>A Service object is created with the metrics port exposed, which can be then
accessed by Prometheus. The Service object is garbage collected when the leader
Pod&#8217;s root owner is deleted.</p>
</div>
<div class="paragraph">
<p>The following example is present in the <code>cmd/manager/main.go</code> file in all
Operators generated using the Operator SDK:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-go" data-lang="go">    import(
     "github.com/operator-framework/operator-sdk/pkg/metrics"
	"sigs.k8s.io/controller-runtime/pkg/manager"
    )

    // Change the below variables to serve metrics on different host or port.
    var metricsHost = "0.0.0.0" <b class="conum">(1)</b>
    var metricsPort int32 = 8383 <b class="conum">(2)</b>

    // Pass metrics address to controller-runtime manager
	mgr, err := manager.New(cfg, manager.Options{
		Namespace:          namespace,
		MetricsBindAddress: fmt.Sprintf("%s:%d", metricsHost, metricsPort),
	})

    ...

	// Create Service object to expose the metrics port.
	_, err = metrics.ExposeMetricsPort(ctx, metricsPort)
	if err != nil {
        // handle error
		log.Info(err.Error())
	}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Host the metrics are exposed on.</p>
</li>
<li>
<p>Port the metrics are exposed on.</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="osdk-monitoring-prometheus-metrics-helper-modifying-port-osdk-monitoring-prometheus">Modifying metrics port</h5>
<div class="paragraph">
<p>Operator authors can modify the port that metrics are exposed on.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Go-based Operator generated using the Operator SDK</p>
</li>
<li>
<p>Kubernetes-based cluster with the Prometheus Operator deployed</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the generated Operator&#8217;s <code>cmd/manager/main.go</code> file, change the <code>var
metricsPort int32 = 8383</code> variable.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="osdk-monitoring-prometheus-servicemonitor-osdk-monitoring-prometheus">ServiceMonitor resources</h4>
<div class="paragraph">
<p>A ServiceMonitor is a Custom Resource Definition (CRD) provided by the
Prometheus Operator that discovers the <code>Endpoints</code> in Service objects and
configures Prometheus to monitor those Pods.</p>
</div>
<div class="paragraph">
<p>In Go-based Operators generated using the Operator SDK, the
<code>GenerateServiceMonitor()</code> helper function can take a Service object and
generate a ServiceMonitor Custom Resource (CR) based on it.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>See the
<a href="https://github.com/coreos/prometheus-operator/blob/7a25bf6b6bb2347dacb235659b73bc210117acc7/Documentation/design.md#servicemonitor">Prometheus Operator documentation</a>
for more about the ServiceMonitor CRD.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="osdk-monitoring-prometheus-servicemonitor-creating-osdk-monitoring-prometheus">Creating ServiceMonitor resources</h5>
<div class="paragraph">
<p>Operator authors can add Service target discovery of created monitoring Services
using the <code>metrics.CreateServiceMonitor()</code> helper function, which accepts the
newly created Service.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Go-based Operator generated using the Operator SDK</p>
</li>
<li>
<p>Kubernetes-based cluster with the Prometheus Operator deployed</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the <code>metrics.CreateServiceMonitor()</code> helper function to your Operator code,
creating only one ServiceMonitor per application and namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-go" data-lang="go">    import "github.com/operator-framework/operator-sdk/pkg/metrics"

    serviceMonitors, err := metrics.CreateServiceMonitors(config *rest.Config, ns string, services []*v1.Service) <b class="conum">(1)</b>
    if err != nil {
        <b class="conum">(2)</b>
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Pass the Service(s) to the helper function, which in turn returns the ServiceMonitor object.</p>
</li>
<li>
<p>Handle errors here.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="operator-sdk-cli-reference">Operator SDK CLI reference</h3>
<div class="paragraph">
<p>This guide documents the Operator SDK CLI commands and their syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk &lt;command&gt; [&lt;subcommand&gt;] [&lt;argument&gt;] [&lt;flags&gt;]</pre>
</div>
</div>
<div class="sect3">
<h4 id="osdk-cli-reference-build-osdk-cli-reference">build</h4>
<div class="paragraph">
<p>The <code>operator-sdk build</code> command compiles the code and builds the executables.
After <code>build</code> completes, the image is built locally in <code>docker</code>. It must then be
pushed to a remote registry.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 18. <code>build</code> arguments</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Argument</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;image&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The container image to be built, e.g., <code>quay.io/example/operator:v0.0.1</code>.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 19. <code>build</code> flags</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Flag</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--enable-tests</code> (bool)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable in-cluster testing by adding test binary to the image.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--namespaced-manifest</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path of namespaced resources manifest for tests. Default: <code>deploy/operator.yaml</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--test-location</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Location of tests. Default: <code>./test/e2e</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-h, --help</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Usage help output.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If <code>--enable-tests</code> is set, the <code>build</code> command also builds the testing binary,
adds it to the container image, and generates a <code>deploy/test-pod.yaml</code> file that
allows a user to run the tests as a Pod on a cluster.</p>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="nowrap">$ operator-sdk build quay.io/example/operator:v0.0.1

building example-operator...

building container quay.io/example/operator:v0.0.1...
Sending build context to Docker daemon  163.9MB
Step 1/4 : FROM alpine:3.6
 ---&gt; 77144d8c6bdc
Step 2/4 : ADD tmp/_output/bin/example-operator /usr/local/bin/example-operator
 ---&gt; 2ada0d6ca93c
Step 3/4 : RUN adduser -D example-operator
 ---&gt; Running in 34b4bb507c14
Removing intermediate container 34b4bb507c14
 ---&gt; c671ec1cff03
Step 4/4 : USER example-operator
 ---&gt; Running in bd336926317c
Removing intermediate container bd336926317c
 ---&gt; d6b58a0fcb8c
Successfully built d6b58a0fcb8c
Successfully tagged quay.io/example/operator:v0.0.1</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="osdk-cli-reference-completion-osdk-cli-reference">completion</h4>
<div class="paragraph">
<p>The <code>operator-sdk completion</code> command generates shell completions to make
issuing CLI commands quicker and easier.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 20. <code>completion</code> subcommands</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Subcommand</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bash</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generate bash completions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>zsh</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generate zsh completions.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 21. <code>completion</code> flags</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Flag</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-h, --help</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Usage help output.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="nowrap">$ operator-sdk completion bash

# bash completion for operator-sdk                         -*- shell-script -*-
...
# ex: ts=4 sw=4 et filetype=sh</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="osdk-cli-reference-print-deps-osdk-cli-reference">print-deps</h4>
<div class="paragraph">
<p>The <code>operator-sdk print-deps</code> command prints the most recent Golang packages and
versions required by Operators. It prints in columnar format by default.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 22. <code>print-deps</code> flags</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Flag</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--as-file</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Print packages and versions in <code>Gopkg.toml</code> format.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="nowrap">$ operator-sdk print-deps --as-file
required = [
  "k8s.io/code-generator/cmd/defaulter-gen",
  "k8s.io/code-generator/cmd/deepcopy-gen",
  "k8s.io/code-generator/cmd/conversion-gen",
  "k8s.io/code-generator/cmd/client-gen",
  "k8s.io/code-generator/cmd/lister-gen",
  "k8s.io/code-generator/cmd/informer-gen",
  "k8s.io/code-generator/cmd/openapi-gen",
  "k8s.io/gengo/args",
]

[[override]]
  name = "k8s.io/code-generator"
  revision = "6702109cc68eb6fe6350b83e14407c8d7309fd1a"
...</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="osdk-cli-reference-generate-osdk-cli-reference">generate</h4>
<div class="paragraph">
<p>The <code>operator-sdk generate</code> command invokes a specific generator to generate
code as needed.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 23. <code>generate</code> subcommands</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Subcommand</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>k8s</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Runs the Kubernetes
<a href="https://github.com/kubernetes/code-generator">code-generators</a> for all CRD
APIs under <code>pkg/apis/</code>. Currently, <code>k8s</code> only runs <code>deepcopy-gen</code> to generate
the required <code>DeepCopy()</code> functions for all Custom Resource (CR) types.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This command must be run every time the API (<code>spec</code> and <code>status</code>) for a custom
resource type is updated.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="nowrap">$ tree pkg/apis/app/v1alpha1/
pkg/apis/app/v1alpha1/
├── appservice_types.go
├── doc.go
├── register.go

$ operator-sdk generate k8s
Running code-generation for Custom Resource (CR) group versions: [app:v1alpha1]
Generating deepcopy funcs

$ tree pkg/apis/app/v1alpha1/
pkg/apis/app/v1alpha1/
├── appservice_types.go
├── doc.go
├── register.go
└── zz_generated.deepcopy.go</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="osdk-cli-reference-olm-catalog-osdk-cli-reference">olm-catalog</h4>
<div class="paragraph">
<p>The <code>operator-sdk olm-catalog</code> is the parent command for all Operator Lifecycle
Manager (OLM) Catalog-related commands.</p>
</div>
<div class="sect4">
<h5 id="_gen-csv">gen-csv</h5>
<div class="paragraph">
<p>The <code>gen-csv</code> subcommand writes a Cluster Service Version (CSV) manifest and
optionally Custom Resource Definition (CRD) files to
<code>deploy/olm-catalog/&lt;operator_name&gt;/&lt;csv_version&gt;</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 24. <code>olm-catalog gen-csv</code> flags</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Flag</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--csv-version</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Semantic version of the CSV manifest. Required.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--from-version</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Semantic version of CSV manifest to use as a base for a new version.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--csv-config</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path to CSV configuration file. Default: <code>deploy/olm-catalog/csv-config.yaml</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--update-crds</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Updates CRD manifests in <code>deploy/&lt;operator_name&gt;/&lt;csv_version&gt;</code> using the
latest CRD manifests.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="nowrap">$ operator-sdk olm-catalog gen-csv --csv-version 0.1.0 --update-crds
INFO[0000] Generating CSV manifest version 0.1.0
INFO[0000] Fill in the following required fields in file deploy/olm-catalog/operator-name/0.1.0/operator-name.v0.1.0.clusterserviceversion.yaml:
	spec.keywords
	spec.maintainers
	spec.provider
	spec.labels
INFO[0000] Created deploy/olm-catalog/operator-name/0.1.0/operator-name.v0.1.0.clusterserviceversion.yaml</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="osdk-cli-reference-new-osdk-cli-reference">new</h4>
<div class="paragraph">
<p>The <code>operator-sdk new</code> command creates a new Operator application and generates
(or <em>scaffolds</em>) a default project directory layout based on the input
<code>&lt;project_name&gt;</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 25. <code>new</code> arguments</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Argument</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;project_name&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the new project.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 26. <code>new</code> flags</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Flag</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--skip-git-init</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do not initialize the directory as a Git repository.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--type</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Type of Operator to initialize: <code>ansible</code> or <code>go</code> (default: <code>go</code>). Also requires the following flags if <code>--type=ansible</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--api-version</code>: CRD <code>APIVersion</code> in the format <code>$GROUP_NAME/$VERSION</code> (e.g., <code>app.example.com/v1alpha1</code>)</p>
</li>
<li>
<p><code>--kind</code>: CRD <code>Kind</code> (e.g., <code>AppService</code>).</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--cluster-scoped</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Initialize the Operator to be cluster-scoped instead of namespace-scoped.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-h, --help</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Usage help output.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example usage for Go project</div>
<div class="content">
<pre class="nowrap">$ mkdir $GOPATH/src/github.com/example.com/
$ cd $GOPATH/src/github.com/example.com/
$ operator-sdk new app-operator</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example usage for Ansible project</div>
<div class="content">
<pre class="nowrap">$ operator-sdk new app-operator \
    --type=ansible \
    --api-version=app.example.com/v1alpha1 \
    --kind=AppService</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="osdk-cli-reference-add-osdk-cli-reference">add</h4>
<div class="paragraph">
<p>The <code>operator-sdk add</code> command adds a controller or resource to the project. The
command must be run from the Operator project root directory.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 27. <code>add</code> subcommands</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Subcommand</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>api</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adds a new API definition for a new Custom Resource (CR) under <code>pkg/apis</code> and
generates the Customer Resource Definition (CRD) and Custom Resource (CR) files
under <code>deploy/crds/</code>. If the API already exists at <code>pkg/apis/&lt;group&gt;/&lt;version&gt;</code>,
then the command does not overwrite and returns an error.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>controller</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adds a new controller under <code>pkg/controller/&lt;kind&gt;/</code>. The controller expects to
use the CR type that should already be defined under
<code>pkg/apis/&lt;group&gt;/&lt;version&gt;</code> via the <code>operator-sdk add api --kind=&lt;kind&gt;
--api-version=&lt;group/version&gt;</code> command. If the controller package for that
<code>Kind</code> already exists at <code>pkg/controller/&lt;kind&gt;</code>, then the command does not
overwrite and returns an error.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>crd</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Adds a CRD and the CR files. The <code>&lt;project-name&gt;/deploy</code> path must already
exist. The <code>--api-version</code> and <code>--kind</code> flags are required to generate the new
Operator application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Generated CRD filename: <code>&lt;project-name&gt;/deploy/crds/&lt;group&gt;_&lt;version&gt;_&lt;kind&gt;_crd.yaml</code></p>
</li>
<li>
<p>Generated CR  filename: <code>&lt;project-name&gt;/deploy/crds/&lt;group&gt;_&lt;version&gt;_&lt;kind&gt;_cr.yaml</code></p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 28. <code>add</code> flags</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Flag</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--api-version</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CRD <code>APIVersion</code> in the format <code>$GROUP_NAME/$VERSION</code> (e.g.,
<code>app.example.com/v1alpha1</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--kind</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CRD <code>Kind</code> (e.g., <code>AppService</code>).</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example <code>add api</code> output</div>
<div class="content">
<pre class="nowrap">$ operator-sdk add api --api-version app.example.com/v1alpha1 --kind AppService
Create pkg/apis/app/v1alpha1/appservice_types.go
Create pkg/apis/addtoscheme_app_v1alpha1.go
Create pkg/apis/app/v1alpha1/register.go
Create pkg/apis/app/v1alpha1/doc.go
Create deploy/crds/app_v1alpha1_appservice_cr.yaml
Create deploy/crds/app_v1alpha1_appservice_crd.yaml
Running code-generation for Custom Resource (CR) group versions: [app:v1alpha1]
Generating deepcopy funcs

$ tree pkg/apis
pkg/apis/
├── addtoscheme_app_appservice.go
├── apis.go
└── app
	└── v1alpha1
		├── doc.go
		├── register.go
		├── types.go</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example <code>add controller</code> output</div>
<div class="content">
<pre class="nowrap">$ operator-sdk add controller --api-version app.example.com/v1alpha1 --kind AppService
Create pkg/controller/appservice/appservice_controller.go
Create pkg/controller/add_appservice.go

$ tree pkg/controller
pkg/controller/
├── add_appservice.go
├── appservice
│   └── appservice_controller.go
└── controller.go</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example <code>add crd</code> output</div>
<div class="content">
<pre class="nowrap">$ operator-sdk add crd --api-version app.example.com/v1alpha1 --kind AppService
Generating Custom Resource Definition (CRD) files
Create deploy/crds/app_v1alpha1_appservice_crd.yaml
Create deploy/crds/app_v1alpha1_appservice_cr.yaml</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="osdk-cli-reference-test-osdk-cli-reference">test</h4>
<div class="paragraph">
<p>The <code>operator-sdk test</code> command has subcommands that can test the Operator
locally or from within a cluster.</p>
</div>
<div class="sect4">
<h5 id="_local">local</h5>
<div class="paragraph">
<p>The <code>local</code> subcommand runs Go tests built using the Operator SDK&#8217;s test
framework locally.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 29. <code>test local</code> arguments</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Arguments</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;test_location&gt;</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Location of e2e test files (e.g., <code>./test/e2e/</code>).</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 30. <code>test local</code> flags</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Flags</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--kubeconfig</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Location of <code>kubeconfig</code> for a cluster. Default: <code>~/.kube/config</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--global-manifest</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path to manifest for global resources. Default: <code>deploy/crd.yaml</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--namespaced-manifest</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path to manifest for per-test, namespaced resources. Default: combines
<code>deploy/service_account.yaml</code>, <code>deploy/rbac.yaml</code>, and <code>deploy/operator.yaml</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--namespace</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If non-empty, a single namespace to run tests in (e.g., <code>operator-test</code>).
Default: <code>""</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--go-test-flags</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extra arguments to pass to <code>go test</code> (e.g., <code>-f "-v -parallel=2"</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--up-local</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable running the Operator locally with <code>go run</code> instead of as an image in the
cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--no-setup</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disable test resource creation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--image</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use a different Operator image from the one specified in the namespaced
manifest.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-h, --help</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Usage help output.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="nowrap">$ operator-sdk test local ./test/e2e/

# Output:
ok  	github.com/operator-framework/operator-sdk-samples/memcached-operator/test/e2e	20.410s</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_cluster">cluster</h5>
<div class="paragraph">
<p>The <code>cluster</code> subcommand runs Go tests embedded in an Operator image built using
the Operator SDK as a Pod in the cluster.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 31. <code>test cluster</code> arguments</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Arguments</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;image_name&gt;</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Operator image that is used to run the tests in a Pod (e.g.,
<code>quay.io/example/memcached-operator:v0.0.1</code>).</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 32. <code>test cluster</code> flags</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Flags</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--kubeconfig</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Location of <code>kubeconfig</code> for a cluster. Default: <code>~/.kube/config</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--image-pull-policy</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set test Pod image pull policy. Allowed values: <code>Always</code> (default), <code>Never</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--namespace</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Namespace to run tests in. Default: <code>default</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--pending-timeout</code> (int)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout in seconds for testing Pod to stay in pending state. Default: <code>60s</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--service-account</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service account to run tests on. Default: <code>default</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--help</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Usage help output.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="nowrap">$ operator-sdk test cluster quay.io/example/memcached-operator:v0.0.1

# Output:
Test Successfully Completed</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="osdk-cli-reference-up-osdk-cli-reference">up</h4>
<div class="paragraph">
<p>The <code>operator-sdk up</code> command has subcommands that can launch the Operator in
various ways.</p>
</div>
<div class="sect4">
<h5 id="_local-2">local</h5>
<div class="paragraph">
<p>The <code>local</code> subcommand launches the Operator on the local machine by building
the Operator binary with the ability to access a Kubernetes cluster using a
<code>kubeconfig</code> file.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 33. <code>up local</code> arguments</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Arguments</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--kubeconfig</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The file path to a Kubernetes configuration file. Defaults: <code>$HOME/.kube/config</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--namespace</code> (string)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The namespace where the Operator watches for changes. Default: <code>default</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--operator-flags</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flags that the local Operator may need. Example: <code>--flag1 value1 --flag2=value2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-h, --help</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Usage help output.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="nowrap">$ operator-sdk up local \
  --kubeconfig "mycluster.kubecfg" \
  --namespace "default" \
  --operator-flags "--flag1 value1 --flag2=value2"</pre>
</div>
</div>
<div class="paragraph">
<p>The following example uses the default <code>kubeconfig</code>, the default namespace
environment variable, and passes in flags for the Operator. To use the Operator
flags, your Operator must know how to handle the option. For example, for an
Operator that understands the <code>resync-interval</code> flag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk up local --operator-flags "--resync-interval 10"</pre>
</div>
</div>
<div class="paragraph">
<p>If you are planning on using a different namespace than the default, use the
<code>--namespace</code> flag to change where the Operator is watching for Custom Resources (CRs)
to be created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ operator-sdk up local --namespace "testing"</pre>
</div>
</div>
<div class="paragraph">
<p>For this to work, your Operator must handle the <code>WATCH_NAMESPACE</code>
environment variable. This can be accomplished using the
<a href="https://github.com/operator-framework/operator-sdk/blob/89bf021063d18b6769bdc551ed08fc37027939d5/pkg/util/k8sutil/k8sutil.go#L140">utility function</a>
<code>k8sutil.GetWatchNamespace</code> in your Operator.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="appendices">Appendices</h3>
<div class="sect3">
<h4 id="osdk-project-scaffolding-layout-operator-appendices">Operator project scaffolding layout</h4>
<div class="paragraph">
<p>The <code>operator-sdk</code> CLI generates a number of packages for each Operator project.
The following sections describes a basic rundown of each generated file and
directory.</p>
</div>
<div class="sect4">
<h5 id="osdk-project-scaffolding-layout-go-operator-appendices">Go-based projects</h5>
<div class="paragraph">
<p>Go-based Operator projects (the default type) generated using the <code>operator-sdk new</code>
command contain the following directories and files:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">File/folders</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cmd/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains <code>manager/main.go</code> file, which is the main program of the Operator. This
instantiates a new manager which registers all Custom Resource Definitions under
<code>pkg/apis/</code> and starts all controllers under <code>pkg/controllers/</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pkg/apis/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains the directory tree that defines the APIs of the Custom Resource
Definitions (CRDs). Users are expected to edit the
<code>pkg/apis/&lt;group&gt;/&lt;version&gt;/&lt;kind&gt;_types.go</code> files to define the API for each
resource type and import these packages in their controllers to watch for these
resource types.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pkg/controller</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This <code>pkg</code> contains the controller implementations. Users are expected to edit
the <code>pkg/controller/&lt;kind&gt;/&lt;kind&gt;_controller.go</code> files to define the
controller&#8217;s reconcile logic for handling a resource type of the specified
<code>kind</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>build/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains the <code>Dockerfile</code> and build scripts used to build the Operator.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>deploy/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains various YAML manifests for registering CRDs, setting up RBAC,
and deploying the Operator as a Deployment.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>Gopkg.toml</code><br>
<code>Gopkg.lock</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <a href="https://github.com/golang/dep">Go Dep</a> manifests that describe the
external dependencies of this Operator.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>vendor/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The golang <a href="https://golang.org/cmd/go/#hdr-Vendor_Directories">vendor</a> folder
that contains the local copies of the external dependencies that satisfy the
imports of this project. <a href="https://github.com/golang/dep">Go Dep</a> manages the
vendor directly.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="osdk-project-scaffolding-layout-helm-operator-appendices">Helm-based projects</h5>
<div class="paragraph">
<p>Helm-based Operator projects generated using the <code>operator-sdk new --type helm</code>
command contain the following directories and files:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">File/folders</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>deploy/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains various YAML manifests for registering CRDs, setting up RBAC,
and deploying the Operator as a Deployment.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>helm-charts/&lt;kind&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains a Helm chart initialized using the equivalent of the
<a href="https://docs.helm.sh/helm/#helm-create"><code>helm create</code></a> command.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>build/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains the <code>Dockerfile</code> and build scripts used to build the Operator.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>watches.yaml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains <code>Group</code>, <code>Version</code>, <code>Kind</code>, and Helm chart location.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-04-12 23:56:11 UTC
</div>
</div>
</body>
</html>